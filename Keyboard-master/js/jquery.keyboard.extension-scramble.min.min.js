(function(b){b.keyboard=b.keyboard||{};b.fn.addScramble=function(a){var d={targetKeys:/[a-z\d]/i,byRow:true,randomizeOnce:true};return this.each(function(){var c,f=b(this).data("keyboard");if(!f){return}c=f.scramble_options=b.extend({},d,a);f.scramble_setup=function(u){var x,t,s,r,w,y,v,z,B,A,e;x=u.find(".ui-keyboard-keyset");if(u.length){for(t=0;t<x.length;t++){s=x.eq(t);v=0;e=[];B=[];z=[];A=[];s.children("button, span, br").each(function(){if(this.tagName==="BR"){if(c.byRow){e.push(this);B.push(false);A[v]=e;z[v]=B;e=[];B=[];v++}else{A[v]=this;z[v]=false;v++}}else{y=b(this).attr("data-value")||"";y=y.length===1&&c.targetKeys.test(y)?y:false;if(c.byRow){e.push(this);B.push(y)}else{A[v]=this;z[v]=y;v++}}});s.find(".ui-keyboard-button-endrow").remove();if(!c.byRow){e=f.shuffle(A,z);for(r=0;r<e.length;r++){s.append(e[r])}}else{for(w=0;w<A.length;w++){e=f.shuffle(A[w],z[w]);for(r=0;r<e.length;r++){s.append(e[r])}}}}return u}};f.shuffle=function(e,k){var l,m,n=e.length;while(n>0){m=Math.floor(Math.random()*n);if(k[n-1]===false){n--}if(k[n-1]!==false&&k[m]!==false){n--;l=e[n];e[n]=e[m];e[m]=l}}return e};f.options.create=function(){var e=f.options.layout;b.keyboard.builtLayouts[e]={mappedKeys:{},acceptedKeys:[],$keyboard:null};if(typeof b.keyboard.builtLayouts[f.orig_layout]==="undefined"){f.layout=f.options.layout=f.orig_layout;f.buildKeyboard();f.layout=f.options.layout=e}b.keyboard.builtLayouts[e]=b.extend({},b.keyboard.builtLayouts[f.orig_layout]);if(c.randomizeOnce){b.keyboard.builtLayouts[e].$keyboard=f.scramble_setup(b.keyboard.builtLayouts[f.orig_layout].$keyboard.clone())}f.$keyboard=b.keyboard.builtLayouts[e].$keyboard;if(!c.randomizeOnce){f.$el.bind("beforeVisible.keyboard",function(i,j){j.$keyboard=j.scramble_setup(j.$keyboard)})}};f.orig_layout=f.options.layout;f.options.layout="scrambled"+Math.round(Math.random()*10000)})}})(jQuery);