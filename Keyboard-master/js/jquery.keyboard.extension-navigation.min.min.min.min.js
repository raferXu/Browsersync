(function(b){b.keyboard=b.keyboard||{};b.keyboard.navigationKeys={toggle:112,enter:13,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,caretrt:45,caretlt:46};b.fn.addNavigation=function(a){return this.each(function(){var g,j,i=b(this).data("keyboard"),h={position:[0,0],toggleMode:false,focusClass:"hasFocus"};if(!i){return}i.navigation_options=g=b.extend({},h,a);i.navigation_keys=j=b.extend({},b.keyboard.navigationKeys);i.saveNav=[i.options.tabNavigation,i.options.enterNavigation];i.allNavKeys=b.map(j,function(d,c){return d});i.navigation_init=function(){i.$keyboard.toggleClass(g.focusClass,g.toggleMode).find(".ui-keyboard-keyset:visible").find('.ui-keyboard-button[data-pos="'+g.position[0]+","+g.position[1]+'"]').addClass("ui-state-hover");i.$preview.unbind("keydown.keyboardNav").bind("keydown.keyboardNav",function(c){return i.checkKeys(c.which)})};i.checkKeys=function(c,d){if(typeof(c)==="undefined"){return}var e=i.navigation_keys;if(c===e.toggle||d){g.toggleMode=(d)?false:!g.toggleMode;i.options.tabNavigation=(g.toggleMode)?false:i.saveNav[0];i.options.enterNavigation=(g.toggleMode)?false:i.saveNav[1]}i.$keyboard.toggleClass(g.focusClass,g.toggleMode);if(g.toggleMode&&c===e.enter){i.$keyboard.find(".ui-keyboard-keyset:visible").find('.ui-keyboard-button[data-pos="'+g.position[0]+","+g.position[1]+'"]').trigger("repeater.keyboard");return false}if(g.toggleMode&&b.inArray(c,i.allNavKeys)>=0){i.navigateKeys(c);return false}};i.navigateKeys=function(f,e,l){l=l||g.position[1];e=e||g.position[0];var c=i.$keyboard.find(".ui-keyboard-keyset:visible"),k=c.find(".ui-keyboard-button-endrow").length-1,p=c.find('.ui-keyboard-button[data-pos^="'+e+',"]').length-1,d=i.lastCaret,t=i.$preview.val().length,s=i.navigation_keys;switch(f){case s.pageup:e=0;break;case s.pagedown:e=k;break;case s.end:l=p;break;case s.home:l=0;break;case s.left:l+=(l>0)?-1:0;break;case s.up:e+=(e>0)?-1:0;break;case s.right:l+=1;break;case s.down:e+=(e+1>k)?0:1;break;case s.caretRt:d.start++;break;case s.caretLt:d.start--;break}if(f===s.caretRt||f===s.caretLt){d.start=d.start<0?0:d.start>t?t:d.start;d.end=d.start;i.lastCaret=d;i.$preview.focus().caret(d.start,d.start)}p=c.find('.ui-keyboard-button[data-pos^="'+e+',"]').length-1;if(l>p){l=p}c.find(".ui-state-hover").removeClass("ui-state-hover");c.find('.ui-keyboard-button[data-pos="'+e+","+l+'"]').addClass("ui-state-hover");g.position=[e,l]};if(i.options.alwaysOpen&&i.isVisible){i.$keyboard.find(".ui-state-hover").removeClass("ui-state-hover");i.navigation_init()}i.$el.bind("visible.keyboard",function(c){i.$keyboard.find(".ui-state-hover").removeClass("ui-state-hover");i.navigation_init()}).bind("inactive.keyboard hidden.keyboard",function(c){i.checkKeys(c.which,true)}).bind("navigate navigateTo",function(d,c,e){c=isNaN(c)?c.toLowerCase():c;if(i.navigation_keys.hasOwnProperty(c)){i.checkKeys(i.navigation_keys[c])}else{i.navigateKeys(null,c,e)}})})}})(jQuery);