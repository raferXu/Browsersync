(function(b){b.fn.addTyping=function(a){var d={showTyping:true,delay:250};return this.each(function(){var c=b(this).data("keyboard");if(!c){return}c.typing_options=b.extend({},d,a);c.typing_keymap={" ":"space",'"':"34","'":"39","&nbsp;":"space","\b":"bksp","\n":"Enter","\r":"Enter","\t":"tab"};c.typing_xref={8:"bksp",9:"tab",13:"enter",32:"space"};c.typing_event=false;c.typing_setup=function(){var f=(c.$preview)?c.$preview:c.$el;f.bind("keyup.keyboard",function(e){if(e.which>=37&&e.which<=40){return}if(e.which===16){c.shiftActive=false}if(e.which===18){c.altActive=false}if(e.which===16||e.which===18){c.showKeySet();setTimeout(function(){c.$preview.focus()},200);return}}).bind("keydown.keyboard",function(e){e.temp=false;if(e.which===16){e.temp=(c.shiftActive)?false:true;c.shiftActive=true}if(e.which===18){e.temp=(c.altActive)?false:true;c.altActive=true}if(e.temp){c.showKeySet();c.$preview.focus()}c.typing_event=true;if(e.which===8||e.which===9){c.typeIn("",c.typing_options.delay||250,function(){c.typing_event=false},e)}}).bind("keypress.keyboard",function(e){if(c.typing_event&&!c.options.lockInput){c.typeIn("",c.typing_options.delay||250,function(){c.typing_event=false},e)}})};c.typeIn=function(n,o,C,k){if(!c.isVisible()){c.typing_options.init=false;clearTimeout(c.typing_timer);return}var A=c.typing_options,m,y,z,x,D,e,B,F,E=b.keyboard.builtLayouts[c.layout].mappedKeys;if(c.typing_options.init!==true){A.init=true;A.text=n;A.len=n.length;A.delay=o||300;A.current=0;A.callback=C}n=A.text.substring(A.current,++A.current);e=c.$keyboard.find(".ui-keyboard-keyset");x=(c.typing_keymap.hasOwnProperty(n))?c.typing_keymap[n]:n;m='.ui-keyboard-button[data-value="'+x+'"]';if(c.typing_event&&k){if(c.typing_xref.hasOwnProperty(k.keyCode||k.which)){m=".ui-keyboard-"+c.typing_xref[k.keyCode||k.which]}else{y=String.fromCharCode(k.charCode||k.which);m=(E.hasOwnProperty(y))?'.ui-keyboard-button[data-value="'+E[y]+'"]':".ui-keyboard-"+(k.charCode||k.which)}}D=e.filter(":visible").find(m);if(D.length){c.typing_simulateKey(D,n)}else{if(c.typing_event){D=e.find(m)}else{z=(c.typing_keymap.hasOwnProperty(n))?c.typing_keymap[n]:n.charCodeAt(0);if(z==="bksp"){n=z}D=e.find(".ui-keyboard-"+z)}F=D.closest(".ui-keyboard-keyset");if(F.attr("name")){B=F.attr("name");c.shiftActive=/shift/.test(B);c.altActive=/alt/.test(B);c.metaActive=c.lastKeyset[2]=(B).match(/meta\d+/)||false;c.showKeySet({name:c.metaActive});c.typing_simulateKey(D,n)}else{if(!c.typing_event){c.insertText(n);c.checkCombos()}}}if(A.current<A.len){if(!c.isVisible()){return}setTimeout(function(){c.typeIn()},A.delay)}else{A.init=false;if(b.isFunction(A.callback)){setTimeout(function(){A.callback(c)},A.delay)}return}};c.typing_simulateKey=function(i,j){var e=i.length;if(e){i.filter(":visible").trigger("mouseenter.keyboard")}c.typing_timer=setTimeout(function(){if(e){setTimeout(function(){i.trigger("mouseleave.keyboard")},c.typing_options.delay/3)}if(!c.isVisible()){return}if(!c.typing_event){c.insertText(j);c.checkCombos()}},c.typing_options.delay/3)};if(c.typing_options.showTyping){if(c.options.alwaysOpen&&c.isVisible()){c.typing_setup()}c.$el.bind("visible.keyboard",function(){c.typing_setup()})}})}})(jQuery);