(function(b){b.keyboard=b.keyboard||{};b.keyboard.navigationKeys={toggle:112,enter:13,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,caretrt:45,caretlt:46};b.fn.addNavigation=function(a){return this.each(function(){var g,j,i=b(this).data("keyboard"),h={position:[0,0],toggleMode:false,focusClass:"hasFocus"};if(!i){return}i.navigation_options=g=b.extend({},h,a);i.navigation_keys=j=b.extend({},b.keyboard.navigationKeys);i.saveNav=[i.options.tabNavigation,i.options.enterNavigation];i.allNavKeys=b.map(j,function(d,c){return d});i.navigation_init=function(){i.$keyboard.toggleClass(g.focusClass,g.toggleMode).find(".ui-keyboard-keyset:visible").find('.ui-keyboard-button[data-pos="'+g.position[0]+","+g.position[1]+'"]').addClass("ui-state-hover");i.$preview.unbind("keydown.keyboardNav").bind("keydown.keyboardNav",function(c){return i.checkKeys(c.which)})};i.checkKeys=function(c,d){if(typeof(c)==="undefined"){return}var e=i.navigation_keys;if(c===e.toggle||d){g.toggleMode=(d)?false:!g.toggleMode;i.options.tabNavigation=(g.toggleMode)?false:i.saveNav[0];i.options.enterNavigation=(g.toggleMode)?false:i.saveNav[1]}i.$keyboard.toggleClass(g.focusClass,g.toggleMode);if(g.toggleMode&&c===e.enter){i.$keyboard.find(".ui-keyboard-keyset:visible").find('.ui-keyboard-button[data-pos="'+g.position[0]+","+g.position[1]+'"]').trigger("repeater.keyboard");return false}if(g.toggleMode&&b.inArray(c,i.allNavKeys)>=0){i.navigateKeys(c);return false}};i.navigateKeys=function(d,c,f){f=f||g.position[1];c=c||g.position[0];var s=i.$keyboard.find(".ui-keyboard-keyset:visible"),e=s.find(".ui-keyboard-button-endrow").length-1,k=s.find('.ui-keyboard-button[data-pos^="'+c+',"]').length-1,t=i.lastCaret,p=i.$preview.val().length,l=i.navigation_keys;switch(d){case l.pageup:c=0;break;case l.pagedown:c=e;break;case l.end:f=k;break;case l.home:f=0;break;case l.left:f+=(f>0)?-1:0;break;case l.up:c+=(c>0)?-1:0;break;case l.right:f+=1;break;case l.down:c+=(c+1>e)?0:1;break;case l.caretRt:t.start++;break;case l.caretLt:t.start--;break}if(d===l.caretRt||d===l.caretLt){t.start=t.start<0?0:t.start>p?p:t.start;t.end=t.start;i.lastCaret=t;i.$preview.focus().caret(t.start,t.start)}k=s.find('.ui-keyboard-button[data-pos^="'+c+',"]').length-1;if(f>k){f=k}s.find(".ui-state-hover").removeClass("ui-state-hover");s.find('.ui-keyboard-button[data-pos="'+c+","+f+'"]').addClass("ui-state-hover");g.position=[c,f]};if(i.options.alwaysOpen&&i.isVisible){i.$keyboard.find(".ui-state-hover").removeClass("ui-state-hover");i.navigation_init()}i.$el.bind("visible.keyboard",function(c){i.$keyboard.find(".ui-state-hover").removeClass("ui-state-hover");i.navigation_init()}).bind("inactive.keyboard hidden.keyboard",function(c){i.checkKeys(c.which,true)}).bind("navigate navigateTo",function(d,c,e){c=isNaN(c)?c.toLowerCase():c;if(i.navigation_keys.hasOwnProperty(c)){i.checkKeys(i.navigation_keys[c])}else{i.navigateKeys(null,c,e)}})})}})(jQuery);