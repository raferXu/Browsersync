(function(a){a.fn.addTyping=function(b){var c={showTyping:true,delay:250};return this.each(function(){var d=a(this).data("keyboard");if(!d){return}d.typing_options=a.extend({},c,b);d.typing_keymap={" ":"space",'"':"34","'":"39","&nbsp;":"space","\b":"bksp","\n":"Enter","\r":"Enter","\t":"tab"};d.typing_xref={8:"bksp",9:"tab",13:"enter",32:"space"};d.typing_event=false;d.typing_setup=function(){var e=(d.$preview)?d.$preview:d.$el;e.bind("keyup.keyboard",function(f){if(f.which>=37&&f.which<=40){return}if(f.which===16){d.shiftActive=false}if(f.which===18){d.altActive=false}if(f.which===16||f.which===18){d.showKeySet();setTimeout(function(){d.$preview.focus()},200);return}}).bind("keydown.keyboard",function(f){f.temp=false;if(f.which===16){f.temp=(d.shiftActive)?false:true;d.shiftActive=true}if(f.which===18){f.temp=(d.altActive)?false:true;d.altActive=true}if(f.temp){d.showKeySet();d.$preview.focus()}d.typing_event=true;if(f.which===8||f.which===9){d.typeIn("",d.typing_options.delay||250,function(){d.typing_event=false},f)}}).bind("keypress.keyboard",function(f){if(d.typing_event&&!d.options.lockInput){d.typeIn("",d.typing_options.delay||250,function(){d.typing_event=false},f)}})};d.typeIn=function(l,i,g,q){if(!d.isVisible()){d.typing_options.init=false;clearTimeout(d.typing_timer);return}var j=d.typing_options,p,t,s,u,f,r,h,v,w=a.keyboard.builtLayouts[d.layout].mappedKeys;if(d.typing_options.init!==true){j.init=true;j.text=l;j.len=l.length;j.delay=i||300;j.current=0;j.callback=g}l=j.text.substring(j.current,++j.current);r=d.$keyboard.find(".ui-keyboard-keyset");u=(d.typing_keymap.hasOwnProperty(l))?d.typing_keymap[l]:l;p='.ui-keyboard-button[data-value="'+u+'"]';if(d.typing_event&&q){if(d.typing_xref.hasOwnProperty(q.keyCode||q.which)){p=".ui-keyboard-"+d.typing_xref[q.keyCode||q.which]}else{t=String.fromCharCode(q.charCode||q.which);p=(w.hasOwnProperty(t))?'.ui-keyboard-button[data-value="'+w[t]+'"]':".ui-keyboard-"+(q.charCode||q.which)}}f=r.filter(":visible").find(p);if(f.length){d.typing_simulateKey(f,l)}else{if(d.typing_event){f=r.find(p)}else{s=(d.typing_keymap.hasOwnProperty(l))?d.typing_keymap[l]:l.charCodeAt(0);if(s==="bksp"){l=s}f=r.find(".ui-keyboard-"+s)}v=f.closest(".ui-keyboard-keyset");if(v.attr("name")){h=v.attr("name");d.shiftActive=/shift/.test(h);d.altActive=/alt/.test(h);d.metaActive=d.lastKeyset[2]=(h).match(/meta\d+/)||false;d.showKeySet({name:d.metaActive});d.typing_simulateKey(f,l)}else{if(!d.typing_event){d.insertText(l);d.checkCombos()}}}if(j.current<j.len){if(!d.isVisible()){return}setTimeout(function(){d.typeIn()},j.delay)}else{j.init=false;if(a.isFunction(j.callback)){setTimeout(function(){j.callback(d)},j.delay)}return}};d.typing_simulateKey=function(g,f){var h=g.length;if(h){g.filter(":visible").trigger("mouseenter.keyboard")}d.typing_timer=setTimeout(function(){if(h){setTimeout(function(){g.trigger("mouseleave.keyboard")},d.typing_options.delay/3)}if(!d.isVisible()){return}if(!d.typing_event){d.insertText(f);d.checkCombos()}},d.typing_options.delay/3)};if(d.typing_options.showTyping){if(d.options.alwaysOpen&&d.isVisible()){d.typing_setup()}d.$el.bind("visible.keyboard",function(){d.typing_setup()})}})}})(jQuery);