(function(b){b.fn.addTyping=function(a){var d={showTyping:true,delay:250};return this.each(function(){var c=b(this).data("keyboard");if(!c){return}c.typing_options=b.extend({},d,a);c.typing_keymap={" ":"space",'"':"34","'":"39","&nbsp;":"space","\b":"bksp","\n":"Enter","\r":"Enter","\t":"tab"};c.typing_xref={8:"bksp",9:"tab",13:"enter",32:"space"};c.typing_event=false;c.typing_setup=function(){var f=(c.$preview)?c.$preview:c.$el;f.bind("keyup.keyboard",function(e){if(e.which>=37&&e.which<=40){return}if(e.which===16){c.shiftActive=false}if(e.which===18){c.altActive=false}if(e.which===16||e.which===18){c.showKeySet();setTimeout(function(){c.$preview.focus()},200);return}}).bind("keydown.keyboard",function(e){e.temp=false;if(e.which===16){e.temp=(c.shiftActive)?false:true;c.shiftActive=true}if(e.which===18){e.temp=(c.altActive)?false:true;c.altActive=true}if(e.temp){c.showKeySet();c.$preview.focus()}c.typing_event=true;if(e.which===8||e.which===9){c.typeIn("",c.typing_options.delay||250,function(){c.typing_event=false},e)}}).bind("keypress.keyboard",function(e){if(c.typing_event&&!c.options.lockInput){c.typeIn("",c.typing_options.delay||250,function(){c.typing_event=false},e)}})};c.typeIn=function(n,x,z,k){if(!c.isVisible()){c.typing_options.init=false;clearTimeout(c.typing_timer);return}var o=c.typing_options,m,E,F,D,A,e,y,C,B=b.keyboard.builtLayouts[c.layout].mappedKeys;if(c.typing_options.init!==true){o.init=true;o.text=n;o.len=n.length;o.delay=x||300;o.current=0;o.callback=z}n=o.text.substring(o.current,++o.current);e=c.$keyboard.find(".ui-keyboard-keyset");D=(c.typing_keymap.hasOwnProperty(n))?c.typing_keymap[n]:n;m='.ui-keyboard-button[data-value="'+D+'"]';if(c.typing_event&&k){if(c.typing_xref.hasOwnProperty(k.keyCode||k.which)){m=".ui-keyboard-"+c.typing_xref[k.keyCode||k.which]}else{E=String.fromCharCode(k.charCode||k.which);m=(B.hasOwnProperty(E))?'.ui-keyboard-button[data-value="'+B[E]+'"]':".ui-keyboard-"+(k.charCode||k.which)}}A=e.filter(":visible").find(m);if(A.length){c.typing_simulateKey(A,n)}else{if(c.typing_event){A=e.find(m)}else{F=(c.typing_keymap.hasOwnProperty(n))?c.typing_keymap[n]:n.charCodeAt(0);if(F==="bksp"){n=F}A=e.find(".ui-keyboard-"+F)}C=A.closest(".ui-keyboard-keyset");if(C.attr("name")){y=C.attr("name");c.shiftActive=/shift/.test(y);c.altActive=/alt/.test(y);c.metaActive=c.lastKeyset[2]=(y).match(/meta\d+/)||false;c.showKeySet({name:c.metaActive});c.typing_simulateKey(A,n)}else{if(!c.typing_event){c.insertText(n);c.checkCombos()}}}if(o.current<o.len){if(!c.isVisible()){return}setTimeout(function(){c.typeIn()},o.delay)}else{o.init=false;if(b.isFunction(o.callback)){setTimeout(function(){o.callback(c)},o.delay)}return}};c.typing_simulateKey=function(i,j){var e=i.length;if(e){i.filter(":visible").trigger("mouseenter.keyboard")}c.typing_timer=setTimeout(function(){if(e){setTimeout(function(){i.trigger("mouseleave.keyboard")},c.typing_options.delay/3)}if(!c.isVisible()){return}if(!c.typing_event){c.insertText(j);c.checkCombos()}},c.typing_options.delay/3)};if(c.typing_options.showTyping){if(c.options.alwaysOpen&&c.isVisible()){c.typing_setup()}c.$el.bind("visible.keyboard",function(){c.typing_setup()})}})}})(jQuery);