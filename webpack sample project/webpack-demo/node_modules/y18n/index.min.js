var fs=require("fs");var path=require("path");var util=require("util");function Y18N(a){a=a||{};this.directory=a.directory||"./locales";this.updateFiles=typeof a.updateFiles==="boolean"?a.updateFiles:true;this.locale=a.locale||"en";this.fallbackToLanguage=typeof a.fallbackToLanguage==="boolean"?a.fallbackToLanguage:true;this.cache={};this.writeQueue=[]}Y18N.prototype.__=function(){var b=Array.prototype.slice.call(arguments);var c=b.shift();var a=function(){};if(typeof b[b.length-1]==="function"){a=b.pop()}a=a||function(){};if(!this.cache[this.locale]){this._readLocaleFile()}if(!this.cache[this.locale][c]&&this.updateFiles){this.cache[this.locale][c]=c;this._enqueueWrite([this.directory,this.locale,a])}else{a()}return util.format.apply(util,[this.cache[this.locale][c]||c].concat(b))};Y18N.prototype._enqueueWrite=function(a){this.writeQueue.push(a);if(this.writeQueue.length===1){this._processWriteQueue()}};Y18N.prototype._processWriteQueue=function(){var g=this;var e=this.writeQueue[0];var d=e[0];var b=e[1];var a=e[2];var f=this._resolveLocaleFile(d,b);var c=JSON.stringify(this.cache[b],null,2);fs.writeFile(f,c,"utf-8",function(h){g.writeQueue.shift();if(g.writeQueue.length>0){g._processWriteQueue()}a(h)})};Y18N.prototype._readLocaleFile=function(){var a={};var c=this._resolveLocaleFile(this.directory,this.locale);try{a=JSON.parse(fs.readFileSync(c,"utf-8"))}catch(b){if(b instanceof SyntaxError){b.message="syntax error in "+c}if(b.code==="ENOENT"){a={}}else{throw b}}this.cache[this.locale]=a};Y18N.prototype._resolveLocaleFile=function(b,a){var c=path.resolve(b,"./",a+".json");if(this.fallbackToLanguage&&!this._fileExistsSync(c)&&~a.lastIndexOf("_")){var d=path.resolve(b,"./",a.split("_")[0]+".json");if(this._fileExistsSync(d)){c=d}}return c};Y18N.prototype._fileExistsSync=function(a){try{return fs.statSync(a).isFile()}catch(b){return false}};Y18N.prototype.__n=function(){var d=Array.prototype.slice.call(arguments);var e=d.shift();var c=d.shift();var f=d.shift();var a=function(){};if(typeof d[d.length-1]==="function"){a=d.pop()}if(!this.cache[this.locale]){this._readLocaleFile()}var g=f===1?e:c;if(this.cache[this.locale][e]){g=this.cache[this.locale][e][f===1?"one":"other"]}if(!this.cache[this.locale][e]&&this.updateFiles){this.cache[this.locale][e]={one:e,other:c};this._enqueueWrite([this.directory,this.locale,a])}else{a()}var b=[g];if(~g.indexOf("%d")){b.push(f)}return util.format.apply(util,b.concat(d))};Y18N.prototype.setLocale=function(a){this.locale=a};Y18N.prototype.getLocale=function(){return this.locale};Y18N.prototype.updateLocale=function(b){if(!this.cache[this.locale]){this._readLocaleFile()}for(var a in b){this.cache[this.locale][a]=b[a]}};module.exports=function(c){var a=new Y18N(c);for(var b in a){if(typeof a[b]==="function"){a[b]=a[b].bind(a)}}return a};