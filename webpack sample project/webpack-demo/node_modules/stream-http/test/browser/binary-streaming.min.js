var Buffer=require("buffer").Buffer;var fs=require("fs");var test=require("tape");var UAParser=require("ua-parser-js");var http=require("../..");var browser=(new UAParser()).setUA(navigator.userAgent).getBrowser();var browserName=browser.name;var browserVersion=browser.major;var skipStreamingCheck=(browserName==="Opera"||(browserName==="IE"&&browserVersion<=10));var skipVerification=(browserName==="IE"&&browserVersion<=8);var COPIES=skipVerification?1:20;var MIN_PIECES=2;var referenceOnce=fs.readFileSync(__dirname+"/../server/static/browserify.png");var reference=new Buffer(referenceOnce.length*COPIES);for(var i=0;i<COPIES;i++){referenceOnce.copy(reference,referenceOnce.length*i)}test("binary streaming",function(a){http.get({path:"/browserify.png?copies="+COPIES,mode:"allow-wrong-content-type"},function(c){var b=[];c.on("end",function(){if(skipVerification){a.skip("binary data not preserved on IE <= 8")}else{a.ok(reference.equals(Buffer.concat(b)),"contents match")}if(skipStreamingCheck){a.skip("streaming not available on IE <= 8")}else{a.ok(b.length>=MIN_PIECES,"received in multiple parts")}a.end()});c.on("data",function(d){b.push(d)})})});test("large binary request without streaming",function(a){http.get({path:"/browserify.png?copies="+COPIES,mode:"default"},function(c){var b=[];c.on("end",function(){if(skipVerification){a.skip("binary data not preserved on IE <= 8")}else{a.ok(reference.equals(Buffer.concat(b)),"contents match")}a.end()});c.on("data",function(d){b.push(d)})})});