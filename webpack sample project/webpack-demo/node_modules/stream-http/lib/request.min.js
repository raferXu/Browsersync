var capability=require("./capability");var inherits=require("inherits");var response=require("./response");var stream=require("readable-stream");var toArrayBuffer=require("to-arraybuffer");var IncomingMessage=response.IncomingMessage;var rStates=response.readyStates;function decideMode(a,b){if(capability.fetch&&b){return"fetch"}else{if(capability.mozchunkedarraybuffer){return"moz-chunked-arraybuffer"}else{if(capability.msstream){return"ms-stream"}else{if(capability.arraybuffer&&a){return"arraybuffer"}else{if(capability.vbArray&&a){return"text:vbarray"}else{return"text"}}}}}}var ClientRequest=module.exports=function(d){var b=this;stream.Writable.call(b);b._opts=d;b._body=[];b._headers={};if(d.auth){b.setHeader("Authorization","Basic "+new Buffer(d.auth).toString("base64"))}Object.keys(d.headers).forEach(function(e){b.setHeader(e,d.headers[e])});var a;var c=true;if(d.mode==="disable-fetch"||"timeout" in d){c=false;a=true}else{if(d.mode==="prefer-streaming"){a=false}else{if(d.mode==="allow-wrong-content-type"){a=!capability.overrideMimeType}else{if(!d.mode||d.mode==="default"||d.mode==="prefer-fast"){a=true}else{throw new Error("Invalid value for opts.mode")}}}}b._mode=decideMode(a,c);b.on("finish",function(){b._onFinish()})};inherits(ClientRequest,stream.Writable);ClientRequest.prototype.setHeader=function(c,d){var b=this;var a=c.toLowerCase();if(unsafeHeaders.indexOf(a)!==-1){return}b._headers[a]={name:c,value:d}};ClientRequest.prototype.getHeader=function(a){var b=this._headers[a.toLowerCase()];if(b){return b.value}return null};ClientRequest.prototype.removeHeader=function(b){var a=this;delete a._headers[b.toLowerCase()]};ClientRequest.prototype._onFinish=function(){var b=this;if(b._destroyed){return}var e=b._opts;var g=b._headers;var a=null;if(e.method!=="GET"&&e.method!=="HEAD"){if(capability.blobConstructor){a=new global.Blob(b._body.map(function(h){return toArrayBuffer(h)}),{type:(g["content-type"]||{}).value||""})}else{a=Buffer.concat(b._body).toString()}}var c=[];Object.keys(g).forEach(function(i){var h=g[i].name;var j=g[i].value;if(Array.isArray(j)){j.forEach(function(k){c.push([h,k])})}else{c.push([h,j])}});if(b._mode==="fetch"){global.fetch(b._opts.url,{method:b._opts.method,headers:c,body:a||undefined,mode:"cors",credentials:e.withCredentials?"include":"same-origin"}).then(function(h){b._fetchResponse=h;b._connect()},function(h){b.emit("error",h)})}else{var f=b._xhr=new global.XMLHttpRequest();try{f.open(b._opts.method,b._opts.url,true)}catch(d){process.nextTick(function(){b.emit("error",d)});return}if("responseType" in f){f.responseType=b._mode.split(":")[0]}if("withCredentials" in f){f.withCredentials=!!e.withCredentials}if(b._mode==="text"&&"overrideMimeType" in f){f.overrideMimeType("text/plain; charset=x-user-defined")}if("timeout" in e){f.timeout=e.timeout;f.ontimeout=function(){b.emit("timeout")}}c.forEach(function(h){f.setRequestHeader(h[0],h[1])});b._response=null;f.onreadystatechange=function(){switch(f.readyState){case rStates.LOADING:case rStates.DONE:b._onXHRProgress();break}};if(b._mode==="moz-chunked-arraybuffer"){f.onprogress=function(){b._onXHRProgress()}}f.onerror=function(){if(b._destroyed){return}b.emit("error",new Error("XHR error"))};try{f.send(a)}catch(d){process.nextTick(function(){b.emit("error",d)});return}}};function statusValid(c){try{var a=c.status;return(a!==null&&a!==0)}catch(b){return false}}ClientRequest.prototype._onXHRProgress=function(){var a=this;if(!statusValid(a._xhr)||a._destroyed){return}if(!a._response){a._connect()}a._response._onXHRProgress()};ClientRequest.prototype._connect=function(){var a=this;if(a._destroyed){return}a._response=new IncomingMessage(a._xhr,a._fetchResponse,a._mode);a._response.on("error",function(b){a.emit("error",b)});a.emit("response",a._response)};ClientRequest.prototype._write=function(c,d,a){var b=this;b._body.push(c);a()};ClientRequest.prototype.abort=ClientRequest.prototype.destroy=function(){var a=this;a._destroyed=true;if(a._response){a._response._destroyed=true}if(a._xhr){a._xhr.abort()}};ClientRequest.prototype.end=function(d,c,a){var b=this;if(typeof d==="function"){a=d;d=undefined}stream.Writable.prototype.end.call(b,d,c,a)};ClientRequest.prototype.flushHeaders=function(){};ClientRequest.prototype.setTimeout=function(){};ClientRequest.prototype.setNoDelay=function(){};ClientRequest.prototype.setSocketKeepAlive=function(){};var unsafeHeaders=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","date","dnt","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];