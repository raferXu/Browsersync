"use strict";var EventEmitter=require("events").EventEmitter;var fs=require("fs");var sysPath=require("path");var asyncEach=require("async-each");var anymatch=require("anymatch");var globParent=require("glob-parent");var isGlob=require("is-glob");var isAbsolute=require("path-is-absolute");var inherits=require("inherits");var NodeFsHandler=require("./lib/nodefs-handler");var FsEventsHandler=require("./lib/fsevents-handler");var arrify=function(a){if(a==null){return[]}return Array.isArray(a)?a:[a]};var flatten=function(b,a){if(a==null){a=[]}b.forEach(function(c){if(Array.isArray(c)){flatten(c,a)}else{a.push(c)}});return a};var isString=function(a){return typeof a==="string"};function FSWatcher(i){EventEmitter.call(this);var a={};if(i){for(var c in i){a[c]=i[c]}}this._watched=Object.create(null);this._closers=Object.create(null);this._ignoredPaths=Object.create(null);Object.defineProperty(this,"_globIgnored",{get:function(){return Object.keys(this._ignoredPaths)}});this.closed=false;this._throttled=Object.create(null);this._symlinkPaths=Object.create(null);function e(j){return a[j]===undefined}if(e("persistent")){a.persistent=true}if(e("ignoreInitial")){a.ignoreInitial=false}if(e("ignorePermissionErrors")){a.ignorePermissionErrors=false}if(e("interval")){a.interval=100}if(e("binaryInterval")){a.binaryInterval=300}if(e("disableGlobbing")){a.disableGlobbing=false}this.enableBinaryInterval=a.binaryInterval!==a.interval;if(e("useFsEvents")){a.useFsEvents=!a.usePolling}if(!FsEventsHandler.canUse()){a.useFsEvents=false}if(e("usePolling")&&!a.useFsEvents){a.usePolling=process.platform==="darwin"}var g=process.env.CHOKIDAR_USEPOLLING;if(g!==undefined){var b=g.toLowerCase();if(b==="false"||b==="0"){a.usePolling=false}else{if(b==="true"||b==="1"){a.usePolling=true}else{a.usePolling=!!b}}}var h=process.env.CHOKIDAR_INTERVAL;if(h){a.interval=parseInt(h)}if(e("atomic")){a.atomic=!a.usePolling&&!a.useFsEvents}if(a.atomic){this._pendingUnlinks=Object.create(null)}if(e("followSymlinks")){a.followSymlinks=true}if(e("awaitWriteFinish")){a.awaitWriteFinish=false}if(a.awaitWriteFinish===true){a.awaitWriteFinish={}}var d=a.awaitWriteFinish;if(d){if(!d.stabilityThreshold){d.stabilityThreshold=2000}if(!d.pollInterval){d.pollInterval=100}this._pendingWrites=Object.create(null)}if(a.ignored){a.ignored=arrify(a.ignored)}this._isntIgnored=function(k,j){return !this._isIgnored(k,j)}.bind(this);var f=0;this._emitReady=function(){if(++f>=this._readyCount){this._emitReady=Function.prototype;this._readyEmitted=true;process.nextTick(this.emit.bind(this,"ready"))}}.bind(this);this.options=a;Object.freeze(a)}inherits(FSWatcher,EventEmitter);FSWatcher.prototype._emit=function(a,j,h,g,e){if(this.options.cwd){j=sysPath.relative(this.options.cwd,j)}var i=[a,j];if(e!==undefined){i.push(h,g,e)}else{if(g!==undefined){i.push(h,g)}else{if(h!==undefined){i.push(h)}}}var c=this.options.awaitWriteFinish;if(c&&this._pendingWrites[j]){this._pendingWrites[j].lastChange=new Date();return this}if(this.options.atomic){if(a==="unlink"){this._pendingUnlinks[j]=i;setTimeout(function(){Object.keys(this._pendingUnlinks).forEach(function(k){this.emit.apply(this,this._pendingUnlinks[k]);this.emit.apply(this,["all"].concat(this._pendingUnlinks[k]));delete this._pendingUnlinks[k]}.bind(this))}.bind(this),typeof this.options.atomic==="number"?this.options.atomic:100);return this}else{if(a==="add"&&this._pendingUnlinks[j]){a=i[0]="change";delete this._pendingUnlinks[j]}}}var f=function(){this.emit.apply(this,i);if(a!=="error"){this.emit.apply(this,["all"].concat(i))}}.bind(this);if(c&&(a==="add"||a==="change")&&this._readyEmitted){var d=function(l,k){if(l){a=i[0]="error";i[1]=l;f()}else{if(k){if(i.length>2){i[2]=k}else{i.push(k)}f()}}};this._awaitWriteFinish(j,c.stabilityThreshold,a,d);return this}if(a==="change"){if(!this._throttle("change",j,50)){return this}}if(this.options.alwaysStat&&h===undefined&&(a==="add"||a==="addDir"||a==="change")){var b=this.options.cwd?sysPath.join(this.options.cwd,j):j;fs.stat(b,function(k,l){if(k||!l){return}i.push(l);f()})}else{f()}return this};FSWatcher.prototype._handleError=function(a){var b=a&&a.code;var c=this.options.ignorePermissionErrors;if(a&&b!=="ENOENT"&&b!=="ENOTDIR"&&(!c||(b!=="EPERM"&&b!=="EACCES"))){this.emit("error",a)}return a||this.closed};FSWatcher.prototype._throttle=function(d,f,c){if(!(d in this._throttled)){this._throttled[d]=Object.create(null)}var b=this._throttled[d];if(f in b){return false}function a(){delete b[f];clearTimeout(e)}var e=setTimeout(a,c);b[f]={timeoutObject:e,clear:a};return b[f]};FSWatcher.prototype._awaitWriteFinish=function(g,b,e,h){var f;var d=g;if(this.options.cwd&&!isAbsolute(g)){d=sysPath.join(this.options.cwd,g)}var c=new Date();var a=(function(i){fs.stat(d,function(l,k){if(l){if(l.code!=="ENOENT"){h(l)}return}var j=new Date();if(i&&k.size!=i.size){this._pendingWrites[g].lastChange=j}if(j-this._pendingWrites[g].lastChange>=b){delete this._pendingWrites[g];h(null,k)}else{f=setTimeout(a.bind(this,k),this.options.awaitWriteFinish.pollInterval)}}.bind(this))}.bind(this));if(!(g in this._pendingWrites)){this._pendingWrites[g]={lastChange:c,cancelWait:function(){delete this._pendingWrites[g];clearTimeout(f);return e}.bind(this)};f=setTimeout(a.bind(this),this.options.awaitWriteFinish.pollInterval)}};var dotRe=/\..*\.(sw[px])$|\~$|\.subl.*\.tmp/;FSWatcher.prototype._isIgnored=function(d,b){if(this.options.atomic&&dotRe.test(d)){return true}if(!this._userIgnored){var c=this.options.cwd;var a=this.options.ignored;if(c&&a){a=a.map(function(f){if(typeof f!=="string"){return f}return isAbsolute(f)?f:sysPath.join(c,f)})}var e=arrify(a).filter(function(f){return typeof f==="string"&&!isGlob(f)}).map(function(f){return f+"/**"});this._userIgnored=anymatch(this._globIgnored.concat(a).concat(e))}return this._userIgnored([d,b])};var replacerRe=/^\.[\/\\]/;FSWatcher.prototype._getWatchHelpers=function(o,g){o=o.replace(replacerRe,"");var h=g||this.options.disableGlobbing||!isGlob(o)?o:globParent(o);var k=sysPath.resolve(h);var d=h!==o;var j=d?anymatch(o):false;var a=this.options.followSymlinks;var f=d&&a?null:false;var n=function(p){if(f==null){f=p.fullParentDir===k?false:{realPath:p.fullParentDir,linkPath:k}}if(f){return p.fullPath.replace(f.realPath,f.linkPath)}return p.fullPath};var i=function(p){return sysPath.join(h,sysPath.relative(h,n(p)))};var e=function(q){if(q.stat&&q.stat.isSymbolicLink()){return b(q)}var p=i(q);return(!d||j(p))&&this._isntIgnored(p,q.stat)&&(this.options.ignorePermissionErrors||this._hasReadPermissions(q.stat))}.bind(this);var m=function(q){if(!d){return false}var p=sysPath.relative(h,q).split(/[\/\\]/);return p};var c=m(o);if(c&&c.length>1){c.pop()}var l;var b=function(r){if(d){var q=m(n(r));var p=false;l=!c.every(function(s,t){if(s==="**"){p=true}return p||!q[t]||anymatch(s,q[t])})}return !l&&this._isntIgnored(i(r),r.stat)}.bind(this);return{followSymlinks:a,statMethod:a?"stat":"lstat",path:o,watchPath:h,entryPath:i,hasGlob:d,globFilter:j,filterPath:e,filterDir:b}};FSWatcher.prototype._getWatchedDir=function(a){var b=sysPath.resolve(a);var c=this._remove.bind(this);if(!(b in this._watched)){this._watched[b]={_items:Object.create(null),add:function(d){if(d!=="."&&d!==".."){this._items[d]=true}},remove:function(d){delete this._items[d];if(!this.children().length){fs.readdir(b,function(e){if(e){c(sysPath.dirname(b),sysPath.basename(b))}})}},has:function(d){return d in this._items},children:function(){return Object.keys(this._items)}}}return this._watched[b]};FSWatcher.prototype._hasReadPermissions=function(a){return Boolean(4&parseInt(((a&&a.mode)&511).toString(8)[0],10))};FSWatcher.prototype._remove=function(g,k){var l=sysPath.join(g,k);var c=sysPath.resolve(l);var h=this._watched[l]||this._watched[c];if(!this._throttle("remove",l,100)){return}var d=Object.keys(this._watched);if(!h&&!this.options.useFsEvents&&d.length===1){this.add(g,k,true)}var b=this._getWatchedDir(l).children();b.forEach(function(m){this._remove(l,m)},this);var j=this._getWatchedDir(g);var e=j.has(k);j.remove(k);var i=l;if(this.options.cwd){i=sysPath.relative(this.options.cwd,l)}if(this.options.awaitWriteFinish&&this._pendingWrites[i]){var a=this._pendingWrites[i].cancelWait();if(a==="add"){return}}delete this._watched[l];delete this._watched[c];var f=h?"unlinkDir":"unlink";if(e&&!this._isIgnored(l)){this._emit(f,l)}if(!this.options.useFsEvents){this._closePath(l)}};FSWatcher.prototype._closePath=function(a){if(!this._closers[a]){return}this._closers[a]();delete this._closers[a];this._getWatchedDir(sysPath.dirname(a)).remove(sysPath.basename(a))};FSWatcher.prototype.add=function(d,c,a){var b=this.options.cwd;this.closed=false;d=flatten(arrify(d));if(!d.every(isString)){throw new TypeError("Non-string provided as watch path: "+d)}if(b){d=d.map(function(e){if(isAbsolute(e)){return e}else{if(e[0]==="!"){return"!"+sysPath.join(b,e.substring(1))}else{return sysPath.join(b,e)}}})}d=d.filter(function(e){if(e[0]==="!"){this._ignoredPaths[e.substring(1)]=true}else{delete this._ignoredPaths[e];delete this._ignoredPaths[e+"/**"];this._userIgnored=null;return true}},this);if(this.options.useFsEvents&&FsEventsHandler.canUse()){if(!this._readyCount){this._readyCount=d.length}if(this.options.persistent){this._readyCount*=2}d.forEach(this._addToFsEvents,this)}else{if(!this._readyCount){this._readyCount=0}this._readyCount+=d.length;asyncEach(d,function(f,e){this._addToNodeFs(f,!a,0,0,c,function(h,g){if(g){this._emitReady()}e(h,g)}.bind(this))}.bind(this),function(e,f){f.forEach(function(g){if(!g||this.closed){return}this.add(sysPath.dirname(g),sysPath.basename(c||g))},this)}.bind(this))}return this};FSWatcher.prototype.unwatch=function(a){if(this.closed){return this}a=flatten(arrify(a));a.forEach(function(b){if(!isAbsolute(b)&&!this._closers[b]){if(this.options.cwd){b=sysPath.join(this.options.cwd,b)}b=sysPath.resolve(b)}this._closePath(b);this._ignoredPaths[b]=true;if(b in this._watched){this._ignoredPaths[b+"/**"]=true}this._userIgnored=null},this);return this};FSWatcher.prototype.close=function(){if(this.closed){return this}this.closed=true;Object.keys(this._closers).forEach(function(a){this._closers[a]();delete this._closers[a]},this);this._watched=Object.create(null);this.removeAllListeners();return this};FSWatcher.prototype.getWatched=function(){var a={};Object.keys(this._watched).forEach(function(b){var c=this.options.cwd?sysPath.relative(this.options.cwd,b):b;a[c||"."]=Object.keys(this._watched[b]._items).sort()}.bind(this));return a};function importHandler(a){Object.keys(a.prototype).forEach(function(b){FSWatcher.prototype[b]=a.prototype[b]})}importHandler(NodeFsHandler);if(FsEventsHandler.canUse()){importHandler(FsEventsHandler)}exports.FSWatcher=FSWatcher;exports.watch=function(b,a){return new FSWatcher(a).add(b)};