"use strict";var fs=require("fs");var sysPath=require("path");var readdirp=require("readdirp");var fsevents;try{fsevents=require("fsevents")}catch(error){}var FSEventsWatchers=Object.create(null);var consolidateThreshhold=10;function createFSEventsInstance(a,b){return(new fsevents(a)).on("fsevent",b).start()}function setFSEventsListener(l,m,d,a){var h=sysPath.extname(l)?sysPath.dirname(l):l;var i;var e=sysPath.dirname(h);if(couldConsolidate(e)){h=e}var b=sysPath.resolve(l);var g=b!==m;function c(o,n,p){if(g){o=o.replace(m,b)}if(o===b||!o.indexOf(b+sysPath.sep)){d(o,n,p)}}function k(){return Object.keys(FSEventsWatchers).some(function(n){if(!m.indexOf(sysPath.resolve(n)+sysPath.sep)){h=n;return true}})}if(h in FSEventsWatchers||k()){i=FSEventsWatchers[h];i.listeners.push(c)}else{i=FSEventsWatchers[h]={listeners:[c],rawEmitters:[a],watcher:createFSEventsInstance(h,function(o,n){var p=fsevents.getInfo(o,n);i.listeners.forEach(function(q){q(o,n,p)});i.rawEmitters.forEach(function(q){q(p.event,o,p)})})}}var f=i.listeners.length-1;return function j(){delete i.listeners[f];delete i.rawEmitters[f];if(!Object.keys(i.listeners).length){i.watcher.stop();delete FSEventsWatchers[h]}}}function couldConsolidate(f){var e=Object.keys(FSEventsWatchers);var d=0;for(var c=0,a=e.length;c<a;++c){var b=e[c];if(b.indexOf(f)===0){d++;if(d>=consolidateThreshhold){return true}}}return false}function canUse(){return fsevents&&Object.keys(FSEventsWatchers).length<128}function depth(c,a){var b=0;while(!c.indexOf(a)&&(c=sysPath.dirname(c))!==a){b++}return b}function FsEventsHandler(){}FsEventsHandler.prototype._watchWithFsEvents=function(c,e,b,d){if(this._isIgnored(c)){return}var a=function(h,i,g){if(this.options.depth!==undefined&&depth(h,e)>this.options.depth){return}var r=b(sysPath.join(c,sysPath.relative(c,h)));if(d&&!d(r)){return}var o=sysPath.dirname(r);var q=sysPath.basename(r);var p=this._getWatchedDir(g.type==="directory"?r:o);var k=function(s){if(this._isIgnored(r,s)){this._ignoredPaths[r]=true;if(s&&s.isDirectory()){this._ignoredPaths[r+"/**/*"]=true}return true}else{delete this._ignoredPaths[r];delete this._ignoredPaths[r+"/**/*"]}}.bind(this);var m=function(t){if(k()){return}if(t==="unlink"){if(g.type==="directory"||p.has(q)){this._remove(o,q)}}else{if(t==="add"){if(g.type==="directory"){this._getWatchedDir(r)}if(g.type==="symlink"&&this.options.followSymlinks){var u=this.options.depth===undefined?undefined:depth(h,e)+1;return this._addToFsEvents(r,false,true,u)}else{this._getWatchedDir(o).add(q)}}var s=g.type==="directory"?t+"Dir":t;this._emit(s,r);if(s==="addDir"){this._addToFsEvents(r,false,true)}}}.bind(this);function j(){m(p.has(q)?"change":"add")}function l(){fs.open(r,"r",function(s,t){if(t){fs.close(t)}s&&s.code!=="EACCES"?m("unlink"):j()})}var n=[69888,70400,71424,72704,73472,131328,131840,262912];if(n.indexOf(i)!==-1||g.event==="unknown"){if(typeof this.options.ignored==="function"){fs.stat(r,function(s,t){if(k(t)){return}t?j():m("unlink")})}else{l()}}else{switch(g.event){case"created":case"modified":return j();case"deleted":case"moved":return l()}}}.bind(this);var f=setFSEventsListener(c,e,a,this.emit.bind(this,"raw"));this._emitReady();return f};FsEventsHandler.prototype._handleFsEventsSymlink=function(c,b,a,d){if(this._symlinkPaths[b]){return}else{this._symlinkPaths[b]=true}this._readyCount++;fs.realpath(c,function(e,f){if(this._handleError(e)||this._isIgnored(f)){return this._emitReady()}this._readyCount++;this._addToFsEvents(f||c,function(i){var h="."+sysPath.sep;var g=c;if(f&&f!==h){g=i.replace(f,c)}else{if(i!==h){g=sysPath.join(c,i)}}return a(g)},false,d)}.bind(this))};FsEventsHandler.prototype._addToFsEvents=function(h,d,g,e){var a=typeof d==="function"?d:function(i){return i};var c=function(k,j){var i=a(k);var n=j.isDirectory();var m=this._getWatchedDir(sysPath.dirname(i));var l=sysPath.basename(i);if(n){this._getWatchedDir(i)}if(m.has(l)){return}m.add(l);if(!this.options.ignoreInitial||g===true){this._emit(n?"addDir":"add",i,j)}}.bind(this);var b=this._getWatchHelpers(h);fs[b.statMethod](b.watchPath,function(i,j){if(this._handleError(i)||this._isIgnored(b.watchPath,j)){this._emitReady();return this._emitReady()}if(j.isDirectory()){if(!b.globFilter){c(a(h),j)}if(e&&e>this.options.depth){return}readdirp({root:b.watchPath,entryType:"all",fileFilter:b.filterPath,directoryFilter:b.filterDir,lstat:true,depth:this.options.depth-(e||0)}).on("data",function(m){if(m.stat.isDirectory()&&!b.filterPath(m)){return}var l=sysPath.join(b.watchPath,m.path);var k=m.fullPath;if(b.followSymlinks&&m.stat.isSymbolicLink()){var n=this.options.depth===undefined?undefined:depth(l,sysPath.resolve(b.watchPath))+1;this._handleFsEventsSymlink(l,k,a,n)}else{c(l,m.stat)}}.bind(this)).on("error",function(){}).on("end",this._emitReady)}else{c(b.watchPath,j);this._emitReady()}}.bind(this));if(this.options.persistent&&g!==true){var f=function(i,j){if(this.closed){return}var k=this._watchWithFsEvents(b.watchPath,sysPath.resolve(j||b.watchPath),a,b.globFilter);if(k){this._closers[h]=k}}.bind(this);if(typeof d==="function"){f()}else{fs.realpath(b.watchPath,f)}}};module.exports=FsEventsHandler;module.exports.canUse=canUse;