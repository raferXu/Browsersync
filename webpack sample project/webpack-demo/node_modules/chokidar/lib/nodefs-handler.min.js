"use strict";var fs=require("fs");var sysPath=require("path");var readdirp=require("readdirp");var isBinaryPath=require("is-binary-path");var FsWatchInstances=Object.create(null);function createFsWatchInstance(f,c,d,e,g){var a=function(h,i){d(f);g(h,i,{watchedPath:f});if(i&&f!==i){fsWatchBroadcast(sysPath.resolve(f,i),"listeners",sysPath.join(f,i))}};try{return fs.watch(f,c,a)}catch(b){e(b)}}function fsWatchBroadcast(a,c,e,d,b){if(!FsWatchInstances[a]){return}FsWatchInstances[a][c].forEach(function(f){f(e,d,b)})}function setFsWatchListener(k,e,l,f){var d=f.listener;var i=f.errHandler;var a=f.rawEmitter;var b=FsWatchInstances[e];var h;if(!l.persistent){h=createFsWatchInstance(k,l,d,i,a);return h.close.bind(h)}if(!b){h=createFsWatchInstance(k,l,fsWatchBroadcast.bind(null,e,"listeners"),i,fsWatchBroadcast.bind(null,e,"rawEmitters"));if(!h){return}var c=fsWatchBroadcast.bind(null,e,"errHandlers");h.on("error",function(m){if(process.platform==="win32"&&m.code==="EPERM"){fs.open(k,"r",function(o,n){if(n){fs.close(n)}if(!o){c(m)}})}else{c(m)}});b=FsWatchInstances[e]={listeners:[d],errHandlers:[i],rawEmitters:[a],watcher:h}}else{b.listeners.push(d);b.errHandlers.push(i);b.rawEmitters.push(a)}var g=b.listeners.length-1;return function j(){delete b.listeners[g];delete b.errHandlers[g];delete b.rawEmitters[g];if(!Object.keys(b.listeners).length){b.watcher.close();delete FsWatchInstances[e]}}}var FsWatchFileInstances=Object.create(null);function setFsWatchFileListener(j,d,k,e){var c=e.listener;var a=e.rawEmitter;var b=FsWatchFileInstances[d];var h=[];var g=[];if(b&&(b.options.persistent<k.persistent||b.options.interval>k.interval)){h=b.listeners;g=b.rawEmitters;fs.unwatchFile(d);b=false}if(!b){h.push(c);g.push(a);b=FsWatchFileInstances[d]={listeners:h,rawEmitters:g,options:k,watcher:fs.watchFile(d,k,function(n,m){b.rawEmitters.forEach(function(o){o("change",d,{curr:n,prev:m})});var l=n.mtime.getTime();if(n.size!==m.size||l>m.mtime.getTime()||l===0){b.listeners.forEach(function(o){o(j,n)})}})}}else{b.listeners.push(c);b.rawEmitters.push(a)}var f=b.listeners.length-1;return function i(){delete b.listeners[f];delete b.rawEmitters[f];if(!Object.keys(b.listeners).length){fs.unwatchFile(d);delete FsWatchFileInstances[d]}}}function NodeFsHandler(){}NodeFsHandler.prototype._watchWithNodeFs=function(g,e){var a=sysPath.dirname(g);var f=sysPath.basename(g);var d=this._getWatchedDir(a);d.add(f);var b=sysPath.resolve(g);var c={persistent:this.options.persistent};if(!e){e=Function.prototype}var h;if(this.options.usePolling){c.interval=this.enableBinaryInterval&&isBinaryPath(f)?this.options.binaryInterval:this.options.interval;h=setFsWatchFileListener(g,b,c,{listener:e,rawEmitter:this.emit.bind(this,"raw")})}else{h=setFsWatchListener(g,b,c,{listener:e,errHandler:this._handleError.bind(this),rawEmitter:this.emit.bind(this,"raw")})}return h};NodeFsHandler.prototype._handleFile=function(b,a,d,h){var f=sysPath.dirname(b);var e=sysPath.basename(b);var c=this._getWatchedDir(f);if(c.has(e)){return h()}var g=this._watchWithNodeFs(b,function(j,i){if(!this._throttle("watch",b,5)){return}if(!i||i&&i.mtime.getTime()===0){fs.stat(b,function(k,l){if(k){this._remove(f,e)}else{this._emit("change",b,l)}}.bind(this))}else{if(c.has(e)){this._emit("change",b,i)}}}.bind(this));if(!(d&&this.options.ignoreInitial)){if(!this._throttle("add",b,0)){return}this._emit("add",b,a)}if(h){h()}return g};NodeFsHandler.prototype._handleSymlink=function(e,a,f,d){var c=e.fullPath;var b=this._getWatchedDir(a);if(!this.options.followSymlinks){this._readyCount++;fs.realpath(f,function(h,g){if(b.has(d)){if(this._symlinkPaths[c]!==g){this._symlinkPaths[c]=g;this._emit("change",f,e.stat)}}else{b.add(d);this._symlinkPaths[c]=g;this._emit("add",f,e.stat)}this._emitReady()}.bind(this));return true}if(this._symlinkPaths[c]){return true}else{this._symlinkPaths[c]=true}};NodeFsHandler.prototype._handleDir=function(d,h,g,f,i,a,j){var c=this._getWatchedDir(sysPath.dirname(d));var e=c.has(sysPath.basename(d));if(!(g&&this.options.ignoreInitial)&&!i&&!e){if(!a.hasGlob||a.globFilter(d)){this._emit("addDir",d,h)}}c.add(sysPath.basename(d));this._getWatchedDir(d);var b=function(m,o,l){m=sysPath.join(m,"");if(!a.hasGlob){var q=this._throttle("readdir",m,1000);if(!q){return}}var n=this._getWatchedDir(a.path);var p=[];readdirp({root:m,entryType:"all",fileFilter:a.filterPath,directoryFilter:a.filterDir,depth:0,lstat:true}).on("data",function(s){var r=s.path;var t=sysPath.join(m,r);p.push(r);if(s.stat.isSymbolicLink()&&this._handleSymlink(s,m,t,r)){return}if(r===i||!i&&!n.has(r)){this._readyCount++;t=sysPath.join(d,sysPath.relative(d,t));this._addToNodeFs(t,o,a,f+1)}}.bind(this)).on("end",function(){if(q){q.clear()}if(l){l()}n.children().filter(function(r){return r!==m&&p.indexOf(r)===-1&&(!a.hasGlob||a.filterPath({fullPath:sysPath.resolve(m,r)}))}).forEach(function(r){this._remove(m,r)},this)}.bind(this)).on("error",this._handleError.bind(this))}.bind(this);var k;if(this.options.depth==null||f<=this.options.depth){if(!i){b(d,g,j)}k=this._watchWithNodeFs(d,function(m,l){if(l&&l.mtime.getTime()===0){return}b(m,false)})}else{j()}return k};NodeFsHandler.prototype._addToNodeFs=function(f,d,b,g,e,h){if(!h){h=Function.prototype}var c=this._emitReady;if(this._isIgnored(f)||this.closed){c();return h(null,false)}var a=this._getWatchHelpers(f,g);if(!a.hasGlob&&b){a.hasGlob=b.hasGlob;a.globFilter=b.globFilter;a.filterPath=b.filterPath;a.filterDir=b.filterDir}fs[a.statMethod](a.watchPath,function(i,j){if(this._handleError(i)){return h(null,f)}if(this._isIgnored(a.watchPath,j)){c();return h(null,false)}var l=function(n,o){return this._handleDir(n,j,d,g,o,a,c)}.bind(this);var m;if(j.isDirectory()){m=l(a.watchPath,e)}else{if(j.isSymbolicLink()){var k=sysPath.dirname(a.watchPath);this._getWatchedDir(k).add(a.watchPath);this._emit("add",a.watchPath,j);m=l(k,f);fs.realpath(f,function(n,o){this._symlinkPaths[sysPath.resolve(f)]=o;c()}.bind(this))}else{m=this._handleFile(a.watchPath,j,d,c)}}if(m){this._closers[f]=m}h(null,false)}.bind(this))};module.exports=NodeFsHandler;