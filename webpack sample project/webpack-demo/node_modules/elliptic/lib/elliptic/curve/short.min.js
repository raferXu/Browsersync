"use strict";var curve=require("../curve");var elliptic=require("../../elliptic");var BN=require("bn.js");var inherits=require("inherits");var Base=curve.base;var assert=elliptic.utils.assert;function ShortCurve(a){Base.call(this,"short",a);this.a=new BN(a.a,16).toRed(this.red);this.b=new BN(a.b,16).toRed(this.red);this.tinv=this.two.redInvm();this.zeroA=this.a.fromRed().cmpn(0)===0;this.threeA=this.a.fromRed().sub(this.p).cmpn(-3)===0;this.endo=this._getEndomorphism(a);this._endoWnafT1=new Array(4);this._endoWnafT2=new Array(4)}inherits(ShortCurve,Base);module.exports=ShortCurve;ShortCurve.prototype._getEndomorphism=function _getEndomorphism(b){if(!this.zeroA||!this.g||!this.n||this.p.modn(3)!==1){return}var e;var a;if(b.beta){e=new BN(b.beta,16).toRed(this.red)}else{var f=this._getEndoRoots(this.p);e=f[0].cmp(f[1])<0?f[0]:f[1];e=e.toRed(this.red)}if(b.lambda){a=new BN(b.lambda,16)}else{var c=this._getEndoRoots(this.n);if(this.g.mul(c[0]).x.cmp(this.g.x.redMul(e))===0){a=c[0]}else{a=c[1];assert(this.g.mul(a).x.cmp(this.g.x.redMul(e))===0)}}var d;if(b.basis){d=b.basis.map(function(g){return{a:new BN(g.a,16),b:new BN(g.b,16)}})}else{d=this._getEndoBasis(a)}return{beta:e,lambda:a,basis:d}};ShortCurve.prototype._getEndoRoots=function _getEndoRoots(c){var g=c===this.p?this.red:BN.mont(c);var e=new BN(2).toRed(g).redInvm();var d=e.redNeg();var f=new BN(3).toRed(g).redNeg().redSqrt().redMul(e);var b=d.redAdd(f).fromRed();var a=d.redSub(f).fromRed();return[b,a]};ShortCurve.prototype._getEndoBasis=function _getEndoBasis(o){var l=this.n.ushrn(Math.floor(this.n.bitLength()/2));var n=o;var m=this.n.clone();var z=new BN(1);var b=new BN(0);var w=new BN(0);var a=new BN(1);var C;var f;var B;var d;var A;var c;var h;var t=0;var p;var k;while(n.cmpn(0)!==0){var s=m.div(n);p=m.sub(s.mul(n));k=w.sub(s.mul(z));var j=a.sub(s.mul(b));if(!B&&p.cmp(l)<0){C=h.neg();f=z;B=p.neg();d=k}else{if(B&&++t===2){break}}h=p;m=n;n=p;w=z;z=k;a=b;b=j}A=p.neg();c=k;var g=B.sqr().add(d.sqr());var e=A.sqr().add(c.sqr());if(e.cmp(g)>=0){A=C;c=f}if(B.negative){B=B.neg();d=d.neg()}if(A.negative){A=A.neg();c=c.neg()}return[{a:B,b:d},{a:A,b:c}]};ShortCurve.prototype._endoSplit=function _endoSplit(a){var h=this.endo.basis;var j=h[0];var i=h[1];var c=i.b.mul(a).divRound(this.n);var b=j.b.neg().mul(a).divRound(this.n);var m=c.mul(j.a);var l=b.mul(i.a);var e=c.mul(j.b);var d=b.mul(i.b);var g=a.sub(m).sub(l);var f=e.add(d).neg();return{k1:g,k2:f}};ShortCurve.prototype.pointFromX=function pointFromX(a,d){a=new BN(a,16);if(!a.red){a=a.toRed(this.red)}var c=a.redSqr().redMul(a).redIAdd(a.redMul(this.a)).redIAdd(this.b);var e=c.redSqrt();if(e.redSqr().redSub(c).cmp(this.zero)!==0){throw new Error("invalid point")}var b=e.fromRed().isOdd();if(d&&!b||!d&&b){e=e.redNeg()}return this.point(a,e)};ShortCurve.prototype.validate=function validate(b){if(b.inf){return true}var a=b.x;var e=b.y;var c=this.a.redMul(a);var d=a.redSqr().redMul(a).redIAdd(c).redIAdd(this.b);return e.redSqr().redISub(d).cmpn(0)===0};ShortCurve.prototype._endoWnafMulAdd=function _endoWnafMulAdd(l,a,m){var g=this._endoWnafT1;var f=this._endoWnafT2;for(var d=0;d<l.length;d++){var h=this._endoSplit(a[d]);var b=l[d];var k=b._getBeta();if(h.k1.negative){h.k1.ineg();b=b.neg(true)}if(h.k2.negative){h.k2.ineg();k=k.neg(true)}g[d*2]=b;g[d*2+1]=k;f[d*2]=h.k1;f[d*2+1]=h.k2}var e=this._wnafMulAdd(1,g,f,d*2,m);for(var c=0;c<d*2;c++){g[c]=null;f[c]=null}return e};function Point(c,a,d,b){Base.BasePoint.call(this,c,"affine");if(a===null&&d===null){this.x=null;this.y=null;this.inf=true}else{this.x=new BN(a,16);this.y=new BN(d,16);if(b){this.x.forceRed(this.curve.red);this.y.forceRed(this.curve.red)}if(!this.x.red){this.x=this.x.toRed(this.curve.red)}if(!this.y.red){this.y=this.y.toRed(this.curve.red)}this.inf=false}}inherits(Point,Base.BasePoint);ShortCurve.prototype.point=function point(a,c,b){return new Point(this,a,c,b)};ShortCurve.prototype.pointFromJSON=function pointFromJSON(b,a){return Point.fromJSON(this,b,a)};Point.prototype._getBeta=function _getBeta(){if(!this.curve.endo){return}var b=this.precomputed;if(b&&b.beta){return b.beta}var a=this.curve.point(this.x.redMul(this.curve.endo.beta),this.y);if(b){var d=this.curve;var c=function(e){return d.point(e.x.redMul(d.endo.beta),e.y)};b.beta=a;a.precomputed={beta:null,naf:b.naf&&{wnd:b.naf.wnd,points:b.naf.points.map(c)},doubles:b.doubles&&{step:b.doubles.step,points:b.doubles.points.map(c)}}}return a};Point.prototype.toJSON=function toJSON(){if(!this.precomputed){return[this.x,this.y]}return[this.x,this.y,this.precomputed&&{doubles:this.precomputed.doubles&&{step:this.precomputed.doubles.step,points:this.precomputed.doubles.points.slice(1)},naf:this.precomputed.naf&&{wnd:this.precomputed.naf.wnd,points:this.precomputed.naf.points.slice(1)}}]};Point.fromJSON=function fromJSON(f,e,d){if(typeof e==="string"){e=JSON.parse(e)}var a=f.point(e[0],e[1],d);if(!e[2]){return a}function b(g){return f.point(g[0],g[1],d)}var c=e[2];a.precomputed={beta:null,doubles:c.doubles&&{step:c.doubles.step,points:[a].concat(c.doubles.points.map(b))},naf:c.naf&&{wnd:c.naf.wnd,points:[a].concat(c.naf.points.map(b))}};return a};Point.prototype.inspect=function inspect(){if(this.isInfinity()){return"<EC Point Infinity>"}return"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+">"};Point.prototype.isInfinity=function isInfinity(){return this.inf};Point.prototype.add=function add(b){if(this.inf){return b}if(b.inf){return this}if(this.eq(b)){return this.dbl()}if(this.neg().eq(b)){return this.curve.point(null,null)}if(this.x.cmp(b.x)===0){return this.curve.point(null,null)}var e=this.y.redSub(b.y);if(e.cmpn(0)!==0){e=e.redMul(this.x.redSub(b.x).redInvm())}var a=e.redSqr().redISub(this.x).redISub(b.x);var d=e.redMul(this.x.redSub(a)).redISub(this.y);return this.curve.point(a,d)};Point.prototype.dbl=function dbl(){if(this.inf){return this}var f=this.y.redAdd(this.y);if(f.cmpn(0)===0){return this.curve.point(null,null)}var d=this.curve.a;var e=this.x.redSqr();var g=f.redInvm();var i=e.redAdd(e).redIAdd(e).redIAdd(d).redMul(g);var b=i.redSqr().redISub(this.x.redAdd(this.x));var h=i.redMul(this.x.redSub(b)).redISub(this.y);return this.curve.point(b,h)};Point.prototype.getX=function getX(){return this.x.fromRed()};Point.prototype.getY=function getY(){return this.y.fromRed()};Point.prototype.mul=function mul(a){a=new BN(a,16);if(this._hasDoubles(a)){return this.curve._fixedNafMul(this,a)}else{if(this.curve.endo){return this.curve._endoWnafMulAdd([this],[a])}else{return this.curve._wnafMul(this,a)}}};Point.prototype.mulAdd=function mulAdd(e,c,d){var b=[this,c];var a=[e,d];if(this.curve.endo){return this.curve._endoWnafMulAdd(b,a)}else{return this.curve._wnafMulAdd(1,b,a,2)}};Point.prototype.jmulAdd=function jmulAdd(e,c,d){var b=[this,c];var a=[e,d];if(this.curve.endo){return this.curve._endoWnafMulAdd(b,a,true)}else{return this.curve._wnafMulAdd(1,b,a,2,true)}};Point.prototype.eq=function eq(a){return this===a||this.inf===a.inf&&(this.inf||this.x.cmp(a.x)===0&&this.y.cmp(a.y)===0)};Point.prototype.neg=function neg(a){if(this.inf){return this}var b=this.curve.point(this.x,this.y.redNeg());if(a&&this.precomputed){var d=this.precomputed;var c=function(e){return e.neg()};b.precomputed={naf:d.naf&&{wnd:d.naf.wnd,points:d.naf.points.map(c)},doubles:d.doubles&&{step:d.doubles.step,points:d.doubles.points.map(c)}}}return b};Point.prototype.toJ=function toJ(){if(this.inf){return this.curve.jpoint(null,null,null)}var a=this.curve.jpoint(this.x,this.y,this.curve.one);return a};function JPoint(c,a,d,b){Base.BasePoint.call(this,c,"jacobian");if(a===null&&d===null&&b===null){this.x=this.curve.one;this.y=this.curve.one;this.z=new BN(0)}else{this.x=new BN(a,16);this.y=new BN(d,16);this.z=new BN(b,16)}if(!this.x.red){this.x=this.x.toRed(this.curve.red)}if(!this.y.red){this.y=this.y.toRed(this.curve.red)}if(!this.z.red){this.z=this.z.toRed(this.curve.red)}this.zOne=this.z===this.curve.one}inherits(JPoint,Base.BasePoint);ShortCurve.prototype.jpoint=function jpoint(a,c,b){return new JPoint(this,a,c,b)};JPoint.prototype.toP=function toP(){if(this.isInfinity()){return this.curve.point(null,null)}var d=this.z.redInvm();var c=d.redSqr();var b=this.x.redMul(c);var a=this.y.redMul(c).redMul(d);return this.curve.point(b,a)};JPoint.prototype.neg=function neg(){return this.curve.jpoint(this.x,this.y.redNeg(),this.z)};JPoint.prototype.add=function add(b){if(this.isInfinity()){return b}if(b.isInfinity()){return this}var m=b.z.redSqr();var e=this.z.redSqr();var d=this.x.redMul(m);var c=b.x.redMul(e);var q=this.y.redMul(m.redMul(b.z));var n=b.y.redMul(e.redMul(this.z));var i=d.redSub(c);var a=q.redSub(n);if(i.cmpn(0)===0){if(a.cmpn(0)!==0){return this.curve.jpoint(null,null,null)}else{return this.dbl()}}var l=i.redSqr();var k=l.redMul(i);var o=d.redMul(l);var j=a.redSqr().redIAdd(k).redISub(o).redISub(o);var g=a.redMul(o.redISub(j)).redISub(q.redMul(k));var f=this.z.redMul(b.z).redMul(i);return this.curve.jpoint(j,g,f)};JPoint.prototype.mixedAdd=function mixedAdd(b){if(this.isInfinity()){return b.toJ()}if(b.isInfinity()){return this}var e=this.z.redSqr();var d=this.x;var c=b.x.redMul(e);var o=this.y;var m=b.y.redMul(e).redMul(this.z);var i=d.redSub(c);var a=o.redSub(m);if(i.cmpn(0)===0){if(a.cmpn(0)!==0){return this.curve.jpoint(null,null,null)}else{return this.dbl()}}var l=i.redSqr();var k=l.redMul(i);var n=d.redMul(l);var j=a.redSqr().redIAdd(k).redISub(n).redISub(n);var g=a.redMul(n.redISub(j)).redISub(o.redMul(k));var f=this.z.redMul(i);return this.curve.jpoint(j,g,f)};JPoint.prototype.dblp=function dblp(e){if(e===0){return this}if(this.isInfinity()){return this}if(!e){return this.dbl()}if(this.curve.zeroA||this.curve.threeA){var n=this;for(var s=0;s<e;s++){n=n.dbl()}return n}var w=this.curve.a;var f=this.curve.tinv;var m=this.x;var l=this.y;var k=this.z;var b=k.redSqr().redSqr();var q=l.redAdd(l);for(var s=0;s<e;s++){var h=m.redSqr();var p=q.redSqr();var o=p.redSqr();var u=h.redAdd(h).redIAdd(h).redIAdd(w.redMul(b));var j=m.redMul(p);var v=u.redSqr().redISub(j.redAdd(j));var g=j.redISub(v);var d=u.redMul(g);d=d.redIAdd(d).redISub(o);var t=q.redMul(k);if(s+1<e){b=b.redMul(o)}m=v;k=t;q=d}return this.curve.jpoint(m,q.redMul(f),k)};JPoint.prototype.dbl=function dbl(){if(this.isInfinity()){return this}if(this.curve.zeroA){return this._zeroDbl()}else{if(this.curve.threeA){return this._threeDbl()}else{return this._dbl()}}};JPoint.prototype._zeroDbl=function _zeroDbl(){var n;var l;var k;if(this.zOne){var g=this.x.redSqr();var r=this.y.redSqr();var j=r.redSqr();var z=this.x.redAdd(r).redSqr().redISub(g).redISub(j);z=z.redIAdd(z);var i=g.redAdd(g).redIAdd(g);var y=i.redSqr().redISub(z).redISub(z);var v=j.redIAdd(j);v=v.redIAdd(v);v=v.redIAdd(v);n=y;l=i.redMul(z.redISub(y)).redISub(v);k=this.y.redAdd(this.y)}else{var x=this.x.redSqr();var w=this.y.redSqr();var u=w.redSqr();var q=this.x.redAdd(w).redSqr().redISub(x).redISub(u);q=q.redIAdd(q);var p=x.redAdd(x).redIAdd(x);var o=p.redSqr();var h=u.redIAdd(u);h=h.redIAdd(h);h=h.redIAdd(h);n=o.redISub(q).redISub(q);l=p.redMul(q.redISub(n)).redISub(h);k=this.y.redMul(this.z);k=k.redIAdd(k)}return this.curve.jpoint(n,l,k)};JPoint.prototype._threeDbl=function _threeDbl(){var j;var i;var h;if(this.zOne){var a=this.x.redSqr();var k=this.y.redSqr();var g=k.redSqr();var r=this.x.redAdd(k).redSqr().redISub(a).redISub(g);r=r.redIAdd(r);var c=a.redAdd(a).redIAdd(a).redIAdd(this.curve.a);var p=c.redSqr().redISub(r).redISub(r);j=p;var l=g.redIAdd(g);l=l.redIAdd(l);l=l.redIAdd(l);i=c.redMul(r.redISub(p)).redISub(l);h=this.y.redAdd(this.y)}else{var o=this.z.redSqr();var d=this.y.redSqr();var n=this.x.redMul(d);var f=this.x.redSub(o).redMul(this.x.redAdd(o));f=f.redAdd(f).redIAdd(f);var e=n.redIAdd(n);e=e.redIAdd(e);var b=e.redAdd(e);j=f.redSqr().redISub(b);h=this.y.redAdd(this.z).redSqr().redISub(d).redISub(o);var q=d.redSqr();q=q.redIAdd(q);q=q.redIAdd(q);q=q.redIAdd(q);i=f.redMul(e.redISub(j)).redISub(q)}return this.curve.jpoint(j,i,h)};JPoint.prototype._dbl=function _dbl(){var n=this.curve.a;var q=this.x;var p=this.y;var o=this.z;var d=o.redSqr().redSqr();var b=q.redSqr();var m=p.redSqr();var l=b.redAdd(b).redIAdd(b).redIAdd(n.redMul(d));var e=q.redAdd(q);e=e.redIAdd(e);var k=e.redMul(m);var j=l.redSqr().redISub(k.redAdd(k));var i=k.redISub(j);var g=m.redSqr();g=g.redIAdd(g);g=g.redIAdd(g);g=g.redIAdd(g);var h=l.redMul(i).redISub(g);var f=p.redAdd(p).redMul(o);return this.curve.jpoint(j,h,f)};JPoint.prototype.trpl=function trpl(){if(!this.curve.zeroA){return this.dbl().add(this)}var a=this.x.redSqr();var l=this.y.redSqr();var b=this.z.redSqr();var f=l.redSqr();var c=a.redAdd(a).redIAdd(a);var d=c.redSqr();var k=this.x.redAdd(l).redSqr().redISub(a).redISub(f);k=k.redIAdd(k);k=k.redAdd(k).redIAdd(k);k=k.redISub(d);var i=k.redSqr();var p=f.redIAdd(f);p=p.redIAdd(p);p=p.redIAdd(p);p=p.redIAdd(p);var o=c.redIAdd(k).redSqr().redISub(d).redISub(i).redISub(p);var n=l.redMul(o);n=n.redIAdd(n);n=n.redIAdd(n);var j=this.x.redMul(i).redISub(n);j=j.redIAdd(j);j=j.redIAdd(j);var h=this.y.redMul(o.redMul(p.redISub(o)).redISub(k.redMul(i)));h=h.redIAdd(h);h=h.redIAdd(h);h=h.redIAdd(h);var g=this.z.redAdd(k).redSqr().redISub(b).redISub(i);return this.curve.jpoint(j,h,g)};JPoint.prototype.mul=function mul(b,a){b=new BN(b,a);return this.curve._wnafMul(this,b)};JPoint.prototype.eq=function eq(d){if(d.type==="affine"){return this.eq(d.toJ())}if(this===d){return true}var b=this.z.redSqr();var e=d.z.redSqr();if(this.x.redMul(e).redISub(d.x.redMul(b)).cmpn(0)!==0){return false}var a=b.redMul(this.z);var c=e.redMul(d.z);return this.y.redMul(c).redISub(d.y.redMul(a)).cmpn(0)===0};JPoint.prototype.eqXToP=function eqXToP(a){var c=this.z.redSqr();var e=a.toRed(this.curve.red).redMul(c);if(this.x.cmp(e)===0){return true}var d=a.clone();var b=this.curve.redN.redMul(c);for(;;){d.iadd(this.curve.n);if(d.cmp(this.curve.p)>=0){return false}e.redIAdd(b);if(this.x.cmp(e)===0){return true}}return false};JPoint.prototype.inspect=function inspect(){if(this.isInfinity()){return"<EC JPoint Infinity>"}return"<EC JPoint x: "+this.x.toString(16,2)+" y: "+this.y.toString(16,2)+" z: "+this.z.toString(16,2)+">"};JPoint.prototype.isInfinity=function isInfinity(){return this.z.cmpn(0)===0};