var inherits=require("inherits");var asn1=require("../../asn1");var base=asn1.base;var bignum=asn1.bignum;var der=asn1.constants.der;function DERDecoder(a){this.enc="der";this.name=a.name;this.entity=a;this.tree=new DERNode();this.tree._init(a.body)}module.exports=DERDecoder;DERDecoder.prototype.decode=function decode(b,a){if(!(b instanceof base.DecoderBuffer)){b=new base.DecoderBuffer(b,a)}return this.tree._decode(b,a)};function DERNode(a){base.Node.call(this,"der",a)}inherits(DERNode,base.Node);DERNode.prototype._peekTag=function peekTag(b,a,d){if(b.isEmpty()){return false}var c=b.save();var e=derDecodeTag(b,'Failed to peek tag: "'+a+'"');if(b.isError(e)){return e}b.restore(c);return e.tag===a||e.tagStr===a||(e.tagStr+"of")===a||d};DERNode.prototype._decodeTag=function decodeTag(c,b,f){var g=derDecodeTag(c,'Failed to decode tag of "'+b+'"');if(c.isError(g)){return g}var a=derDecodeLen(c,g.primitive,'Failed to get length of "'+b+'"');if(c.isError(a)){return a}if(!f&&g.tag!==b&&g.tagStr!==b&&g.tagStr+"of"!==b){return c.error('Failed to match tag: "'+b+'"')}if(g.primitive||a!==null){return c.skip(a,'Failed to match body of: "'+b+'"')}var e=c.save();var d=this._skipUntilEnd(c,'Failed to skip indefinite length body: "'+this.tag+'"');if(c.isError(d)){return d}a=c.offset-e.offset;c.restore(e);return c.skip(a,'Failed to match body of: "'+b+'"')};DERNode.prototype._skipUntilEnd=function skipUntilEnd(d,c){while(true){var b=derDecodeTag(d,c);if(d.isError(b)){return b}var a=derDecodeLen(d,b.primitive,c);if(d.isError(a)){return a}var e;if(b.primitive||a!==null){e=d.skip(a)}else{e=this._skipUntilEnd(d,c)}if(d.isError(e)){return e}if(b.tagStr==="end"){break}}};DERNode.prototype._decodeList=function decodeList(c,b,g,d){var a=[];while(!c.isEmpty()){var f=this._peekTag(c,"end");if(c.isError(f)){return f}var e=g.decode(c,"der",d);if(c.isError(e)&&f){break}a.push(e)}return a};DERNode.prototype._decodeStr=function decodeStr(d,b){if(b==="bitstr"){var a=d.readUInt8();if(d.isError(a)){return a}return{unused:a,data:d.raw()}}else{if(b==="bmpstr"){var f=d.raw();if(f.length%2===1){return d.error("Decoding of string type: bmpstr length mismatch")}var h="";for(var g=0;g<f.length/2;g++){h+=String.fromCharCode(f.readUInt16BE(g*2))}return h}else{if(b==="numstr"){var c=d.raw().toString("ascii");if(!this._isNumstr(c)){return d.error("Decoding of string type: numstr unsupported characters")}return c}else{if(b==="octstr"){return d.raw()}else{if(b==="objDesc"){return d.raw()}else{if(b==="printstr"){var e=d.raw().toString("ascii");if(!this._isPrintstr(e)){return d.error("Decoding of string type: printstr unsupported characters")}return e}else{if(/str$/.test(b)){return d.raw().toString()}else{return d.error("Decoding of string type: "+b+" unsupported")}}}}}}}};DERNode.prototype._decodeObjid=function decodeObjid(c,i,a){var j;var h=[];var e=0;while(!c.isEmpty()){var f=c.readUInt8();e<<=7;e|=f&127;if((f&128)===0){h.push(e);e=0}}if(f&128){h.push(e)}var g=(h[0]/40)|0;var b=h[0]%40;if(a){j=h}else{j=[g,b].concat(h.slice(1))}if(i){var d=i[j.join(" ")];if(d===undefined){d=i[j.join(".")]}if(d!==undefined){j=d}}return j};DERNode.prototype._decodeTime=function decodeTime(d,i){var f=d.raw().toString();if(i==="gentime"){var g=f.slice(0,4)|0;var a=f.slice(4,6)|0;var h=f.slice(6,8)|0;var b=f.slice(8,10)|0;var c=f.slice(10,12)|0;var e=f.slice(12,14)|0}else{if(i==="utctime"){var g=f.slice(0,2)|0;var a=f.slice(2,4)|0;var h=f.slice(4,6)|0;var b=f.slice(6,8)|0;var c=f.slice(8,10)|0;var e=f.slice(10,12)|0;if(g<70){g=2000+g}else{g=1900+g}}else{return d.error("Decoding "+i+" time is not supported yet")}}return Date.UTC(g,a-1,h,b,c,e,0)};DERNode.prototype._decodeNull=function decodeNull(a){return null};DERNode.prototype._decodeBool=function decodeBool(a){var b=a.readUInt8();if(a.isError(b)){return b}else{return b!==0}};DERNode.prototype._decodeInt=function decodeInt(a,b){var c=a.raw();var d=new bignum(c);if(b){d=b[d.toString(10)]||d}return d};DERNode.prototype._use=function use(a,b){if(typeof a==="function"){a=a(b)}return a._getDecoder("der").tree};function derDecodeTag(f,e){var b=f.readUInt8(e);if(f.isError(b)){return b}var d=der.tagClass[b>>6];var c=(b&32)===0;if((b&31)===31){var a=b;b=0;while((a&128)===128){a=f.readUInt8(e);if(f.isError(a)){return a}b<<=7;b|=a&127}}else{b&=31}var g=der.tag[b];return{cls:d,primitive:c,tag:b,tagStr:g}}function derDecodeLen(f,c,b){var a=f.readUInt8(b);if(f.isError(a)){return a}if(!c&&a===128){return null}if((a&128)===0){return a}var e=a&127;if(e>4){return f.error("length octect is too long")}a=0;for(var g=0;g<e;g++){a<<=8;var d=f.readUInt8(b);if(f.isError(d)){return d}a|=d}return a};