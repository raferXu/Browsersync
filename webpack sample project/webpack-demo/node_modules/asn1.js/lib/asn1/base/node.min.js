var Reporter=require("../base").Reporter;var EncoderBuffer=require("../base").EncoderBuffer;var DecoderBuffer=require("../base").DecoderBuffer;var assert=require("minimalistic-assert");var tags=["seq","seqof","set","setof","objid","bool","gentime","utctime","null_","enum","int","objDesc","bitstr","bmpstr","charstr","genstr","graphstr","ia5str","iso646str","numstr","octstr","printstr","t61str","unistr","utf8str","videostr"];var methods=["key","obj","use","optional","explicit","implicit","def","choice","any","contains"].concat(tags);var overrided=["_peekTag","_decodeTag","_use","_decodeStr","_decodeObjid","_decodeTime","_decodeNull","_decodeInt","_decodeBool","_decodeList","_encodeComposite","_encodeStr","_encodeObjid","_encodeTime","_encodeNull","_encodeInt","_encodeBool"];function Node(a,b){var c={};this._baseState=c;c.enc=a;c.parent=b||null;c.children=null;c.tag=null;c.args=null;c.reverseArgs=null;c.choice=null;c.optional=false;c.any=false;c.obj=false;c.use=null;c.useDecoder=null;c.key=null;c["default"]=null;c.explicit=null;c.implicit=null;c.contains=null;if(!c.parent){c.children=[];this._wrap()}}module.exports=Node;var stateProps=["enc","parent","children","tag","args","reverseArgs","choice","optional","any","obj","use","alteredUse","key","default","explicit","implicit","contains"];Node.prototype.clone=function clone(){var b=this._baseState;var c={};stateProps.forEach(function(d){c[d]=b[d]});var a=new this.constructor(c.parent);a._baseState=c;return a};Node.prototype._wrap=function wrap(){var a=this._baseState;methods.forEach(function(c){this[c]=function b(){var d=new this.constructor(this);a.children.push(d);return d[c].apply(d,arguments)}},this)};Node.prototype._init=function init(a){var b=this._baseState;assert(b.parent===null);a.call(this);b.children=b.children.filter(function(c){return c._baseState.parent===this},this);assert.equal(b.children.length,1,"Root node can have only one child")};Node.prototype._useArgs=function useArgs(a){var c=this._baseState;var b=a.filter(function(d){return d instanceof this.constructor},this);a=a.filter(function(d){return !(d instanceof this.constructor)},this);if(b.length!==0){assert(c.children===null);c.children=b;b.forEach(function(d){d._baseState.parent=this},this)}if(a.length!==0){assert(c.args===null);c.args=a;c.reverseArgs=a.map(function(d){if(typeof d!=="object"||d.constructor!==Object){return d}var e={};Object.keys(d).forEach(function(f){if(f==(f|0)){f|=0}var g=d[f];e[g]=f});return e})}};overrided.forEach(function(b){Node.prototype[b]=function a(){var c=this._baseState;throw new Error(b+" not implemented for encoding: "+c.enc)}});tags.forEach(function(a){Node.prototype[a]=function b(){var d=this._baseState;var c=Array.prototype.slice.call(arguments);assert(d.tag===null);d.tag=a;this._useArgs(c);return this}});Node.prototype.use=function use(a){assert(a);var b=this._baseState;assert(b.use===null);b.use=a;return this};Node.prototype.optional=function optional(){var a=this._baseState;a.optional=true;return this};Node.prototype.def=function def(b){var a=this._baseState;assert(a["default"]===null);a["default"]=b;a.optional=true;return this};Node.prototype.explicit=function explicit(a){var b=this._baseState;assert(b.explicit===null&&b.implicit===null);b.explicit=a;return this};Node.prototype.implicit=function implicit(a){var b=this._baseState;assert(b.explicit===null&&b.implicit===null);b.implicit=a;return this};Node.prototype.obj=function obj(){var b=this._baseState;var a=Array.prototype.slice.call(arguments);b.obj=true;if(a.length!==0){this._useArgs(a)}return this};Node.prototype.key=function key(b){var a=this._baseState;assert(a.key===null);a.key=b;return this};Node.prototype.any=function any(){var a=this._baseState;a.any=true;return this};Node.prototype.choice=function choice(b){var a=this._baseState;assert(a.choice===null);a.choice=b;this._useArgs(Object.keys(b).map(function(c){return b[c]}));return this};Node.prototype.contains=function contains(a){var b=this._baseState;assert(b.use===null);b.contains=a;return this};Node.prototype._decode=function decode(l,n){var a=this._baseState;if(a.parent===null){return l.wrapResult(a.children[0]._decode(l,n))}var o=a["default"];var g=true;var m=null;if(a.key!==null){m=l.enterKey(a.key)}if(a.optional){var p=null;if(a.explicit!==null){p=a.explicit}else{if(a.implicit!==null){p=a.implicit}else{if(a.tag!==null){p=a.tag}}}if(p===null&&!a.any){var k=l.save();try{if(a.choice===null){this._decodeGeneric(a.tag,l,n)}else{this._decodeChoice(l,n)}g=true}catch(j){g=false}l.restore(k)}else{g=this._peekTag(l,p,a.any);if(l.isError(g)){return g}}}var h;if(a.obj&&g){h=l.enterObject()}if(g){if(a.explicit!==null){var i=this._decodeTag(l,a.explicit);if(l.isError(i)){return i}l=i}var b=l.offset;if(a.use===null&&a.choice===null){if(a.any){var k=l.save()}var f=this._decodeTag(l,a.implicit!==null?a.implicit:a.tag,a.any);if(l.isError(f)){return f}if(a.any){o=l.raw(k)}else{l=f}}if(n&&n.track&&a.tag!==null){n.track(l.path(),b,l.length,"tagged")}if(n&&n.track&&a.tag!==null){n.track(l.path(),l.offset,l.length,"content")}if(a.any){o=o}else{if(a.choice===null){o=this._decodeGeneric(a.tag,l,n)}else{o=this._decodeChoice(l,n)}}if(l.isError(o)){return o}if(!a.any&&a.choice===null&&a.children!==null){a.children.forEach(function c(e){e._decode(l,n)})}if(a.contains&&(a.tag==="octstr"||a.tag==="bitstr")){var d=new DecoderBuffer(o);o=this._getUse(a.contains,l._reporterState.obj)._decode(d,n)}}if(a.obj&&g){o=l.leaveObject(h)}if(a.key!==null&&(o!==null||g===true)){l.leaveKey(m,a.key,o)}else{if(m!==null){l.exitKey(m)}}return o};Node.prototype._decodeGeneric=function decodeGeneric(a,b,c){var d=this._baseState;if(a==="seq"||a==="set"){return null}if(a==="seqof"||a==="setof"){return this._decodeList(b,a,d.args[0],c)}else{if(/str$/.test(a)){return this._decodeStr(b,a,c)}else{if(a==="objid"&&d.args){return this._decodeObjid(b,d.args[0],d.args[1],c)}else{if(a==="objid"){return this._decodeObjid(b,null,null,c)}else{if(a==="gentime"||a==="utctime"){return this._decodeTime(b,a,c)}else{if(a==="null_"){return this._decodeNull(b,c)}else{if(a==="bool"){return this._decodeBool(b,c)}else{if(a==="objDesc"){return this._decodeStr(b,a,c)}else{if(a==="int"||a==="enum"){return this._decodeInt(b,d.args&&d.args[0],c)}}}}}}}}}if(d.use!==null){return this._getUse(d.use,b._reporterState.obj)._decode(b,c)}else{return b.error("unknown tag: "+a)}};Node.prototype._getUse=function _getUse(a,c){var b=this._baseState;b.useDecoder=this._use(a,c);assert(b.useDecoder._baseState.parent===null);b.useDecoder=b.useDecoder._baseState.children[0];if(b.implicit!==b.useDecoder._baseState.implicit){b.useDecoder=b.useDecoder.clone();b.useDecoder._baseState.implicit=b.implicit}return b.useDecoder};Node.prototype._decodeChoice=function decodeChoice(b,d){var e=this._baseState;var a=null;var c=false;Object.keys(e.choice).some(function(f){var h=b.save();var g=e.choice[f];try{var i=g._decode(b,d);if(b.isError(i)){return false}a={type:f,value:i};c=true}catch(j){b.restore(h);return false}return true},this);if(!c){return b.error("Choice not matched")}return a};Node.prototype._createEncoderBuffer=function createEncoderBuffer(a){return new EncoderBuffer(a,this.reporter)};Node.prototype._encode=function encode(e,b,c){var d=this._baseState;if(d["default"]!==null&&d["default"]===e){return}var a=this._encodeValue(e,b,c);if(a===undefined){return}if(this._skipDefault(a,b,c)){return}return a};Node.prototype._encodeValue=function encode(d,c,g){var a=this._baseState;if(a.parent===null){return a.children[0]._encode(d,c||new Reporter())}var j=null;this.reporter=c;if(a.optional&&d===undefined){if(a["default"]!==null){d=a["default"]}else{return}}var f=null;var e=false;if(a.any){j=this._createEncoderBuffer(d)}else{if(a.choice){j=this._encodeChoice(d,c)}else{if(a.contains){f=this._getUse(a.contains,g)._encode(d,c);e=true}else{if(a.children){f=a.children.map(function(m){if(m._baseState.tag==="null_"){return m._encode(null,c,d)}if(m._baseState.key===null){return c.error("Child should have a key")}var l=c.enterKey(m._baseState.key);if(typeof d!=="object"){return c.error("Child expected, but input is not object")}var k=m._encode(d[m._baseState.key],c,d);c.leaveKey(l);return k},this).filter(function(k){return k});f=this._createEncoderBuffer(f)}else{if(a.tag==="seqof"||a.tag==="setof"){if(!(a.args&&a.args.length===1)){return c.error("Too many args for : "+a.tag)}if(!Array.isArray(d)){return c.error("seqof/setof, but data is not Array")}var b=this.clone();b._baseState.implicit=null;f=this._createEncoderBuffer(d.map(function(k){var l=this._baseState;return this._getUse(l.args[0],d)._encode(k,c)},b))}else{if(a.use!==null){j=this._getUse(a.use,g)._encode(d,c)}else{f=this._encodePrimitive(a.tag,d);e=true}}}}}}var j;if(!a.any&&a.choice===null){var i=a.implicit!==null?a.implicit:a.tag;var h=a.implicit===null?"universal":"context";if(i===null){if(a.use===null){c.error("Tag could be ommited only for .use()")}}else{if(a.use===null){j=this._encodeComposite(i,e,h,f)}}}if(a.explicit!==null){j=this._encodeComposite(a.explicit,false,"context",j)}return j};Node.prototype._encodeChoice=function encodeChoice(d,a){var c=this._baseState;var b=c.choice[d.type];if(!b){assert(false,d.type+" not found in "+JSON.stringify(Object.keys(c.choice)))}return b._encode(d.value,a)};Node.prototype._encodePrimitive=function encodePrimitive(a,c){var b=this._baseState;if(/str$/.test(a)){return this._encodeStr(c,a)}else{if(a==="objid"&&b.args){return this._encodeObjid(c,b.reverseArgs[0],b.args[1])}else{if(a==="objid"){return this._encodeObjid(c,null,null)}else{if(a==="gentime"||a==="utctime"){return this._encodeTime(c,a)}else{if(a==="null_"){return this._encodeNull()}else{if(a==="int"||a==="enum"){return this._encodeInt(c,b.args&&b.reverseArgs[0])}else{if(a==="bool"){return this._encodeBool(c)}else{if(a==="objDesc"){return this._encodeStr(c,a)}else{throw new Error("Unsupported tag: "+a)}}}}}}}}};Node.prototype._isNumstr=function isNumstr(a){return/^[0-9 ]*$/.test(a)};Node.prototype._isPrintstr=function isPrintstr(a){return/^[A-Za-z0-9 '\(\)\+,\-\.\/:=\?]*$/.test(a)};