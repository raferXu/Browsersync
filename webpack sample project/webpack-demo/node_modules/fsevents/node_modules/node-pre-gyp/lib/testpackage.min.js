"use strict";module.exports=exports=testpackage;exports.usage="Tests that the staged package is valid";var fs=require("fs");var path=require("path");var log=require("npmlog");var existsAsync=fs.exists||path.exists;var versioning=require("./util/versioning.js");var testbinary=require("./testbinary.js");var read=require("fs").createReadStream;var zlib=require("zlib");function testpackage(c,a,f){var d=JSON.parse(fs.readFileSync("./package.json"));var e=versioning.evaluate(d,c.opts);var b=e.staged_tarball;existsAsync(b,function(i){if(!i){return f(new Error("Cannot test package because "+b+" missing: run `node-pre-gyp package` first"))}var k=e.module_path;var h=zlib.createGunzip();var j=require("tar").Extract({path:k,strip:1});function g(l){l.props.mode|=(l.props.mode>>>2)&parseInt("0111",8);log.info("install","unpacking "+l.path)}h.on("error",f);j.on("error",f);j.on("entry",g);j.on("end",function(l){if(l){return f(l)}testbinary(c,a,function(m){if(m){return f(m)}else{console.log("["+d.name+"] Package appears valid");return f()}})});read(b).pipe(h).pipe(j)})};