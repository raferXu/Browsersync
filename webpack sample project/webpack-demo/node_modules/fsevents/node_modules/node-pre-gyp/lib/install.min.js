"use strict";module.exports=exports=install;exports.usage="Attempts to install pre-built binary for module";var fs=require("fs");var path=require("path");var zlib=require("zlib");var log=require("npmlog");var existsAsync=fs.exists||path.exists;var versioning=require("./util/versioning.js");var npgVersion="unknown";try{var ownPackageJSON=fs.readFileSync(path.join(__dirname,"..","package.json"),"utf8");npgVersion=JSON.parse(ownPackageJSON).version}catch(e){}function download(f,d,i){log.http("GET",f);var c=null;var b=process.env.npm_config_user_agent||"node "+process.version;var a={uri:f.replace("+","%2B"),headers:{"User-Agent":"node-pre-gyp (v"+npgVersion+", "+b+")"}};if(d.cafile){try{a.ca=fs.readFileSync(d.cafile)}catch(g){return i(g)}}else{if(d.ca){a.ca=d.ca}}var h=d.proxy||process.env.http_proxy||process.env.HTTP_PROXY||process.env.npm_config_proxy;if(h){if(/^https?:\/\//i.test(h)){log.verbose("download",'using proxy url: "%s"',h);a.proxy=h}else{log.warn("download",'ignoring invalid "proxy" config setting: "%s"',h)}}try{c=require("request")(a)}catch(g){return i(g)}if(c){c.on("response",function(j){log.http(j.statusCode,f)})}return i(null,c)}function place_binary(d,c,a,b){download(d,a,function(k,j){if(k){return b(k)}if(!j){return b(new Error("empty req"))}var m=false;var i=0;var g=zlib.createGunzip();var l=require("tar").Extract({path:c,strip:1});function h(n){if(n){return b(n)}if(m){return b(new Error("bad download"))}if(i===0){return b(new Error("There was a fatal problem while downloading/extracting the tarball"))}log.info("tarball","done parsing tarball");b()}function f(n){n.props.mode|=(n.props.mode>>>2)&parseInt("0111",8);log.info("install","unpacking "+n.path);i++}g.on("error",b);l.on("entry",f);l.on("error",b);l.on("end",h);j.on("error",function(n){m=true;return b(n)});j.on("close",function(){if(i===0){return b(new Error("Connection closed while downloading tarball file"))}});j.on("response",function(n){if(n.statusCode!==200){m=true;var o=new Error(n.statusCode+" status code downloading tarball "+d);o.statusCode=n.statusCode;return b(o)}j.pipe(g).pipe(l)})})}function do_build(b,a,c){b.todo.push({name:"build",args:["rebuild"]});process.nextTick(c)}function print_fallback_error(f,d,c){var a=" (falling back to source compile with node-gyp)";var b="Pre-built binaries not found for "+c.name+"@"+c.version;b+=" and "+d.runtime+"@"+(d.target||process.versions.node)+" ("+d.node_abi+" ABI)";b+=a;log.error("Tried to download("+f.statusCode+"): "+d.hosted_tarball);log.error(b);log.http(f.message)}function install(f,h,o){var p=JSON.parse(fs.readFileSync("./package.json"));var b=f.opts["build-from-source"]||f.opts.build_from_source;var j=f.opts["update-binary"]||f.opts.update_binary;var q=b===p.name||(b===true||b==="true");if(q){log.info("build","requesting source compile");return do_build(f,h,o)}else{var c=f.opts["fallback-to-build"]||f.opts.fallback_to_build;var n=c===p.name||(c===true||c==="true");if(process.env.npm_config_argv){var i=JSON.parse(process.env.npm_config_argv).cooked;var g=i.indexOf("--fallback-to-build");if(g>-1&&i.length>g&&i[g+1]=="false"){n=false;log.info("install","Build fallback disabled via npm flag: --fallback-to-build=false")}}var a;try{a=versioning.evaluate(p,f.opts)}catch(d){return o(d)}a.ca=f.opts.ca;a.cafile=f.opts.cafile;var m=a.hosted_tarball;var l=a.module_path;var k=path.join(l,a.module_name+".node");if(existsAsync(k,function(r){if(r&&!j){console.log("["+p.name+'] Success: "'+k+'" already installed');console.log("Pass --update-binary to reinstall or --build-from-source to recompile");return o()}else{if(!j){log.info("check",'checked for "'+k+'" (not found)')}place_binary(m,l,a,function(s){if(s&&n){print_fallback_error(s,a,p);return do_build(f,h,o)}else{if(s){return o(s)}else{console.log("["+p.name+'] Success: "'+k+'" is installed via remote');return o()}}})}})){}}};