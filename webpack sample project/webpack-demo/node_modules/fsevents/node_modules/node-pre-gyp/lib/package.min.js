"use strict";module.exports=exports=_package;exports.usage="Packs binary (and enclosing directory) into locally staged tarball";var fs=require("fs");var path=require("path");var log=require("npmlog");var versioning=require("./util/versioning.js");var write=require("fs").createWriteStream;var existsAsync=fs.exists||path.exists;var mkdirp=require("mkdirp");function _package(b,a,h){var e=require("tar-pack").pack;var d=JSON.parse(fs.readFileSync("./package.json"));var f=versioning.evaluate(d,b.opts);var g=f.module_path;var c=path.join(g,f.module_name+".node");existsAsync(c,function(k){if(!k){return h(new Error("Cannot package because "+c+" missing: run `node-pre-gyp rebuild` first"))}var j=f.staged_tarball;var i=function(l){log.info("package","packing "+l.path);return true};mkdirp(path.dirname(j),function(l){if(l){throw l}e(g,{filter:i}).pipe(write(j)).on("error",function(m){if(m){console.error("["+d.name+"] "+m.message)}return h(m)}).on("close",function(){log.info("package",'Binary staged at "'+j+'"');return h()})})})};