module.exports=ForeverAgent;ForeverAgent.SSL=ForeverAgentSSL;var util=require("util"),Agent=require("http").Agent,net=require("net"),tls=require("tls"),AgentSSL=require("https").Agent;function getConnectionName(c,a){var b="";if(typeof c==="string"){b=c+":"+a}else{b=c.host+":"+c.port+":"+(c.localAddress?(c.localAddress+":"):":")}return b}function ForeverAgent(b){var a=this;a.options=b||{};a.requests={};a.sockets={};a.freeSockets={};a.maxSockets=a.options.maxSockets||Agent.defaultMaxSockets;a.minSockets=a.options.minSockets||ForeverAgent.defaultMinSockets;a.on("free",function(c,g,d){var f=getConnectionName(g,d);if(a.requests[f]&&a.requests[f].length){a.requests[f].shift().onSocket(c)}else{if(a.sockets[f].length<a.minSockets){if(!a.freeSockets[f]){a.freeSockets[f]=[]}a.freeSockets[f].push(c);var e=function(){c.destroy()};c._onIdleError=e;c.on("error",e)}else{c.destroy()}}})}util.inherits(ForeverAgent,Agent);ForeverAgent.defaultMinSockets=5;ForeverAgent.prototype.createConnection=net.createConnection;ForeverAgent.prototype.addRequestNoreuse=Agent.prototype.addRequest;ForeverAgent.prototype.addRequest=function(e,d,a){var c=getConnectionName(d,a);if(typeof d!=="string"){var b=d;a=b.port;d=b.host}if(this.freeSockets[c]&&this.freeSockets[c].length>0&&!e.useChunkedEncodingByDefault){var f=this.freeSockets[c].pop();f.removeListener("error",f._onIdleError);delete f._onIdleError;e._reusedSocket=true;e.onSocket(f)}else{this.addRequestNoreuse(e,d,a)}};ForeverAgent.prototype.removeSocket=function(d,c,e,a){if(this.sockets[c]){var b=this.sockets[c].indexOf(d);if(b!==-1){this.sockets[c].splice(b,1)}}else{if(this.sockets[c]&&this.sockets[c].length===0){delete this.sockets[c];delete this.requests[c]}}if(this.freeSockets[c]){var b=this.freeSockets[c].indexOf(d);if(b!==-1){this.freeSockets[c].splice(b,1);if(this.freeSockets[c].length===0){delete this.freeSockets[c]}}}if(this.requests[c]&&this.requests[c].length){this.createSocket(c,e,a).emit("free")}};function ForeverAgentSSL(a){ForeverAgent.call(this,a)}util.inherits(ForeverAgentSSL,ForeverAgent);ForeverAgentSSL.prototype.createConnection=createConnectionSSL;ForeverAgentSSL.prototype.addRequestNoreuse=AgentSSL.prototype.addRequest;function createConnectionSSL(a,c,b){if(typeof a==="object"){b=a}else{if(typeof c==="object"){b=c}else{if(typeof b==="object"){b=b}else{b={}}}}if(typeof a==="number"){b.port=a}if(typeof c==="string"){b.host=c}return tls.connect(b)};