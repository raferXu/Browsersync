var Minimatch=require("minimatch").Minimatch,fstream=require("fstream"),DirReader=fstream.DirReader,inherits=require("inherits"),path=require("path"),fs=require("fs");module.exports=IgnoreReader;inherits(IgnoreReader,DirReader);function IgnoreReader(a){if(!(this instanceof IgnoreReader)){return new IgnoreReader(a)}if(typeof a==="string"){a={path:path.resolve(a)}}a.type="Directory";a.Directory=true;if(!a.ignoreFiles){a.ignoreFiles=[".ignore"]}this.ignoreFiles=a.ignoreFiles;this.ignoreRules=null;if(a.sort){this._sort=a.sort==="alpha"?alphasort:a.sort;a.sort=null}this.on("entries",function(){var b=this.entries.some(this.isIgnoreFile,this);if(!b){return this.filterEntries()}this.addIgnoreFiles()});this.on("_entryStat",function(d,c){var b=d.basename;if(!this.applyIgnores(d.basename,d.type==="Directory",d)){d.abort()}}.bind(this));DirReader.call(this,a)}IgnoreReader.prototype.addIgnoreFiles=function(){if(this._paused){this.once("resume",this.addIgnoreFiles);return}if(this._ignoreFilesAdded){return}this._ignoreFilesAdded=true;var a=this.entries.filter(this.isIgnoreFile,this),b=a.length,d=null;if(!b){return}this.pause();var c=function(e){if(d){return}if(e){return this.emit("error",d=e)}if(--b===0){this.filterEntries();this.resume()}else{this.addIgnoreFile(a[a.length-b],c)}}.bind(this);this.addIgnoreFile(a[0],c)};IgnoreReader.prototype.isIgnoreFile=function(a){return a!=="."&&a!==".."&&-1!==this.ignoreFiles.indexOf(a)};IgnoreReader.prototype.getChildProps=function(b){var a=DirReader.prototype.getChildProps.call(this,b);a.ignoreFiles=this.ignoreFiles;if(b.isDirectory()){a.type=this.constructor}return a};IgnoreReader.prototype.addIgnoreFile=function(c,a){var b=path.resolve(this.path,c);fs.readFile(b,function(f,d){if(f){return a(f)}this.emit("ignoreFile",c,d);var e=this.readRules(d,c);this.addIgnoreRules(e,c);a()}.bind(this))};IgnoreReader.prototype.readRules=function(a,b){return a.toString().split(/\r?\n/)};IgnoreReader.prototype.addIgnoreRules=function(d,b){d=d.filter(function(e){e=e.trim();return e&&!e.match(/^#/)});if(!d.length){return}var a={matchBase:true,dot:true,flipNegate:true},c=d.map(function(f){var e=new Minimatch(f,a);e.ignoreFile=b;return e});if(!this.ignoreRules){this.ignoreRules=[]}this.ignoreRules.push.apply(this.ignoreRules,c)};IgnoreReader.prototype.filterEntries=function(){this.entries=this.entries.filter(function(a){return this.applyIgnores(a)||this.applyIgnores(a,true)},this)};IgnoreReader.prototype.applyIgnores=function(b,a,e){var d=true;if(this.parent&&this.parent.applyIgnores){var c=this.basename+"/"+b;d=this.parent.applyIgnores(c,a)}if(!this.ignoreRules){return d}this.ignoreRules.forEach(function(g){if(g.negate&&d||!g.negate&&!d){return}var f=g.match("/"+b);if(!f){f=g.match(b)}if(!f&&a){f=g.match("/"+b+"/")||g.match(b+"/")}if(!f&&g.negate&&a){f=g.match("/"+b,true)||g.match(b,true)}if(f){d=g.negate}},this);return d};IgnoreReader.prototype.sort=function(e,d){var f=this.ignoreFiles.indexOf(e)!==-1,c=this.ignoreFiles.indexOf(d)!==-1;if(f&&!c){return -1}if(c&&!f){return 1}return this._sort(e,d)};IgnoreReader.prototype._sort=function(d,c){return 0};function alphasort(d,c){return d===c?0:d.toLowerCase()>c.toLowerCase()?1:d.toLowerCase()<c.toLowerCase()?-1:d>c?1:-1};