"use strict";var http=require("http"),https=require("https"),url=require("url"),util=require("util"),stream=require("stream"),zlib=require("zlib"),hawk=require("hawk"),aws2=require("aws-sign2"),aws4=require("aws4"),httpSignature=require("http-signature"),mime=require("mime-types"),stringstream=require("stringstream"),caseless=require("caseless"),ForeverAgent=require("forever-agent"),FormData=require("form-data"),extend=require("extend"),isstream=require("isstream"),isTypedArray=require("is-typedarray").strict,helpers=require("./lib/helpers"),cookies=require("./lib/cookies"),getProxyFromURI=require("./lib/getProxyFromURI"),Querystring=require("./lib/querystring").Querystring,Har=require("./lib/har").Har,Auth=require("./lib/auth").Auth,OAuth=require("./lib/oauth").OAuth,Multipart=require("./lib/multipart").Multipart,Redirect=require("./lib/redirect").Redirect,Tunnel=require("./lib/tunnel").Tunnel,now=require("performance-now"),Buffer=require("safe-buffer").Buffer;var safeStringify=helpers.safeStringify,isReadStream=helpers.isReadStream,toBase64=helpers.toBase64,defer=helpers.defer,copy=helpers.copy,version=helpers.version,globalCookieJar=cookies.jar();var globalPool={};function filterForNonReserved(a,c){var b={};for(var d in c){var e=(a.indexOf(d)===-1);if(e){b[d]=c[d]}}return b}function filterOutReservedFunctions(a,c){var b={};for(var d in c){var f=!(a.indexOf(d)===-1);var e=(typeof c[d]==="function");if(!(f&&e)){b[d]=c[d]}}return b}function requestToJSON(){var a=this;return{uri:a.uri,method:a.method,headers:a.headers}}function responseToJSON(){var a=this;return{statusCode:a.statusCode,body:a.body,headers:a.headers,request:requestToJSON.call(a.request)}}function Request(c){var b=this;if(c.har){b._har=new Har(b);c=b._har.options(c)}stream.Stream.call(b);var a=Object.keys(Request.prototype);var d=filterForNonReserved(a,c);extend(b,d);c=filterOutReservedFunctions(a,c);b.readable=true;b.writable=true;if(c.method){b.explicitMethod=true}b._qs=new Querystring(b);b._auth=new Auth(b);b._oauth=new OAuth(b);b._multipart=new Multipart(b);b._redirect=new Redirect(b);b._tunnel=new Tunnel(b);b.init(c)}util.inherits(Request,stream.Stream);Request.debug=process.env.NODE_DEBUG&&/\brequest\b/.test(process.env.NODE_DEBUG);function debug(){if(Request.debug){console.error("REQUEST %s",util.format.apply(util,arguments))}}Request.prototype.debug=debug;Request.prototype.init=function(c){var n=this;if(!c){c={}}n.headers=n.headers?copy(n.headers):{};for(var l in n.headers){if(typeof n.headers[l]==="undefined"){delete n.headers[l]}}caseless.httpify(n,n.headers);if(!n.method){n.method=c.method||"GET"}if(!n.localAddress){n.localAddress=c.localAddress}n._qs.init(c);debug(c);if(!n.pool&&n.pool!==false){n.pool=globalPool}n.dests=n.dests||[];n.__isRequestRequest=true;if(!n._callback&&n.callback){n._callback=n.callback;n.callback=function(){if(n._callbackCalled){return}n._callbackCalled=true;n._callback.apply(n,arguments)};n.on("error",n.callback.bind());n.on("complete",n.callback.bind(n,null))}if(!n.uri&&n.url){n.uri=n.url;delete n.url}if(n.baseUrl){if(typeof n.baseUrl!=="string"){return n.emit("error",new Error("options.baseUrl must be a string"))}if(typeof n.uri!=="string"){return n.emit("error",new Error("options.uri must be a string when using options.baseUrl"))}if(n.uri.indexOf("//")===0||n.uri.indexOf("://")!==-1){return n.emit("error",new Error("options.uri must be a path when using options.baseUrl"))}var a=n.baseUrl.lastIndexOf("/")===n.baseUrl.length-1;var p=n.uri.indexOf("/")===0;if(a&&p){n.uri=n.baseUrl+n.uri.slice(1)}else{if(a||p){n.uri=n.baseUrl+n.uri}else{if(n.uri===""){n.uri=n.baseUrl}else{n.uri=n.baseUrl+"/"+n.uri}}}delete n.baseUrl}if(!n.uri){return n.emit("error",new Error("options.uri is a required argument"))}if(typeof n.uri==="string"){n.uri=url.parse(n.uri)}if(!n.uri.href){n.uri.href=url.format(n.uri)}if(n.uri.protocol==="unix:"){return n.emit("error",new Error("`unix://` URL scheme is no longer supported. Please use the format `http://unix:SOCKET:PATH`"))}if(n.uri.host==="unix"){n.enableUnixSocket()}if(n.strictSSL===false){n.rejectUnauthorized=false}if(!n.uri.pathname){n.uri.pathname="/"}if(!(n.uri.host||(n.uri.hostname&&n.uri.port))&&!n.uri.isUnix){var d=url.format(n.uri);var h='Invalid URI "'+d+'"';if(Object.keys(c).length===0){h+=". This can be caused by a crappy redirection."}n.abort();return n.emit("error",new Error(h))}if(!n.hasOwnProperty("proxy")){n.proxy=getProxyFromURI(n.uri)}n.tunnel=n._tunnel.isEnabled();if(n.proxy){n._tunnel.setup(c)}n._redirect.onRequest(c);n.setHost=false;if(!n.hasHeader("host")){var q=n.originalHostHeaderName||"host";n.setHeader(q,n.uri.host);n.setHost=true}n.jar(n._jar||c.jar);if(!n.uri.port){if(n.uri.protocol==="http:"){n.uri.port=80}else{if(n.uri.protocol==="https:"){n.uri.port=443}}}if(n.proxy&&!n.tunnel){n.port=n.proxy.port;n.host=n.proxy.hostname}else{n.port=n.uri.port;n.host=n.uri.hostname}if(c.form){n.form(c.form)}if(c.formData){var r=c.formData;var x=n.form();var o=function(j,v){if(v&&v.hasOwnProperty("value")&&v.hasOwnProperty("options")){x.append(j,v.value,v.options)}else{x.append(j,v)}};for(var w in r){if(r.hasOwnProperty(w)){var f=r[w];if(f instanceof Array){for(var s=0;s<f.length;s++){o(w,f[s])}}else{o(w,f)}}}}if(c.qs){n.qs(c.qs)}if(n.uri.path){n.path=n.uri.path}else{n.path=n.uri.pathname+(n.uri.search||"")}if(n.path.length===0){n.path="/"}if(c.aws){n.aws(c.aws)}if(c.hawk){n.hawk(c.hawk)}if(c.httpSignature){n.httpSignature(c.httpSignature)}if(c.auth){if(Object.prototype.hasOwnProperty.call(c.auth,"username")){c.auth.user=c.auth.username}if(Object.prototype.hasOwnProperty.call(c.auth,"password")){c.auth.pass=c.auth.password}n.auth(c.auth.user,c.auth.pass,c.auth.sendImmediately,c.auth.bearer)}if(n.gzip&&!n.hasHeader("accept-encoding")){n.setHeader("accept-encoding","gzip, deflate")}if(n.uri.auth&&!n.hasHeader("authorization")){var t=n.uri.auth.split(":").map(function(j){return n._qs.unescape(j)});n.auth(t[0],t.slice(1).join(":"),true)}if(!n.tunnel&&n.proxy&&n.proxy.auth&&!n.hasHeader("proxy-authorization")){var e=n.proxy.auth.split(":").map(function(j){return n._qs.unescape(j)});var u="Basic "+toBase64(e.join(":"));n.setHeader("proxy-authorization",u)}if(n.proxy&&!n.tunnel){n.path=(n.uri.protocol+"//"+n.uri.host+n.path)}if(c.json){n.json(c.json)}if(c.multipart){n.multipart(c.multipart)}if(c.time){n.timing=true;n.elapsedTime=n.elapsedTime||0}function g(){if(isTypedArray(n.body)){n.body=Buffer.from(n.body)}if(!n.hasHeader("content-length")){var j;if(typeof n.body==="string"){j=Buffer.byteLength(n.body)}else{if(Array.isArray(n.body)){j=n.body.reduce(function(y,v){return y+v.length},0)}else{j=n.body.length}}if(j){n.setHeader("content-length",j)}else{n.emit("error",new Error("Argument error, options.body."))}}}if(n.body&&!isstream(n.body)){g()}if(c.oauth){n.oauth(c.oauth)}else{if(n._oauth.params&&n.hasHeader("authorization")){n.oauth(n._oauth.params)}}var k=n.proxy&&!n.tunnel?n.proxy.protocol:n.uri.protocol,m={"http:":http,"https:":https},b=n.httpModules||{};n.httpModule=b[k]||m[k];if(!n.httpModule){return n.emit("error",new Error("Invalid protocol: "+k))}if(c.ca){n.ca=c.ca}if(!n.agent){if(c.agentOptions){n.agentOptions=c.agentOptions}if(c.agentClass){n.agentClass=c.agentClass}else{if(c.forever){var i=version();if(i.major===0&&i.minor<=10){n.agentClass=k==="http:"?ForeverAgent:ForeverAgent.SSL}else{n.agentClass=n.httpModule.Agent;n.agentOptions=n.agentOptions||{};n.agentOptions.keepAlive=true}}else{n.agentClass=n.httpModule.Agent}}}if(n.pool===false){n.agent=false}else{n.agent=n.agent||n.getNewAgent()}n.on("pipe",function(v){if(n.ntick&&n._started){n.emit("error",new Error("You cannot pipe to this stream after the outbound request has started."))}n.src=v;if(isReadStream(v)){if(!n.hasHeader("content-type")){n.setHeader("content-type",mime.lookup(v.path))}}else{if(v.headers){for(var j in v.headers){if(!n.hasHeader(j)){n.setHeader(j,v.headers[j])}}}if(n._json&&!n.hasHeader("content-type")){n.setHeader("content-type","application/json")}if(v.method&&!n.explicitMethod){n.method=v.method}}});defer(function(){if(n._aborted){return}var j=function(){if(n._form){if(!n._auth.hasAuth){n._form.pipe(n)}else{if(n._auth.hasAuth&&n._auth.sentAuth){n._form.pipe(n)}}}if(n._multipart&&n._multipart.chunked){n._multipart.body.pipe(n)}if(n.body){if(isstream(n.body)){n.body.pipe(n)}else{g();if(Array.isArray(n.body)){n.body.forEach(function(v){n.write(v)})}else{n.write(n.body)}n.end()}}else{if(n.requestBodyStream){console.warn("options.requestBodyStream is deprecated, please pass the request object to stream.pipe.");n.requestBodyStream.pipe(n)}else{if(!n.src){if(n._auth.hasAuth&&!n._auth.sentAuth){n.end();return}if(n.method!=="GET"&&typeof n.method!=="undefined"){n.setHeader("content-length",0)}n.end()}}}};if(n._form&&!n.hasHeader("content-length")){n.setHeader(n._form.getHeaders(),true);n._form.getLength(function(y,v){if(!y&&!isNaN(v)){n.setHeader("content-length",v)}j()})}else{j()}n.ntick=true})};Request.prototype.getNewAgent=function(){var b=this;var a=b.agentClass;var c={};if(b.agentOptions){for(var e in b.agentOptions){c[e]=b.agentOptions[e]}}if(b.ca){c.ca=b.ca}if(b.ciphers){c.ciphers=b.ciphers}if(b.secureProtocol){c.secureProtocol=b.secureProtocol}if(b.secureOptions){c.secureOptions=b.secureOptions}if(typeof b.rejectUnauthorized!=="undefined"){c.rejectUnauthorized=b.rejectUnauthorized}if(b.cert&&b.key){c.key=b.key;c.cert=b.cert}if(b.pfx){c.pfx=b.pfx}if(b.passphrase){c.passphrase=b.passphrase}var g="";if(a!==b.httpModule.Agent){g+=a.name}var d=b.proxy;if(typeof d==="string"){d=url.parse(d)}var f=(d&&d.protocol==="https:")||this.uri.protocol==="https:";if(f){if(c.ca){if(g){g+=":"}g+=c.ca}if(typeof c.rejectUnauthorized!=="undefined"){if(g){g+=":"}g+=c.rejectUnauthorized}if(c.cert){if(g){g+=":"}g+=c.cert.toString("ascii")+c.key.toString("ascii")}if(c.pfx){if(g){g+=":"}g+=c.pfx.toString("ascii")}if(c.ciphers){if(g){g+=":"}g+=c.ciphers}if(c.secureProtocol){if(g){g+=":"}g+=c.secureProtocol}if(c.secureOptions){if(g){g+=":"}g+=c.secureOptions}}if(b.pool===globalPool&&!g&&Object.keys(c).length===0&&b.httpModule.globalAgent){return b.httpModule.globalAgent}g=b.uri.protocol+g;if(!b.pool[g]){b.pool[g]=new a(c);if(b.pool.maxSockets){b.pool[g].maxSockets=b.pool.maxSockets}}return b.pool[g]};Request.prototype.start=function(){var a=this;if(a.timing){var d=new Date().getTime();var c=now()}if(a._aborted){return}a._started=true;a.method=a.method||"GET";a.href=a.uri.href;if(a.src&&a.src.stat&&a.src.stat.size&&!a.hasHeader("content-length")){a.setHeader("content-length",a.src.stat.size)}if(a._aws){a.aws(a._aws,true)}var b=copy(a);delete b.auth;debug("make request",a.uri.href);delete b.timeout;try{a.req=a.httpModule.request(b)}catch(e){a.emit("error",e);return}if(a.timing){a.startTime=d;a.startTimeNow=c;a.timings={}}var f;if(a.timeout&&!a.timeoutTimer){if(a.timeout<0){f=0}else{if(typeof a.timeout==="number"&&isFinite(a.timeout)){f=a.timeout}}}a.req.on("response",a.onRequestResponse.bind(a));a.req.on("error",a.onRequestError.bind(a));a.req.on("drain",function(){a.emit("drain")});a.req.on("socket",function(g){var j=g._connecting||g.connecting;if(a.timing){a.timings.socket=now()-a.startTimeNow;if(j){var i=function(){a.timings.lookup=now()-a.startTimeNow};var k=function(){a.timings.connect=now()-a.startTimeNow};g.once("lookup",i);g.once("connect",k);a.req.once("error",function(){g.removeListener("lookup",i);g.removeListener("connect",k)})}}var l=function(){a.req.setTimeout(f,function(){if(a.req){a.abort();var m=new Error("ESOCKETTIMEDOUT");m.code="ESOCKETTIMEDOUT";m.connect=false;a.emit("error",m)}})};if(f!==undefined){if(j){var h=function(){g.removeListener("connect",h);clearTimeout(a.timeoutTimer);a.timeoutTimer=null;l()};g.on("connect",h);a.req.on("error",function(m){g.removeListener("connect",h)});a.timeoutTimer=setTimeout(function(){g.removeListener("connect",h);a.abort();var m=new Error("ETIMEDOUT");m.code="ETIMEDOUT";m.connect=true;a.emit("error",m)},f)}else{l()}}a.emit("socket",g)});a.emit("request",a.req)};Request.prototype.onRequestError=function(b){var a=this;if(a._aborted){return}if(a.req&&a.req._reusedSocket&&b.code==="ECONNRESET"&&a.agent.addRequestNoreuse){a.agent={addRequest:a.agent.addRequestNoreuse.bind(a.agent)};a.start();a.req.end();return}if(a.timeout&&a.timeoutTimer){clearTimeout(a.timeoutTimer);a.timeoutTimer=null}a.emit("error",b)};Request.prototype.onRequestResponse=function(b){var j=this;if(j.timing){j.timings.response=now()-j.startTimeNow}debug("onRequestResponse",j.uri.href,b.statusCode,b.headers);b.on("end",function(){if(j.timing){j.timings.end=now()-j.startTimeNow;b.timingStart=j.startTime;if(!j.timings.socket){j.timings.socket=0}if(!j.timings.lookup){j.timings.lookup=j.timings.socket}if(!j.timings.connect){j.timings.connect=j.timings.lookup}if(!j.timings.response){j.timings.response=j.timings.connect}debug("elapsed time",j.timings.end);j.elapsedTime+=Math.round(j.timings.end);b.elapsedTime=j.elapsedTime;b.timings=j.timings;b.timingPhases={wait:j.timings.socket,dns:j.timings.lookup-j.timings.socket,tcp:j.timings.connect-j.timings.lookup,firstByte:j.timings.response-j.timings.connect,download:j.timings.end-j.timings.response,total:j.timings.end}}debug("response end",j.uri.href,b.statusCode,b.headers)});if(j._aborted){debug("aborted",j.uri.href);b.resume();return}j.response=b;b.request=j;b.toJSON=responseToJSON;if(j.httpModule===https&&j.strictSSL&&(!b.hasOwnProperty("socket")||!b.socket.authorized)){debug("strict ssl error",j.uri.href);var d=b.hasOwnProperty("socket")?b.socket.authorizationError:j.uri.href+" does not support SSL";j.emit("error",new Error("SSL Error: "+d));return}j.originalHost=j.getHeader("host");if(!j.originalHostHeaderName){j.originalHostHeaderName=j.hasHeader("host")}if(j.setHost){j.removeHeader("host")}if(j.timeout&&j.timeoutTimer){clearTimeout(j.timeoutTimer);j.timeoutTimer=null}var a=(j._jar&&j._jar.setCookie)?j._jar:globalCookieJar;var c=function(k){try{a.setCookie(k,j.uri.href,{ignoreError:true})}catch(l){j.emit("error",l)}};b.caseless=caseless(b.headers);if(b.caseless.has("set-cookie")&&(!j._disableCookies)){var g=b.caseless.has("set-cookie");if(Array.isArray(b.headers[g])){b.headers[g].forEach(c)}else{c(b.headers[g])}}if(j._redirect.onResponse(b)){return}else{b.on("close",function(){if(!j._ended){j.response.emit("end")}});b.once("end",function(){j._ended=true});var i=function(k){return(j.method==="HEAD"||(k>=100&&k<200)||k===204||k===304)};var e;if(j.gzip&&!i(b.statusCode)){var f=b.headers["content-encoding"]||"identity";f=f.trim().toLowerCase();var h={flush:zlib.Z_SYNC_FLUSH,finishFlush:zlib.Z_SYNC_FLUSH};if(f==="gzip"){e=zlib.createGunzip(h);b.pipe(e)}else{if(f==="deflate"){e=zlib.createInflate(h);b.pipe(e)}else{if(f!=="identity"){debug("ignoring unrecognized Content-Encoding "+f)}e=b}}}else{e=b}if(j.encoding){if(j.dests.length!==0){console.error("Ignoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid.")}else{if(e.setEncoding){e.setEncoding(j.encoding)}else{e=e.pipe(stringstream(j.encoding))}}}if(j._paused){e.pause()}j.responseContent=e;j.emit("response",b);j.dests.forEach(function(k){j.pipeDest(k)});e.on("data",function(k){if(j.timing&&!j.responseStarted){j.responseStartTime=(new Date()).getTime();b.responseStartTime=j.responseStartTime}j._destdata=true;j.emit("data",k)});e.once("end",function(k){j.emit("end",k)});e.on("error",function(k){j.emit("error",k)});e.on("close",function(){j.emit("close")});if(j.callback){j.readResponseBody(b)}else{j.on("end",function(){if(j._aborted){debug("aborted",j.uri.href);return}j.emit("complete",b)})}}debug("finish init function",j.uri.href)};Request.prototype.readResponseBody=function(d){var c=this;debug("reading response's body");var b=[],e=0,a=[];c.on("data",function(f){if(!Buffer.isBuffer(f)){a.push(f)}else{if(f.length){e+=f.length;b.push(f)}}});c.on("end",function(){debug("end event",c.uri.href);if(c._aborted){debug("aborted",c.uri.href);b=[];e=0;return}if(e){debug("has body",c.uri.href,e);d.body=Buffer.concat(b,e);if(c.encoding!==null){d.body=d.body.toString(c.encoding)}b=[];e=0}else{if(a.length){if(c.encoding==="utf8"&&a[0].length>0&&a[0][0]==="\uFEFF"){a[0]=a[0].substring(1)}d.body=a.join("")}}if(c._json){try{d.body=JSON.parse(d.body,c._jsonReviver)}catch(f){debug("invalid JSON received",c.uri.href)}}debug("emitting complete",c.uri.href);if(typeof d.body==="undefined"&&!c._json){d.body=c.encoding===null?Buffer.alloc(0):""}c.emit("complete",d,d.body)})};Request.prototype.abort=function(){var a=this;a._aborted=true;if(a.req){a.req.abort()}else{if(a.response){a.response.destroy()}}a.emit("abort")};Request.prototype.pipeDest=function(c){var b=this;var a=b.response;if(c.headers&&!c.headersSent){if(a.caseless.has("content-type")){var f=a.caseless.has("content-type");if(c.setHeader){c.setHeader(f,a.headers[f])}else{c.headers[f]=a.headers[f]}}if(a.caseless.has("content-length")){var e=a.caseless.has("content-length");if(c.setHeader){c.setHeader(e,a.headers[e])}else{c.headers[e]=a.headers[e]}}}if(c.setHeader&&!c.headersSent){for(var d in a.headers){if(!b.gzip||d!=="content-encoding"){c.setHeader(d,a.headers[d])}}c.statusCode=a.statusCode}if(b.pipefilter){b.pipefilter(a,c)}};Request.prototype.qs=function(e,f){var b=this;var d;if(!f&&b.uri.query){d=b._qs.parse(b.uri.query)}else{d={}}for(var c in e){d[c]=e[c]}var a=b._qs.stringify(d);if(a===""){return b}b.uri=url.parse(b.uri.href.split("?")[0]+"?"+a);b.url=b.uri;b.path=b.uri.path;if(b.uri.host==="unix"){b.enableUnixSocket()}return b};Request.prototype.form=function(b){var a=this;if(b){if(!/^application\/x-www-form-urlencoded\b/.test(a.getHeader("content-type"))){a.setHeader("content-type","application/x-www-form-urlencoded")}a.body=(typeof b==="string")?a._qs.rfc3986(b.toString("utf8")):a._qs.stringify(b).toString("utf8");return a}a._form=new FormData();a._form.on("error",function(c){c.message="form-data: "+c.message;a.emit("error",c);a.abort()});return a._form};Request.prototype.multipart=function(b){var a=this;a._multipart.onRequest(b);if(!a._multipart.chunked){a.body=a._multipart.body}return a};Request.prototype.json=function(b){var a=this;if(!a.hasHeader("accept")){a.setHeader("accept","application/json")}if(typeof a.jsonReplacer==="function"){a._jsonReplacer=a.jsonReplacer}a._json=true;if(typeof b==="boolean"){if(a.body!==undefined){if(!/^application\/x-www-form-urlencoded\b/.test(a.getHeader("content-type"))){a.body=safeStringify(a.body,a._jsonReplacer)}else{a.body=a._qs.rfc3986(a.body)}if(!a.hasHeader("content-type")){a.setHeader("content-type","application/json")}}}else{a.body=safeStringify(b,a._jsonReplacer);if(!a.hasHeader("content-type")){a.setHeader("content-type","application/json")}}if(typeof a.jsonReviver==="function"){a._jsonReviver=a.jsonReviver}return a};Request.prototype.getHeader=function(d,f){var b=this;var a,e,c;if(!f){f=b.headers}Object.keys(f).forEach(function(g){if(g.length!==d.length){return}e=new RegExp(d,"i");c=g.match(e);if(c){a=f[g]}});return a};Request.prototype.enableUnixSocket=function(){var a=this.uri.path.split(":"),b=a[0],c=a[1];this.socketPath=b;this.uri.pathname=c;this.uri.path=c;this.uri.host=b;this.uri.hostname=b;this.uri.isUnix=true};Request.prototype.auth=function(c,e,a,d){var b=this;b._auth.onRequest(c,e,a,d);return b};Request.prototype.aws=function(g,e){var a=this;if(!e){a._aws=g;return a}if(g.sign_version==4||g.sign_version=="4"){var d={host:a.uri.host,path:a.uri.path,method:a.method,headers:{"content-type":a.getHeader("content-type")||""},body:a.body};var c=aws4.sign(d,{accessKeyId:g.key,secretAccessKey:g.secret,sessionToken:g.session});a.setHeader("authorization",c.headers.Authorization);a.setHeader("x-amz-date",c.headers["X-Amz-Date"]);if(c.headers["X-Amz-Security-Token"]){a.setHeader("x-amz-security-token",c.headers["X-Amz-Security-Token"])}}else{var b=new Date();a.setHeader("date",b.toUTCString());var f={key:g.key,secret:g.secret,verb:a.method.toUpperCase(),date:b,contentType:a.getHeader("content-type")||"",md5:a.getHeader("content-md5")||"",amazonHeaders:aws2.canonicalizeHeaders(a.headers)};var h=a.uri.path;if(g.bucket&&h){f.resource="/"+g.bucket+h}else{if(g.bucket&&!h){f.resource="/"+g.bucket}else{if(!g.bucket&&h){f.resource=h}else{if(!g.bucket&&!h){f.resource="/"}}}}f.resource=aws2.canonicalizeResource(f.resource);a.setHeader("authorization",aws2.authorization(f))}return a};Request.prototype.httpSignature=function(b){var a=this;httpSignature.signRequest({getHeader:function(c){return a.getHeader(c,a.headers)},setHeader:function(d,c){a.setHeader(d,c)},method:a.method,path:a.path},b);debug("httpSignature authorization",a.getHeader("authorization"));return a};Request.prototype.hawk=function(b){var a=this;a.setHeader("Authorization",hawk.client.header(a.uri,a.method,b).field)};Request.prototype.oauth=function(b){var a=this;a._oauth.onRequest(b);return a};Request.prototype.jar=function(e){var a=this;var d;if(a._redirect.redirectsFollowed===0){a.originalCookieHeader=a.getHeader("cookie")}if(!e){d=false;a._disableCookies=true}else{var c=(e&&e.getCookieString)?e:globalCookieJar;var b=a.uri.href;if(c){d=c.getCookieString(b)}}if(d&&d.length){if(a.originalCookieHeader){a.setHeader("cookie",a.originalCookieHeader+"; "+d)}else{a.setHeader("cookie",d)}}a._jar=e;return a};Request.prototype.pipe=function(b,c){var a=this;if(a.response){if(a._destdata){a.emit("error",new Error("You cannot pipe after data has been emitted from the response."))}else{if(a._ended){a.emit("error",new Error("You cannot pipe after the response has been ended."))}else{stream.Stream.prototype.pipe.call(a,b,c);a.pipeDest(b);return b}}}else{a.dests.push(b);stream.Stream.prototype.pipe.call(a,b,c);return b}};Request.prototype.write=function(){var a=this;if(a._aborted){return}if(!a._started){a.start()}if(a.req){return a.req.write.apply(a.req,arguments)}};Request.prototype.end=function(b){var a=this;if(a._aborted){return}if(b){a.write(b)}if(!a._started){a.start()}if(a.req){a.req.end()}};Request.prototype.pause=function(){var a=this;if(!a.responseContent){a._paused=true}else{a.responseContent.pause.apply(a.responseContent,arguments)}};Request.prototype.resume=function(){var a=this;if(!a.responseContent){a._paused=false}else{a.responseContent.resume.apply(a.responseContent,arguments)}};Request.prototype.destroy=function(){var a=this;if(!a._ended){a.end()}else{if(a.response){a.response.destroy()}}};Request.defaultProxyHeaderWhiteList=Tunnel.defaultProxyHeaderWhiteList.slice();Request.defaultProxyHeaderExclusiveList=Tunnel.defaultProxyHeaderExclusiveList.slice();Request.prototype.toJSON=requestToJSON;module.exports=Request;