"use strict";var url=require("url"),qs=require("qs"),caseless=require("caseless"),uuid=require("uuid"),oauth=require("oauth-sign"),crypto=require("crypto"),Buffer=require("safe-buffer").Buffer;function OAuth(a){this.request=a;this.params=null}OAuth.prototype.buildParams=function(m,d,a,l,b,n){var c={};for(var h in m){c["oauth_"+h]=m[h]}if(!c.oauth_version){c.oauth_version="1.0"}if(!c.oauth_timestamp){c.oauth_timestamp=Math.floor(Date.now()/1000).toString()}if(!c.oauth_nonce){c.oauth_nonce=uuid().replace(/-/g,"")}if(!c.oauth_signature_method){c.oauth_signature_method="HMAC-SHA1"}var e=c.oauth_consumer_secret||c.oauth_private_key;delete c.oauth_consumer_secret;delete c.oauth_private_key;var g=c.oauth_token_secret;delete c.oauth_token_secret;var j=c.oauth_realm;delete c.oauth_realm;delete c.oauth_transport_method;var k=d.protocol+"//"+d.host+d.pathname;var f=n.parse([].concat(l,b,n.stringify(c)).join("&"));c.oauth_signature=oauth.sign(c.oauth_signature_method,a,k,f,e,g);if(j){c.realm=j}return c};OAuth.prototype.buildBodyHash=function(c,a){if(["HMAC-SHA1","RSA-SHA1"].indexOf(c.signature_method||"HMAC-SHA1")<0){this.request.emit("error",new Error("oauth: "+c.signature_method+" signature_method not supported with body_hash signing."))}var b=crypto.createHash("sha1");b.update(a||"");var d=b.digest("hex");return Buffer.from(d).toString("base64")};OAuth.prototype.concatParams=function(b,a,c){c=c||"";var d=Object.keys(b).filter(function(e){return e!=="realm"&&e!=="oauth_signature"}).sort();if(b.realm){d.splice(0,0,"realm")}d.push("oauth_signature");return d.map(function(e){return e+"="+c+oauth.rfc3986(b[e])+c}).join(a)};OAuth.prototype.onRequest=function(j){var n=this;n.params=j;var f=n.request.uri||{},a=n.request.method||"",e=caseless(n.request.headers),h=n.request.body||"",m=n.request.qsLib||qs;var c,i,l=e.get("content-type")||"",k="application/x-www-form-urlencoded",g=j.transport_method||"header";if(l.slice(0,k.length)===k){l=k;c=h}if(f.query){i=f.query}if(g==="body"&&(a!=="POST"||l!==k)){n.request.emit("error",new Error("oauth: transport_method of body requires POST and content-type "+k))}if(!c&&typeof j.body_hash==="boolean"){j.body_hash=n.buildBodyHash(j,n.request.body.toString())}var d=n.buildParams(j,f,a,i,c,m);switch(g){case"header":n.request.setHeader("Authorization","OAuth "+n.concatParams(d,",",'"'));break;case"query":var b=n.request.uri.href+=(i?"&":"?")+n.concatParams(d,"&");n.request.uri=url.parse(b);n.request.path=n.request.uri.path;break;case"body":n.request.body=(c?c+"&":"")+n.concatParams(d,"&");break;default:n.request.emit("error",new Error("oauth: transport_method invalid"))}};exports.OAuth=OAuth;