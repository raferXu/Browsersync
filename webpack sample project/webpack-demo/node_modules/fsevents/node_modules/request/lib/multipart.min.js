"use strict";var uuid=require("uuid"),CombinedStream=require("combined-stream"),isstream=require("isstream"),Buffer=require("safe-buffer").Buffer;function Multipart(a){this.request=a;this.boundary=uuid();this.chunked=false;this.body=null}Multipart.prototype.isChunked=function(c){var a=this,b=false,d=c.data||c;if(!d.forEach){a.request.emit("error",new Error("Argument error, options.multipart."))}if(c.chunked!==undefined){b=c.chunked}if(a.request.getHeader("transfer-encoding")==="chunked"){b=true}if(!b){d.forEach(function(e){if(typeof e.body==="undefined"){a.request.emit("error",new Error("Body attribute missing in multipart."))}if(isstream(e.body)){b=true}})}return b};Multipart.prototype.setHeaders=function(b){var a=this;if(b&&!a.request.hasHeader("transfer-encoding")){a.request.setHeader("transfer-encoding","chunked")}var c=a.request.getHeader("content-type");if(!c||c.indexOf("multipart")===-1){a.request.setHeader("content-type","multipart/related; boundary="+a.boundary)}else{if(c.indexOf("boundary")!==-1){a.boundary=c.replace(/.*boundary=([^\s;]+).*/,"$1")}else{a.request.setHeader("content-type",c+"; boundary="+a.boundary)}}};Multipart.prototype.build=function(e,c){var b=this;var a=c?new CombinedStream():[];function d(f){if(typeof f==="number"){f=f.toString()}return c?a.append(f):a.push(Buffer.from(f))}if(b.request.preambleCRLF){d("\r\n")}e.forEach(function(f){var g="--"+b.boundary+"\r\n";Object.keys(f).forEach(function(h){if(h==="body"){return}g+=h+": "+f[h]+"\r\n"});g+="\r\n";d(g);d(f.body);d("\r\n")});d("--"+b.boundary+"--");if(b.request.postambleCRLF){d("\r\n")}return a};Multipart.prototype.onRequest=function(c){var a=this;var b=a.isChunked(c),d=c.data||c;a.setHeaders(b);a.chunked=b;a.body=a.build(d,b)};exports.Multipart=Multipart;