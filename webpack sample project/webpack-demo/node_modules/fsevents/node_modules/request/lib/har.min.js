"use strict";var fs=require("fs");var qs=require("querystring");var validate=require("har-validator");var extend=require("extend");function Har(a){this.request=a}Har.prototype.reducer=function(b,c){if(b[c.name]===undefined){b[c.name]=c.value;return b}var a=[b[c.name],c.value];b[c.name]=a;return b};Har.prototype.prep=function(b){b.queryObj={};b.headersObj={};b.postData.jsonObj=false;b.postData.paramsObj=false;if(b.queryString&&b.queryString.length){b.queryObj=b.queryString.reduce(this.reducer,{})}if(b.headers&&b.headers.length){b.headersObj=b.headers.reduceRight(function(e,f){e[f.name]=f.value;return e},{})}if(b.cookies&&b.cookies.length){var a=b.cookies.map(function(e){return e.name+"="+e.value});if(a.length){b.headersObj.cookie=a.join("; ")}}function d(e){return e.some(function(f){return b.postData.mimeType.indexOf(f)===0})}if(d(["multipart/mixed","multipart/related","multipart/form-data","multipart/alternative"])){b.postData.mimeType="multipart/form-data"}else{if(d(["application/x-www-form-urlencoded"])){if(!b.postData.params){b.postData.text=""}else{b.postData.paramsObj=b.postData.params.reduce(this.reducer,{});b.postData.text=qs.stringify(b.postData.paramsObj)}}else{if(d(["text/json","text/x-json","application/json","application/x-json"])){b.postData.mimeType="application/json";if(b.postData.text){try{b.postData.jsonObj=JSON.parse(b.postData.text)}catch(c){this.request.debug(c);b.postData.mimeType="text/plain"}}}}}return b};Har.prototype.options=function(a){if(!a.har){return a}var b={};extend(b,a.har);if(b.log&&b.log.entries){b=b.log.entries[0]}b.url=b.url||a.url||a.uri||a.baseUrl||"/";b.httpVersion=b.httpVersion||"HTTP/1.1";b.queryString=b.queryString||[];b.headers=b.headers||[];b.cookies=b.cookies||[];b.postData=b.postData||{};b.postData.mimeType=b.postData.mimeType||"application/octet-stream";b.bodySize=0;b.headersSize=0;b.postData.size=0;if(!validate.request(b)){return a}var c=this.prep(b);if(c.url){a.url=c.url}if(c.method){a.method=c.method}if(Object.keys(c.queryObj).length){a.qs=c.queryObj}if(Object.keys(c.headersObj).length){a.headers=c.headersObj}function d(e){return c.postData.mimeType.indexOf(e)===0}if(d("application/x-www-form-urlencoded")){a.form=c.postData.paramsObj}else{if(d("application/json")){if(c.postData.jsonObj){a.body=c.postData.jsonObj;a.json=true}}else{if(d("multipart/form-data")){a.formData={};c.postData.params.forEach(function(f){var e={};if(!f.fileName&&!f.fileName&&!f.contentType){a.formData[f.name]=f.value;return}if(f.fileName&&!f.value){e.value=fs.createReadStream(f.fileName)}else{if(f.value){e.value=f.value}}if(f.fileName){e.options={filename:f.fileName,contentType:f.contentType?f.contentType:null}}a.formData[f.name]=e})}else{if(c.postData.text){a.body=c.postData.text}}}}return a};exports.Har=Har;