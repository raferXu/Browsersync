"use strict";var url=require("url");var isUrl=/^https?:/;function Redirect(a){this.request=a;this.followRedirect=true;this.followRedirects=true;this.followAllRedirects=false;this.followOriginalHttpMethod=false;this.allowRedirect=function(){return true};this.maxRedirects=10;this.redirects=[];this.redirectsFollowed=0;this.removeRefererHeader=false}Redirect.prototype.onRequest=function(b){var a=this;if(b.maxRedirects!==undefined){a.maxRedirects=b.maxRedirects}if(typeof b.followRedirect==="function"){a.allowRedirect=b.followRedirect}if(b.followRedirect!==undefined){a.followRedirects=!!b.followRedirect}if(b.followAllRedirects!==undefined){a.followAllRedirects=b.followAllRedirects}if(a.followRedirects||a.followAllRedirects){a.redirects=a.redirects||[]}if(b.removeRefererHeader!==undefined){a.removeRefererHeader=b.removeRefererHeader}if(b.followOriginalHttpMethod!==undefined){a.followOriginalHttpMethod=b.followOriginalHttpMethod}};Redirect.prototype.redirectTo=function(c){var b=this,f=b.request;var e=null;if(c.statusCode>=300&&c.statusCode<400&&c.caseless.has("location")){var a=c.caseless.get("location");f.debug("redirect",a);if(b.followAllRedirects){e=a}else{if(b.followRedirects){switch(f.method){case"PATCH":case"PUT":case"POST":case"DELETE":break;default:e=a;break}}}}else{if(c.statusCode===401){var d=f._auth.onResponse(c);if(d){f.setHeader("authorization",d);e=f.uri}}}return e};Redirect.prototype.onResponse=function(b){var a=this,e=a.request;var d=a.redirectTo(b);if(!d||!a.allowRedirect.call(e,b)){return false}e.debug("redirect to",d);if(b.resume){b.resume()}if(a.redirectsFollowed>=a.maxRedirects){e.emit("error",new Error("Exceeded maxRedirects. Probably stuck in a redirect loop "+e.uri.href));return false}a.redirectsFollowed+=1;if(!isUrl.test(d)){d=url.resolve(e.uri.href,d)}var c=e.uri;e.uri=url.parse(d);if(e.uri.protocol!==c.protocol){delete e.agent}a.redirects.push({statusCode:b.statusCode,redirectUri:d});if(a.followAllRedirects&&e.method!=="HEAD"&&b.statusCode!==401&&b.statusCode!==307){e.method=a.followOriginalHttpMethod?e.method:"GET"}delete e.src;delete e.req;delete e._started;if(b.statusCode!==401&&b.statusCode!==307){delete e.body;delete e._form;if(e.headers){e.removeHeader("host");e.removeHeader("content-type");e.removeHeader("content-length");if(e.uri.hostname!==e.originalHost.split(":")[0]){e.removeHeader("authorization")}}}if(!a.removeRefererHeader){e.setHeader("referer",c.href)}e.emit("redirect");e.init();return true};exports.Redirect=Redirect;