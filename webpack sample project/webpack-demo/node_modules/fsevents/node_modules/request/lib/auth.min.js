"use strict";var caseless=require("caseless"),uuid=require("uuid"),helpers=require("./helpers");var md5=helpers.md5,toBase64=helpers.toBase64;function Auth(a){this.request=a;this.hasAuth=false;this.sentAuth=false;this.bearerToken=null;this.user=null;this.pass=null}Auth.prototype.basic=function(c,e,a){var b=this;if(typeof c!=="string"||(e!==undefined&&typeof e!=="string")){b.request.emit("error",new Error("auth() received invalid user or password"))}b.user=c;b.pass=e;b.hasAuth=true;var f=c+":"+(e||"");if(a||typeof a==="undefined"){var d="Basic "+toBase64(f);b.sentAuth=true;return d}};Auth.prototype.bearer=function(d,a){var b=this;b.bearerToken=d;b.hasAuth=true;if(a||typeof a==="undefined"){if(typeof d==="function"){d=d()}var c="Bearer "+(d||"");b.sentAuth=true;return c}};Auth.prototype.digest=function(a,q,g){var o=this;var j={};var n=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/gi;for(;;){var f=n.exec(g);if(!f){break}j[f[1]]=f[2]||f[3]}var c=function(s,r,k,v,u,w){var t=md5(r+":"+k+":"+v);if(s&&s.toLowerCase()==="md5-sess"){return md5(t+":"+u+":"+w)}else{return t}};var b=/(^|,)\s*auth\s*($|,)/.test(j.qop)&&"auth";var e=b&&"00000001";var m=b&&uuid().replace(/-/g,"");var i=c(j.algorithm,o.user,j.realm,o.pass,j.nonce,m);var h=md5(a+":"+q);var l=b?md5(i+":"+j.nonce+":"+e+":"+m+":"+b+":"+h):md5(i+":"+j.nonce+":"+h);var p={username:o.user,realm:j.realm,nonce:j.nonce,uri:q,qop:b,response:l,nc:e,cnonce:m,algorithm:j.algorithm,opaque:j.opaque};g=[];for(var d in p){if(p[d]){if(d==="qop"||d==="nc"||d==="algorithm"){g.push(d+"="+p[d])}else{g.push(d+'="'+p[d]+'"')}}}g="Digest "+g.join(", ");o.sentAuth=true;return g};Auth.prototype.onRequest=function(c,g,a,e){var b=this,f=b.request;var d;if(e===undefined&&c===undefined){b.request.emit("error",new Error("no auth mechanism defined"))}else{if(e!==undefined){d=b.bearer(e,a)}else{d=b.basic(c,g,a)}}if(d){f.setHeader("authorization",d)}};Auth.prototype.onResponse=function(b){var a=this,e=a.request;if(!a.hasAuth||a.sentAuth){return null}var g=caseless(b.headers);var d=g.get("www-authenticate");var f=d&&d.split(" ")[0].toLowerCase();e.debug("reauth",f);switch(f){case"basic":return a.basic(a.user,a.pass,true);case"bearer":return a.bearer(a.bearerToken,true);case"digest":return a.digest(e.method,e.path,d)}};exports.Auth=Auth;