var CombinedStream=require("combined-stream");var util=require("util");var path=require("path");var http=require("http");var https=require("https");var parseUrl=require("url").parse;var fs=require("fs");var mime=require("mime-types");var asynckit=require("asynckit");var populate=require("./populate.js");module.exports=FormData;util.inherits(FormData,CombinedStream);function FormData(){if(!(this instanceof FormData)){return new FormData()}this._overheadLength=0;this._valueLength=0;this._valuesToMeasure=[];CombinedStream.call(this)}FormData.LINE_BREAK="\r\n";FormData.DEFAULT_CONTENT_TYPE="application/octet-stream";FormData.prototype.append=function(d,c,b){b=b||{};if(typeof b=="string"){b={filename:b}}var a=CombinedStream.prototype.append.bind(this);if(typeof c=="number"){c=""+c}if(util.isArray(c)){this._error(new Error("Arrays are not supported."));return}var f=this._multiPartHeader(d,c,b);var e=this._multiPartFooter();a(f);a(c);a(e);this._trackLength(f,c,b)};FormData.prototype._trackLength=function(d,c,a){var b=0;if(a.knownLength!=null){b+=+a.knownLength}else{if(Buffer.isBuffer(c)){b=c.length}else{if(typeof c==="string"){b=Buffer.byteLength(c)}}}this._valueLength+=b;this._overheadLength+=Buffer.byteLength(d)+FormData.LINE_BREAK.length;if(!c||(!c.path&&!(c.readable&&c.hasOwnProperty("httpVersion")))){return}if(!a.knownLength){this._valuesToMeasure.push(c)}};FormData.prototype._lengthRetriever=function(a,b){if(a.hasOwnProperty("fd")){if(a.end!=undefined&&a.end!=Infinity&&a.start!=undefined){b(null,a.end+1-(a.start?a.start:0))}else{fs.stat(a.path,function(e,d){var c;if(e){b(e);return}c=d.size-(a.start?a.start:0);b(null,c)})}}else{if(a.hasOwnProperty("httpVersion")){b(null,+a.headers["content-length"])}else{if(a.hasOwnProperty("httpModule")){a.on("response",function(c){a.pause();b(null,+c.headers["content-length"])});a.resume()}else{b("Unknown stream")}}}};FormData.prototype._multiPartHeader=function(f,g,i){if(typeof i.header=="string"){return i.header}var c=this._getContentDisposition(g,i);var h=this._getContentType(g,i);var d="";var b={"Content-Disposition":["form-data",'name="'+f+'"'].concat(c||[]),"Content-Type":[].concat(h||[])};if(typeof i.header=="object"){populate(b,i.header)}var e;for(var a in b){e=b[a];if(e==null){continue}if(!Array.isArray(e)){e=[e]}if(e.length){d+=a+": "+e.join("; ")+FormData.LINE_BREAK}}return"--"+this.getBoundary()+FormData.LINE_BREAK+d+FormData.LINE_BREAK};FormData.prototype._getContentDisposition=function(d,c){var a;var b=c.filename||d.name||d.path;if(!b&&d.readable&&d.hasOwnProperty("httpVersion")){b=d.client._httpMessage.path}if(b){a='filename="'+path.basename(b)+'"'}return a};FormData.prototype._getContentType=function(b,a){var c=a.contentType;if(!c&&b.name){c=mime.lookup(b.name)}if(!c&&b.path){c=mime.lookup(b.path)}if(!c&&b.readable&&b.hasOwnProperty("httpVersion")){c=b.headers["content-type"]}if(!c&&a.filename){c=mime.lookup(a.filename)}if(!c&&typeof b=="object"){c=FormData.DEFAULT_CONTENT_TYPE}return c};FormData.prototype._multiPartFooter=function(){return function(b){var c=FormData.LINE_BREAK;var a=(this._streams.length===0);if(a){c+=this._lastBoundary()}b(c)}.bind(this)};FormData.prototype._lastBoundary=function(){return"--"+this.getBoundary()+"--"+FormData.LINE_BREAK};FormData.prototype.getHeaders=function(a){var c;var b={"content-type":"multipart/form-data; boundary="+this.getBoundary()};for(c in a){if(a.hasOwnProperty(c)){b[c.toLowerCase()]=a[c]}}return b};FormData.prototype.getBoundary=function(){if(!this._boundary){this._generateBoundary()}return this._boundary};FormData.prototype._generateBoundary=function(){var b="--------------------------";for(var a=0;a<24;a++){b+=Math.floor(Math.random()*10).toString(16)}this._boundary=b};FormData.prototype.getLengthSync=function(){var a=this._overheadLength+this._valueLength;if(this._streams.length){a+=this._lastBoundary().length}if(!this.hasKnownLength()){this._error(new Error("Cannot calculate proper length in synchronous way."))}return a};FormData.prototype.hasKnownLength=function(){var a=true;if(this._valuesToMeasure.length){a=false}return a};FormData.prototype.getLength=function(a){var b=this._overheadLength+this._valueLength;if(this._streams.length){b+=this._lastBoundary().length}if(!this._valuesToMeasure.length){process.nextTick(a.bind(this,null,b));return}asynckit.parallel(this._valuesToMeasure,this._lengthRetriever,function(d,c){if(d){a(d);return}c.forEach(function(e){b+=e});a(null,b)})};FormData.prototype.submit=function(e,a){var c,b,d={method:"post"};if(typeof e=="string"){e=parseUrl(e);b=populate({port:e.port,path:e.pathname,host:e.hostname},d)}else{b=populate(e,d);if(!b.port){b.port=b.protocol=="https:"?443:80}}b.headers=this.getHeaders(e.headers);if(b.protocol=="https:"){c=https.request(b)}else{c=http.request(b)}this.getLength(function(g,f){if(g){this._error(g);return}c.setHeader("Content-Length",f);this.pipe(c);if(a){c.on("error",a);c.on("response",a.bind(this,null))}}.bind(this));return c};FormData.prototype._error=function(a){if(!this.error){this.error=a;this.pause();this.emit("error",a)}};FormData.prototype.toString=function(){return"[object FormData]"};