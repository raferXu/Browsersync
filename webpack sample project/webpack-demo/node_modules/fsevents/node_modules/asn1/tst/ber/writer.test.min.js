var test=require("tap").test;var sys=require("sys");var BerWriter;var BerReader;test("load library",function(a){BerWriter=require("../../lib/index").BerWriter;a.ok(BerWriter);a.ok(new BerWriter());a.end()});test("write byte",function(b){var c=new BerWriter();c.writeByte(194);var a=c.buffer;b.ok(a);b.equal(a.length,1,"Wrong length");b.equal(a[0],194,"value wrong");b.end()});test("write 1 byte int",function(b){var c=new BerWriter();c.writeInt(127);var a=c.buffer;b.ok(a);b.equal(a.length,3,"Wrong length for an int: "+a.length);b.equal(a[0],2,"ASN.1 tag wrong (2) -> "+a[0]);b.equal(a[1],1,"length wrong(1) -> "+a[1]);b.equal(a[2],127,"value wrong(3) -> "+a[2]);b.end()});test("write 2 byte int",function(b){var c=new BerWriter();c.writeInt(32766);var a=c.buffer;b.ok(a);b.equal(a.length,4,"Wrong length for an int");b.equal(a[0],2,"ASN.1 tag wrong");b.equal(a[1],2,"length wrong");b.equal(a[2],127,"value wrong (byte 1)");b.equal(a[3],254,"value wrong (byte 2)");b.end()});test("write 3 byte int",function(b){var c=new BerWriter();c.writeInt(8388606);var a=c.buffer;b.ok(a);b.equal(a.length,5,"Wrong length for an int");b.equal(a[0],2,"ASN.1 tag wrong");b.equal(a[1],3,"length wrong");b.equal(a[2],127,"value wrong (byte 1)");b.equal(a[3],255,"value wrong (byte 2)");b.equal(a[4],254,"value wrong (byte 3)");b.end()});test("write 4 byte int",function(b){var c=new BerWriter();c.writeInt(2147483646);var a=c.buffer;b.ok(a);b.equal(a.length,6,"Wrong length for an int");b.equal(a[0],2,"ASN.1 tag wrong");b.equal(a[1],4,"length wrong");b.equal(a[2],127,"value wrong (byte 1)");b.equal(a[3],255,"value wrong (byte 2)");b.equal(a[4],255,"value wrong (byte 3)");b.equal(a[5],254,"value wrong (byte 4)");b.end()});test("write 1 byte negative int",function(b){var c=new BerWriter();c.writeInt(-128);var a=c.buffer;b.ok(a);b.equal(a.length,3,"Wrong length for an int");b.equal(a[0],2,"ASN.1 tag wrong");b.equal(a[1],1,"length wrong");b.equal(a[2],128,"value wrong (byte 1)");b.end()});test("write 2 byte negative int",function(b){var c=new BerWriter();c.writeInt(-22400);var a=c.buffer;b.ok(a);b.equal(a.length,4,"Wrong length for an int");b.equal(a[0],2,"ASN.1 tag wrong");b.equal(a[1],2,"length wrong");b.equal(a[2],168,"value wrong (byte 1)");b.equal(a[3],128,"value wrong (byte 2)");b.end()});test("write 3 byte negative int",function(b){var c=new BerWriter();c.writeInt(-481653);var a=c.buffer;b.ok(a);b.equal(a.length,5,"Wrong length for an int");b.equal(a[0],2,"ASN.1 tag wrong");b.equal(a[1],3,"length wrong");b.equal(a[2],248,"value wrong (byte 1)");b.equal(a[3],166,"value wrong (byte 2)");b.equal(a[4],139,"value wrong (byte 3)");b.end()});test("write 4 byte negative int",function(b){var c=new BerWriter();c.writeInt(-1522904131);var a=c.buffer;b.ok(a);b.equal(a.length,6,"Wrong length for an int");b.equal(a[0],2,"ASN.1 tag wrong");b.equal(a[1],4,"length wrong");b.equal(a[2],165,"value wrong (byte 1)");b.equal(a[3],58,"value wrong (byte 2)");b.equal(a[4],83,"value wrong (byte 3)");b.equal(a[5],189,"value wrong (byte 4)");b.end()});test("write boolean",function(b){var c=new BerWriter();c.writeBoolean(true);c.writeBoolean(false);var a=c.buffer;b.ok(a);b.equal(a.length,6,"Wrong length");b.equal(a[0],1,"tag wrong");b.equal(a[1],1,"length wrong");b.equal(a[2],255,"value wrong");b.equal(a[3],1,"tag wrong");b.equal(a[4],1,"length wrong");b.equal(a[5],0,"value wrong");b.end()});test("write string",function(b){var c=new BerWriter();c.writeString("hello world");var a=c.buffer;b.ok(a);b.equal(a.length,13,"wrong length");b.equal(a[0],4,"wrong tag");b.equal(a[1],11,"wrong length");b.equal(a.slice(2).toString("utf8"),"hello world","wrong value");b.end()});test("write buffer",function(e){var f=new BerWriter();f.writeString("hello world");var c=f.buffer;var b=new Buffer([4,11,48,9,2,1,15,1,1,255,1,1,255]);f.writeBuffer(b.slice(2,b.length),4);c=f.buffer;e.ok(c);e.equal(c.length,26,"wrong length");e.equal(c[0],4,"wrong tag");e.equal(c[1],11,"wrong length");e.equal(c.slice(2,13).toString("utf8"),"hello world","wrong value");e.equal(c[13],b[0],"wrong tag");e.equal(c[14],b[1],"wrong length");for(var d=13,a=0;d<c.length&&a<b.length;d++,a++){e.equal(c[d],b[a],"buffer contents not identical")}e.end()});test("write string array",function(b){var c=new BerWriter();c.writeStringArray(["hello world","fubar!"]);var a=c.buffer;b.ok(a);b.equal(a.length,21,"wrong length");b.equal(a[0],4,"wrong tag");b.equal(a[1],11,"wrong length");b.equal(a.slice(2,13).toString("utf8"),"hello world","wrong value");b.equal(a[13],4,"wrong tag");b.equal(a[14],6,"wrong length");b.equal(a.slice(15).toString("utf8"),"fubar!","wrong value");b.end()});test("resize internal buffer",function(b){var c=new BerWriter({size:2});c.writeString("hello world");var a=c.buffer;b.ok(a);b.equal(a.length,13,"wrong length");b.equal(a[0],4,"wrong tag");b.equal(a[1],11,"wrong length");b.equal(a.slice(2).toString("utf8"),"hello world","wrong value");b.end()});test("sequence",function(b){var c=new BerWriter({size:25});c.startSequence();c.writeString("hello world");c.endSequence();var a=c.buffer;b.ok(a);console.log(a);b.equal(a.length,15,"wrong length");b.equal(a[0],48,"wrong tag");b.equal(a[1],13,"wrong length");b.equal(a[2],4,"wrong tag");b.equal(a[3],11,"wrong length");b.equal(a.slice(4).toString("utf8"),"hello world","wrong value");b.end()});test("nested sequence",function(b){var c=new BerWriter({size:25});c.startSequence();c.writeString("hello world");c.startSequence();c.writeString("hello world");c.endSequence();c.endSequence();var a=c.buffer;b.ok(a);b.equal(a.length,30,"wrong length");b.equal(a[0],48,"wrong tag");b.equal(a[1],28,"wrong length");b.equal(a[2],4,"wrong tag");b.equal(a[3],11,"wrong length");b.equal(a.slice(4,15).toString("utf8"),"hello world","wrong value");b.equal(a[15],48,"wrong tag");b.equal(a[16],13,"wrong length");b.equal(a[17],4,"wrong tag");b.equal(a[18],11,"wrong length");b.equal(a.slice(19,30).toString("utf8"),"hello world","wrong value");b.end()});test("LDAP bind message",function(c){var a="cn=foo,ou=unit,o=test";var d=new BerWriter();d.startSequence();d.writeInt(3);d.startSequence(96);d.writeInt(3);d.writeString(a);d.writeByte(128);d.writeByte(0);d.endSequence();d.endSequence();var b=d.buffer;c.ok(b);c.equal(b.length,35,"wrong length (buffer)");c.equal(b[0],48,"wrong tag");c.equal(b[1],33,"wrong length");c.equal(b[2],2,"wrong tag");c.equal(b[3],1,"wrong length");c.equal(b[4],3,"wrong value");c.equal(b[5],96,"wrong tag");c.equal(b[6],28,"wrong length");c.equal(b[7],2,"wrong tag");c.equal(b[8],1,"wrong length");c.equal(b[9],3,"wrong value");c.equal(b[10],4,"wrong tag");c.equal(b[11],a.length,"wrong length");c.equal(b.slice(12,33).toString("utf8"),a,"wrong value");c.equal(b[33],128,"wrong tag");c.equal(b[34],0,"wrong len");c.end()});test("Write OID",function(b){var c="1.2.840.113549.1.1.1";var d=new BerWriter();d.writeOID(c);var a=d.buffer;b.ok(a);console.log(require("util").inspect(a));console.log(require("util").inspect(new Buffer([6,9,42,134,72,134,247,13,1,1,1])));b.end()});