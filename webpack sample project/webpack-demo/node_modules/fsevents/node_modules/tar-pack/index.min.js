"use strict";var debug=require("debug")("tar-pack");var uidNumber=require("uid-number");var rm=require("rimraf");var tar=require("tar");var once=require("once");var fstream=require("fstream");var packer=require("fstream-ignore");var PassThrough=require("stream").PassThrough||require("readable-stream").PassThrough;var zlib=require("zlib");var path=require("path");var win32=process.platform==="win32";var myUid=process.getuid&&process.getuid();var myGid=process.getgid&&process.getgid();if(process.env.SUDO_UID&&myUid===0){if(!isNaN(process.env.SUDO_UID)){myUid=+process.env.SUDO_UID}if(!isNaN(process.env.SUDO_GID)){myGid=+process.env.SUDO_GID}}exports.pack=pack;exports.unpack=unpack;function pack(e,a){a=a||{};if(typeof e==="string"){var d=a.filter||function(f){return true};e=packer({path:e,type:"Directory",isDirectory:true,ignoreFiles:a.ignoreFiles||[".gitignore"],filter:function(f){var g=f.basename;if(g===".git"||g===".lock-wscript"||g.match(/^\.wafpickle-[0-9]+$/)||g==="CVS"||g===".svn"||g===".hg"||g.match(/^\..*\.swp$/)||g===".DS_Store"||g.match(/^\._/)){return false}return d(f)}})}var c=tar.Pack({noProprietary:a.noProprietary||false,fromBase:a.fromBase||false});var b=zlib.Gzip();e.on("error",function(f){if(f){debug("Error reading folder")}return b.emit("error",f)});c.on("error",function(f){if(f){debug("tar creation error")}b.emit("error",f)});return e.pipe(c).pipe(b)}function unpack(j,n,f){if(typeof n==="function"&&f===undefined){f=n,n=undefined}var a=new PassThrough();if(typeof f==="function"){f=once(f);a.on("error",f);a.on("close",function(){f()})}var k=path.dirname(j);var d=path.basename(j);n=n||{};var h=n.gid||null;var i=n.uid||null;var e=n.dmode||1911;var m=n.fmode||1638;var l=n.defaultName||(n.defaultName===false?false:"index.js");var c=(n.strip!==undefined)?n.strip:1;if(n.unsafe&&!win32){i=myUid;h=myGid}var b=2;uidNumber(i,h,function(q,o,p){if(q){a.emit("error",q);return a.end()}if(0===--b){g()}});if(!n.keepFiles){rm(j,function(o){if(o){a.emit("error",o);return a.end()}if(0===--b){g()}})}else{g()}function g(){gunzTarPerm(a,j,e,m,i,h,l,c)}return a}function gunzTarPerm(a,f,c,j,e,d,h,b){debug("modes %j",[c.toString(8),j.toString(8)]);function i(k){debug("fixEntry %j",k.path);var l=k.mode=k.mode||k.props.mode;k.mode=k.mode|(k.type==="Directory"?c:j);k.props.mode=k.mode;if(l!==k.mode){debug("modified mode %j",[k.path,l,k.mode])}if(!win32&&typeof e==="number"&&typeof d==="number"){k.props.uid=k.uid=e;k.props.gid=k.gid=d}}var g={type:"Directory",path:f,strip:b};if(!win32&&typeof e==="number"&&typeof d==="number"){g.uid=e;g.gid=d}g.filter=function(){if(this.type.match(/^.*Link$/)){debug("excluding symbolic link: "+this.path.substr(f.length+1)+" -> "+this.linkpath);return false}return true};type(a,function(n,l){if(n){return a.emit("error",n)}var k=a;if(l==="gzip"){k=k.pipe(zlib.Unzip());k.on("error",function(o){if(o){debug("unzip error")}a.emit("error",o)});l="tar"}if(l==="tar"){k.pipe(tar.Extract(g)).on("entry",i).on("error",function(o){if(o){debug("untar error")}a.emit("error",o)}).on("close",function(){a.emit("close")});return}if(l==="naked-file"&&h){var m={path:path.resolve(f,h)};if(!win32&&typeof e==="number"&&typeof d==="number"){m.uid=e;m.gid=d}k.pipe(fstream.Writer(m)).on("error",function(o){if(o){debug("copy error")}a.emit("error",o)}).on("close",function(){a.emit("close")});return}return cb(new Error("Unrecognised package type"))})}function type(c,d){c.on("error",a);c.on("data",b);function a(e){c.removeListener("data",b);c.removeListener("error",a)}function b(e){if(e[0]===31&&e[1]===139&&e[2]===8){d(null,"gzip")}else{if(e.toString().match(/^package\/\u0000/)){d(null,"tar")}else{d(null,"naked-file")}}c.removeListener("data",b);c.removeListener("error",a);c.unshift(e)}};