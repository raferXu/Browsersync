"use strict";var core=require("./core");var curve255=require("./curve255");var utils=require("./utils");var BigInteger=require("jsbn").BigInteger;var crypto=require("crypto");var ns={};function _bi255(a){if(!(this instanceof _bi255)){return new _bi255(a)}if(typeof a==="undefined"){return _ZERO}var b=a.constructor;if((b===Array||b===Uint16Array||b===Uint32Array)&&(a.length===16)){this.n=a}else{if((b===Array)&&(a.length===32)){this.n=_bytes2bi255(a).n}else{if(b===String){this.n=utils.hexDecode(a)}else{if(b===Number){this.n=[a&65535,a>>16,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}else{if(a instanceof _bi255){this.n=a.n.slice(0)}else{throw"Bad argument for bignum: "+a}}}}}}_bi255.prototype={toString:function(){return utils.hexEncode(this.n)},toSource:function(){return"_"+utils.hexEncode(this.n)},plus:function(a){return _bi255(core.bigintadd(this.n,a.n))},minus:function(a){return _bi255(core.bigintsub(this.n,a.n)).modq()},times:function(a){return _bi255(core.mulmodp(this.n,a.n))},divide:function(a){return this.times(a.inv())},sqr:function(){return _bi255(core.sqrmodp(this.n))},cmp:function(a){return core.bigintcmp(this.n,a.n)},equals:function(a){return this.cmp(a)===0},isOdd:function(){return(this.n[0]&1)===1},shiftLeft:function(a){_shiftL(this.n,a);return this},shiftRight:function(a){_shiftR(this.n,a);return this},inv:function(){return _bi255(core.invmodp(this.n))},pow:function(a){return _bi255(_pow(this.n,a.n))},modq:function(){return _modq(this)},bytes:function(){return _bi255_bytes(this)}};function _shiftL(e,b){var d=0;for(var a=0;a<16;a++){var c=e[a]>>(16-b);e[a]=(e[a]<<b)&65535|d;d=c}return e}function _shiftR(e,b){var d=0;for(var a=15;a>=0;a--){var c=e[a]<<(16-b)&65535;e[a]=(e[a]>>b)|d;d=c}return e}function _bi255_bytes(d){d=_bi255(d);var b=new Array(32);for(var c=31;c>=0;c--){b[c]=d.n[0]&255;d.shiftRight(8)}return b}function _bytes2bi255(b){var d=_ZERO;for(var c=0;c<32;c++){d.shiftLeft(8);d=d.plus(_bi255(b[c]))}return d}function _pow(d,c){var a=core.ONE();for(var b=0;b<256;b++){if(core.getbit(c,b)===1){a=core.mulmodp(a,d)}d=core.sqrmodp(d)}return a}var _ZERO=_bi255(0);var _ONE=_bi255(1);var _TWO=_bi255(2);var _Q=_bi255([65535-18,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,32767]);function _modq(a){core.reduce(a.n);if(a.cmp(_Q)>=0){return _modq(a.minus(_Q))}if(a.cmp(_ZERO)===-1){return _modq(a.plus(_Q))}else{return a}}var _RECOVERY_EXPONENT=_bi255("0ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe");var _D=_bi255("52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3");var _I=_bi255("2b8324804fc1df0b2b4d00993dfbd7a72f431806ad2fe478c4ee1b274a0ea0b0");var _L=_bi255("1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed");var _L_BI=_bi("1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed",16);function _isoncurve(e){var a=e[0];var f=e[1];var d=a.sqr();var c=f.sqr();var b=_D.times(d).times(c);return c.minus(d).minus(_ONE).minus(b).modq().equals(_ZERO)}function _xrecover(d){var b=d.sqr();var c=b.minus(_ONE).divide(_ONE.plus(_D.times(b)));var a=c.pow(_RECOVERY_EXPONENT);if(!(a.times(a).minus(c).equals(_ZERO))){a=a.times(_I)}if(a.isOdd()){a=_Q.minus(a)}return a}function _x_pt_add(d,c){var r=d[0];var b=d[1];var j=d[2];var f=d[3];var q=c[0];var a=c[1];var h=c[2];var e=c[3];var p=b.minus(r).times(a.plus(q));var o=b.plus(r).times(a.minus(q));var n=j.times(_TWO).times(e);var m=f.times(_TWO).times(h);var l=m.plus(n);var k=o.minus(p);var i=o.plus(p);var g=m.minus(n);return[l.times(k),i.times(g),k.times(i),l.times(g)]}function _xpt_double(j){var d=j[0];var h=j[1];var f=j[2];var e=d.times(d);var c=h.times(h);var b=_TWO.times(f).times(f);var a=_Q.minus(e);var g=d.plus(h);var m=g.times(g).minus(e).minus(c);var k=a.plus(c);var l=k.minus(b);var i=a.minus(c);return[m.times(l),k.times(i),l.times(k),m.times(i)]}function _xpt_mult(c,d){if(d.equals(_ZERO)){return[_ZERO,_ONE,_ONE,_ZERO]}var b=d.isOdd();d.shiftRight(1);var a=_xpt_double(_xpt_mult(c,d));return b?_x_pt_add(a,c):a}function _pt_xform(b){var a=b[0];var c=b[1];return[a,c,_ONE,a.times(c)]}function _pt_unxform(c){var a=c[0];var e=c[1];var d=c[2];var b=d.inv();return[a.times(b),e.times(b)]}function _scalarmult(a,b){return _pt_unxform(_xpt_mult(_pt_xform(a),b))}function _bytesgetbit(a,b){return(a[a.length-(b>>>3)-1]>>(b&7))&1}function _xpt_mult_bytes(d,a){var c=[_ZERO,_ONE,_ONE,_ZERO];for(var b=(a.length<<3)-1;b>=0;b--){c=_xpt_double(c);if(_bytesgetbit(a,b)===1){c=_x_pt_add(c,d)}}return c}function _scalarmultBytes(b,a){return _pt_unxform(_xpt_mult_bytes(_pt_xform(b),a))}var _by=_bi255(4).divide(_bi255(5));var _bx=_xrecover(_by);var _bp=[_bx,_by];function _encodeint(a){return a.bytes(32).reverse()}function _decodeint(a){return _bi255(a.slice(0).reverse())}function _encodepoint(b){var a=_encodeint(b[1]);if(b[0].isOdd()){a[31]|=128}return a}function _decodepoint(c){c=c.slice(0);var b=c[31]>>7;c[31]&=127;var e=_decodeint(c);var a=_xrecover(e);if((a.n[0]&1)!==b){a=_Q.minus(a)}var d=[a,e];if(!_isoncurve(d)){throw ("Point is not on curve")}return d}function _bi(b,a){if(a!==undefined){if(a===256){return _bi(utils.string2bytes(b))}return new BigInteger(b,a)}else{if(typeof b==="string"){return new BigInteger(b,10)}else{if((b instanceof Array)||(b instanceof Uint8Array)||Buffer.isBuffer(b)){return new BigInteger(b)}else{if(typeof b==="number"){return new BigInteger(b.toString(),10)}else{throw"Can't convert "+b+" to BigInteger"}}}}}function _bi2bytes(d,c){if(c===undefined){c=(d.bitLength()+7)>>>3}var a=new Array(c);for(var b=c-1;b>=0;b--){a[b]=d[0]&255;d=d.shiftRight(8)}return a}BigInteger.prototype.bytes=function(a){return _bi2bytes(this,a)};function _bytehash(b){var a=crypto.createHash("sha512").update(b).digest();return _bi2bytes(_bi(a),64).reverse()}function _stringhash(b){var a=crypto.createHash("sha512").update(b).digest();return _map(_chr,_bi2bytes(_bi(a),64)).join("")}function _inthash(a){return _bi([0].concat(_bytehash(a)))}function _inthash_lo(a){return _bi255(_bytehash(a).slice(32,64))}function _inthash_mod_l(a){return _inthash(a).mod(_L_BI)}function _get_a(c){var b=_inthash_lo(c);b.n[0]&=65528;b.n[15]&=16383;b.n[15]|=16384;return b}function _publickey(a){return _encodepoint(_scalarmult(_bp,_get_a(a)))}function _map(d,b){var a=new Array(b.length);for(var c=0;c<b.length;c++){a[c]=d(b[c])}return a}function _chr(a){return String.fromCharCode(a)}function _ord(a){return a.charCodeAt(0)}function _pt_add(b,a){return _pt_unxform(_x_pt_add(_pt_xform(b),_pt_xform(a)))}ns.isOnCurve=function(a){try{_isoncurve(_decodepoint(utils.string2bytes(a)))}catch(b){if(b==="Point is not on curve"){return false}else{throw b}}return true};ns.publicKey=function(a){return utils.bytes2string(_publickey(a))};ns.sign=function(j,c,f){if(f===undefined){f=_publickey(c)}else{f=utils.string2bytes(f)}var g=_bi(_get_a(c).toString(),16);var h=_stringhash(c);var b=_bytehash(h.slice(32,64)+j);var e=_scalarmultBytes(_bp,b);var d=_encodepoint(e);b=_bi(b).mod(_bi(1,10).shiftLeft(512));var i=_map(_chr,d).join("")+_map(_chr,f).join("")+j;i=_inthash_mod_l(i).multiply(g).add(b).mod(_L_BI);return utils.bytes2string(d.concat(_encodeint(i)))};ns.verify=function(b,l,f){b=utils.string2bytes(b.slice(0,64));f=utils.string2bytes(f);var c=b.slice(0,32);var d=_decodepoint(c);var i=_decodepoint(f);var m=_decodeint(b.slice(32,64));var e=_inthash(utils.bytes2string(c.concat(f))+l);var k=_scalarmult(_bp,m);var j=_scalarmultBytes(i,_bi2bytes(e));var g=_pt_add(d,j);return k[0].equals(g[0])&&k[1].equals(g[1])};ns.generateKeySeed=function(){return core.generateKey(false)};module.exports=ns;