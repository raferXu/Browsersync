var fs=require("./fs.js");var constants=require("constants");var origCwd=process.cwd;var cwd=null;var platform=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){if(!cwd){cwd=origCwd.call(process)}return cwd};try{process.cwd()}catch(er){}var chdir=process.chdir;process.chdir=function(a){cwd=null;chdir.call(process,a)};module.exports=patch;function patch(a){if(constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)){patchLchmod(a)}if(!a.lutimes){patchLutimes(a)}a.chown=chownFix(a.chown);a.fchown=chownFix(a.fchown);a.lchown=chownFix(a.lchown);a.chmod=chmodFix(a.chmod);a.fchmod=chmodFix(a.fchmod);a.lchmod=chmodFix(a.lchmod);a.chownSync=chownFixSync(a.chownSync);a.fchownSync=chownFixSync(a.fchownSync);a.lchownSync=chownFixSync(a.lchownSync);a.chmodSync=chmodFixSync(a.chmodSync);a.fchmodSync=chmodFixSync(a.fchmodSync);a.lchmodSync=chmodFixSync(a.lchmodSync);a.stat=statFix(a.stat);a.fstat=statFix(a.fstat);a.lstat=statFix(a.lstat);a.statSync=statFixSync(a.statSync);a.fstatSync=statFixSync(a.fstatSync);a.lstatSync=statFixSync(a.lstatSync);if(!a.lchmod){a.lchmod=function(c,d,b){if(b){process.nextTick(b)}};a.lchmodSync=function(){}}if(!a.lchown){a.lchown=function(e,c,d,b){if(b){process.nextTick(b)}};a.lchownSync=function(){}}if(platform==="win32"){a.rename=(function(b){return function(h,g,c){var f=Date.now();var e=0;b(h,g,function d(i){if(i&&(i.code==="EACCES"||i.code==="EPERM")&&Date.now()-f<60000){setTimeout(function(){a.stat(g,function(k,j){if(k&&k.code==="ENOENT"){b(h,g,d)}else{c(i)}})},e);if(e<100){e+=10}return}if(c){c(i)}})}})(a.rename)}a.read=(function(b){return function(f,d,i,g,c,e){var j;if(e&&typeof e==="function"){var h=0;j=function(m,k,l){if(m&&m.code==="EAGAIN"&&h<10){h++;return b.call(a,f,d,i,g,c,j)}e.apply(this,arguments)}}return b.call(a,f,d,i,g,c,j)}})(a.read);a.readSync=(function(b){return function(e,d,h,f,c){var g=0;while(true){try{return b.call(a,e,d,h,f,c)}catch(i){if(i.code==="EAGAIN"&&g<10){g++;continue}throw i}}}})(a.readSync)}function patchLchmod(a){a.lchmod=function(b,c,d){a.open(b,constants.O_WRONLY|constants.O_SYMLINK,c,function(f,e){if(f){if(d){d(f)}return}a.fchmod(e,c,function(g){a.close(e,function(h){if(d){d(g||h)}})})})};a.lchmodSync=function(d,e){var c=a.openSync(d,constants.O_WRONLY|constants.O_SYMLINK,e);var g=true;var b;try{b=a.fchmodSync(c,e);g=false}finally{if(g){try{a.closeSync(c)}catch(f){}}else{a.closeSync(c)}}return b}}function patchLutimes(a){if(constants.hasOwnProperty("O_SYMLINK")){a.lutimes=function(e,c,d,b){a.open(e,constants.O_SYMLINK,function(g,f){if(g){if(b){b(g)}return}a.futimes(f,c,d,function(h){a.close(f,function(i){if(b){b(h||i)}})})})};a.lutimesSync=function(f,b,c){var e=a.openSync(f,constants.O_SYMLINK);var d;var h=true;try{d=a.futimesSync(e,b,c);h=false}finally{if(h){try{a.closeSync(e)}catch(g){}}else{a.closeSync(e)}}return d}}else{a.lutimes=function(e,d,c,b){if(b){process.nextTick(b)}};a.lutimesSync=function(){}}}function chmodFix(a){if(!a){return a}return function(c,d,b){return a.call(fs,c,d,function(e){if(chownErOk(e)){e=null}if(b){b.apply(this,arguments)}})}}function chmodFixSync(a){if(!a){return a}return function(b,c){try{return a.call(fs,b,c)}catch(d){if(!chownErOk(d)){throw d}}}}function chownFix(a){if(!a){return a}return function(e,c,d,b){return a.call(fs,e,c,d,function(f){if(chownErOk(f)){f=null}if(b){b.apply(this,arguments)}})}}function chownFixSync(a){if(!a){return a}return function(d,b,c){try{return a.call(fs,d,b,c)}catch(e){if(!chownErOk(e)){throw e}}}}function statFix(a){if(!a){return a}return function(c,b){return a.call(fs,c,function(e,d){if(!d){return b.apply(this,arguments)}if(d.uid<0){d.uid+=4294967296}if(d.gid<0){d.gid+=4294967296}if(b){b.apply(this,arguments)}})}}function statFixSync(a){if(!a){return a}return function(c){var b=a.call(fs,c);if(b.uid<0){b.uid+=4294967296}if(b.gid<0){b.gid+=4294967296}return b}}function chownErOk(b){if(!b){return true}if(b.code==="ENOSYS"){return true}var a=!process.getuid||process.getuid()!==0;if(a){if(b.code==="EINVAL"||b.code==="EPERM"){return true}}return false};