"use strict";var net=require("net"),tls=require("tls"),http=require("http"),https=require("https"),events=require("events"),assert=require("assert"),util=require("util"),Buffer=require("safe-buffer").Buffer;exports.httpOverHttp=httpOverHttp;exports.httpsOverHttp=httpsOverHttp;exports.httpOverHttps=httpOverHttps;exports.httpsOverHttps=httpsOverHttps;function httpOverHttp(a){var b=new TunnelingAgent(a);b.request=http.request;return b}function httpsOverHttp(a){var b=new TunnelingAgent(a);b.request=http.request;b.createSocket=createSecureSocket;b.defaultPort=443;return b}function httpOverHttps(a){var b=new TunnelingAgent(a);b.request=https.request;return b}function httpsOverHttps(a){var b=new TunnelingAgent(a);b.request=https.request;b.createSocket=createSecureSocket;b.defaultPort=443;return b}function TunnelingAgent(b){var a=this;a.options=b||{};a.proxyOptions=a.options.proxy||{};a.maxSockets=a.options.maxSockets||http.Agent.defaultMaxSockets;a.requests=[];a.sockets=[];a.on("free",function c(e,h,f){for(var g=0,d=a.requests.length;g<d;++g){var j=a.requests[g];if(j.host===h&&j.port===f){a.requests.splice(g,1);j.request.onSocket(e);return}}e.destroy();a.removeSocket(e)})}util.inherits(TunnelingAgent,events.EventEmitter);TunnelingAgent.prototype.addRequest=function addRequest(c,b){var a=this;if(typeof b==="string"){b={host:b,port:arguments[2],path:arguments[3]}}if(a.sockets.length>=this.maxSockets){a.requests.push({host:b.host,port:b.port,request:c});return}a.createConnection({host:b.host,port:b.port,request:c})};TunnelingAgent.prototype.createConnection=function createConnection(b){var a=this;a.createSocket(b,function(c){c.on("free",d);c.on("close",e);c.on("agentRemove",e);b.request.onSocket(c);function d(){a.emit("free",c,b.host,b.port)}function e(f){a.removeSocket(c);c.removeListener("free",d);c.removeListener("close",e);c.removeListener("agentRemove",e)}})};TunnelingAgent.prototype.createSocket=function createSocket(j,b){var h=this;var f={};h.sockets.push(f);var a=mergeOptions({},h.proxyOptions,{method:"CONNECT",path:j.host+":"+j.port,agent:false});if(a.proxyAuth){a.headers=a.headers||{};a.headers["Proxy-Authorization"]="Basic "+Buffer.from(a.proxyAuth).toString("base64")}debug("making CONNECT request");var e=h.request(a);e.useChunkedEncodingByDefault=false;e.once("response",d);e.once("upgrade",g);e.once("connect",i);e.once("error",c);e.end();function d(k){k.upgrade=true}function g(m,k,l){process.nextTick(function(){i(m,k,l)})}function i(n,k,m){e.removeAllListeners();k.removeAllListeners();if(n.statusCode===200){assert.equal(m.length,0);debug("tunneling connection has established");h.sockets[h.sockets.indexOf(f)]=k;b(k)}else{debug("tunneling socket could not be established, statusCode=%d",n.statusCode);var l=new Error("tunneling socket could not be established, statusCode="+n.statusCode);l.code="ECONNRESET";j.request.emit("error",l);h.removeSocket(f)}}function c(l){e.removeAllListeners();debug("tunneling socket could not be established, cause=%s\n",l.message,l.stack);var k=new Error("tunneling socket could not be established, cause="+l.message);k.code="ECONNRESET";j.request.emit("error",k);h.removeSocket(f)}};TunnelingAgent.prototype.removeSocket=function removeSocket(a){var c=this.sockets.indexOf(a);if(c===-1){return}this.sockets.splice(c,1);var b=this.requests.shift();if(b){this.createConnection(b)}};function createSecureSocket(c,a){var b=this;TunnelingAgent.prototype.createSocket.call(b,c,function(d){var e=tls.connect(0,mergeOptions({},b.options,{servername:c.host,socket:d}));b.sockets[b.sockets.indexOf(d)]=e;a(e)})}function mergeOptions(g){for(var e=1,a=arguments.length;e<a;++e){var h=arguments[e];if(typeof h==="object"){var f=Object.keys(h);for(var d=0,c=f.length;d<c;++d){var b=f[d];if(h[b]!==undefined){g[b]=h[b]}}}}return g}var debug;if(process.env.NODE_DEBUG&&/\btunnel\b/.test(process.env.NODE_DEBUG)){debug=function(){var a=Array.prototype.slice.call(arguments);if(typeof a[0]==="string"){a[0]="TUNNEL: "+a[0]}else{a.unshift("TUNNEL:")}console.error.apply(console,a)}}else{debug=function(){}}exports.debug=debug;