"use strict";var util=require("util");var TrackerBase=require("./tracker-base.js");var Tracker=require("./tracker.js");var TrackerStream=require("./tracker-stream.js");var TrackerGroup=module.exports=function(a){TrackerBase.call(this,a);this.parentGroup=null;this.trackers=[];this.completion={};this.weight={};this.totalWeight=0;this.finished=false;this.bubbleChange=bubbleChange(this)};util.inherits(TrackerGroup,TrackerBase);function bubbleChange(a){return function(b,c,d){a.completion[d.id]=c;if(a.finished){return}a.emit("change",b||a.name,a.completed(),a)}}TrackerGroup.prototype.nameInTree=function(){var a=[];var b=this;while(b){a.unshift(b.name);b=b.parentGroup}return a.join("/")};TrackerGroup.prototype.addUnit=function(a,b){if(a.addUnit){var c=this;while(c){if(a===c){throw new Error("Attempted to add tracker group "+a.name+" to tree that already includes it "+this.nameInTree(this))}c=c.parentGroup}a.parentGroup=this}this.weight[a.id]=b||1;this.totalWeight+=this.weight[a.id];this.trackers.push(a);this.completion[a.id]=a.completed();a.on("change",this.bubbleChange);if(!this.finished){this.emit("change",a.name,this.completion[a.id],a)}return a};TrackerGroup.prototype.completed=function(){if(this.trackers.length===0){return 0}var d=1/this.totalWeight;var c=0;for(var b=0;b<this.trackers.length;b++){var a=this.trackers[b].id;c+=d*this.weight[a]*this.completion[a]}return c};TrackerGroup.prototype.newGroup=function(a,b){return this.addUnit(new TrackerGroup(a),b)};TrackerGroup.prototype.newItem=function(b,a,c){return this.addUnit(new Tracker(b,a),c)};TrackerGroup.prototype.newStream=function(b,a,c){return this.addUnit(new TrackerStream(b,a),c)};TrackerGroup.prototype.finish=function(){this.finished=true;if(!this.trackers.length){this.addUnit(new Tracker(),1,true)}for(var a=0;a<this.trackers.length;a++){var b=this.trackers[a];b.finish();b.removeListener("change",this.bubbleChange)}this.emit("change",this.name,1,this)};var buffer="                                  ";TrackerGroup.prototype.debug=function(c){c=c||0;var a=c?buffer.substr(0,c):"";var b=a+(this.name||"top")+": "+this.completed()+"\n";this.trackers.forEach(function(d){if(d instanceof TrackerGroup){b+=d.debug(c+1)}else{b+=a+" "+d.name+": "+d.completed()+"\n"}});return b};