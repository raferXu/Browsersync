var util=require("util");var Stream=require("stream");var StringDecoder=require("string_decoder").StringDecoder;module.exports=StringStream;module.exports.AlignedStringDecoder=AlignedStringDecoder;function StringStream(b,a){if(!(this instanceof StringStream)){return new StringStream(b,a)}Stream.call(this);if(b==null){b="utf8"}this.readable=this.writable=true;this.paused=false;this.toEncoding=(a==null?b:a);this.fromEncoding=(a==null?"":b);this.decoder=new AlignedStringDecoder(this.toEncoding)}util.inherits(StringStream,Stream);StringStream.prototype.write=function(c){if(!this.writable){var b=new Error("stream not writable");b.code="EPIPE";this.emit("error",b);return false}if(this.fromEncoding){if(Buffer.isBuffer(c)){c=c.toString()}c=new Buffer(c,this.fromEncoding)}var a=this.decoder.write(c);if(a.length){this.emit("data",a)}return !this.paused};StringStream.prototype.flush=function(){if(this.decoder.flush){var a=this.decoder.flush();if(a.length){this.emit("data",a)}}};StringStream.prototype.end=function(){if(!this.writable&&!this.readable){return}this.flush();this.emit("end");this.writable=this.readable=false;this.destroy()};StringStream.prototype.destroy=function(){this.decoder=null;this.writable=this.readable=false;this.emit("close")};StringStream.prototype.pause=function(){this.paused=true};StringStream.prototype.resume=function(){if(this.paused){this.emit("drain")}this.paused=false};function AlignedStringDecoder(a){StringDecoder.call(this,a);switch(this.encoding){case"base64":this.write=alignedWrite;this.alignedBuffer=new Buffer(3);this.alignedBytes=0;break}}util.inherits(AlignedStringDecoder,StringDecoder);AlignedStringDecoder.prototype.flush=function(){if(!this.alignedBuffer||!this.alignedBytes){return""}var a=this.alignedBuffer.toString(this.encoding,0,this.alignedBytes);this.alignedBytes=0;return a};function alignedWrite(a){var c=(this.alignedBytes+a.length)%this.alignedBuffer.length;if(!c&&!this.alignedBytes){return a.toString(this.encoding)}var b=new Buffer(this.alignedBytes+a.length-c);this.alignedBuffer.copy(b,0,0,this.alignedBytes);a.copy(b,this.alignedBytes,0,a.length-c);a.copy(this.alignedBuffer,0,a.length-c,a.length);this.alignedBytes=c;return b.toString(this.encoding)};