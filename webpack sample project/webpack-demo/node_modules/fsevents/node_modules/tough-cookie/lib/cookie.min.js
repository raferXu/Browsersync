/*!
 * Copyright (c) 2015, Salesforce.com, Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 * this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation
 * and/or other materials provided with the distribution.
 *
 * 3. Neither the name of Salesforce.com nor the names of its contributors may
 * be used to endorse or promote products derived from this software without
 * specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */
;"use strict";var net=require("net");var urlParse=require("url").parse;var pubsuffix=require("./pubsuffix");var Store=require("./store").Store;var MemoryCookieStore=require("./memstore").MemoryCookieStore;var pathMatch=require("./pathMatch").pathMatch;var VERSION=require("../package.json").version;var punycode;try{punycode=require("punycode")}catch(e){console.warn("cookie: can't load punycode; won't use punycode for domain normalization")}var DATE_DELIM=/[\x09\x20-\x2F\x3B-\x40\x5B-\x60\x7B-\x7E]/;var COOKIE_OCTET=/[\x21\x23-\x2B\x2D-\x3A\x3C-\x5B\x5D-\x7E]/;var COOKIE_OCTETS=new RegExp("^"+COOKIE_OCTET.source+"+$");var CONTROL_CHARS=/[\x00-\x1F]/;var COOKIE_PAIR=/^(([^=;]+))\s*=\s*([^\n\r\0]*)/;var LOOSE_COOKIE_PAIR=/^((?:=)?([^=;]*)\s*=\s*)?([^\n\r\0]*)/;var PATH_VALUE=/[\x20-\x3A\x3C-\x7E]+/;var DAY_OF_MONTH=/^(\d{1,2})[^\d]*$/;var TIME=/^(\d{1,2})[^\d]*:(\d{1,2})[^\d]*:(\d{1,2})[^\d]*$/;var MONTH=/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i;var MONTH_TO_NUM={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};var NUM_TO_MONTH=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var NUM_TO_DAY=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var YEAR=/^(\d{2}|\d{4})$/;var MAX_TIME=2147483647000;var MIN_TIME=0;function parseDate(g){if(!g){return}var h=g.split(DATE_DELIM);if(!h){return}var c=null;var b=null;var l=null;var k=null;var f=null;var j=null;for(var d=0;d<h.length;d++){var a=h[d].trim();if(!a.length){continue}var m;if(l===null){m=TIME.exec(a);if(m){c=parseInt(m[1],10);b=parseInt(m[2],10);l=parseInt(m[3],10);if(c>23||b>59||l>59){return}continue}}if(k===null){m=DAY_OF_MONTH.exec(a);if(m){k=parseInt(m,10);if(k<1||k>31){return}continue}}if(f===null){m=MONTH.exec(a);if(m){f=MONTH_TO_NUM[m[1].toLowerCase()];continue}}if(j===null){m=YEAR.exec(a);if(m){j=parseInt(m[0],10);if(70<=j&&j<=99){j+=1900}else{if(0<=j&&j<=69){j+=2000}}if(j<1601){return}}}}if(l===null||k===null||f===null||j===null){return}return new Date(Date.UTC(j,f,k,c,b,l))}function formatDate(b){var g=b.getUTCDate();g=g>=10?g:"0"+g;var f=b.getUTCHours();f=f>=10?f:"0"+f;var a=b.getUTCMinutes();a=a>=10?a:"0"+a;var c=b.getUTCSeconds();c=c>=10?c:"0"+c;return NUM_TO_DAY[b.getUTCDay()]+", "+g+" "+NUM_TO_MONTH[b.getUTCMonth()]+" "+b.getUTCFullYear()+" "+f+":"+a+":"+c+" GMT"}function canonicalDomain(a){if(a==null){return null}a=a.trim().replace(/^\./,"");if(punycode&&/[^\u0001-\u007f]/.test(a)){a=punycode.toASCII(a)}return a.toLowerCase()}function domainMatch(d,c,b){if(d==null||c==null){return null}if(b!==false){d=canonicalDomain(d);c=canonicalDomain(c)}if(d==c){return true}if(net.isIP(d)){return false}var a=d.indexOf(c);if(a<=0){return false}if(d.length!==c.length+a){return false}if(d.substr(a-1,1)!=="."){return false}return true}function defaultPath(b){if(!b||b.substr(0,1)!=="/"){return"/"}if(b==="/"){return b}var a=b.lastIndexOf("/");if(a===0){return"/"}return b.slice(0,a)}function parse(m,p){if(!p||typeof p!=="object"){p={}}m=m.trim();var d=m.indexOf(";");var h=p.loose?LOOSE_COOKIE_PAIR:COOKIE_PAIR;var q=h.exec(d===-1?m:m.substr(0,d));if(!q){return}var l=new Cookie();if(q[1]){l.key=q[2].trim()}else{l.key=""}l.value=q[3].trim();if(CONTROL_CHARS.test(l.key)||CONTROL_CHARS.test(l.value)){return}if(d===-1){return l}var b=m.slice(d+1).trim();if(b.length===0){return l}var j=b.split(";");while(j.length){var a=j.shift().trim();if(a.length===0){continue}var n=a.indexOf("=");var k,i;if(n===-1){k=a;i=null}else{k=a.substr(0,n);i=a.substr(n+1)}k=k.trim().toLowerCase();if(i){i=i.trim()}switch(k){case"expires":if(i){var f=parseDate(i);if(f){l.expires=f}}break;case"max-age":if(i){if(/^-?[0-9]+$/.test(i)){var o=parseInt(i,10);l.setMaxAge(o)}}break;case"domain":if(i){var g=i.trim().replace(/^\./,"");if(g){l.domain=g.toLowerCase()}}break;case"path":l.path=i&&i[0]==="/"?i:null;break;case"secure":l.secure=true;break;case"httponly":l.httpOnly=true;break;default:l.extensions=l.extensions||[];l.extensions.push(a);break}}return l}function jsonParse(c){var b;try{b=JSON.parse(c)}catch(a){return a}return b}function fromJSON(d){if(!d){return null}var b;if(typeof d==="string"){b=jsonParse(d);if(b instanceof Error){return null}}else{b=d}var g=new Cookie();for(var a=0;a<Cookie.serializableProperties.length;a++){var f=Cookie.serializableProperties[a];if(b[f]===undefined||b[f]===Cookie.prototype[f]){continue}if(f==="expires"||f==="creation"||f==="lastAccessed"){if(b[f]===null){g[f]=null}else{g[f]=b[f]=="Infinity"?"Infinity":new Date(b[f])}}else{g[f]=b[f]}}return g}function cookieCompare(f,d){var i=0;var g=f.path?f.path.length:0;var c=d.path?d.path.length:0;i=c-g;if(i!==0){return i}var h=f.creation?f.creation.getTime():MAX_TIME;var j=d.creation?d.creation.getTime():MAX_TIME;i=h-j;if(i!==0){return i}i=f.creationIndex-d.creationIndex;return i}function permutePath(c){if(c==="/"){return["/"]}if(c.lastIndexOf("/")===c.length-1){c=c.substr(0,c.length-1)}var a=[c];while(c.length>1){var b=c.lastIndexOf("/");if(b===0){break}c=c.substr(0,b);a.push(c)}a.push("/");return a}function getCookieContext(a){if(a instanceof Object){return a}try{a=decodeURI(a)}catch(b){}return urlParse(a)}function Cookie(a){a=a||{};Object.keys(a).forEach(function(b){if(Cookie.prototype.hasOwnProperty(b)&&Cookie.prototype[b]!==a[b]&&b.substr(0,1)!=="_"){this[b]=a[b]}},this);this.creation=this.creation||new Date();Object.defineProperty(this,"creationIndex",{configurable:false,enumerable:false,writable:true,value:++Cookie.cookiesCreated})}Cookie.cookiesCreated=0;Cookie.parse=parse;Cookie.fromJSON=fromJSON;Cookie.prototype.key="";Cookie.prototype.value="";Cookie.prototype.expires="Infinity";Cookie.prototype.maxAge=null;Cookie.prototype.domain=null;Cookie.prototype.path=null;Cookie.prototype.secure=false;Cookie.prototype.httpOnly=false;Cookie.prototype.extensions=null;Cookie.prototype.hostOnly=null;Cookie.prototype.pathIsDefault=null;Cookie.prototype.creation=null;Cookie.prototype.lastAccessed=null;Object.defineProperty(Cookie.prototype,"creationIndex",{configurable:true,enumerable:false,writable:true,value:0});Cookie.serializableProperties=Object.keys(Cookie.prototype).filter(function(a){return !(Cookie.prototype[a] instanceof Function||a==="creationIndex"||a.substr(0,1)==="_")});Cookie.prototype.inspect=function inspect(){var a=Date.now();return'Cookie="'+this.toString()+"; hostOnly="+(this.hostOnly!=null?this.hostOnly:"?")+"; aAge="+(this.lastAccessed?(a-this.lastAccessed.getTime())+"ms":"?")+"; cAge="+(this.creation?(a-this.creation.getTime())+"ms":"?")+'"'};Cookie.prototype.toJSON=function(){var c={};var b=Cookie.serializableProperties;for(var a=0;a<b.length;a++){var d=b[a];if(this[d]===Cookie.prototype[d]){continue}if(d==="expires"||d==="creation"||d==="lastAccessed"){if(this[d]===null){c[d]=null}else{c[d]=this[d]=="Infinity"?"Infinity":this[d].toISOString()}}else{if(d==="maxAge"){if(this[d]!==null){c[d]=(this[d]==Infinity||this[d]==-Infinity)?this[d].toString():this[d]}}else{if(this[d]!==Cookie.prototype[d]){c[d]=this[d]}}}}return c};Cookie.prototype.clone=function(){return fromJSON(this.toJSON())};Cookie.prototype.validate=function validate(){if(!COOKIE_OCTETS.test(this.value)){return false}if(this.expires!=Infinity&&!(this.expires instanceof Date)&&!parseDate(this.expires)){return false}if(this.maxAge!=null&&this.maxAge<=0){return false}if(this.path!=null&&!PATH_VALUE.test(this.path)){return false}var a=this.cdomain();if(a){if(a.match(/\.$/)){return false}var b=pubsuffix.getPublicSuffix(a);if(b==null){return false}}return true};Cookie.prototype.setExpires=function setExpires(a){if(a instanceof Date){this.expires=a}else{this.expires=parseDate(a)||"Infinity"}};Cookie.prototype.setMaxAge=function setMaxAge(a){if(a===Infinity||a===-Infinity){this.maxAge=a.toString()}else{this.maxAge=a}};Cookie.prototype.cookieString=function cookieString(){var a=this.value;if(a==null){a=""}if(this.key===""){return a}return this.key+"="+a};Cookie.prototype.toString=function toString(){var a=this.cookieString();if(this.expires!=Infinity){if(this.expires instanceof Date){a+="; Expires="+formatDate(this.expires)}else{a+="; Expires="+this.expires}}if(this.maxAge!=null&&this.maxAge!=Infinity){a+="; Max-Age="+this.maxAge}if(this.domain&&!this.hostOnly){a+="; Domain="+this.domain}if(this.path){a+="; Path="+this.path}if(this.secure){a+="; Secure"}if(this.httpOnly){a+="; HttpOnly"}if(this.extensions){this.extensions.forEach(function(b){a+="; "+b})}return a};Cookie.prototype.TTL=function TTL(b){if(this.maxAge!=null){return this.maxAge<=0?0:this.maxAge*1000}var a=this.expires;if(a!=Infinity){if(!(a instanceof Date)){a=parseDate(a)||Infinity}if(a==Infinity){return Infinity}return a.getTime()-(b||Date.now())}return Infinity};Cookie.prototype.expiryTime=function expiryTime(b){if(this.maxAge!=null){var c=b||this.creation||new Date();var a=(this.maxAge<=0)?-Infinity:this.maxAge*1000;return c.getTime()+a}if(this.expires==Infinity){return Infinity}return this.expires.getTime()};Cookie.prototype.expiryDate=function expiryDate(a){var b=this.expiryTime(a);if(b==Infinity){return new Date(MAX_TIME)}else{if(b==-Infinity){return new Date(MIN_TIME)}else{return new Date(b)}}};Cookie.prototype.isPersistent=function isPersistent(){return(this.maxAge!=null||this.expires!=Infinity)};Cookie.prototype.cdomain=Cookie.prototype.canonicalizedDomain=function canonicalizedDomain(){if(this.domain==null){return null}return canonicalDomain(this.domain)};function CookieJar(a,b){if(typeof b==="boolean"){b={rejectPublicSuffixes:b}}else{if(b==null){b={}}}if(b.rejectPublicSuffixes!=null){this.rejectPublicSuffixes=b.rejectPublicSuffixes}if(b.looseMode!=null){this.enableLooseMode=b.looseMode}if(!a){a=new MemoryCookieStore()}this.store=a}CookieJar.prototype.store=null;CookieJar.prototype.rejectPublicSuffixes=true;CookieJar.prototype.enableLooseMode=false;var CAN_BE_SYNC=[];CAN_BE_SYNC.push("setCookie");CookieJar.prototype.setCookie=function(d,b,m,g){var h;var f=getCookieContext(b);if(m instanceof Function){g=m;m={}}var l=canonicalDomain(f.hostname);var i=this.enableLooseMode;if(m.loose!=null){i=m.loose}if(!(d instanceof Cookie)){d=Cookie.parse(d,{loose:i})}if(!d){h=new Error("Cookie failed to parse");return g(m.ignoreError?null:h)}var c=m.now||new Date();if(this.rejectPublicSuffixes&&d.domain){var k=pubsuffix.getPublicSuffix(d.cdomain());if(k==null){h=new Error("Cookie has domain set to a public suffix");return g(m.ignoreError?null:h)}}if(d.domain){if(!domainMatch(l,d.cdomain(),false)){h=new Error("Cookie not in this host's domain. Cookie:"+d.cdomain()+" Request:"+l);return g(m.ignoreError?null:h)}if(d.hostOnly==null){d.hostOnly=false}}else{d.hostOnly=true;d.domain=l}if(!d.path||d.path[0]!=="/"){d.path=defaultPath(f.pathname);d.pathIsDefault=true}if(m.http===false&&d.httpOnly){h=new Error("Cookie is HttpOnly and this isn't an HTTP API");return g(m.ignoreError?null:h)}var j=this.store;if(!j.updateCookie){j.updateCookie=function(o,p,n){this.putCookie(p,n)}}function a(p,n){if(p){return g(p)}var o=function(q){if(q){return g(q)}else{g(null,d)}};if(n){if(m.http===false&&n.httpOnly){p=new Error("old Cookie is HttpOnly and this isn't an HTTP API");return g(m.ignoreError?null:p)}d.creation=n.creation;d.creationIndex=n.creationIndex;d.lastAccessed=c;j.updateCookie(n,d,o)}else{d.creation=d.lastAccessed=c;j.putCookie(d,o)}}j.findCookie(d.domain,d.path,d.key,a)};CAN_BE_SYNC.push("getCookies");CookieJar.prototype.getCookies=function(c,n,g){var f=getCookieContext(c);if(n instanceof Function){g=n;n={}}var k=canonicalDomain(f.hostname);var m=f.pathname||"/";var a=n.secure;if(a==null&&f.protocol&&(f.protocol=="https:"||f.protocol=="wss:")){a=true}var i=n.http;if(i==null){i=true}var d=n.now||Date.now();var b=n.expire!==false;var l=!!n.allPaths;var h=this.store;function j(o){if(o.hostOnly){if(o.domain!=k){return false}}else{if(!domainMatch(k,o.domain,false)){return false}}if(!l&&!pathMatch(m,o.path)){return false}if(o.secure&&!a){return false}if(o.httpOnly&&!i){return false}if(b&&o.expiryTime()<=d){h.removeCookie(o.domain,o.path,o.key,function(){});return false}return true}h.findCookies(k,l?null:m,function(q,p){if(q){return g(q)}p=p.filter(j);if(n.sort!==false){p=p.sort(cookieCompare)}var o=new Date();p.forEach(function(r){r.lastAccessed=o});g(null,p)})};CAN_BE_SYNC.push("getCookieString");CookieJar.prototype.getCookieString=function(){var b=Array.prototype.slice.call(arguments,0);var a=b.pop();var c=function(f,d){if(f){a(f)}else{a(null,d.sort(cookieCompare).map(function(g){return g.cookieString()}).join("; "))}};b.push(c);this.getCookies.apply(this,b)};CAN_BE_SYNC.push("getSetCookieStrings");CookieJar.prototype.getSetCookieStrings=function(){var b=Array.prototype.slice.call(arguments,0);var a=b.pop();var c=function(f,d){if(f){a(f)}else{a(null,d.map(function(g){return g.toString()}))}};b.push(c);this.getCookies.apply(this,b)};CAN_BE_SYNC.push("serialize");CookieJar.prototype.serialize=function(a){var b=this.store.constructor.name;if(b==="Object"){b=null}var c={version:"tough-cookie@"+VERSION,storeType:b,rejectPublicSuffixes:!!this.rejectPublicSuffixes,cookies:[]};if(!(this.store.getAllCookies&&typeof this.store.getAllCookies==="function")){return a(new Error("store does not support getAllCookies and cannot be serialized"))}this.store.getAllCookies(function(f,d){if(f){return a(f)}c.cookies=d.map(function(g){g=(g instanceof Cookie)?g.toJSON():g;delete g.creationIndex;return g});return a(null,c)})};CookieJar.prototype.toJSON=function(){return this.serializeSync()};CAN_BE_SYNC.push("_importCookies");CookieJar.prototype._importCookies=function(f,a){var c=this;var b=f.cookies;if(!b||!Array.isArray(b)){return a(new Error("serialized jar has no cookies array"))}function d(h){if(h){return a(h)}if(!b.length){return a(h,c)}var g;try{g=fromJSON(b.shift())}catch(i){return a(i)}if(g===null){return d(null)}c.store.putCookie(g,d)}d()};CookieJar.deserialize=function(b,c,a){if(arguments.length!==3){a=c;c=null}var f;if(typeof b==="string"){f=jsonParse(b);if(f instanceof Error){return a(f)}}else{f=b}var d=new CookieJar(c,f.rejectPublicSuffixes);d._importCookies(f,function(g){if(g){return a(g)}a(null,d)})};CookieJar.deserializeSync=function(a,b){var d=typeof a==="string"?JSON.parse(a):a;var c=new CookieJar(b,d.rejectPublicSuffixes);if(!c.store.synchronous){throw new Error("CookieJar store is not synchronous; use async API instead.")}c._importCookiesSync(d);return c};CookieJar.fromJSON=CookieJar.deserializeSync;CAN_BE_SYNC.push("clone");CookieJar.prototype.clone=function(b,a){if(arguments.length===1){a=b;b=null}this.serialize(function(c,d){if(c){return a(c)}CookieJar.deserialize(b,d,a)})};function syncWrap(a){return function(){if(!this.store.synchronous){throw new Error("CookieJar store is not synchronous; use async API instead.")}var c=Array.prototype.slice.call(arguments);var b,d;c.push(function f(h,g){b=h;d=g});this[a].apply(this,c);if(b){throw b}return d}}CAN_BE_SYNC.forEach(function(a){CookieJar.prototype[a+"Sync"]=syncWrap(a)});module.exports={CookieJar:CookieJar,Cookie:Cookie,Store:Store,MemoryCookieStore:MemoryCookieStore,parseDate:parseDate,formatDate:formatDate,parse:parse,fromJSON:fromJSON,domainMatch:domainMatch,defaultPath:defaultPath,pathMatch:pathMatch,getPublicSuffix:pubsuffix.getPublicSuffix,cookieCompare:cookieCompare,permuteDomain:require("./permuteDomain").permuteDomain,permutePath:permutePath,canonicalDomain:canonicalDomain};