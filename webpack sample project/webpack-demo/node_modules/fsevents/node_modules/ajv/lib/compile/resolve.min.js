"use strict";var url=require("url"),equal=require("./equal"),util=require("./util"),SchemaObject=require("./schema_obj");module.exports=resolve;resolve.normalizeId=normalizeId;resolve.fullPath=getFullPath;resolve.url=resolveUrl;resolve.ids=resolveIds;resolve.inlineRef=inlineRef;resolve.schema=resolveSchema;function resolve(h,a,g){var f=this._refs[g];if(typeof f=="string"){if(this._refs[f]){f=this._refs[f]}else{return resolve.call(this,h,a,f)}}f=f||this._schemas[g];if(f instanceof SchemaObject){return inlineRef(f.schema,this._opts.inlineRefs)?f.schema:f.validate||this._compile(f)}var d=resolveSchema.call(this,a,g);var e,c,b;if(d){e=d.schema;a=d.root;b=d.baseId}if(e instanceof SchemaObject){c=e.validate||h.call(this,e.schema,a,undefined,b)}else{if(e){c=inlineRef(e,this._opts.inlineRefs)?e:h.call(this,e,a,undefined,b)}}return c}function resolveSchema(a,e){var f=url.parse(e,false,true),c=_getFullPath(f),b=getFullPath(a.schema.id);if(c!==b){var g=normalizeId(c);var d=this._refs[g];if(typeof d=="string"){return resolveRecursive.call(this,a,d,f)}else{if(d instanceof SchemaObject){if(!d.validate){this._compile(d)}a=d}else{d=this._schemas[g];if(d instanceof SchemaObject){if(!d.validate){this._compile(d)}if(g==normalizeId(e)){return{schema:d,root:a,baseId:b}}a=d}else{return}}}if(!a.schema){return}b=getFullPath(a.schema.id)}return getJsonPointer.call(this,f,b,a.schema,a)}function resolveRecursive(a,e,f){var c=resolveSchema.call(this,a,e);if(c){var d=c.schema;var b=c.baseId;a=c.root;if(d.id){b=resolveUrl(b,d.id)}return getJsonPointer.call(this,f,b,d,a)}}var PREVENT_SCOPE_CHANGE=util.toHash(["properties","patternProperties","enum","dependencies","definitions"]);function getJsonPointer(f,j,b,g){f.hash=f.hash||"";if(f.hash.slice(0,2)!="#/"){return}var c=f.hash.split("/");for(var d=1;d<c.length;d++){var a=c[d];if(a){a=util.unescapeFragment(a);b=b[a];if(!b){break}if(b.id&&!PREVENT_SCOPE_CHANGE[a]){j=resolveUrl(j,b.id)}if(b.$ref){var h=resolveUrl(j,b.$ref);var e=resolveSchema.call(this,g,h);if(e){b=e.schema;g=e.root;j=e.baseId}}}}if(b&&b!=g.schema){return{schema:b,root:g,baseId:j}}}var SIMPLE_INLINED=util.toHash(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum"]);function inlineRef(b,a){if(a===false){return false}if(a===undefined||a===true){return checkNoRef(b)}else{if(a){return countKeys(b)<=a}}}function checkNoRef(d){var c;if(Array.isArray(d)){for(var b=0;b<d.length;b++){c=d[b];if(typeof c=="object"&&!checkNoRef(c)){return false}}}else{for(var a in d){if(a=="$ref"){return false}c=d[a];if(typeof c=="object"&&!checkNoRef(c)){return false}}}return true}function countKeys(e){var d=0,c;if(Array.isArray(e)){for(var b=0;b<e.length;b++){c=e[b];if(typeof c=="object"){d+=countKeys(c)}if(d==Infinity){return Infinity}}}else{for(var a in e){if(a=="$ref"){return Infinity}if(SIMPLE_INLINED[a]){d++}else{c=e[a];if(typeof c=="object"){d+=countKeys(c)+1}if(d==Infinity){return Infinity}}}}return d}function getFullPath(c,a){if(a!==false){c=normalizeId(c)}var b=url.parse(c,false,true);return _getFullPath(b)}function _getFullPath(b){var a=b.protocol||b.href.slice(0,2)=="//"?"//":"";return(b.protocol||"")+a+(b.host||"")+(b.path||"")+"#"}var TRAILING_SLASH_HASH=/#\/?$/;function normalizeId(a){return a?a.replace(TRAILING_SLASH_HASH,""):""}function resolveUrl(a,b){b=normalizeId(b);return url.resolve(a,b)}function resolveIds(b){var d=normalizeId(b.id);var a={};c.call(this,b,getFullPath(d,false),d);return a;function c(k,f,e){if(Array.isArray(k)){for(var h=0;h<k.length;h++){c.call(this,k[h],f+"/"+h,e)}}else{if(k&&typeof k=="object"){if(typeof k.id=="string"){var l=e=e?url.resolve(e,k.id):k.id;l=normalizeId(l);var j=this._refs[l];if(typeof j=="string"){j=this._refs[j]}if(j&&j.schema){if(!equal(k,j.schema)){throw new Error('id "'+l+'" resolves to more than one schema')}}else{if(l!=normalizeId(f)){if(l[0]=="#"){if(a[l]&&!equal(k,a[l])){throw new Error('id "'+l+'" resolves to more than one schema')}a[l]=k}else{this._refs[l]=f}}}}for(var g in k){c.call(this,k[g],f+"/"+util.escapeFragment(g),e)}}}}};