"use strict";var resolve=require("./resolve"),util=require("./util"),stableStringify=require("json-stable-stringify"),async=require("../async");var beautify;function loadBeautify(){if(beautify===undefined){var a="js-beautify";try{beautify=require(a).js_beautify}catch(b){beautify=false}}}var validateGenerator=require("../dotjs/validate");var co=require("co");var ucs2length=util.ucs2length;var equal=require("./equal");var ValidationError=require("./validation_error");module.exports=compile;function compile(x,y,k,s){var w=this,t=this._opts,A=[undefined],i={},f=[],u={},o=[],b={},e=[],d=t.sourceCode!==false;y=y||{schema:x,refVal:A,refs:i};var B=checkCompiling.call(this,x,y,s);var C=this._compilations[B.index];if(B.compiling){return(C.callValidate=q)}var l=this._formats;var a=this.RULES;try{var r=m(x,y,k,s);C.validate=r;var j=C.callValidate;if(j){j.schema=r.schema;j.errors=null;j.refs=r.refs;j.refVal=r.refVal;j.root=r.root;j.$async=r.$async;if(d){j.sourceCode=r.sourceCode}}return r}finally{endCompiling.call(this,x,y,s)}function q(){var v=C.validate;var c=v.apply(null,arguments);q.errors=v.errors;return c}function m(M,H,O,N){var G=!H||(H&&H.schema==M);if(H.schema!=y.schema){return compile.call(w,M,H,O,N)}var F=M.$async===true;if(F&&!t.transpile){async.setup(t)}var v=validateGenerator({isTop:true,schema:M,isRoot:G,baseId:N,root:H,schemaPath:"",errSchemaPath:"#",errorPath:'""',RULES:a,validate:validateGenerator,util:util,resolve:resolve,resolveRef:h,usePattern:E,useDefault:D,useCustomRule:p,opts:t,formats:l,self:w});v=vars(A,refValCode)+vars(f,patternCode)+vars(o,defaultCode)+vars(e,customRuleCode)+v;if(t.beautify){loadBeautify();if(beautify){v=beautify(v,t.beautify)}else{console.error('"npm install js-beautify" to use beautify option')}}var K,L,J=t._transpileFunc;try{L=F&&J?J(v):v;var c=new Function("self","RULES","formats","root","refVal","defaults","customRules","co","equal","ucs2length","ValidationError",L);K=c(w,a,l,y,A,o,e,co,equal,ucs2length,ValidationError);A[0]=K}catch(I){console.error("Error compiling schema, function code:",L);throw I}K.schema=M;K.errors=null;K.refs=i;K.refVal=A;K.root=G?K:H;if(F){K.$async=true}if(d){K.sourceCode=v}if(t.sourceCode===true){K.source={patterns:f,defaults:o}}return K}function h(K,F,H){F=resolve.url(K,F);var M=i[F];var G,I;if(M!==undefined){G=A[M];I="refVal["+M+"]";return z(G,I)}if(!H&&y.refs){var c=y.refs[F];if(c!==undefined){G=y.refVal[c];I=g(F,G);return z(G,I)}}I=g(F);var L=resolve.call(w,m,y,F);if(!L){var J=k&&k[F];if(J){L=resolve.inlineRef(J,t.inlineRefs)?J:compile.call(w,J,y,k,K)}}if(L){n(F,L);return z(L,I)}}function g(F,c){var G=A.length;A[G]=c;i[F]=G;return"refVal"+G}function n(F,c){var G=i[F];A[G]=c}function z(v,c){return typeof v=="object"?{code:c,schema:v,inline:true}:{code:c,$async:v&&v.$async}}function E(v){var c=u[v];if(c===undefined){c=u[v]=f.length;f[c]=v}return"pattern"+c}function D(F){switch(typeof F){case"boolean":case"number":return""+F;case"string":return util.toQuotedString(F);case"object":if(F===null){return"null"}var c=stableStringify(F);var v=b[c];if(v===undefined){v=b[c]=o.length;o[v]=F}return"default"+v}}function p(L,F,N,G){var I=L.definition.validateSchema;if(I&&w._opts.validateSchema!==false){var c=I(F);if(!c){var O="keyword schema is invalid: "+w.errorsText(I.errors);if(w._opts.validateSchema=="log"){console.error(O)}else{throw new Error(O)}}}var M=L.definition.compile,J=L.definition.inline,v=L.definition.macro;var K;if(M){K=M.call(w,F,N,G)}else{if(v){K=v.call(w,F,N,G);if(t.validateSchema!==false){w.validateSchema(K,true)}}else{if(J){K=J.call(w,G,L.keyword,F,N)}else{K=L.definition.validate}}}var H=e.length;e[H]=K;return{code:"customRule"+H,validate:K}}}function checkCompiling(d,a,b){var c=compIndex.call(this,d,a,b);if(c>=0){return{index:c,compiling:true}}c=this._compilations.length;this._compilations[c]={schema:d,root:a,baseId:b};return{index:c,compiling:false}}function endCompiling(d,a,b){var c=compIndex.call(this,d,a,b);if(c>=0){this._compilations.splice(c,1)}}function compIndex(e,a,b){for(var d=0;d<this._compilations.length;d++){var f=this._compilations[d];if(f.schema==e&&f.root==a&&f.baseId==b){return d}}return -1}function patternCode(a,b){return"var pattern"+a+" = new RegExp("+util.toQuotedString(b[a])+");"}function defaultCode(a){return"var default"+a+" = defaults["+a+"];"}function refValCode(a,b){return b[a]?"var refVal"+a+" = refVal["+a+"];":""}function customRuleCode(a){return"var customRule"+a+" = customRules["+a+"];"}function vars(a,d){if(!a.length){return""}var c="";for(var b=0;b<a.length;b++){c+=d(b,a)}return c};