"use strict";var compileSchema=require("./compile"),resolve=require("./compile/resolve"),Cache=require("./cache"),SchemaObject=require("./compile/schema_obj"),stableStringify=require("json-stable-stringify"),formats=require("./compile/formats"),rules=require("./compile/rules"),v5=require("./v5"),util=require("./compile/util"),async=require("./async"),co=require("co");module.exports=Ajv;Ajv.prototype.compileAsync=async.compile;var customKeyword=require("./keyword");Ajv.prototype.addKeyword=customKeyword.add;Ajv.prototype.getKeyword=customKeyword.get;Ajv.prototype.removeKeyword=customKeyword.remove;Ajv.ValidationError=require("./compile/validation_error");var META_SCHEMA_ID="http://json-schema.org/draft-04/schema";var SCHEMA_URI_FORMAT=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/\/)?[^\s]*$/i;function SCHEMA_URI_FORMAT_FUNC(a){return SCHEMA_URI_FORMAT.test(a)}var META_IGNORE_OPTIONS=["removeAdditional","useDefaults","coerceTypes"];function Ajv(m){if(!(this instanceof Ajv)){return new Ajv(m)}var o=this;m=this._opts=util.copy(m)||{};this._schemas={};this._refs={};this._fragments={};this._formats=formats(m.format);this._cache=m.cache||new Cache;this._loadingSchemas={};this._compilations=[];this.RULES=rules();this.validate=n;this.compile=f;this.addSchema=c;this.addMetaSchema=j;this.validateSchema=d;this.getSchema=l;this.removeSchema=i;this.addFormat=g;this.errorsText=b;this._addSchema=a;this._compile=s;m.loopRequired=m.loopRequired||Infinity;if(m.async||m.transpile){async.setup(m)}if(m.beautify===true){m.beautify={indent_size:2}}if(m.errorDataPath=="property"){m._errorDataPathProperty=true}this._metaOpts=h();if(m.formats){u()}v();if(m.v5){v5.enable(this)}if(typeof m.meta=="object"){j(m.meta)}t();function n(x,A){var w;if(typeof x=="string"){w=l(x);if(!w){throw new Error('no schema with key or ref "'+x+'"')}}else{var y=a(x);w=y.validate||s(y)}var z=w(A);if(w.$async===true){return o._opts.async=="*"?co(z):z}o.errors=w.errors;return z}function f(y,x){var w=a(y,undefined,x);return w.validate||s(w)}function c(A,x,z,y){if(Array.isArray(A)){for(var w=0;w<A.length;w++){c(A[w],undefined,z,y)}return}x=resolve.normalizeId(x||A.id);r(x);o._schemas[x]=a(A,z,y,true)}function j(y,w,x){c(y,w,x,true)}function d(A,x){var B=A.$schema||o._opts.defaultMeta||p();var w=o._formats.uri;o._formats.uri=typeof w=="function"?SCHEMA_URI_FORMAT_FUNC:SCHEMA_URI_FORMAT;var z;try{z=n(B,A)}finally{o._formats.uri=w}if(!z&&x){var y="schema is invalid: "+b();if(o._opts.validateSchema=="log"){console.error(y)}else{throw new Error(y)}}return z}function p(){var w=o._opts.meta;o._opts.defaultMeta=typeof w=="object"?w.id||w:o._opts.v5?v5.META_SCHEMA_ID:META_SCHEMA_ID;return o._opts.defaultMeta}function l(x){var w=k(x);switch(typeof w){case"object":return w.validate||s(w);case"string":return l(w);case"undefined":return e(x)}}function e(B){var z=resolve.schema.call(o,{schema:{}},B);if(z){var A=z.schema,w=z.root,y=z.baseId;var x=compileSchema.call(o,A,w,undefined,y);o._fragments[B]=new SchemaObject({ref:B,fragment:true,schema:A,root:w,baseId:y,validate:x});return x}}function k(w){w=resolve.normalizeId(w);return o._schemas[w]||o._refs[w]||o._fragments[w]}function i(x){if(x instanceof RegExp){q(o._schemas,x);q(o._refs,x);return}switch(typeof x){case"undefined":q(o._schemas);q(o._refs);o._cache.clear();return;case"string":var y=k(x);if(y){o._cache.del(y.jsonStr)}delete o._schemas[x];delete o._refs[x];return;case"object":var w=stableStringify(x);o._cache.del(w);var z=x.id;if(z){z=resolve.normalizeId(z);delete o._schemas[z];delete o._refs[z]}}}function q(w,y){for(var z in w){var x=w[z];if(!x.meta&&(!y||y.test(z))){o._cache.del(x.jsonStr);delete w[z]}}}function a(B,x,G,D){if(typeof B!="object"){throw new Error("schema should be object")}var y=stableStringify(B);var z=o._cache.get(y);if(z){return z}D=D||o._opts.addUsedSchema!==false;var w=resolve.normalizeId(B.id);if(w&&D){r(w)}var A=o._opts.validateSchema!==false&&!x;var C;if(A&&!(C=B.id&&B.id==B.$schema)){d(B,true)}var F=resolve.ids.call(o,B);var E=new SchemaObject({id:w,schema:B,localRefs:F,jsonStr:y,meta:G});if(w[0]!="#"&&D){o._refs[w]=E}o._cache.put(y,E);if(A&&C){d(B,true)}return E}function s(z,w){if(z.compiling){z.validate=A;A.schema=z.schema;A.errors=null;A.root=w?w:A;if(z.schema.$async===true){A.$async=true}return A}z.compiling=true;var y;if(z.meta){y=o._opts;o._opts=o._metaOpts}var x;try{x=compileSchema.call(o,z.schema,w,z.localRefs)}finally{z.compiling=false;if(z.meta){o._opts=y}}z.validate=x;z.refs=x.refs;z.refVal=x.refVal;z.root=x.root;return x;function A(){var C=z.validate;var B=C.apply(null,arguments);A.errors=C.errors;return B}}function b(C,w){C=C||o.errors;if(!C){return"No errors"}w=w||{};var A=w.separator===undefined?", ":w.separator;var z=w.dataVar===undefined?"data":w.dataVar;var B="";for(var x=0;x<C.length;x++){var y=C[x];if(y){B+=z+y.dataPath+" "+y.message+A}}return B.slice(0,-A.length)}function g(w,x){if(typeof x=="string"){x=new RegExp(x)}o._formats[w]=x}function v(){if(o._opts.meta!==false){var w=require("./refs/json-schema-draft-04.json");j(w,META_SCHEMA_ID,true);o._refs["http://json-schema.org/schema"]=META_SCHEMA_ID}}function t(){var x=o._opts.schemas;if(!x){return}if(Array.isArray(x)){c(x)}else{for(var w in x){c(x[w],w)}}}function u(){for(var w in o._opts.formats){var x=o._opts.formats[w];g(w,x)}}function r(w){if(o._schemas[w]||o._refs[w]){throw new Error('schema with key or id "'+w+'" already exists')}}function h(){var w=util.copy(o._opts);for(var x=0;x<META_IGNORE_OPTIONS.length;x++){delete w[META_IGNORE_OPTIONS[x]]}return w}};