"use strict";module.exports={setup:setupAsync,compile:compileAsync};var util=require("./compile/util");var ASYNC={"*":checkGenerators,"co*":checkGenerators,es7:checkAsyncFunction};var TRANSPILE={nodent:getNodent,regenerator:getRegenerator};var MODES=[{async:"co*"},{async:"es7",transpile:"nodent"},{async:"co*",transpile:"regenerator"}];var regenerator,nodent;function setupAsync(g,h){if(h!==false){h=true}var f=g.async,e=g.transpile,a;switch(typeof e){case"string":var b=TRANSPILE[e];if(!b){throw new Error("bad transpiler: "+e)}return(g._transpileFunc=b(g,h));case"undefined":case"boolean":if(typeof f=="string"){a=ASYNC[f];if(!a){throw new Error("bad async mode: "+f)}return(g.transpile=a(g,h))}for(var d=0;d<MODES.length;d++){var c=MODES[d];if(setupAsync(c,false)){util.copy(c,g);return g.transpile}}throw new Error("generators, nodent and regenerator are not available");case"function":return(g._transpileFunc=g.transpile);default:throw new Error("bad transpiler: "+e)}}function checkGenerators(a,c){try{(new Function("(function*(){})()"))();return true}catch(b){if(c){throw new Error("generators not supported")}}}function checkAsyncFunction(a,c){try{(new Function("(async function(){})()"))();return true}catch(b){if(c){throw new Error("es7 async functions not supported")}}}function getRegenerator(b,d){try{if(!regenerator){var a="regenerator";regenerator=require(a);regenerator.runtime()}if(!b.async||b.async===true){b.async="es7"}return regeneratorTranspile}catch(c){if(d){throw new Error("regenerator not available")}}}function regeneratorTranspile(a){return regenerator.compile(a).code}function getNodent(b,d){try{if(!nodent){var a="nodent";nodent=require(a)({log:false,dontInstallRequireHook:true})}if(b.async!="es7"){if(b.async&&b.async!==true){console.warn("nodent transpiles only es7 async functions")}b.async="es7"}return nodentTranspile}catch(c){if(d){throw new Error("nodent not available")}}}function nodentTranspile(a){return nodent.compile(a,"",{promises:true,sourcemap:false}).code}function compileAsync(d,g){var c;var b=this;try{c=this._addSchema(d)}catch(f){setTimeout(function(){g(f)});return}if(c.validate){setTimeout(function(){g(null,c.validate)})}else{if(typeof this._opts.loadSchema!="function"){throw new Error("options.loadSchema should be a function")}a(d,g,true)}function a(j,n,k){var m;try{m=b.compile(j)}catch(l){if(l.missingSchema){i(l)}else{h(l)}return}h(null,m);function i(q){var p=q.missingSchema;if(b._refs[p]||b._schemas[p]){return n(new Error("Schema "+p+" is loaded but "+q.missingRef+" cannot be resolved"))}var o=b._loadingSchemas[p];if(o){if(typeof o=="function"){b._loadingSchemas[p]=[o,r]}else{o[o.length]=r}}else{b._loadingSchemas[p]=r;b._opts.loadSchema(p,function(t,u){var s=b._loadingSchemas[p];delete b._loadingSchemas[p];if(typeof s=="function"){s(t,u)}else{for(var e=0;e<s.length;e++){s[e](t,u)}}})}function r(s,t){if(s){return n(s)}if(!(b._refs[p]||b._schemas[p])){try{b.addSchema(t,p)}catch(u){n(u);return}}a(j,n)}}function h(e,o){if(k){setTimeout(function(){n(e,o)})}else{return n(e,o)}}}};