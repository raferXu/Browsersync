var Dgram=require("dgram");var Dns=require("dns");var Hoek=require("hoek");var internals={};exports.time=function(j,g){if(arguments.length!==2){g=arguments[0];j={}}var a=Hoek.clone(j);a.host=a.host||"pool.ntp.org";a.port=a.port||123;a.resolveReference=a.resolveReference||false;var e=0;var c=0;var d=function(k,i){if(e){clearTimeout(e);e=0}f.removeAllListeners();f.once("error",internals.ignore);f.close();return g(k,i)};d=Hoek.once(d);var f=Dgram.createSocket("udp4");f.once("error",function(i){return d(i)});f.on("message",function(i,q){var p=Date.now();var m=new internals.NtpMessage(i);if(!m.isValid){return d(new Error("Invalid server response"),m)}if(m.originateTimestamp!==c){return d(new Error("Wrong originate timestamp"),m)}var o=m.originateTimestamp;var n=m.receiveTimestamp;var l=m.transmitTimestamp;var k=p;m.d=(k-o)-(l-n);m.t=((n-o)+(l-k))/2;m.receivedLocally=p;if(!a.resolveReference||m.stratum!=="secondary"){return d(null,m)}Dns.reverse(m.referenceId,function(s,r){if(!s){m.referenceHost=r[0]}return d(null,m)})});if(a.timeout){e=setTimeout(function(){e=0;return d(new Error("Timeout"))},a.timeout)}var h=new Buffer(48);for(var b=0;b<48;b++){h[b]=0}h[0]=(0<<6)+(4<<3)+(3<<0);c=Date.now();internals.fromMsecs(c,h,40);f.send(h,0,h.length,a.port,a.host,function(k,i){if(k||i!==48){return d(k||new Error("Could not send entire message"))}})};internals.NtpMessage=function(d){this.isValid=false;if(d.length!==48){return}var a=(d[0]>>6);switch(a){case 0:this.leapIndicator="no-warning";break;case 1:this.leapIndicator="last-minute-61";break;case 2:this.leapIndicator="last-minute-59";break;case 3:this.leapIndicator="alarm";break}var e=((d[0]&56)>>3);this.version=e;var f=(d[0]&7);switch(f){case 1:this.mode="symmetric-active";break;case 2:this.mode="symmetric-passive";break;case 3:this.mode="client";break;case 4:this.mode="server";break;case 5:this.mode="broadcast";break;case 0:case 6:case 7:this.mode="reserved";break}var c=d[1];if(c===0){this.stratum="death"}else{if(c===1){this.stratum="primary"}else{if(c<=15){this.stratum="secondary"}else{this.stratum="reserved"}}}this.pollInterval=Math.round(Math.pow(2,d[2]))*1000;this.precision=Math.pow(2,d[3])*1000;var b=256*(256*(256*d[4]+d[5])+d[6])+d[7];this.rootDelay=1000*(b/65536);this.rootDispersion=((d[8]<<8)+d[9]+((d[10]<<8)+d[11])/Math.pow(2,16))*1000;this.referenceId="";switch(this.stratum){case"death":case"primary":this.referenceId=String.fromCharCode(d[12])+String.fromCharCode(d[13])+String.fromCharCode(d[14])+String.fromCharCode(d[15]);break;case"secondary":this.referenceId=""+d[12]+"."+d[13]+"."+d[14]+"."+d[15];break}this.referenceTimestamp=internals.toMsecs(d,16);this.originateTimestamp=internals.toMsecs(d,24);this.receiveTimestamp=internals.toMsecs(d,32);this.transmitTimestamp=internals.toMsecs(d,40);if(this.version===4&&this.stratum!=="reserved"&&this.mode==="server"&&this.originateTimestamp&&this.receiveTimestamp&&this.transmitTimestamp){this.isValid=true}return this};internals.toMsecs=function(a,e){var d=0;var c=0;for(var b=0;b<4;++b){d=(d*256)+a[e+b]}for(b=4;b<8;++b){c=(c*256)+a[e+b]}return((d-2208988800+(c/Math.pow(2,32)))*1000)};internals.fromMsecs=function(c,a,e){var d=Math.floor(c/1000)+2208988800;var b=Math.round((c%1000)/1000*Math.pow(2,32));a[e+0]=(d&4278190080)>>24;a[e+1]=(d&16711680)>>16;a[e+2]=(d&65280)>>8;a[e+3]=(d&255);a[e+4]=(b&4278190080)>>24;a[e+5]=(b&16711680)>>16;a[e+6]=(b&65280)>>8;a[e+7]=(b&255)};internals.last={offset:0,expires:0,host:"",port:0};exports.offset=function(b,d){if(arguments.length!==2){d=arguments[0];b={}}var a=Date.now();var c=b.clockSyncRefresh||24*60*60*1000;if(internals.last.offset&&internals.last.host===b.host&&internals.last.port===b.port&&a<internals.last.expires){process.nextTick(function(){d(null,internals.last.offset)});return}exports.time(b,function(e,f){if(e){return d(e,0)}internals.last={offset:Math.round(f.t),expires:a+c,host:b.host,port:b.port};return d(null,internals.last.offset)})};internals.now={intervalId:0};exports.start=function(a,b){if(arguments.length!==2){b=arguments[0];a={}}if(internals.now.intervalId){process.nextTick(function(){b()});return}exports.offset(a,function(c,d){internals.now.intervalId=setInterval(function(){exports.offset(a,function(){})},a.clockSyncRefresh||24*60*60*1000);return b()})};exports.stop=function(){if(!internals.now.intervalId){return}clearInterval(internals.now.intervalId);internals.now.intervalId=0};exports.isLive=function(){return !!internals.now.intervalId};exports.now=function(){var a=Date.now();if(!exports.isLive()||a>=internals.last.expires){return a}return a+internals.last.offset};internals.ignore=function(){};