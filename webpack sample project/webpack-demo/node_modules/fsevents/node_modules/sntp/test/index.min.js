var Dns=require("dns");var Dgram=require("dgram");var Lab=require("lab");var Sntp=require("../lib");var internals={};var lab=exports.lab=Lab.script();var before=lab.before;var after=lab.after;var describe=lab.experiment;var it=lab.test;var expect=Lab.expect;describe("SNTP",function(){describe("#time",function(){it("returns consistent result over multiple tries",function(b){Sntp.time(function(d,e){expect(d).to.not.exist;expect(e).to.exist;var c=e.t;Sntp.time(function(g,h){expect(g).to.not.exist;expect(h).to.exist;var f=h.t;expect(Math.abs(c-f)).is.below(200);b()})})});it("resolves reference IP",function(b){Sntp.time({host:"ntp.exnet.com",resolveReference:true},function(c,d){expect(c).to.not.exist;expect(d).to.exist;expect(d.referenceHost).to.exist;b()})});it("times out on no response",function(b){Sntp.time({port:124,timeout:100},function(c,d){expect(c).to.exist;expect(d).to.not.exist;expect(c.message).to.equal("Timeout");b()})});it("errors on error event",{parallel:false},function(b){var c=Dgram.createSocket;Dgram.createSocket=function(e){Dgram.createSocket=c;var d=Dgram.createSocket(e);setImmediate(function(){d.emit("error",new Error("Fake"))});return d};Sntp.time(function(d,e){expect(d).to.exist;expect(e).to.not.exist;expect(d.message).to.equal("Fake");b()})});it("errors on incorrect sent size",{parallel:false},function(b){var c=Dgram.Socket.prototype.send;Dgram.Socket.prototype.send=function(f,h,g,e,d,i){Dgram.Socket.prototype.send=c;return i(null,40)};Sntp.time(function(d,e){expect(d).to.exist;expect(e).to.not.exist;expect(d.message).to.equal("Could not send entire message");b()})});it("times out on invalid host",function(b){Sntp.time({host:"error",timeout:10000},function(c,d){expect(c).to.exist;expect(d).to.not.exist;expect(c.message).to.contain("getaddrinfo");b()})});it("fails on bad response buffer size",function(b){var c=Dgram.createSocket("udp4");c.on("message",function(d,e){var d=new Buffer(10);c.send(d,0,d.length,e.port,e.address,function(g,f){c.close()})});c.bind(49123);Sntp.time({host:"localhost",port:49123},function(d,e){expect(d).to.exist;expect(d.message).to.equal("Invalid server response");b()})});var a=function(b){var c=Dgram.createSocket("udp4");c.on("message",function(f,g){var f=new Buffer([36,1,0,227,0,0,0,0,0,0,0,0,65,67,84,83,212,168,45,199,28,93,73,27,212,168,45,230,103,239,157,178,212,168,45,230,113,237,181,251,212,168,45,230,113,238,108,197]);for(var e=0,d=b.length;e<d;++e){f[b[e][0]]=b[e][1]}c.send(f,0,f.length,g.port,g.address,function(i,h){c.close()})});c.bind(49123)};it("fails on bad version",function(b){a([[0,(0<<6)+(3<<3)+(4<<0)]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(d.version).to.equal(3);expect(c.message).to.equal("Invalid server response");b()})});it("fails on bad originateTimestamp",function(b){a([[24,131],[25,170],[26,126],[27,128],[28,0],[29,0],[30,0],[31,0]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(c.message).to.equal("Invalid server response");b()})});it("fails on bad receiveTimestamp",function(b){a([[32,131],[33,170],[34,126],[35,128],[36,0],[37,0],[38,0],[39,0]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(c.message).to.equal("Invalid server response");b()})});it("fails on bad originate timestamp and alarm li",function(b){a([[0,(3<<6)+(4<<3)+(4<<0)]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(c.message).to.equal("Wrong originate timestamp");expect(d.leapIndicator).to.equal("alarm");b()})});it("returns time with death stratum and last61 li",function(b){a([[0,(1<<6)+(4<<3)+(4<<0)],[1,0]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(d.stratum).to.equal("death");expect(d.leapIndicator).to.equal("last-minute-61");b()})});it("returns time with reserved stratum and last59 li",function(b){a([[0,(2<<6)+(4<<3)+(4<<0)],[1,31]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(d.stratum).to.equal("reserved");expect(d.leapIndicator).to.equal("last-minute-59");b()})});it("fails on bad mode (symmetric-active)",function(b){a([[0,(0<<6)+(4<<3)+(1<<0)]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(d.mode).to.equal("symmetric-active");b()})});it("fails on bad mode (symmetric-passive)",function(b){a([[0,(0<<6)+(4<<3)+(2<<0)]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(d.mode).to.equal("symmetric-passive");b()})});it("fails on bad mode (client)",function(b){a([[0,(0<<6)+(4<<3)+(3<<0)]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(d.mode).to.equal("client");b()})});it("fails on bad mode (broadcast)",function(b){a([[0,(0<<6)+(4<<3)+(5<<0)]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(d.mode).to.equal("broadcast");b()})});it("fails on bad mode (reserved)",function(b){a([[0,(0<<6)+(4<<3)+(6<<0)]]);Sntp.time({host:"localhost",port:49123},function(c,d){expect(c).to.exist;expect(d.mode).to.equal("reserved");b()})})});describe("#offset",function(){it("gets the current offset",function(a){Sntp.offset(function(b,c){expect(b).to.not.exist;expect(c).to.not.equal(0);a()})});it("gets the current offset from cache",function(a){Sntp.offset(function(c,d){expect(c).to.not.exist;expect(d).to.not.equal(0);var b=d;Sntp.offset({},function(e,f){expect(e).to.not.exist;expect(f).to.equal(b);a()})})});it("gets the new offset on different server",function(a){Sntp.offset(function(c,d){expect(c).to.not.exist;expect(d).to.not.equal(0);var b=d;Sntp.offset({host:"nist1-sj.ustiming.org"},function(e,f){expect(e).to.not.exist;expect(f).to.not.equal(b);a()})})});it("gets the new offset on different server",function(a){Sntp.offset(function(c,d){expect(c).to.not.exist;expect(d).to.not.equal(0);var b=d;Sntp.offset({port:123},function(e,f){expect(e).to.not.exist;expect(f).to.not.equal(b);a()})})});it("fails getting the current offset on invalid server",function(a){Sntp.offset({host:"error"},function(b,c){expect(b).to.exist;expect(c).to.equal(0);a()})})});describe("#now",function(){it("starts auto-sync, gets now, then stops",function(a){Sntp.stop();var b=Sntp.now();expect(b).to.equal(Date.now());Sntp.start(function(){var c=Sntp.now();expect(c).to.not.equal(Date.now());Sntp.stop();a()})});it("starts twice",function(a){Sntp.start(function(){Sntp.start(function(){var b=Sntp.now();expect(b).to.not.equal(Date.now());Sntp.stop();a()})})});it("starts auto-sync, gets now, waits, gets again after timeout",function(a){Sntp.stop();var b=Sntp.now();expect(b).to.equal(Date.now());Sntp.start({clockSyncRefresh:100},function(){var c=Sntp.now();expect(c).to.not.equal(Date.now());expect(c).to.equal(Sntp.now());setTimeout(function(){expect(Sntp.now()).to.not.equal(c);Sntp.stop();a()},110)})})})});