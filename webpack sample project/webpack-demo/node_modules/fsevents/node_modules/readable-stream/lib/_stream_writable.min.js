"use strict";module.exports=Writable;var processNextTick=require("process-nextick-args");var asyncWrite=!process.browser&&["v0.10","v0.9."].indexOf(process.version.slice(0,5))>-1?setImmediate:processNextTick;var Duplex;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");var internalUtil={deprecate:require("util-deprecate")};var Stream=require("./internal/streams/stream");var Buffer=require("buffer").Buffer;var bufferShim=require("buffer-shims");util.inherits(Writable,Stream);function nop(){}function WriteReq(b,c,a){this.chunk=b;this.encoding=c;this.callback=a;this.next=null}function WritableState(a,d){Duplex=Duplex||require("./_stream_duplex");a=a||{};this.objectMode=!!a.objectMode;if(d instanceof Duplex){this.objectMode=this.objectMode||!!a.writableObjectMode}var c=a.highWaterMark;var e=this.objectMode?16:16*1024;this.highWaterMark=c||c===0?c:e;this.highWaterMark=~~this.highWaterMark;this.needDrain=false;this.ending=false;this.ended=false;this.finished=false;var b=a.decodeStrings===false;this.decodeStrings=!b;this.defaultEncoding=a.defaultEncoding||"utf8";this.length=0;this.writing=false;this.corked=0;this.sync=true;this.bufferProcessing=false;this.onwrite=function(f){onwrite(d,f)};this.writecb=null;this.writelen=0;this.bufferedRequest=null;this.lastBufferedRequest=null;this.pendingcb=0;this.prefinished=false;this.errorEmitted=false;this.bufferedRequestCount=0;this.corkedRequestsFree=new CorkedRequest(this)}WritableState.prototype.getBuffer=function getBuffer(){var b=this.bufferedRequest;var a=[];while(b){a.push(b);b=b.next}return a};(function(){try{Object.defineProperty(WritableState.prototype,"buffer",{get:internalUtil.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.")})}catch(a){}})();var realHasInstance;if(typeof Symbol==="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]==="function"){realHasInstance=Function.prototype[Symbol.hasInstance];Object.defineProperty(Writable,Symbol.hasInstance,{value:function(a){if(realHasInstance.call(this,a)){return true}return a&&a._writableState instanceof WritableState}})}else{realHasInstance=function(a){return a instanceof this}}function Writable(a){Duplex=Duplex||require("./_stream_duplex");if(!realHasInstance.call(Writable,this)&&!(this instanceof Duplex)){return new Writable(a)}this._writableState=new WritableState(a,this);this.writable=true;if(a){if(typeof a.write==="function"){this._write=a.write}if(typeof a.writev==="function"){this._writev=a.writev}}Stream.call(this)}Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))};function writeAfterEnd(b,a){var c=new Error("write after end");b.emit("error",c);processNextTick(a,c)}function validChunk(e,d,b,a){var c=true;var f=false;if(b===null){f=new TypeError("May not write null values to stream")}else{if(typeof b!=="string"&&b!==undefined&&!d.objectMode){f=new TypeError("Invalid non-string/buffer chunk")}}if(f){e.emit("error",f);processNextTick(a,f);c=false}return c}Writable.prototype.write=function(c,d,a){var e=this._writableState;var b=false;var f=Buffer.isBuffer(c);if(typeof d==="function"){a=d;d=null}if(f){d="buffer"}else{if(!d){d=e.defaultEncoding}}if(typeof a!=="function"){a=nop}if(e.ended){writeAfterEnd(this,a)}else{if(f||validChunk(this,e,c,a)){e.pendingcb++;b=writeOrBuffer(this,e,f,c,d,a)}}return b};Writable.prototype.cork=function(){var a=this._writableState;a.corked++};Writable.prototype.uncork=function(){var a=this._writableState;if(a.corked){a.corked--;if(!a.writing&&!a.corked&&!a.finished&&!a.bufferProcessing&&a.bufferedRequest){clearBuffer(this,a)}}};Writable.prototype.setDefaultEncoding=function setDefaultEncoding(a){if(typeof a==="string"){a=a.toLowerCase()}if(!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((a+"").toLowerCase())>-1)){throw new TypeError("Unknown encoding: "+a)}this._writableState.defaultEncoding=a;return this};function decodeChunk(c,a,b){if(!c.objectMode&&c.decodeStrings!==false&&typeof a==="string"){a=bufferShim.from(a,b)}return a}function writeOrBuffer(i,b,a,g,c,d){if(!a){g=decodeChunk(b,g,c);if(Buffer.isBuffer(g)){c="buffer"}}var e=b.objectMode?1:g.length;b.length+=e;var f=b.length<b.highWaterMark;if(!f){b.needDrain=true}if(b.writing||b.corked){var h=b.lastBufferedRequest;b.lastBufferedRequest=new WriteReq(g,c,d);if(h){h.next=b.lastBufferedRequest}else{b.bufferedRequest=b.lastBufferedRequest}b.bufferedRequestCount+=1}else{doWrite(i,b,false,e,g,c,d)}return f}function doWrite(g,f,d,b,c,e,a){f.writelen=b;f.writecb=a;f.writing=true;f.sync=true;if(d){g._writev(c,f.onwrite)}else{g._write(c,e,f.onwrite)}f.sync=false}function onwriteError(d,c,b,e,a){--c.pendingcb;if(b){processNextTick(a,e)}else{a(e)}d._writableState.errorEmitted=true;d.emit("error",e)}function onwriteStateUpdate(a){a.writing=false;a.writecb=null;a.length-=a.writelen;a.writelen=0}function onwrite(d,f){var c=d._writableState;var b=c.sync;var a=c.writecb;onwriteStateUpdate(c);if(f){onwriteError(d,c,b,f,a)}else{var e=needFinish(c);if(!e&&!c.corked&&!c.bufferProcessing&&c.bufferedRequest){clearBuffer(d,c)}if(b){asyncWrite(afterWrite,d,c,e,a)}else{afterWrite(d,c,e,a)}}}function afterWrite(c,b,d,a){if(!d){onwriteDrain(c,b)}b.pendingcb--;a();finishMaybe(c,b)}function onwriteDrain(b,a){if(a.length===0&&a.needDrain){a.needDrain=false;b.emit("drain")}}function clearBuffer(k,a){a.bufferProcessing=true;var j=a.bufferedRequest;if(k._writev&&j&&j.next){var d=a.bufferedRequestCount;var e=new Array(d);var h=a.corkedRequestsFree;h.entry=j;var g=0;while(j){e[g]=j;j=j.next;g+=1}doWrite(k,a,true,a.length,e,"",h.finish);a.pendingcb++;a.lastBufferedRequest=null;if(h.next){a.corkedRequestsFree=h.next;h.next=null}else{a.corkedRequestsFree=new CorkedRequest(a)}}else{while(j){var i=j.chunk;var b=j.encoding;var c=j.callback;var f=a.objectMode?1:i.length;doWrite(k,a,false,f,i,b,c);j=j.next;if(a.writing){break}}if(j===null){a.lastBufferedRequest=null}}a.bufferedRequestCount=0;a.bufferedRequest=j;a.bufferProcessing=false}Writable.prototype._write=function(b,c,a){a(new Error("_write() is not implemented"))};Writable.prototype._writev=null;Writable.prototype.end=function(b,c,a){var d=this._writableState;if(typeof b==="function"){a=b;b=null;c=null}else{if(typeof c==="function"){a=c;c=null}}if(b!==null&&b!==undefined){this.write(b,c)}if(d.corked){d.corked=1;this.uncork()}if(!d.ending&&!d.finished){endWritable(this,d,a)}};function needFinish(a){return a.ending&&a.length===0&&a.bufferedRequest===null&&!a.finished&&!a.writing}function prefinish(b,a){if(!a.prefinished){a.prefinished=true;b.emit("prefinish")}}function finishMaybe(c,b){var a=needFinish(b);if(a){if(b.pendingcb===0){prefinish(c,b);b.finished=true;c.emit("finish")}else{prefinish(c,b)}}return a}function endWritable(c,b,a){b.ending=true;finishMaybe(c,b);if(a){if(b.finished){processNextTick(a)}else{c.once("finish",a)}}b.ended=true;c.writable=false}function CorkedRequest(a){var b=this;this.next=null;this.entry=null;this.finish=function(e){var d=b.entry;b.entry=null;while(d){var c=d.callback;a.pendingcb--;c(e);d=d.next}if(a.corkedRequestsFree){a.corkedRequestsFree.next=b}else{a.corkedRequestsFree=b}}};