"use strict";module.exports=Readable;var processNextTick=require("process-nextick-args");var isArray=require("isarray");var Duplex;Readable.ReadableState=ReadableState;var EE=require("events").EventEmitter;var EElistenerCount=function(b,a){return b.listeners(a).length};var Stream=require("./internal/streams/stream");var Buffer=require("buffer").Buffer;var bufferShim=require("buffer-shims");var util=require("core-util-is");util.inherits=require("inherits");var debugUtil=require("util");var debug=void 0;if(debugUtil&&debugUtil.debuglog){debug=debugUtil.debuglog("stream")}else{debug=function(){}}var BufferList=require("./internal/streams/BufferList");var StringDecoder;util.inherits(Readable,Stream);var kProxyEvents=["error","close","destroy","pause","resume"];function prependListener(c,b,a){if(typeof c.prependListener==="function"){return c.prependListener(b,a)}else{if(!c._events||!c._events[b]){c.on(b,a)}else{if(isArray(c._events[b])){c._events[b].unshift(a)}else{c._events[b]=[a,c._events[b]]}}}}function ReadableState(a,c){Duplex=Duplex||require("./_stream_duplex");a=a||{};this.objectMode=!!a.objectMode;if(c instanceof Duplex){this.objectMode=this.objectMode||!!a.readableObjectMode}var b=a.highWaterMark;var d=this.objectMode?16:16*1024;this.highWaterMark=b||b===0?b:d;this.highWaterMark=~~this.highWaterMark;this.buffer=new BufferList();this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=null;this.ended=false;this.endEmitted=false;this.reading=false;this.sync=true;this.needReadable=false;this.emittedReadable=false;this.readableListening=false;this.resumeScheduled=false;this.defaultEncoding=a.defaultEncoding||"utf8";this.ranOut=false;this.awaitDrain=0;this.readingMore=false;this.decoder=null;this.encoding=null;if(a.encoding){if(!StringDecoder){StringDecoder=require("string_decoder/").StringDecoder}this.decoder=new StringDecoder(a.encoding);this.encoding=a.encoding}}function Readable(a){Duplex=Duplex||require("./_stream_duplex");if(!(this instanceof Readable)){return new Readable(a)}this._readableState=new ReadableState(a,this);this.readable=true;if(a&&typeof a.read==="function"){this._read=a.read}Stream.call(this)}Readable.prototype.push=function(a,b){var c=this._readableState;if(!c.objectMode&&typeof a==="string"){b=b||c.defaultEncoding;if(b!==c.encoding){a=bufferShim.from(a,b);b=""}}return readableAddChunk(this,c,a,b,false)};Readable.prototype.unshift=function(a){var b=this._readableState;return readableAddChunk(this,b,a,"",true)};Readable.prototype.isPaused=function(){return this._readableState.flowing===false};function readableAddChunk(j,a,g,b,h){var i=chunkInvalid(a,g);if(i){j.emit("error",i)}else{if(g===null){a.reading=false;onEofChunk(j,a)}else{if(a.objectMode||g&&g.length>0){if(a.ended&&!h){var d=new Error("stream.push() after EOF");j.emit("error",d)}else{if(a.endEmitted&&h){var c=new Error("stream.unshift() after end event");j.emit("error",c)}else{var f;if(a.decoder&&!h&&!b){g=a.decoder.write(g);f=!a.objectMode&&g.length===0}if(!h){a.reading=false}if(!f){if(a.flowing&&a.length===0&&!a.sync){j.emit("data",g);j.read(0)}else{a.length+=a.objectMode?1:g.length;if(h){a.buffer.unshift(g)}else{a.buffer.push(g)}if(a.needReadable){emitReadable(j)}}}maybeReadMore(j,a)}}}else{if(!h){a.reading=false}}}}return needMoreData(a)}function needMoreData(a){return !a.ended&&(a.needReadable||a.length<a.highWaterMark||a.length===0)}Readable.prototype.setEncoding=function(a){if(!StringDecoder){StringDecoder=require("string_decoder/").StringDecoder}this._readableState.decoder=new StringDecoder(a);this._readableState.encoding=a;return this};var MAX_HWM=8388608;function computeNewHighWaterMark(a){if(a>=MAX_HWM){a=MAX_HWM}else{a--;a|=a>>>1;a|=a>>>2;a|=a>>>4;a|=a>>>8;a|=a>>>16;a++}return a}function howMuchToRead(b,a){if(b<=0||a.length===0&&a.ended){return 0}if(a.objectMode){return 1}if(b!==b){if(a.flowing&&a.length){return a.buffer.head.data.length}else{return a.length}}if(b>a.highWaterMark){a.highWaterMark=computeNewHighWaterMark(b)}if(b<=a.length){return b}if(!a.ended){a.needReadable=true;return 0}return a.length}Readable.prototype.read=function(e){debug("read",e);e=parseInt(e,10);var d=this._readableState;var c=e;if(e!==0){d.emittedReadable=false}if(e===0&&d.needReadable&&(d.length>=d.highWaterMark||d.ended)){debug("read: emitReadable",d.length,d.ended);if(d.length===0&&d.ended){endReadable(this)}else{emitReadable(this)}return null}e=howMuchToRead(e,d);if(e===0&&d.ended){if(d.length===0){endReadable(this)}return null}var a=d.needReadable;debug("need readable",a);if(d.length===0||d.length-e<d.highWaterMark){a=true;debug("length less than watermark",a)}if(d.ended||d.reading){a=false;debug("reading or ended",a)}else{if(a){debug("do read");d.reading=true;d.sync=true;if(d.length===0){d.needReadable=true}this._read(d.highWaterMark);d.sync=false;if(!d.reading){e=howMuchToRead(c,d)}}}var b;if(e>0){b=fromList(e,d)}else{b=null}if(b===null){d.needReadable=true;e=0}else{d.length-=e}if(d.length===0){if(!d.ended){d.needReadable=true}if(c!==e&&d.ended){endReadable(this)}}if(b!==null){this.emit("data",b)}return b};function chunkInvalid(b,a){var c=null;if(!Buffer.isBuffer(a)&&typeof a!=="string"&&a!==null&&a!==undefined&&!b.objectMode){c=new TypeError("Invalid non-string/buffer chunk")}return c}function onEofChunk(c,b){if(b.ended){return}if(b.decoder){var a=b.decoder.end();if(a&&a.length){b.buffer.push(a);b.length+=b.objectMode?1:a.length}}b.ended=true;emitReadable(c)}function emitReadable(b){var a=b._readableState;a.needReadable=false;if(!a.emittedReadable){debug("emitReadable",a.flowing);a.emittedReadable=true;if(a.sync){processNextTick(emitReadable_,b)}else{emitReadable_(b)}}}function emitReadable_(a){debug("emit readable");a.emit("readable");flow(a)}function maybeReadMore(b,a){if(!a.readingMore){a.readingMore=true;processNextTick(maybeReadMore_,b,a)}}function maybeReadMore_(c,b){var a=b.length;while(!b.reading&&!b.flowing&&!b.ended&&b.length<b.highWaterMark){debug("maybeReadMore read 0");c.read(0);if(a===b.length){break}else{a=b.length}}b.readingMore=false}Readable.prototype._read=function(a){this.emit("error",new Error("_read() is not implemented"))};Readable.prototype.pipe=function(m,k){var a=this;var b=this._readableState;switch(b.pipesCount){case 0:b.pipes=m;break;case 1:b.pipes=[b.pipes,m];break;default:b.pipes.push(m);break}b.pipesCount+=1;debug("pipe count=%d opts=%j",b.pipesCount,k);var l=(!k||k.end!==false)&&m!==process.stdout&&m!==process.stderr;var d=l?q:c;if(b.endEmitted){processNextTick(d)}else{a.once("end",d)}m.on("unpipe",h);function h(r){debug("onunpipe");if(r===a){c()}}function q(){debug("onend");m.end()}var e=pipeOnDrain(a);m.on("drain",e);var g=false;function c(){debug("cleanup");m.removeListener("close",o);m.removeListener("finish",f);m.removeListener("drain",e);m.removeListener("error",j);m.removeListener("unpipe",h);a.removeListener("end",q);a.removeListener("end",c);a.removeListener("data",n);g=true;if(b.awaitDrain&&(!m._writableState||m._writableState.needDrain)){e()}}var p=false;a.on("data",n);function n(s){debug("ondata");p=false;var r=m.write(s);if(false===r&&!p){if((b.pipesCount===1&&b.pipes===m||b.pipesCount>1&&indexOf(b.pipes,m)!==-1)&&!g){debug("false write response, pause",a._readableState.awaitDrain);a._readableState.awaitDrain++;p=true}a.pause()}}function j(r){debug("onerror",r);i();m.removeListener("error",j);if(EElistenerCount(m,"error")===0){m.emit("error",r)}}prependListener(m,"error",j);function o(){m.removeListener("finish",f);i()}m.once("close",o);function f(){debug("onfinish");m.removeListener("close",o);i()}m.once("finish",f);function i(){debug("unpipe");a.unpipe(m)}m.emit("pipe",a);if(!b.flowing){debug("pipe resume");a.resume()}return m};function pipeOnDrain(a){return function(){var b=a._readableState;debug("pipeOnDrain",b.awaitDrain);if(b.awaitDrain){b.awaitDrain--}if(b.awaitDrain===0&&EElistenerCount(a,"data")){b.flowing=true;flow(a)}}}Readable.prototype.unpipe=function(c){var e=this._readableState;if(e.pipesCount===0){return this}if(e.pipesCount===1){if(c&&c!==e.pipes){return this}if(!c){c=e.pipes}e.pipes=null;e.pipesCount=0;e.flowing=false;if(c){c.emit("unpipe",this)}return this}if(!c){var f=e.pipes;var a=e.pipesCount;e.pipes=null;e.pipesCount=0;e.flowing=false;for(var d=0;d<a;d++){f[d].emit("unpipe",this)}return this}var b=indexOf(e.pipes,c);if(b===-1){return this}e.pipes.splice(b,1);e.pipesCount-=1;if(e.pipesCount===1){e.pipes=e.pipes[0]}c.emit("unpipe",this);return this};Readable.prototype.on=function(c,b){var a=Stream.prototype.on.call(this,c,b);if(c==="data"){if(this._readableState.flowing!==false){this.resume()}}else{if(c==="readable"){var d=this._readableState;if(!d.endEmitted&&!d.readableListening){d.readableListening=d.needReadable=true;d.emittedReadable=false;if(!d.reading){processNextTick(nReadingNextTick,this)}else{if(d.length){emitReadable(this,d)}}}}}return a};Readable.prototype.addListener=Readable.prototype.on;function nReadingNextTick(a){debug("readable nexttick read 0");a.read(0)}Readable.prototype.resume=function(){var a=this._readableState;if(!a.flowing){debug("resume");a.flowing=true;resume(this,a)}return this};function resume(b,a){if(!a.resumeScheduled){a.resumeScheduled=true;processNextTick(resume_,b,a)}}function resume_(b,a){if(!a.reading){debug("resume read 0");b.read(0)}a.resumeScheduled=false;a.awaitDrain=0;b.emit("resume");flow(b);if(a.flowing&&!a.reading){b.read(0)}}Readable.prototype.pause=function(){debug("call pause flowing=%j",this._readableState.flowing);if(false!==this._readableState.flowing){debug("pause");this._readableState.flowing=false;this.emit("pause")}return this};function flow(b){var a=b._readableState;debug("flow",a.flowing);while(a.flowing&&b.read()!==null){}}Readable.prototype.wrap=function(e){var d=this._readableState;var c=false;var a=this;e.on("end",function(){debug("wrapped end");if(d.decoder&&!d.ended){var g=d.decoder.end();if(g&&g.length){a.push(g)}}a.push(null)});e.on("data",function(h){debug("wrapped data");if(d.decoder){h=d.decoder.write(h)}if(d.objectMode&&(h===null||h===undefined)){return}else{if(!d.objectMode&&(!h||!h.length)){return}}var g=a.push(h);if(!g){c=true;e.pause()}});for(var b in e){if(this[b]===undefined&&typeof e[b]==="function"){this[b]=function(g){return function(){return e[g].apply(e,arguments)}}(b)}}for(var f=0;f<kProxyEvents.length;f++){e.on(kProxyEvents[f],a.emit.bind(a,kProxyEvents[f]))}a._read=function(g){debug("wrapped _read",g);if(c){c=false;e.resume()}};return a};Readable._fromList=fromList;function fromList(c,b){if(b.length===0){return null}var a;if(b.objectMode){a=b.buffer.shift()}else{if(!c||c>=b.length){if(b.decoder){a=b.buffer.join("")}else{if(b.buffer.length===1){a=b.buffer.head.data}else{a=b.buffer.concat(b.length)}}b.buffer.clear()}else{a=fromListPartial(c,b.buffer,b.decoder)}}return a}function fromListPartial(d,c,b){var a;if(d<c.head.data.length){a=c.head.data.slice(0,d);c.head.data=c.head.data.slice(d)}else{if(d===c.head.data.length){a=c.shift()}else{a=b?copyFromBufferString(d,c):copyFromBuffer(d,c)}}return a}function copyFromBufferString(h,d){var e=d.head;var g=1;var b=e.data;h-=b.length;while(e=e.next){var f=e.data;var a=h>f.length?f.length:h;if(a===f.length){b+=f}else{b+=f.slice(0,h)}h-=a;if(h===0){if(a===f.length){++g;if(e.next){d.head=e.next}else{d.head=d.tail=null}}else{d.head=e;e.data=f.slice(a)}break}++g}d.length-=g;return b}function copyFromBuffer(h,e){var d=bufferShim.allocUnsafe(h);var f=e.head;var g=1;f.data.copy(d);h-=f.data.length;while(f=f.next){var b=f.data;var a=h>b.length?b.length:h;b.copy(d,d.length-h,0,a);h-=a;if(h===0){if(a===b.length){++g;if(f.next){e.head=f.next}else{e.head=e.tail=null}}else{e.head=f;f.data=b.slice(a)}break}++g}e.length-=g;return d}function endReadable(b){var a=b._readableState;if(a.length>0){throw new Error('"endReadable()" called on non-empty stream')}if(!a.endEmitted){a.ended=true;processNextTick(endReadableNT,a,b)}}function endReadableNT(a,b){if(!a.endEmitted&&a.length===0){a.endEmitted=true;b.readable=false;b.emit("end")}}function forEach(b,d){for(var c=0,a=b.length;c<a;c++){d(b[c],c)}}function indexOf(c,a){for(var d=0,b=c.length;d<b;d++){if(c[d]===a){return d}}return -1};