var Boom=require("boom");var Hoek=require("hoek");var Cryptiles=require("cryptiles");var Crypto=require("./crypto");var Utils=require("./utils");var internals={};exports.authenticate=function(g,b,e,h){h=Hoek.nextTick(h);e.nonceFunc=e.nonceFunc||internals.nonceFunc;e.timestampSkewSec=e.timestampSkewSec||60;var d=Utils.now(e.localtimeOffsetMsec);var f=Utils.parseRequest(g,e);if(f instanceof Error){return h(Boom.badRequest(f.message))}var a=Utils.parseAuthorizationHeader(f.authorization);if(a instanceof Error){return h(a)}var c={method:f.method,host:f.host,port:f.port,resource:f.url,ts:a.ts,nonce:a.nonce,hash:a.hash,ext:a.ext,app:a.app,dlg:a.dlg,mac:a.mac,id:a.id};if(!a.id||!a.ts||!a.nonce||!a.mac){return h(Boom.badRequest("Missing attributes"),null,c)}b(a.id,function(j,i){if(j){return h(j,i||null,c)}if(!i){return h(Boom.unauthorized("Unknown credentials","Hawk"),null,c)}if(!i.key||!i.algorithm){return h(Boom.internal("Invalid credentials"),i,c)}if(Crypto.algorithms.indexOf(i.algorithm)===-1){return h(Boom.internal("Unknown algorithm"),i,c)}var l=Crypto.calculateMac("header",i,c);if(!Cryptiles.fixedTimeComparison(l,a.mac)){return h(Boom.unauthorized("Bad mac","Hawk"),i,c)}if(e.payload||e.payload===""){if(!a.hash){return h(Boom.unauthorized("Missing required payload hash","Hawk"),i,c)}var k=Crypto.calculatePayloadHash(e.payload,i.algorithm,f.contentType);if(!Cryptiles.fixedTimeComparison(k,a.hash)){return h(Boom.unauthorized("Bad payload hash","Hawk"),i,c)}}e.nonceFunc(i.key,a.nonce,a.ts,function(m){if(m){return h(Boom.unauthorized("Invalid nonce","Hawk"),i,c)}if(Math.abs((a.ts*1000)-d)>(e.timestampSkewSec*1000)){var n=Crypto.timestampMessage(i,e.localtimeOffsetMsec);return h(Boom.unauthorized("Stale timestamp","Hawk",n),i,c)}return h(null,i,c)})})};exports.authenticatePayload=function(c,b,a,e){var d=Crypto.calculatePayloadHash(c,b.algorithm,e);return Cryptiles.fixedTimeComparison(d,a.hash)};exports.authenticatePayloadHash=function(b,a){return Cryptiles.fixedTimeComparison(b,a.hash)};exports.header=function(c,b,a){a=a||{};if(!b||typeof b!=="object"||typeof a!=="object"){return""}b=Hoek.clone(b);delete b.mac;b.hash=a.hash;b.ext=a.ext;if(!c||!c.key||!c.algorithm){return""}if(Crypto.algorithms.indexOf(c.algorithm)===-1){return""}if(!b.hash&&(a.payload||a.payload==="")){b.hash=Crypto.calculatePayloadHash(a.payload,c.algorithm,a.contentType)}var e=Crypto.calculateMac("response",c,b);var d='Hawk mac="'+e+'"'+(b.hash?', hash="'+b.hash+'"':"");if(b.ext!==null&&b.ext!==undefined&&b.ext!==""){d+=', ext="'+Hoek.escapeHeaderAttribute(b.ext)+'"'}return d};internals.bewitRegex=/^(\/.*)([\?&])bewit\=([^&$]*)(?:&(.+))?$/;exports.authenticateBewit=function(h,c,j,i){i=Hoek.nextTick(i);var b=Utils.now(j.localtimeOffsetMsec);var f=Utils.parseRequest(h,j);if(f instanceof Error){return i(Boom.badRequest(f.message))}if(f.url.length>Utils.limits.maxMatchLength){return i(Boom.badRequest("Resource path exceeds max length"))}var e=f.url.match(internals.bewitRegex);if(!e){return i(Boom.unauthorized(null,"Hawk"))}if(!e[3]){return i(Boom.unauthorized("Empty bewit","Hawk"))}if(f.method!=="GET"&&f.method!=="HEAD"){return i(Boom.unauthorized("Invalid method","Hawk"))}if(f.authorization){return i(Boom.badRequest("Multiple authentications"))}var k=Hoek.base64urlDecode(e[3]);if(k instanceof Error){return i(Boom.badRequest("Invalid bewit encoding"))}var d=k.split("\\");if(d.length!==4){return i(Boom.badRequest("Invalid bewit structure"))}var g={id:d[0],exp:parseInt(d[1],10),mac:d[2],ext:d[3]||""};if(!g.id||!g.exp||!g.mac){return i(Boom.badRequest("Missing bewit attributes"))}var a=e[1];if(e[4]){a+=e[2]+e[4]}if(g.exp*1000<=b){return i(Boom.unauthorized("Access expired","Hawk"),null,g)}c(g.id,function(m,l){if(m){return i(m,l||null,g.ext)}if(!l){return i(Boom.unauthorized("Unknown credentials","Hawk"),null,g)}if(!l.key||!l.algorithm){return i(Boom.internal("Invalid credentials"),l,g)}if(Crypto.algorithms.indexOf(l.algorithm)===-1){return i(Boom.internal("Unknown algorithm"),l,g)}var n=Crypto.calculateMac("bewit",l,{ts:g.exp,nonce:"",method:"GET",resource:a,host:f.host,port:f.port,ext:g.ext});if(!Cryptiles.fixedTimeComparison(n,g.mac)){return i(Boom.unauthorized("Bad mac","Hawk"),l,g)}return i(null,l,g)})};exports.authenticateMessage=function(g,b,f,e,a,d,h){h=Hoek.nextTick(h);d.nonceFunc=d.nonceFunc||internals.nonceFunc;d.timestampSkewSec=d.timestampSkewSec||60;var c=Utils.now(d.localtimeOffsetMsec);if(!e.id||!e.ts||!e.nonce||!e.hash||!e.mac){return h(Boom.badRequest("Invalid authorization"))}a(e.id,function(k,j){if(k){return h(k,j||null)}if(!j){return h(Boom.unauthorized("Unknown credentials","Hawk"))}if(!j.key||!j.algorithm){return h(Boom.internal("Invalid credentials"),j)}if(Crypto.algorithms.indexOf(j.algorithm)===-1){return h(Boom.internal("Unknown algorithm"),j)}var i={ts:e.ts,nonce:e.nonce,host:g,port:b,hash:e.hash};var m=Crypto.calculateMac("message",j,i);if(!Cryptiles.fixedTimeComparison(m,e.mac)){return h(Boom.unauthorized("Bad mac","Hawk"),j)}var l=Crypto.calculatePayloadHash(f,j.algorithm);if(!Cryptiles.fixedTimeComparison(l,e.hash)){return h(Boom.unauthorized("Bad message hash","Hawk"),j)}d.nonceFunc(j.key,e.nonce,e.ts,function(n){if(n){return h(Boom.unauthorized("Invalid nonce","Hawk"),j)}if(Math.abs((e.ts*1000)-c)>(d.timestampSkewSec*1000)){return h(Boom.unauthorized("Stale timestamp"),j)}return h(null,j)})})};internals.nonceFunc=function(b,c,d,a){return a()};