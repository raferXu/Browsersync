var Sntp=require("sntp");var Boom=require("boom");var internals={};exports.version=function(){return require("../package.json").version};exports.limits={maxMatchLength:4096};internals.hostHeaderRegex=/^(?:(?:\r\n)?\s)*((?:[^:]+)|(?:\[[^\]]+\]))(?::(\d+))?(?:(?:\r\n)?\s)*$/;exports.parseHost=function(d,b){b=(b?b.toLowerCase():"host");var c=d.headers[b];if(!c){return null}if(c.length>exports.limits.maxMatchLength){return null}var a=c.match(internals.hostHeaderRegex);if(!a){return null}return{name:a[1],port:(a[2]?a[2]:(d.connection&&d.connection.encrypted?443:80))}};exports.parseContentType=function(a){if(!a){return""}return a.split(";")[0].trim().toLowerCase()};exports.parseRequest=function(d,a){if(!d.headers){return d}var c;if(!a.host||!a.port){c=exports.parseHost(d,a.hostHeaderName);if(!c){return new Error("Invalid Host header")}}var b={method:d.method,url:d.url,host:a.host||c.name,port:a.port||c.port,authorization:d.headers.authorization,contentType:d.headers["content-type"]||""};return b};exports.now=function(a){return Sntp.now()+(a||0)};exports.nowSecs=function(a){return Math.floor(exports.now(a)/1000)};internals.authHeaderRegex=/^(\w+)(?:\s+(.*))?$/;internals.attributeRegex=/^[ \w\!#\$%&'\(\)\*\+,\-\.\/\:;<\=>\?@\[\]\^`\{\|\}~]+$/;exports.parseAuthorizationHeader=function(h,f){f=f||["id","ts","nonce","hash","ext","mac","app","dlg"];if(!h){return Boom.unauthorized(null,"Hawk")}if(h.length>exports.limits.maxMatchLength){return Boom.badRequest("Header length too long")}var e=h.match(internals.authHeaderRegex);if(!e){return Boom.badRequest("Invalid header syntax")}var b=e[1];if(b.toLowerCase()!=="hawk"){return Boom.unauthorized(null,"Hawk")}var d=e[2];if(!d){return Boom.badRequest("Invalid header syntax")}var a={};var c="";var g=d.replace(/(\w+)="([^"\\]*)"\s*(?:,\s*|$)/g,function(j,i,k){if(f.indexOf(i)===-1){c="Unknown attribute: "+i;return}if(k.match(internals.attributeRegex)===null){c="Bad attribute value: "+i;return}if(a.hasOwnProperty(i)){c="Duplicate attribute: "+i;return}a[i]=k;return""});if(g!==""){return Boom.badRequest(c||"Bad header format")}return a};exports.unauthorized=function(b,a){return Boom.unauthorized(b,"Hawk",a)};