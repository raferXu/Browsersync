var Http=require("http");var Url=require("url");var Code=require("code");var Hawk=require("../lib");var Hoek=require("hoek");var Lab=require("lab");var internals={};var lab=exports.lab=Lab.script();var describe=lab.experiment;var it=lab.test;var expect=Code.expect;describe("Uri",function(){var a=function(d,c){var b={id:d,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:(d==="1"?"sha1":"sha256"),user:"steve"};return c(null,b)};it("should generate a bewit then successfully authenticate it",function(b){var c={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};a("123456",function(f,e){var d=Hawk.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:e,ttlSec:60*60*24*365*100,ext:"some-app-data"});c.url+="&bewit="+d;Hawk.uri.authenticate(c,a,{},function(i,h,g){expect(i).to.not.exist();expect(h.user).to.equal("steve");expect(g.ext).to.equal("some-app-data");b()})})});it("should generate a bewit then successfully authenticate it (no ext)",function(b){var c={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};a("123456",function(f,e){var d=Hawk.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:e,ttlSec:60*60*24*365*100});c.url+="&bewit="+d;Hawk.uri.authenticate(c,a,{},function(i,h,g){expect(i).to.not.exist();expect(h.user).to.equal("steve");b()})})});it("should successfully authenticate a request (last param)",function(b){var c={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.not.exist();expect(e.user).to.equal("steve");expect(d.ext).to.equal("some-app-data");b()})});it("should successfully authenticate a request (first param)",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ&a=1&b=2",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.not.exist();expect(e.user).to.equal("steve");expect(d.ext).to.equal("some-app-data");b()})});it("should successfully authenticate a request (only param)",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.not.exist();expect(e.user).to.equal("steve");expect(d.ext).to.equal("some-app-data");b()})});it("should fail on multiple authentication",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Multiple authentications");b()})});it("should fail on method other than GET",function(b){a("123456",function(g,d){var f={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080};var h=Math.floor(Hawk.utils.now()/1000)+60;var e="some-app-data";var i=Hawk.crypto.calculateMac("bewit",d,{timestamp:h,nonce:"",method:f.method,resource:f.url,host:f.host,port:f.port,ext:e});var c=d.id+"\\"+h+"\\"+i+"\\"+e;f.url+="&bewit="+Hoek.base64urlEncode(c);Hawk.uri.authenticate(f,a,{},function(l,k,j){expect(l).to.exist();expect(l.output.payload.message).to.equal("Invalid method");b()})})});it("should fail on invalid host header",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",headers:{host:"example.com:something"}};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Invalid Host header");b()})});it("should fail on empty bewit",function(b){var c={method:"GET",url:"/resource/4?bewit=",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Empty bewit");expect(f.isMissing).to.not.exist();b()})});it("should fail on invalid bewit",function(b){var c={method:"GET",url:"/resource/4?bewit=*",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Invalid bewit encoding");expect(f.isMissing).to.not.exist();b()})});it("should fail on missing bewit",function(b){var c={method:"GET",url:"/resource/4",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.not.exist();expect(f.isMissing).to.equal(true);b()})});it("should fail on invalid bewit structure",function(b){var c={method:"GET",url:"/resource/4?bewit=abc",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Invalid bewit structure");b()})});it("should fail on empty bewit attribute",function(b){var c={method:"GET",url:"/resource/4?bewit=YVxcY1xk",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Missing bewit attributes");b()})});it("should fail on missing bewit id attribute",function(b){var c={method:"GET",url:"/resource/4?bewit=XDQ1NTIxNDc2MjJcK0JFbFhQMXhuWjcvd1Nrbm1ldGhlZm5vUTNHVjZNSlFVRHk4NWpTZVJ4VT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Missing bewit attributes");b()})});it("should fail on expired access",function(b){var c={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDEzNTY0MTg1ODNcWk1wZlMwWU5KNHV0WHpOMmRucTRydEk3NXNXTjFjeWVITTcrL0tNZFdVQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,a,{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Access expired");b()})});it("should fail on credentials function error",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,function(e,d){d(Hawk.error.badRequest("Boom"))},{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Boom");b()})});it("should fail on credentials function error with credentials",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,function(e,d){d(Hawk.error.badRequest("Boom"),{some:"value"})},{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Boom");expect(e.some).to.equal("value");b()})});it("should fail on null credentials function response",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,function(e,d){d(null,null)},{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Unknown credentials");b()})});it("should fail on invalid credentials function response",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,function(e,d){d(null,{})},{},function(f,e,d){expect(f).to.exist();expect(f.message).to.equal("Invalid credentials");b()})});it("should fail on invalid credentials function response (unknown algorithm)",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,function(e,d){d(null,{key:"xxx",algorithm:"xxx"})},{},function(f,e,d){expect(f).to.exist();expect(f.message).to.equal("Unknown algorithm");b()})});it("should fail on expired access",function(b){var c={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(c,function(e,d){d(null,{key:"xxx",algorithm:"sha256"})},{},function(f,e,d){expect(f).to.exist();expect(f.output.payload.message).to.equal("Bad mac");b()})});describe("getBewit()",function(){it("returns a valid bewit value",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var b=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:d,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(b).to.equal("MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6");c()});it("returns a valid bewit value (explicit port)",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var b=Hawk.uri.getBewit("https://example.com:8080/somewhere/over/the/rainbow",{credentials:d,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(b).to.equal("MTIzNDU2XDEzNTY0MjA3MDdcaFpiSjNQMmNLRW80a3kwQzhqa1pBa1J5Q1p1ZWc0V1NOYnhWN3ZxM3hIVT1ceGFuZHlhbmR6");c()});it("returns a valid bewit value (null ext)",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var b=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:d,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:null});expect(b).to.equal("MTIzNDU2XDEzNTY0MjA3MDdcSUdZbUxnSXFMckNlOEN4dktQczRKbFdJQStValdKSm91d2dBUmlWaENBZz1c");c()});it("returns a valid bewit value (parsed uri)",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var b=Hawk.uri.getBewit(Url.parse("https://example.com/somewhere/over/the/rainbow"),{credentials:d,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(b).to.equal("MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6");c()});it("errors on invalid options",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var b=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",4);expect(b).to.equal("");c()});it("errors on missing uri",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var b=Hawk.uri.getBewit("",{credentials:d,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(b).to.equal("");c()});it("errors on invalid uri",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var b=Hawk.uri.getBewit(5,{credentials:d,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(b).to.equal("");c()});it("errors on invalid credentials (id)",function(c){var d={key:"2983d45yun89q",algorithm:"sha256"};var b=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:d,ttlSec:3000,ext:"xandyandz"});expect(b).to.equal("");c()});it("errors on missing credentials",function(c){var b=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{ttlSec:3000,ext:"xandyandz"});expect(b).to.equal("");c()});it("errors on invalid credentials (key)",function(c){var d={id:"123456",algorithm:"sha256"};var b=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:d,ttlSec:3000,ext:"xandyandz"});expect(b).to.equal("");c()});it("errors on invalid algorithm",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"};var b=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:d,ttlSec:300,ext:"xandyandz"});expect(b).to.equal("");c()});it("errors on missing options",function(c){var d={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"};var b=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow");expect(b).to.equal("");c()})});describe("authenticateMessage()",function(){it("should generate an authorization then successfully parse it",function(b){a("123456",function(e,c){var d=Hawk.client.message("example.com",8080,"some message",{credentials:c});expect(d).to.exist();Hawk.server.authenticateMessage("example.com",8080,"some message",d,a,{},function(g,f){expect(g).to.not.exist();expect(f.user).to.equal("steve");b()})})});it("should fail authorization on mismatching host",function(b){a("123456",function(e,c){var d=Hawk.client.message("example.com",8080,"some message",{credentials:c});expect(d).to.exist();Hawk.server.authenticateMessage("example1.com",8080,"some message",d,a,{},function(g,f){expect(g).to.exist();expect(g.message).to.equal("Bad mac");b()})})});it("should fail authorization on stale timestamp",function(b){a("123456",function(e,c){var d=Hawk.client.message("example.com",8080,"some message",{credentials:c});expect(d).to.exist();Hawk.server.authenticateMessage("example.com",8080,"some message",d,a,{localtimeOffsetMsec:100000},function(g,f){expect(g).to.exist();expect(g.message).to.equal("Stale timestamp");b()})})});it("overrides timestampSkewSec",function(b){a("123456",function(e,c){var d=Hawk.client.message("example.com",8080,"some message",{credentials:c,localtimeOffsetMsec:100000});expect(d).to.exist();Hawk.server.authenticateMessage("example.com",8080,"some message",d,a,{timestampSkewSec:500},function(g,f){expect(g).to.not.exist();b()})})});it("should fail authorization on invalid authorization",function(b){a("123456",function(e,c){var d=Hawk.client.message("example.com",8080,"some message",{credentials:c});expect(d).to.exist();delete d.id;Hawk.server.authenticateMessage("example.com",8080,"some message",d,a,{},function(g,f){expect(g).to.exist();expect(g.message).to.equal("Invalid authorization");b()})})});it("should fail authorization on bad hash",function(b){a("123456",function(e,c){var d=Hawk.client.message("example.com",8080,"some message",{credentials:c});expect(d).to.exist();Hawk.server.authenticateMessage("example.com",8080,"some message1",d,a,{},function(g,f){expect(g).to.exist();expect(g.message).to.equal("Bad message hash");b()})})});it("should fail authorization on nonce error",function(b){a("123456",function(e,c){var d=Hawk.client.message("example.com",8080,"some message",{credentials:c});expect(d).to.exist();Hawk.server.authenticateMessage("example.com",8080,"some message",d,a,{nonceFunc:function(f,g,h,i){i(new Error("kaboom"))}},function(g,f){expect(g).to.exist();expect(g.message).to.equal("Invalid nonce");b()})})});it("should fail authorization on credentials error",function(b){a("123456",function(f,d){var e=Hawk.client.message("example.com",8080,"some message",{credentials:d});expect(e).to.exist();var c=function(h,g){g(new Error("kablooey"))};Hawk.server.authenticateMessage("example.com",8080,"some message",e,c,{},function(h,g){expect(h).to.exist();expect(h.message).to.equal("kablooey");b()})})});it("should fail authorization on missing credentials",function(b){a("123456",function(f,d){var e=Hawk.client.message("example.com",8080,"some message",{credentials:d});expect(e).to.exist();var c=function(h,g){g()};Hawk.server.authenticateMessage("example.com",8080,"some message",e,c,{},function(h,g){expect(h).to.exist();expect(h.message).to.equal("Unknown credentials");b()})})});it("should fail authorization on invalid credentials",function(b){a("123456",function(f,d){var e=Hawk.client.message("example.com",8080,"some message",{credentials:d});expect(e).to.exist();var c=function(h,g){g(null,{})};Hawk.server.authenticateMessage("example.com",8080,"some message",e,c,{},function(h,g){expect(h).to.exist();expect(h.message).to.equal("Invalid credentials");b()})})});it("should fail authorization on invalid credentials algorithm",function(b){a("123456",function(f,d){var e=Hawk.client.message("example.com",8080,"some message",{credentials:d});expect(e).to.exist();var c=function(h,g){g(null,{key:"123",algorithm:"456"})};Hawk.server.authenticateMessage("example.com",8080,"some message",e,c,{},function(h,g){expect(h).to.exist();expect(h.message).to.equal("Unknown algorithm");b()})})});it("should fail on missing host",function(b){a("123456",function(e,c){var d=Hawk.client.message(null,8080,"some message",{credentials:c});expect(d).to.not.exist();b()})});it("should fail on missing credentials",function(b){var c=Hawk.client.message("example.com",8080,"some message",{});expect(c).to.not.exist();b()});it("should fail on invalid algorithm",function(b){a("123456",function(e,c){var f=Hoek.clone(c);f.algorithm="blah";var d=Hawk.client.message("example.com",8080,"some message",{credentials:f});expect(d).to.not.exist();b()})})})});