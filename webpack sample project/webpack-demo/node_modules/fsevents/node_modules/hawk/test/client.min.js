var Url=require("url");var Code=require("code");var Hawk=require("../lib");var Lab=require("lab");var internals={};var lab=exports.lab=Lab.script();var describe=lab.experiment;var it=lab.test;var expect=Code.expect;describe("Client",function(){describe("header()",function(){it("returns a valid authorization header (sha1)",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.header("http://example.net/somewhere/over/the/rainbow","POST",{credentials:b,ext:"Bazinga!",timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about"}).field;expect(c).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="bsvY3IfUllw6V5rvk4tStEvpBhE=", ext="Bazinga!", mac="qbf1ZPG/r/e06F4ht+T77LXi5vw="');a()});it("returns a valid authorization header (sha256)",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var c=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:b,ext:"Bazinga!",timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"}).field;expect(c).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", ext="Bazinga!", mac="q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8="');a()});it("returns a valid authorization header (no ext)",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var c=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:b,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"}).field;expect(c).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="');a()});it("returns a valid authorization header (null ext)",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var c=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:b,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain",ext:null}).field;expect(c).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="');a()});it("returns a valid authorization header (empty payload)",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var c=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:b,timestamp:1353809207,nonce:"Ygvqdz",payload:"",contentType:"text/plain"}).field;expect(c).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="q/t+NNAkQZNlq/aAD6PlexImwQTxwgT2MahfTa9XRLA=", mac="U5k16YEzn3UnBHKeBzsDXn067Gu3R4YaY6xOt9PYRZM="');a()});it("returns a valid authorization header (pre hashed payload)",function(a){var c={id:"123456",key:"2983d45yun89q",algorithm:"sha256"};var b={credentials:c,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"};b.hash=Hawk.crypto.calculatePayloadHash(b.payload,c.algorithm,b.contentType);var d=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",b).field;expect(d).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="');a()});it("errors on missing uri",function(a){var b=Hawk.client.header("","POST");expect(b.field).to.equal("");expect(b.err).to.equal("Invalid argument type");a()});it("errors on invalid uri",function(a){var b=Hawk.client.header(4,"POST");expect(b.field).to.equal("");expect(b.err).to.equal("Invalid argument type");a()});it("errors on missing method",function(a){var b=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","");expect(b.field).to.equal("");expect(b.err).to.equal("Invalid argument type");a()});it("errors on invalid method",function(a){var b=Hawk.client.header("https://example.net/somewhere/over/the/rainbow",5);expect(b.field).to.equal("");expect(b.err).to.equal("Invalid argument type");a()});it("errors on missing options",function(a){var b=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST");expect(b.field).to.equal("");expect(b.err).to.equal("Invalid argument type");a()});it("errors on invalid credentials (id)",function(a){var b={key:"2983d45yun89q",algorithm:"sha256"};var c=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:b,ext:"Bazinga!",timestamp:1353809207});expect(c.field).to.equal("");expect(c.err).to.equal("Invalid credential object");a()});it("errors on missing credentials",function(a){var b=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",{ext:"Bazinga!",timestamp:1353809207});expect(b.field).to.equal("");expect(b.err).to.equal("Invalid credential object");a()});it("errors on invalid credentials",function(a){var b={id:"123456",algorithm:"sha256"};var c=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:b,ext:"Bazinga!",timestamp:1353809207});expect(c.field).to.equal("");expect(c.err).to.equal("Invalid credential object");a()});it("errors on invalid algorithm",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"};var c=Hawk.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:b,payload:"something, anything!",ext:"Bazinga!",timestamp:1353809207});expect(c.field).to.equal("");expect(c.err).to.equal("Unknown algorithm");a()})});describe("authenticate()",function(){it("returns false on invalid header",function(a){var b={headers:{"server-authorization":'Hawk mac="abc", bad="xyz"'}};expect(Hawk.client.authenticate(b,{})).to.equal(false);a()});it("returns false on invalid mac",function(a){var d={headers:{"content-type":"text/plain","server-authorization":'Hawk mac="_IJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'}};var b={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1362336900",nonce:"eb5S_L",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",app:undefined,dlg:undefined,mac:"BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=",id:"123456"};var c={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};expect(Hawk.client.authenticate(d,c,b)).to.equal(false);a()});it("returns true on ignoring hash",function(a){var d={headers:{"content-type":"text/plain","server-authorization":'Hawk mac="XIJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'}};var b={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1362336900",nonce:"eb5S_L",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",app:undefined,dlg:undefined,mac:"BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=",id:"123456"};var c={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};expect(Hawk.client.authenticate(d,c,b)).to.equal(true);a()});it("fails on invalid WWW-Authenticate header format",function(a){var b='Hawk ts="1362346425875", tsm="PhwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", x="Stale timestamp"';expect(Hawk.client.authenticate({headers:{"www-authenticate":b}},{})).to.equal(false);a()});it("fails on invalid WWW-Authenticate header format",function(a){var b={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};var c='Hawk ts="1362346425875", tsm="hwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", error="Stale timestamp"';expect(Hawk.client.authenticate({headers:{"www-authenticate":c}},b)).to.equal(false);a()});it("skips tsm validation when missing ts",function(a){var b='Hawk error="Stale timestamp"';expect(Hawk.client.authenticate({headers:{"www-authenticate":b}},{})).to.equal(true);a()})});describe("message()",function(){it("generates authorization",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message("example.com",80,"I am the boodyman",{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.exist();expect(c.ts).to.equal(1353809207);expect(c.nonce).to.equal("abc123");a()});it("errors on invalid host",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message(5,80,"I am the boodyman",{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.not.exist();a()});it("errors on invalid port",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message("example.com","80","I am the boodyman",{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.not.exist();a()});it("errors on missing host",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message("example.com",0,"I am the boodyman",{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.not.exist();a()});it("errors on null message",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message("example.com",80,null,{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.not.exist();a()});it("errors on missing message",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message("example.com",80,undefined,{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.not.exist();a()});it("errors on invalid message",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message("example.com",80,5,{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.not.exist();a()});it("errors on missing options",function(a){var b={id:"123456",key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message("example.com",80,"I am the boodyman");expect(c).to.not.exist();a()});it("errors on invalid credentials (id)",function(a){var b={key:"2983d45yun89q",algorithm:"sha1"};var c=Hawk.client.message("example.com",80,"I am the boodyman",{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.not.exist();a()});it("errors on invalid credentials (key)",function(a){var b={id:"123456",algorithm:"sha1"};var c=Hawk.client.message("example.com",80,"I am the boodyman",{credentials:b,timestamp:1353809207,nonce:"abc123"});expect(c).to.not.exist();a()})})});