"use strict";var _typeof=function(a){return a&&typeof Symbol!=="undefined"&&a.constructor===Symbol?"symbol":typeof a};var Url=require("url");var Hoek=require("hoek");var Cryptiles=require("cryptiles");var Crypto=require("./crypto");var Utils=require("./utils");var internals={};exports.header=function(b,a,i){var j={field:"",artifacts:{}};if(!b||typeof b!=="string"&&(typeof b==="undefined"?"undefined":_typeof(b))!=="object"||!a||typeof a!=="string"||!i||(typeof i==="undefined"?"undefined":_typeof(i))!=="object"){j.err="Invalid argument type";return j}var e=i.timestamp||Utils.nowSecs(i.localtimeOffsetMsec);var c=i.credentials;if(!c||!c.id||!c.key||!c.algorithm){j.err="Invalid credential object";return j}if(Crypto.algorithms.indexOf(c.algorithm)===-1){j.err="Unknown algorithm";return j}if(typeof b==="string"){b=Url.parse(b)}var h={ts:e,nonce:i.nonce||Cryptiles.randomString(6),method:a,resource:b.pathname+(b.search||""),host:b.hostname,port:b.port||(b.protocol==="http:"?80:443),hash:i.hash,ext:i.ext,app:i.app,dlg:i.dlg};j.artifacts=h;if(!h.hash&&(i.payload||i.payload==="")){h.hash=Crypto.calculatePayloadHash(i.payload,c.algorithm,i.contentType)}var f=Crypto.calculateMac("header",c,h);var g=h.ext!==null&&h.ext!==undefined&&h.ext!=="";var d='Hawk id="'+c.id+'", ts="'+h.ts+'", nonce="'+h.nonce+(h.hash?'", hash="'+h.hash:"")+(g?'", ext="'+Hoek.escapeHeaderAttribute(h.ext):"")+'", mac="'+f+'"';if(h.app){d=d+', app="'+h.app+(h.dlg?'", dlg="'+h.dlg:"")+'"'}j.field=d;return j};exports.authenticate=function(g,b,h,i){h=Hoek.clone(h);i=i||{};if(g.headers["www-authenticate"]){var a=Utils.parseAuthorizationHeader(g.headers["www-authenticate"],["ts","tsm","error"]);if(a instanceof Error){return false}if(a.ts){var e=Crypto.calculateTsMac(a.ts,b);if(e!==a.tsm){return false}}}if(!g.headers["server-authorization"]&&!i.required){return true}var d=Utils.parseAuthorizationHeader(g.headers["server-authorization"],["mac","ext","hash"]);if(d instanceof Error){return false}h.ext=d.ext;h.hash=d.hash;var f=Crypto.calculateMac("response",b,h);if(f!==d.mac){return false}if(!i.payload&&i.payload!==""){return true}if(!d.hash){return false}var c=Crypto.calculatePayloadHash(i.payload,b.algorithm,g.headers["content-type"]);return c===d.hash};exports.getBewit=function(e,c){if(!e||typeof e!=="string"&&(typeof e==="undefined"?"undefined":_typeof(e))!=="object"||!c||(typeof c==="undefined"?"undefined":_typeof(c))!=="object"||!c.ttlSec){return""}c.ext=c.ext===null||c.ext===undefined?"":c.ext;var b=Utils.now(c.localtimeOffsetMsec);var d=c.credentials;if(!d||!d.id||!d.key||!d.algorithm){return""}if(Crypto.algorithms.indexOf(d.algorithm)===-1){return""}if(typeof e==="string"){e=Url.parse(e)}var f=Math.floor(b/1000)+c.ttlSec;var g=Crypto.calculateMac("bewit",d,{ts:f,nonce:"",method:"GET",resource:e.pathname+(e.search||""),host:e.hostname,port:e.port||(e.protocol==="http:"?80:443),ext:c.ext});var a=d.id+"\\"+f+"\\"+g+"\\"+c.ext;return Hoek.base64urlEncode(a)};exports.message=function(g,b,f,d){if(!g||typeof g!=="string"||!b||typeof b!=="number"||f===null||f===undefined||typeof f!=="string"||!d||(typeof d==="undefined"?"undefined":_typeof(d))!=="object"){return null}var h=d.timestamp||Utils.nowSecs(d.localtimeOffsetMsec);var e=d.credentials;if(!e||!e.id||!e.key||!e.algorithm){return null}if(Crypto.algorithms.indexOf(e.algorithm)===-1){return null}var c={ts:h,nonce:d.nonce||Cryptiles.randomString(6),host:g,port:b,hash:Crypto.calculatePayloadHash(f,e.algorithm)};var a={id:e.id,ts:c.ts,nonce:c.nonce,hash:c.hash,mac:Crypto.calculateMac("message",e,c)};return a};