var aws4=exports,url=require("url"),querystring=require("querystring"),crypto=require("crypto"),lru=require("./lru"),credentialsCache=lru(1000);function hmac(b,a,c){return crypto.createHmac("sha256",b).update(a,"utf8").digest(c)}function hash(a,b){return crypto.createHash("sha256").update(a,"utf8").digest(b)}function encodeRfc3986(a){return a.replace(/[!'()*]/g,function(b){return"%"+b.charCodeAt(0).toString(16).toUpperCase()})}function RequestSigner(c,b){if(typeof c==="string"){c=url.parse(c)}var d=c.headers=(c.headers||{}),a=this.matchHost(c.hostname||c.host||d.Host||d.host);this.request=c;this.credentials=b||this.defaultCredentials();this.service=c.service||a[0]||"";this.region=c.region||a[1]||"us-east-1";if(this.service==="email"){this.service="ses"}if(!c.method&&c.body){c.method="POST"}if(!d.Host&&!d.host){d.Host=c.hostname||c.host||this.createHost();if(c.port){d.Host+=":"+c.port}}if(!c.hostname&&!c.host){c.hostname=d.Host||d.host}this.isCodeCommitGit=this.service==="codecommit"&&c.method==="GIT"}RequestSigner.prototype.matchHost=function(c){var b=(c||"").match(/([^\.]+)\.(?:([^\.]*)\.)?amazonaws\.com$/);var a=(b||[]).slice(1,3);if(a[1]==="es"){a=a.reverse()}return a};RequestSigner.prototype.isSingleRegion=function(){if(["s3","sdb"].indexOf(this.service)>=0&&this.region==="us-east-1"){return true}return["cloudfront","ls","route53","iam","importexport","sts"].indexOf(this.service)>=0};RequestSigner.prototype.createHost=function(){var b=this.isSingleRegion()?"":(this.service==="s3"&&this.region!=="us-east-1"?"-":".")+this.region,a=this.service==="ses"?"email":this.service;return a+b+".amazonaws.com"};RequestSigner.prototype.prepareRequest=function(){this.parsePath();var a=this.request,c=a.headers,b;if(a.signQuery){this.parsedPath.query=b=this.parsedPath.query||{};if(this.credentials.sessionToken){b["X-Amz-Security-Token"]=this.credentials.sessionToken}if(this.service==="s3"&&!b["X-Amz-Expires"]){b["X-Amz-Expires"]=86400}if(b["X-Amz-Date"]){this.datetime=b["X-Amz-Date"]}else{b["X-Amz-Date"]=this.getDateTime()}b["X-Amz-Algorithm"]="AWS4-HMAC-SHA256";b["X-Amz-Credential"]=this.credentials.accessKeyId+"/"+this.credentialString();b["X-Amz-SignedHeaders"]=this.signedHeaders()}else{if(!a.doNotModifyHeaders&&!this.isCodeCommitGit){if(a.body&&!c["Content-Type"]&&!c["content-type"]){c["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8"}if(a.body&&!c["Content-Length"]&&!c["content-length"]){c["Content-Length"]=Buffer.byteLength(a.body)}if(this.credentials.sessionToken&&!c["X-Amz-Security-Token"]&&!c["x-amz-security-token"]){c["X-Amz-Security-Token"]=this.credentials.sessionToken}if(this.service==="s3"&&!c["X-Amz-Content-Sha256"]&&!c["x-amz-content-sha256"]){c["X-Amz-Content-Sha256"]=hash(this.request.body||"","hex")}if(c["X-Amz-Date"]||c["x-amz-date"]){this.datetime=c["X-Amz-Date"]||c["x-amz-date"]}else{c["X-Amz-Date"]=this.getDateTime()}}delete c.Authorization;delete c.authorization}};RequestSigner.prototype.sign=function(){if(!this.parsedPath){this.prepareRequest()}if(this.request.signQuery){this.parsedPath.query["X-Amz-Signature"]=this.signature()}else{this.request.headers.Authorization=this.authHeader()}this.request.path=this.formatPath();return this.request};RequestSigner.prototype.getDateTime=function(){if(!this.datetime){var b=this.request.headers,a=new Date(b.Date||b.date||new Date);this.datetime=a.toISOString().replace(/[:\-]|\.\d{3}/g,"");if(this.isCodeCommitGit){this.datetime=this.datetime.slice(0,-1)}}return this.datetime};RequestSigner.prototype.getDate=function(){return this.getDateTime().substr(0,8)};RequestSigner.prototype.authHeader=function(){return["AWS4-HMAC-SHA256 Credential="+this.credentials.accessKeyId+"/"+this.credentialString(),"SignedHeaders="+this.signedHeaders(),"Signature="+this.signature()].join(", ")};RequestSigner.prototype.signature=function(){var c=this.getDate(),f=[this.credentials.secretAccessKey,c,this.region,this.service].join(),d,a,b,e=credentialsCache.get(f);if(!e){d=hmac("AWS4"+this.credentials.secretAccessKey,c);a=hmac(d,this.region);b=hmac(a,this.service);e=hmac(b,"aws4_request");credentialsCache.set(f,e)}return hmac(e,this.stringToSign(),"hex")};RequestSigner.prototype.stringToSign=function(){return["AWS4-HMAC-SHA256",this.getDateTime(),this.credentialString(),hash(this.canonicalString(),"hex")].join("\n")};RequestSigner.prototype.canonicalString=function(){if(!this.parsedPath){this.prepareRequest()}var i=this.parsedPath.path,h=this.parsedPath.query,b=this.request.headers,c="",g=this.service!=="s3",f=this.service==="s3"||this.request.doNotEncodePath,d=this.service==="s3",a=this.service==="s3",e;if(this.service==="s3"&&this.request.signQuery){e="UNSIGNED-PAYLOAD"}else{if(this.isCodeCommitGit){e=""}else{e=b["X-Amz-Content-Sha256"]||b["x-amz-content-sha256"]||hash(this.request.body||"","hex")}}if(h){c=encodeRfc3986(querystring.stringify(Object.keys(h).sort().reduce(function(k,j){if(!j){return k}k[j]=!Array.isArray(h[j])?h[j]:(a?h[j][0]:h[j].slice().sort());return k},{})))}if(i!=="/"){if(g){i=i.replace(/\/{2,}/g,"/")}i=i.split("/").reduce(function(k,j){if(g&&j===".."){k.pop()}else{if(!g||j!=="."){if(f){j=querystring.unescape(j)}k.push(encodeRfc3986(querystring.escape(j)))}}return k},[]).join("/");if(i[0]!=="/"){i="/"+i}if(d){i=i.replace(/%2F/g,"/")}}return[this.request.method||"GET",i,c,this.canonicalHeaders()+"\n",this.signedHeaders(),e].join("\n")};RequestSigner.prototype.canonicalHeaders=function(){var b=this.request.headers;function a(c){return c.toString().trim().replace(/\s+/g," ")}return Object.keys(b).sort(function(d,c){return d.toLowerCase()<c.toLowerCase()?-1:1}).map(function(c){return c.toLowerCase()+":"+a(b[c])}).join("\n")};RequestSigner.prototype.signedHeaders=function(){return Object.keys(this.request.headers).map(function(a){return a.toLowerCase()}).sort().join(";")};RequestSigner.prototype.credentialString=function(){return[this.getDate(),this.region,this.service,"aws4_request"].join("/")};RequestSigner.prototype.defaultCredentials=function(){var a=process.env;return{accessKeyId:a.AWS_ACCESS_KEY_ID||a.AWS_ACCESS_KEY,secretAccessKey:a.AWS_SECRET_ACCESS_KEY||a.AWS_SECRET_KEY,sessionToken:a.AWS_SESSION_TOKEN}};RequestSigner.prototype.parsePath=function(){var b=this.request.path||"/",c=b.indexOf("?"),a=null;if(c>=0){a=querystring.parse(b.slice(c+1));b=b.slice(0,c)}if(/[^0-9A-Za-z!'()*\-._~%/]/.test(b)){b=b.split("/").map(function(d){return querystring.escape(querystring.unescape(d))}).join("/")}this.parsedPath={path:b,query:a}};RequestSigner.prototype.formatPath=function(){var b=this.parsedPath.path,a=this.parsedPath.query;if(!a){return b}if(a[""]!=null){delete a[""]}return b+"?"+encodeRfc3986(querystring.stringify(a))};aws4.RequestSigner=RequestSigner;aws4.sign=function(b,a){return new RequestSigner(b,a).sign()};