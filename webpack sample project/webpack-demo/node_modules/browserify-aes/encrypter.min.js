var MODES=require("./modes");var AuthCipher=require("./authCipher");var Buffer=require("safe-buffer").Buffer;var StreamCipher=require("./streamCipher");var Transform=require("cipher-base");var aes=require("./aes");var ebtk=require("evp_bytestokey");var inherits=require("inherits");function Cipher(c,b,a){Transform.call(this);this._cache=new Splitter();this._cipher=new aes.AES(b);this._prev=Buffer.from(a);this._mode=c;this._autopadding=true}inherits(Cipher,Transform);Cipher.prototype._update=function(d){this._cache.add(d);var c;var b;var a=[];while((c=this._cache.get())){b=this._mode.encrypt(this,c);a.push(b)}return Buffer.concat(a)};var PADDING=Buffer.alloc(16,16);Cipher.prototype._final=function(){var a=this._cache.flush();if(this._autopadding){a=this._mode.encrypt(this,a);this._cipher.scrub();return a}if(!a.equals(PADDING)){this._cipher.scrub();throw new Error("data not multiple of block length")}};Cipher.prototype.setAutoPadding=function(a){this._autopadding=!!a;return this};function Splitter(){this.cache=Buffer.allocUnsafe(0)}Splitter.prototype.add=function(a){this.cache=Buffer.concat([this.cache,a])};Splitter.prototype.get=function(){if(this.cache.length>15){var a=this.cache.slice(0,16);this.cache=this.cache.slice(16);return a}return null};Splitter.prototype.flush=function(){var a=16-this.cache.length;var b=Buffer.allocUnsafe(a);var c=-1;while(++c<a){b.writeUInt8(a,c)}return Buffer.concat([this.cache,b])};function createCipheriv(d,c,b){var a=MODES[d.toLowerCase()];if(!a){throw new TypeError("invalid suite type")}if(typeof c==="string"){c=Buffer.from(c)}if(c.length!==a.key/8){throw new TypeError("invalid key length "+c.length)}if(typeof b==="string"){b=Buffer.from(b)}if(b.length!==a.iv){throw new TypeError("invalid iv length "+b.length)}if(a.type==="stream"){return new StreamCipher(a.module,c,b)}else{if(a.type==="auth"){return new AuthCipher(a.module,c,b)}}return new Cipher(a.module,c,b)}function createCipher(c,b){var a=MODES[c.toLowerCase()];if(!a){throw new TypeError("invalid suite type")}var d=ebtk(b,false,a.key,a.iv);return createCipheriv(c,d.key,d.iv)}exports.createCipheriv=createCipheriv;exports.createCipher=createCipher;