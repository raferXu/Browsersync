var AuthCipher=require("./authCipher");var Buffer=require("safe-buffer").Buffer;var MODES=require("./modes");var StreamCipher=require("./streamCipher");var Transform=require("cipher-base");var aes=require("./aes");var ebtk=require("evp_bytestokey");var inherits=require("inherits");function Decipher(c,b,a){Transform.call(this);this._cache=new Splitter();this._last=void 0;this._cipher=new aes.AES(b);this._prev=Buffer.from(a);this._mode=c;this._autopadding=true}inherits(Decipher,Transform);Decipher.prototype._update=function(d){this._cache.add(d);var c;var b;var a=[];while((c=this._cache.get(this._autopadding))){b=this._mode.decrypt(this,c);a.push(b)}return Buffer.concat(a)};Decipher.prototype._final=function(){var a=this._cache.flush();if(this._autopadding){return unpad(this._mode.decrypt(this,a))}else{if(a){throw new Error("data not multiple of block length")}}};Decipher.prototype.setAutoPadding=function(a){this._autopadding=!!a;return this};function Splitter(){this.cache=Buffer.allocUnsafe(0)}Splitter.prototype.add=function(a){this.cache=Buffer.concat([this.cache,a])};Splitter.prototype.get=function(b){var a;if(b){if(this.cache.length>16){a=this.cache.slice(0,16);this.cache=this.cache.slice(16);return a}}else{if(this.cache.length>=16){a=this.cache.slice(0,16);this.cache=this.cache.slice(16);return a}}return null};Splitter.prototype.flush=function(){if(this.cache.length){return this.cache}};function unpad(c){var b=c[15];var a=-1;while(++a<b){if(c[(a+(16-b))]!==b){throw new Error("unable to decrypt data")}}if(b===16){return}return c.slice(0,16-b)}function createDecipheriv(d,c,b){var a=MODES[d.toLowerCase()];if(!a){throw new TypeError("invalid suite type")}if(typeof b==="string"){b=Buffer.from(b)}if(b.length!==a.iv){throw new TypeError("invalid iv length "+b.length)}if(typeof c==="string"){c=Buffer.from(c)}if(c.length!==a.key/8){throw new TypeError("invalid key length "+c.length)}if(a.type==="stream"){return new StreamCipher(a.module,c,b,true)}else{if(a.type==="auth"){return new AuthCipher(a.module,c,b,true)}}return new Decipher(a.module,c,b)}function createDecipher(c,b){var a=MODES[c.toLowerCase()];if(!a){throw new TypeError("invalid suite type")}var d=ebtk(b,false,a.key,a.iv);return createDecipheriv(c,d.key,d.iv)}exports.createDecipher=createDecipher;exports.createDecipheriv=createDecipheriv;