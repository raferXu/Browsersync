var BN=require("bn.js");var MillerRabin=require("miller-rabin");var millerRabin=new MillerRabin();var TWENTYFOUR=new BN(24);var ELEVEN=new BN(11);var TEN=new BN(10);var THREE=new BN(3);var SEVEN=new BN(7);var primes=require("./generatePrime");var randomBytes=require("randombytes");module.exports=DH;function setPublicKey(b,a){a=a||"utf8";if(!Buffer.isBuffer(b)){b=new Buffer(b,a)}this._pub=new BN(b);return this}function setPrivateKey(b,a){a=a||"utf8";if(!Buffer.isBuffer(b)){b=new Buffer(b,a)}this._priv=new BN(b);return this}var primeCache={};function checkPrime(b,d){var e=d.toString("hex");var c=[e,b.toString(16)].join("_");if(c in primeCache){return primeCache[c]}var a=0;if(b.isEven()||!primes.simpleSieve||!primes.fermatTest(b)||!millerRabin.test(b)){a+=1;if(e==="02"||e==="05"){a+=8}else{a+=4}primeCache[c]=a;return a}if(!millerRabin.test(b.shrn(1))){a+=2}var f;switch(e){case"02":if(b.mod(TWENTYFOUR).cmp(ELEVEN)){a+=8}break;case"05":f=b.mod(TEN);if(f.cmp(THREE)&&f.cmp(SEVEN)){a+=8}break;default:a+=4}primeCache[c]=a;return a}function DH(a,c,b){this.setGenerator(c);this.__prime=new BN(a);this._prime=BN.mont(this.__prime);this._primeLen=a.length;this._pub=undefined;this._priv=undefined;this._primeCode=undefined;if(b){this.setPublicKey=setPublicKey;this.setPrivateKey=setPrivateKey}else{this._primeCode=8}}Object.defineProperty(DH.prototype,"verifyError",{enumerable:true,get:function(){if(typeof this._primeCode!=="number"){this._primeCode=checkPrime(this.__prime,this.__gen)}return this._primeCode}});DH.prototype.generateKeys=function(){if(!this._priv){this._priv=new BN(randomBytes(this._primeLen))}this._pub=this._gen.toRed(this._prime).redPow(this._priv).fromRed();return this.getPublicKey()};DH.prototype.computeSecret=function(a){a=new BN(a);a=a.toRed(this._prime);var b=a.redPow(this._priv).fromRed();var c=new Buffer(b.toArray());var d=this.getPrime();if(c.length<d.length){var e=new Buffer(d.length-c.length);e.fill(0);c=Buffer.concat([e,c])}return c};DH.prototype.getPublicKey=function getPublicKey(a){return formatReturnValue(this._pub,a)};DH.prototype.getPrivateKey=function getPrivateKey(a){return formatReturnValue(this._priv,a)};DH.prototype.getPrime=function(a){return formatReturnValue(this.__prime,a)};DH.prototype.getGenerator=function(a){return formatReturnValue(this._gen,a)};DH.prototype.setGenerator=function(b,a){a=a||"utf8";if(!Buffer.isBuffer(b)){b=new Buffer(b,a)}this.__gen=b;this._gen=new BN(b);return this};function formatReturnValue(c,a){var b=new Buffer(c.toArray());if(!a){return b}else{return b.toString(a)}};