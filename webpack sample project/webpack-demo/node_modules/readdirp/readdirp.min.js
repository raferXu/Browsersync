"use strict";var fs=require("graceful-fs"),path=require("path"),minimatch=require("minimatch"),toString=Object.prototype.toString,si=require("set-immediate-shim");function isFunction(a){return toString.call(a)==="[object Function]"}function isString(a){return toString.call(a)==="[object String]"}function isRegExp(a){return toString.call(a)==="[object RegExp]"}function isUndefined(a){return a===void 0}function readdir(m,j,i){var e,k,b,c=0,l=[],g={directories:[],files:[]},h,q,r,o=false,t=false;if(isUndefined(j)){var n=require("./stream-api")();e=n.stream;j=n.processEntry;i=n.done;k=n.handleError;b=n.handleFatalError;e.on("close",function(){o=true});e.on("pause",function(){t=true});e.on("resume",function(){t=false})}else{k=function(u){l.push(u)};b=function(u){k(u);q(l,null)}}if(isUndefined(m)){b(new Error("Need to pass at least one argument: opts! \nhttps://github.com/thlorenz/readdirp#options"));return e}m.root=m.root||".";m.fileFilter=m.fileFilter||function(){return true};m.directoryFilter=m.directoryFilter||function(){return true};m.depth=typeof m.depth==="undefined"?999999999:m.depth;m.entryType=m.entryType||"files";var p=m.lstat===true?fs.lstat.bind(fs):fs.stat.bind(fs);if(isUndefined(i)){h=function(){};q=j}else{h=j;q=i}function f(v){if(isUndefined(v)){return undefined}function u(w){function y(z){return z.indexOf("!")===0}var x=w.some(y);if(!x){return false}else{if(w.every(y)){return true}else{throw new Error("Cannot mix negated with non negated glob filters: "+w+"\nhttps://github.com/thlorenz/readdirp#filters")}}}if(isFunction(v)){return v}else{if(isString(v)){return function(w){return minimatch(w.name,v.trim())}}else{if(v&&Array.isArray(v)){if(v){v=v.map(function(w){return w.trim()})}return u(v)?function(w){return v.every(function(x){return minimatch(w.name,x)})}:function(w){return v.some(function(x){return minimatch(w.name,x)})}}}}}function a(y,u,v){if(o){return}var w=u.length,z=0,x=[];fs.realpath(y,function(C,A){if(o){return}if(C){k(C);v(x);return}var B=path.relative(r,A);if(u.length===0){v([])}else{u.forEach(function(E){var D=path.join(A,E),F=path.join(B,E);p(D,function(H,G){if(H){k(H)}else{x.push({name:E,path:F,fullPath:D,parentDir:B,fullParentDir:A,stat:G})}z++;if(z===w){v(x)}})})}})}function s(w,x,v){var u=arguments;if(o){return}if(t){si(function(){s.apply(null,u)});return}fs.readdir(w,function(z,y){if(z){k(z);v();return}a(w,y,function(C){var B=C.filter(function(D){return D.stat.isDirectory()&&m.directoryFilter(D)});B.forEach(function(D){if(m.entryType==="directories"||m.entryType==="both"||m.entryType==="all"){h(D)}g.directories.push(D)});C.filter(function(E){var D=m.entryType==="all"?!E.stat.isDirectory():E.stat.isFile()||E.stat.isSymbolicLink();return D&&m.fileFilter(E)}).forEach(function(D){if(m.entryType==="files"||m.entryType==="both"||m.entryType==="all"){h(D)}g.files.push(D)});var A=B.length;if(A===0||x===m.depth){v()}else{B.forEach(function(D){s(D.fullPath,x+1,function(){A=A-1;if(A===0){v()}})})}})})}try{m.fileFilter=f(m.fileFilter);m.directoryFilter=f(m.directoryFilter)}catch(d){b(d);return e}fs.realpath(m.root,function(v,u){if(v){b(v);return e}r=u;s(m.root,0,function(){if(l.length>0){q(l,g)}else{q(null,g)}})});return e}module.exports=readdir;