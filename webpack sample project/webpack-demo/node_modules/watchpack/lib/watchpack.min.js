var watcherManager=require("./watcherManager");var EventEmitter=require("events").EventEmitter;function Watchpack(a){EventEmitter.call(this);if(!a){a={}}if(!a.aggregateTimeout){a.aggregateTimeout=200}this.options=a;this.watcherOptions={ignored:a.ignored,poll:a.poll};this.fileWatchers=[];this.dirWatchers=[];this.mtimes=Object.create(null);this.paused=false;this.aggregatedChanges=[];this.aggregatedRemovals=[];this.aggregateTimeout=0;this._onTimeout=this._onTimeout.bind(this)}module.exports=Watchpack;Watchpack.prototype=Object.create(EventEmitter.prototype);Watchpack.prototype.watch=function watch(b,e,a){this.paused=false;var d=this.fileWatchers;var c=this.dirWatchers;this.fileWatchers=b.map(function(f){return this._fileWatcher(f,watcherManager.watchFile(f,this.watcherOptions,a))},this);this.dirWatchers=e.map(function(f){return this._dirWatcher(f,watcherManager.watchDirectory(f,this.watcherOptions,a))},this);d.forEach(function(f){f.close()},this);c.forEach(function(f){f.close()},this)};Watchpack.prototype.close=function resume(){this.paused=true;if(this.aggregateTimeout){clearTimeout(this.aggregateTimeout)}this.fileWatchers.forEach(function(a){a.close()},this);this.dirWatchers.forEach(function(a){a.close()},this);this.fileWatchers.length=0;this.dirWatchers.length=0};Watchpack.prototype.pause=function pause(){this.paused=true;if(this.aggregateTimeout){clearTimeout(this.aggregateTimeout)}};function addWatchersToArray(a,b){a.forEach(function(c){if(b.indexOf(c.directoryWatcher)<0){b.push(c.directoryWatcher);addWatchersToArray(Object.keys(c.directoryWatcher.directories).reduce(function(d,e){if(c.directoryWatcher.directories[e]!==true){d.push(c.directoryWatcher.directories[e])}return d},[]),b)}})}Watchpack.prototype.getTimes=function(){var a=[];addWatchersToArray(this.fileWatchers.concat(this.dirWatchers),a);var b=Object.create(null);a.forEach(function(c){var d=c.getTimes();Object.keys(d).forEach(function(e){b[e]=d[e]})});return b};Watchpack.prototype._fileWatcher=function _fileWatcher(b,a){a.on("change",function(c,d){this._onChange(b,c,b,d)}.bind(this));a.on("remove",function(c){this._onRemove(b,b,c)}.bind(this));return a};Watchpack.prototype._dirWatcher=function _dirWatcher(b,a){a.on("change",function(d,c,e){this._onChange(b,c,d,e)}.bind(this));return a};Watchpack.prototype._onChange=function _onChange(c,a,b){b=b||c;this.mtimes[b]=a;if(this.paused){return}this.emit("change",b,a);if(this.aggregateTimeout){clearTimeout(this.aggregateTimeout)}if(this.aggregatedChanges.indexOf(c)<0){this.aggregatedChanges.push(c)}this.aggregateTimeout=setTimeout(this._onTimeout,this.options.aggregateTimeout)};Watchpack.prototype._onRemove=function _onRemove(b,a){a=a||b;delete this.mtimes[b];if(this.paused){return}this.emit("remove",b);if(this.aggregateTimeout){clearTimeout(this.aggregateTimeout)}if(this.aggregatedRemovals.indexOf(b)<0){this.aggregatedRemovals.push(b)}this.aggregateTimeout=setTimeout(this._onTimeout,this.options.aggregateTimeout)};Watchpack.prototype._onTimeout=function _onTimeout(){this.aggregateTimeout=0;var b=this.aggregatedChanges;var a=this.aggregatedRemovals;this.aggregatedChanges=[];this.aggregatedRemovals=[];this.emit("aggregated",b,a)};