var EventEmitter=require("events").EventEmitter;var async=require("async");var chokidar=require("chokidar");var fs=require("graceful-fs");var path=require("path");var watcherManager=require("./watcherManager");var FS_ACCURACY=10000;function withoutCase(a){return a.toLowerCase()}function Watcher(b,a,c){EventEmitter.call(this);this.directoryWatcher=b;this.path=a;this.startTime=c&&+c;this.data=0}Watcher.prototype=Object.create(EventEmitter.prototype);Watcher.prototype.constructor=Watcher;Watcher.prototype.checkStartTime=function checkStartTime(a,b){if(typeof this.startTime!=="number"){return !b}var c=this.startTime;return c<=a};Watcher.prototype.close=function close(){this.emit("closed")};function DirectoryWatcher(a,b){EventEmitter.call(this);this.options=b;this.path=a;this.files=Object.create(null);this.directories=Object.create(null);this.watcher=chokidar.watch(a,{ignoreInitial:true,persistent:true,followSymlinks:false,depth:0,atomic:false,alwaysStat:true,ignorePermissionErrors:true,ignored:b.ignored,usePolling:b.poll?true:undefined,interval:typeof b.poll==="number"?b.poll:undefined,disableGlobbing:true});this.watcher.on("add",this.onFileAdded.bind(this));this.watcher.on("addDir",this.onDirectoryAdded.bind(this));this.watcher.on("change",this.onChange.bind(this));this.watcher.on("unlink",this.onFileUnlinked.bind(this));this.watcher.on("unlinkDir",this.onDirectoryUnlinked.bind(this));this.watcher.on("error",this.onWatcherError.bind(this));this.initialScan=true;this.nestedWatching=false;this.initialScanRemoved=[];this.doInitialScan();this.watchers=Object.create(null);this.refs=0}module.exports=DirectoryWatcher;DirectoryWatcher.prototype=Object.create(EventEmitter.prototype);DirectoryWatcher.prototype.constructor=DirectoryWatcher;DirectoryWatcher.prototype.setFileTime=function setFileTime(e,b,d,f){var c=Date.now();var a=this.files[e];this.files[e]=[d?Math.min(c,b):c,b];if(b){b=b+FS_ACCURACY}if(!a){if(b){if(this.watchers[withoutCase(e)]){this.watchers[withoutCase(e)].forEach(function(g){if(!d||g.checkStartTime(b,d)){g.emit("change",b,d?"initial":f)}})}}}else{if(!d&&b&&f!=="add"){if(this.watchers[withoutCase(e)]){this.watchers[withoutCase(e)].forEach(function(g){g.emit("change",b,f)})}}else{if(!d&&!b){if(this.watchers[withoutCase(e)]){this.watchers[withoutCase(e)].forEach(function(g){g.emit("remove",f)})}}}}if(this.watchers[withoutCase(this.path)]){this.watchers[withoutCase(this.path)].forEach(function(g){if(!d||g.checkStartTime(b,d)){g.emit("change",e,b,d?"initial":f)}})}};DirectoryWatcher.prototype.setDirectory=function setDirectory(b,e,c,d){if(b===this.path){if(!c&&this.watchers[withoutCase(this.path)]){this.watchers[withoutCase(this.path)].forEach(function(f){f.emit("change",b,f.data,c?"initial":d)})}}else{var a=this.directories[b];if(!a){if(e){if(this.nestedWatching){this.createNestedWatcher(b)}else{this.directories[b]=true}if(!c&&this.watchers[withoutCase(this.path)]){this.watchers[withoutCase(this.path)].forEach(function(f){f.emit("change",b,f.data,c?"initial":d)})}}}else{if(!e){if(this.nestedWatching){this.directories[b].close()}delete this.directories[b];if(!c&&this.watchers[withoutCase(this.path)]){this.watchers[withoutCase(this.path)].forEach(function(f){f.emit("change",b,f.data,c?"initial":d)})}}}}};DirectoryWatcher.prototype.createNestedWatcher=function(a){this.directories[a]=watcherManager.watchDirectory(a,this.options,1);this.directories[a].on("change",function(c,b,d){if(this.watchers[withoutCase(this.path)]){this.watchers[withoutCase(this.path)].forEach(function(e){if(e.checkStartTime(b,false)){e.emit("change",c,b,d)}})}}.bind(this))};DirectoryWatcher.prototype.setNestedWatching=function(a){if(this.nestedWatching!==!!a){this.nestedWatching=!!a;if(this.nestedWatching){Object.keys(this.directories).forEach(function(b){this.createNestedWatcher(b)},this)}else{Object.keys(this.directories).forEach(function(b){this.directories[b].close();this.directories[b]=true},this)}}};DirectoryWatcher.prototype.watch=function watch(b,c){this.watchers[withoutCase(b)]=this.watchers[withoutCase(b)]||[];this.refs++;var a=new Watcher(this,b,c);a.on("closed",function(){var e=this.watchers[withoutCase(b)].indexOf(a);this.watchers[withoutCase(b)].splice(e,1);if(this.watchers[withoutCase(b)].length===0){delete this.watchers[withoutCase(b)];if(this.path===b){this.setNestedWatching(false)}}if(--this.refs<=0){this.close()}}.bind(this));this.watchers[withoutCase(b)].push(a);var d;if(b===this.path){this.setNestedWatching(true);d=false;Object.keys(this.files).forEach(function(e){var f=this.files[e];if(!d){d=f}else{d=[Math.max(d[0],f[0]),Math.max(d[1],f[1])]}},this)}else{d=this.files[b]}process.nextTick(function(){if(d){var e=d[0]===d[1]?d[0]+FS_ACCURACY:d[0];if(e>=c){a.emit("change",d[1])}}else{if(this.initialScan&&this.initialScanRemoved.indexOf(b)>=0){a.emit("remove")}}}.bind(this));return a};DirectoryWatcher.prototype.onFileAdded=function onFileAdded(a,b){if(a.indexOf(this.path)!==0){return}if(/[\\\/]/.test(a.substr(this.path.length+1))){return}this.setFileTime(a,+b.mtime,false,"add")};DirectoryWatcher.prototype.onDirectoryAdded=function onDirectoryAdded(a){if(a.indexOf(this.path)!==0){return}if(/[\\\/]/.test(a.substr(this.path.length+1))){return}this.setDirectory(a,true,false,"add")};DirectoryWatcher.prototype.onChange=function onChange(b,c){if(b.indexOf(this.path)!==0){return}if(/[\\\/]/.test(b.substr(this.path.length+1))){return}var a=+c.mtime;ensureFsAccuracy(a);this.setFileTime(b,a,false,"change")};DirectoryWatcher.prototype.onFileUnlinked=function onFileUnlinked(a){if(a.indexOf(this.path)!==0){return}if(/[\\\/]/.test(a.substr(this.path.length+1))){return}this.setFileTime(a,null,false,"unlink");if(this.initialScan){this.initialScanRemoved.push(a)}};DirectoryWatcher.prototype.onDirectoryUnlinked=function onDirectoryUnlinked(a){if(a.indexOf(this.path)!==0){return}if(/[\\\/]/.test(a.substr(this.path.length+1))){return}this.setDirectory(a,false,false,"unlink");if(this.initialScan){this.initialScanRemoved.push(a)}};DirectoryWatcher.prototype.onWatcherError=function onWatcherError(){};DirectoryWatcher.prototype.doInitialScan=function doInitialScan(){fs.readdir(this.path,function(b,a){if(b){this.initialScan=false;return}async.forEach(a,function(d,e){var c=path.join(this.path,d);fs.stat(c,function(f,g){if(!this.initialScan){return}if(f){e();return}if(g.isFile()){if(!this.files[c]){this.setFileTime(c,+g.mtime,true)}}else{if(g.isDirectory()){if(!this.directories[c]){this.setDirectory(c,true,true)}}}e()}.bind(this))}.bind(this),function(){this.initialScan=false;this.initialScanRemoved=null}.bind(this))}.bind(this))};DirectoryWatcher.prototype.getTimes=function(){var b=Object.create(null);var a=0;Object.keys(this.files).forEach(function(c){var d=this.files[c];var e;if(d[1]){e=Math.max(d[0],d[1]+FS_ACCURACY)}else{e=d[0]}b[c]=e;if(e>a){a=e}},this);if(this.nestedWatching){Object.keys(this.directories).forEach(function(d){var c=this.directories[d];var e=c.directoryWatcher.getTimes();Object.keys(e).forEach(function(f){var g=e[f];b[f]=g;if(g>a){a=g}})},this);b[this.path]=a}return b};DirectoryWatcher.prototype.close=function(){this.initialScan=false;this.watcher.close();if(this.nestedWatching){Object.keys(this.directories).forEach(function(a){this.directories[a].close()},this)}this.emit("closed")};function ensureFsAccuracy(a){if(!a){return}if(FS_ACCURACY>1&&a%1!==0){FS_ACCURACY=1}else{if(FS_ACCURACY>10&&a%10!==0){FS_ACCURACY=10}else{if(FS_ACCURACY>100&&a%100!==0){FS_ACCURACY=100}else{if(FS_ACCURACY>1000&&a%1000!==0){FS_ACCURACY=1000}else{if(FS_ACCURACY>2000&&a%2000!==0){FS_ACCURACY=2000}}}}}};