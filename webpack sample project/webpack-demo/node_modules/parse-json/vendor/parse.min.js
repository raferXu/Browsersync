var Uni=require("./unicode");function isHexDigit(a){return(a>="0"&&a<="9")||(a>="A"&&a<="F")||(a>="a"&&a<="f")}function isOctDigit(a){return a>="0"&&a<="7"}function isDecDigit(a){return a>="0"&&a<="9"}var unescapeMap={"'":"'",'"':'"',"\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t",v:"\v","/":"/"};function formatError(j,d,h,b,e,f){var l=d+" at "+(b+1)+":"+(e+1),i=h-e-1,k="",a="";var c=f?Uni.isLineTerminator:Uni.isLineTerminatorJSON;if(i<h-70){i=h-70}while(1){var g=j[++i];if(c(g)||i===j.length){if(h>=i){a+="^"}break}k+=g;if(h===i){a+="^"}else{if(h>i){a+=j[i]==="\t"?"\t":" "}}if(k.length>78){break}}return l+"\n"+k+"\n"+a}function parse(q,b){var g=!(b.mode==="json"||b.legacy);var y=g?Uni.isLineTerminator:Uni.isLineTerminatorJSON;var r=g?Uni.isWhiteSpace:Uni.isWhiteSpaceJSON;var c=q.length,m=0,k=0,x=0,j=[];var e=function(){};var a=function(z){return z};if(b._tokenize){(function(){var z=null;e=function(){if(z!==null){throw Error("internal error, token overlap")}z=x};a=function(A,B){if(z!=x){var C={raw:q.substr(z,x-z),type:B,stack:j.slice(0)};if(A!==undefined){C.value=A}b._tokenize.call(null,C)}z=null;return A}})()}function h(C){var B=x-k;if(!C){if(x<c){var A="'"+JSON.stringify(q[x]).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";if(!C){C="Unexpected token "+A}}else{if(!C){C="Unexpected end of input"}}}var z=SyntaxError(formatError(q,C,x,m,B,g));z.row=m+1;z.column=B+1;throw z}function s(z){if(z==="\r"&&q[x]==="\n"){x++}k=x;m++}function t(){var z;while(x<c){e();var A=q[x++];if(A==='"'||(A==="'"&&g)){return a(l(A),"literal")}else{if(A==="{"){a(undefined,"separator");return i()}else{if(A==="["){a(undefined,"separator");return o()}else{if(A==="-"||A==="."||isDecDigit(A)||(g&&(A==="+"||A==="I"||A==="N"))){return a(n(),"literal")}else{if(A==="n"){u("null");return a(null,"literal")}else{if(A==="t"){u("true");return a(true,"literal")}else{if(A==="f"){u("false");return a(false,"literal")}else{x--;return a(undefined)}}}}}}}}}function p(){var A;while(x<c){e();var B=q[x++];if(B==='"'||(B==="'"&&g)){return a(l(B),"key")}else{if(B==="{"){a(undefined,"separator");return i()}else{if(B==="["){a(undefined,"separator");return o()}else{if(B==="."||isDecDigit(B)){return a(n(true),"key")}else{if(g&&Uni.isIdentifierStart(B)||(B==="\\"&&q[x]==="u")){var z=x-1;var A=d();if(A===undefined){x=z;return a(undefined)}else{return a(A,"key")}}else{x--;return a(undefined)}}}}}}}function f(){e();while(x<c){var z=q[x++];if(y(z)){x--;a(undefined,"whitespace");e();x++;s(z);a(undefined,"newline");e()}else{if(r(z)){}else{if(z==="/"&&g&&(q[x]==="/"||q[x]==="*")){x--;a(undefined,"whitespace");e();x++;w(q[x++]==="*");a(undefined,"comment");e()}else{x--;break}}}}return a(undefined,"whitespace")}function w(A){while(x<c){var z=q[x++];if(y(z)){if(!A){x--;return}s(z)}else{if(z==="*"&&A){if(q[x]==="/"){x++;return}}else{}}}if(A){h("Unclosed multiline comment")}}function u(B){var A=x;var z=B.length;for(var C=1;C<z;C++){if(x>=c||B[C]!=q[x]){x=A-1;h()}x++}}function i(){var z=b.null_prototype?Object.create(null):{},C={},E=false;while(x<c){f();var B=p();f();e();var D=q[x++];a(undefined,"separator");if(D==="}"&&B===undefined){if(!g&&E){x--;h("Trailing comma in object")}return z}else{if(D===":"&&B!==undefined){f();j.push(B);var A=t();j.pop();if(A===undefined){h("No value found for key "+B)}if(typeof(B)!=="string"){if(!g||typeof(B)!=="number"){h("Wrong key type: "+B)}}if((B in C||C[B]!=null)&&b.reserved_keys!=="replace"){if(b.reserved_keys==="throw"){h("Reserved key: "+B)}else{}}else{if(typeof(b.reviver)==="function"){A=b.reviver.call(null,B,A)}if(A!==undefined){E=true;Object.defineProperty(z,B,{value:A,enumerable:true,configurable:true,writable:true})}}f();e();var D=q[x++];a(undefined,"separator");if(D===","){continue}else{if(D==="}"){return z}else{h()}}}else{x--;h()}}}h()}function o(){var z=[];while(x<c){f();j.push(z.length);var B=t();j.pop();f();e();var A=q[x++];a(undefined,"separator");if(B!==undefined){if(typeof(b.reviver)==="function"){B=b.reviver.call(null,String(z.length),B)}if(B===undefined){z.length++;B=true}else{z.push(B)}}if(A===","){if(B===undefined){h("Elisions are not supported")}}else{if(A==="]"){if(!g&&B===undefined&&z.length){x--;h("Trailing comma in array")}return z}else{x--;h()}}}}function n(){x--;var F=x,C=q[x++],B;var D=function(H){var I=q.substr(F,x-F);if(H){var G=parseInt(I.replace(/^0o?/,""),8)}else{var G=Number(I)}if(Number.isNaN(G)){x--;h('Bad numeric literal - "'+q.substr(F,x-F+1)+'"')}else{if(!g&&!I.match(/^-?(0|[1-9][0-9]*)(\.[0-9]+)?(e[+-]?[0-9]+)?$/i)){x--;h('Non-json numeric literal - "'+q.substr(F,x-F+1)+'"')}else{return G}}};if(C==="-"||(C==="+"&&g)){C=q[x++]}if(C==="N"&&g){u("NaN");return NaN}if(C==="I"&&g){u("Infinity");return D()}if(C>="1"&&C<="9"){while(x<c&&isDecDigit(q[x])){x++}C=q[x++]}if(C==="0"){C=q[x++];var E=C==="o"||C==="O"||isOctDigit(C);var z=C==="x"||C==="X";if(g&&(E||z)){while(x<c&&(z?isHexDigit:isOctDigit)(q[x])){x++}var A=1;if(q[F]==="-"){A=-1;F++}else{if(q[F]==="+"){F++}}return A*D(E)}}if(C==="."){while(x<c&&isDecDigit(q[x])){x++}C=q[x++]}if(C==="e"||C==="E"){C=q[x++];if(C==="-"||C==="+"){x++}while(x<c&&isDecDigit(q[x])){x++}C=q[x++]}x--;return D()}function d(){x--;var z="";while(x<c){var A=q[x++];if(A==="\\"&&q[x]==="u"&&isHexDigit(q[x+1])&&isHexDigit(q[x+2])&&isHexDigit(q[x+3])&&isHexDigit(q[x+4])){A=String.fromCharCode(parseInt(q.substr(x+1,4),16));x+=5}if(z.length){if(Uni.isIdentifierPart(A)){z+=A}else{x--;return z}}else{if(Uni.isIdentifierStart(A)){z+=A}else{return undefined}}}h()}function l(E){var z="";while(x<c){var B=q[x++];if(B===E){return z}else{if(B==="\\"){if(x>=c){h()}B=q[x++];if(unescapeMap[B]&&(g||(B!="v"&&B!="'"))){z+=unescapeMap[B]}else{if(g&&y(B)){s(B)}else{if(B==="u"||(B==="x"&&g)){var D=B==="u"?4:2;for(var A=0;A<D;A++){if(x>=c){h()}if(!isHexDigit(q[x])){h("Bad escape sequence")}x++}z+=String.fromCharCode(parseInt(q.substr(x-D,D),16))}else{if(g&&isOctDigit(B)){if(B<"4"&&isOctDigit(q[x])&&isOctDigit(q[x+1])){var C=3}else{if(isOctDigit(q[x])){var C=2}else{var C=1}}x+=C-1;z+=String.fromCharCode(parseInt(q.substr(x-C,C),8))}else{if(g){z+=B}else{x--;h()}}}}}}else{if(y(B)){h()}else{if(!g&&B.charCodeAt(0)<32){x--;h("Unexpected control character")}z+=B}}}}h()}f();var v=t();if(v!==undefined||x<c){f();if(x>=c){if(typeof(b.reviver)==="function"){v=b.reviver.call(null,"",v)}return v}else{h()}}else{if(x){h("No data, only a whitespace")}else{h("No data, empty input")}}}module.exports.parse=function parseJSON(b,c){if(typeof(c)==="function"){c={reviver:c}}if(b===undefined){return undefined}if(typeof(b)!=="string"){b=String(b)}if(c==null){c={}}if(c.reserved_keys==null){c.reserved_keys="ignore"}if(c.reserved_keys==="throw"||c.reserved_keys==="ignore"){if(c.null_prototype==null){c.null_prototype=true}}try{return parse(b,c)}catch(d){if(d instanceof SyntaxError&&d.row!=null&&d.column!=null){var a=d;d=SyntaxError(a.message);d.column=a.column;d.row=a.row}throw d}};module.exports.tokenize=function tokenizeJSON(a,b){if(b==null){b={}}b._tokenize=function(d){if(b._addstack){d.stack.unshift.apply(d.stack,b._addstack)}c.push(d)};var c=[];c.data=module.exports.parse(a,b);return c};