"use strict";function SymbolDef(b,a,c){this.name=c.name;this.orig=[c];this.scope=b;this.references=[];this.global=false;this.mangled_name=null;this.undeclared=false;this.index=a;this.id=SymbolDef.next_id++}SymbolDef.next_id=1;SymbolDef.prototype={unmangleable:function(options){if(!options){options={}}return(this.global&&!options.toplevel)||this.undeclared||(!options.eval&&(this.scope.uses_eval||this.scope.uses_with))||(options.keep_fnames&&(this.orig[0] instanceof AST_SymbolLambda||this.orig[0] instanceof AST_SymbolDefun))},mangle:function(c){var b=c.cache&&c.cache.props;if(this.global&&b&&b.has(this.name)){this.mangled_name=b.get(this.name)}else{if(!this.mangled_name&&!this.unmangleable(c)){var d=this.scope;var a=this.orig[0];if(!c.screw_ie8&&a instanceof AST_SymbolLambda){d=d.parent_scope}var e;if(this.defun&&(e=this.defun.variables.get(this.name))){this.mangled_name=e.mangled_name||e.name}else{this.mangled_name=d.next_mangled(c,this)}if(this.global&&b){b.set(this.name,this.mangled_name)}}}}};AST_Toplevel.DEFMETHOD("figure_out_scope",function(d){d=defaults(d,{cache:null,screw_ie8:true});var c=this;var e=c.parent_scope=null;var h=new Dictionary();var a=null;var b=new TreeWalker(function(k,o){if(k instanceof AST_Catch){var q=e;e=new AST_Scope(k);e.init_scope_vars(q);o();e=q;return true}if(k instanceof AST_Scope){k.init_scope_vars(e);var q=e;var n=a;var p=h;a=e=k;h=new Dictionary();o();e=q;a=n;h=p;return true}if(k instanceof AST_LabeledStatement){var m=k.label;if(h.has(m.name)){throw new Error(string_template("Label {name} defined twice",m))}h.set(m.name,m);o();h.del(m.name);return true}if(k instanceof AST_With){for(var r=e;r;r=r.parent_scope){r.uses_with=true}return}if(k instanceof AST_Symbol){k.scope=e}if(k instanceof AST_Label){k.thedef=k;k.references=[]}if(k instanceof AST_SymbolLambda){a.def_function(k)}else{if(k instanceof AST_SymbolDefun){(k.scope=a.parent_scope).def_function(k)}else{if(k instanceof AST_SymbolVar||k instanceof AST_SymbolConst){a.def_variable(k);if(a!==e){k.mark_enclosed(d);var j=e.find_variable(k);if(k.thedef!==j){k.thedef=j;k.reference(d)}}}else{if(k instanceof AST_SymbolCatch){e.def_variable(k).defun=a}else{if(k instanceof AST_LabelRef){var i=h.get(k.name);if(!i){throw new Error(string_template("Undefined label {name} [{line},{col}]",{name:k.name,line:k.start.line,col:k.start.col}))}k.thedef=i}}}}}});c.walk(b);var g=null;var f=c.globals=new Dictionary();var b=new TreeWalker(function(m,l){if(m instanceof AST_Lambda){var n=g;g=m;l();g=n;return true}if(m instanceof AST_LoopControl&&m.label){m.label.thedef.references.push(m);return true}if(m instanceof AST_SymbolRef){var j=m.name;if(j=="eval"&&b.parent() instanceof AST_Call){for(var k=m.scope;k&&!k.uses_eval;k=k.parent_scope){k.uses_eval=true}}var i=m.scope.find_variable(j);if(m.scope instanceof AST_Lambda&&j=="arguments"){m.scope.uses_arguments=true}if(!i){i=c.def_global(m)}m.thedef=i;m.reference(d);return true}});c.walk(b);if(!d.screw_ie8){c.walk(new TreeWalker(function(m,l){if(m instanceof AST_SymbolCatch){var j=m.name;var i=m.thedef.references;var k=m.thedef.defun;var n=k.find_variable(j)||c.globals.get(j)||k.def_variable(m);i.forEach(function(o){o.thedef=n;o.reference(d)});m.thedef=n;return true}}))}if(d.cache){this.cname=d.cache.cname}});AST_Toplevel.DEFMETHOD("def_global",function(d){var c=this.globals,a=d.name;if(c.has(a)){return c.get(a)}else{var b=new SymbolDef(this,c.size(),d);b.undeclared=true;b.global=true;c.set(a,b);return b}});AST_Scope.DEFMETHOD("init_scope_vars",function(a){this.variables=new Dictionary();this.functions=new Dictionary();this.uses_with=false;this.uses_eval=false;this.parent_scope=a;this.enclosed=[];this.cname=-1});AST_Lambda.DEFMETHOD("init_scope_vars",function(){AST_Scope.prototype.init_scope_vars.apply(this,arguments);this.uses_arguments=false;this.def_variable(new AST_SymbolVar({name:"arguments",start:this.start,end:this.end}))});AST_Symbol.DEFMETHOD("mark_enclosed",function(a){var c=this.definition();var b=this.scope;while(b){push_uniq(b.enclosed,c);if(a.keep_fnames){b.functions.each(function(e){push_uniq(c.scope.enclosed,e)})}if(b===c.scope){break}b=b.parent_scope}});AST_Symbol.DEFMETHOD("reference",function(a){this.definition().references.push(this);this.mark_enclosed(a)});AST_Scope.DEFMETHOD("find_variable",function(a){if(a instanceof AST_Symbol){a=a.name}return this.variables.get(a)||(this.parent_scope&&this.parent_scope.find_variable(a))});AST_Scope.DEFMETHOD("def_function",function(a){this.functions.set(a.name,this.def_variable(a))});AST_Scope.DEFMETHOD("def_variable",function(b){var a;if(!this.variables.has(b.name)){a=new SymbolDef(this,this.variables.size(),b);this.variables.set(b.name,a);a.global=!this.parent_scope}else{a=this.variables.get(b.name);a.orig.push(b)}return b.thedef=a});AST_Scope.DEFMETHOD("next_mangled",function(d){var f=this.enclosed;out:while(true){var a=base54(++this.cname);if(!is_identifier(a)){continue}if(d.except.indexOf(a)>=0){continue}for(var e=f.length;--e>=0;){var b=f[e];var c=b.mangled_name||(b.unmangleable(d)&&b.name);if(a==c){continue out}}return a}});AST_Function.DEFMETHOD("next_mangled",function(b,e){var d=e.orig[0] instanceof AST_SymbolFunarg&&this.name&&this.name.definition();var c=d?d.mangled_name||d.name:null;while(true){var a=AST_Lambda.prototype.next_mangled.call(this,b,e);if(!c||c!=a){return a}}});AST_Symbol.DEFMETHOD("unmangleable",function(a){return this.definition().unmangleable(a)});AST_Label.DEFMETHOD("unmangleable",function(){return false});AST_Symbol.DEFMETHOD("unreferenced",function(){return this.definition().references.length==0&&!(this.scope.uses_eval||this.scope.uses_with)});AST_Symbol.DEFMETHOD("undeclared",function(){return this.definition().undeclared});AST_LabelRef.DEFMETHOD("undeclared",function(){return false});AST_Label.DEFMETHOD("undeclared",function(){return false});AST_Symbol.DEFMETHOD("definition",function(){return this.thedef});AST_Symbol.DEFMETHOD("global",function(){return this.definition().global});AST_Toplevel.DEFMETHOD("_default_mangler_options",function(options){return defaults(options,{eval:false,except:[],keep_fnames:false,screw_ie8:true,sort:false,toplevel:false})});AST_Toplevel.DEFMETHOD("mangle_names",function(c){c=this._default_mangler_options(c);c.except.push("arguments");var b=-1;var d=[];if(c.cache){this.globals.each(function(e){if(c.except.indexOf(e.name)<0){d.push(e)}})}var a=new TreeWalker(function(i,h){if(i instanceof AST_LabeledStatement){var g=b;h();b=g;return true}if(i instanceof AST_Scope){var j=a.parent(),e=[];i.variables.each(function(k){if(c.except.indexOf(k.name)<0){e.push(k)}});d.push.apply(d,e);return}if(i instanceof AST_Label){var f;do{f=base54(++b)}while(!is_identifier(f));i.mangled_name=f;return true}if(c.screw_ie8&&i instanceof AST_SymbolCatch){d.push(i.definition());return}});this.walk(a);d.forEach(function(e){e.mangle(c)});if(c.cache){c.cache.cname=this.cname}});AST_Toplevel.DEFMETHOD("compute_char_frequency",function(b){b=this._default_mangler_options(b);var a=new TreeWalker(function(c){if(c instanceof AST_Constant){base54.consider(c.print_to_string())}else{if(c instanceof AST_Return){base54.consider("return")}else{if(c instanceof AST_Throw){base54.consider("throw")}else{if(c instanceof AST_Continue){base54.consider("continue")}else{if(c instanceof AST_Break){base54.consider("break")}else{if(c instanceof AST_Debugger){base54.consider("debugger")}else{if(c instanceof AST_Directive){base54.consider(c.value)}else{if(c instanceof AST_While){base54.consider("while")}else{if(c instanceof AST_Do){base54.consider("do while")}else{if(c instanceof AST_If){base54.consider("if");if(c.alternative){base54.consider("else")}}else{if(c instanceof AST_Var){base54.consider("var")}else{if(c instanceof AST_Const){base54.consider("const")}else{if(c instanceof AST_Lambda){base54.consider("function")}else{if(c instanceof AST_For){base54.consider("for")}else{if(c instanceof AST_ForIn){base54.consider("for in")}else{if(c instanceof AST_Switch){base54.consider("switch")}else{if(c instanceof AST_Case){base54.consider("case")}else{if(c instanceof AST_Default){base54.consider("default")}else{if(c instanceof AST_With){base54.consider("with")}else{if(c instanceof AST_ObjectSetter){base54.consider("set"+c.key)}else{if(c instanceof AST_ObjectGetter){base54.consider("get"+c.key)}else{if(c instanceof AST_ObjectKeyVal){base54.consider(c.key)}else{if(c instanceof AST_New){base54.consider("new")}else{if(c instanceof AST_This){base54.consider("this")}else{if(c instanceof AST_Try){base54.consider("try")}else{if(c instanceof AST_Catch){base54.consider("catch")}else{if(c instanceof AST_Finally){base54.consider("finally")}else{if(c instanceof AST_Symbol&&c.unmangleable(b)){base54.consider(c.name)}else{if(c instanceof AST_Unary||c instanceof AST_Binary){base54.consider(c.operator)}else{if(c instanceof AST_Dot){base54.consider(c.property)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}});this.walk(a);base54.sort()});var base54=(function(){var a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_0123456789";var c,d;function b(){d=Object.create(null);c=a.split("").map(function(f){return f.charCodeAt(0)});c.forEach(function(f){d[f]=0})}e.consider=function(h){for(var f=h.length;--f>=0;){var g=h.charCodeAt(f);if(g in d){++d[g]}}};e.sort=function(){c=mergeSort(c,function(g,f){if(is_digit(g)&&!is_digit(f)){return 1}if(is_digit(f)&&!is_digit(g)){return -1}return d[f]-d[g]})};e.reset=b;b();e.get=function(){return c};e.freq=function(){return d};function e(g){var f="",h=54;g++;do{g--;f+=String.fromCharCode(c[g%h]);g=Math.floor(g/h);h=64}while(g>0);return f}return e})();AST_Toplevel.DEFMETHOD("scope_warnings",function(options){options=defaults(options,{assign_to_global:true,eval:true,func_arguments:true,nested_defuns:true,undeclared:false,unreferenced:true});var tw=new TreeWalker(function(node){if(options.undeclared&&node instanceof AST_SymbolRef&&node.undeclared()){AST_Node.warn("Undeclared symbol: {name} [{file}:{line},{col}]",{name:node.name,file:node.start.file,line:node.start.line,col:node.start.col})}if(options.assign_to_global){var sym=null;if(node instanceof AST_Assign&&node.left instanceof AST_SymbolRef){sym=node.left}else{if(node instanceof AST_ForIn&&node.init instanceof AST_SymbolRef){sym=node.init}}if(sym&&(sym.undeclared()||(sym.global()&&sym.scope!==sym.definition().scope))){AST_Node.warn("{msg}: {name} [{file}:{line},{col}]",{msg:sym.undeclared()?"Accidental global?":"Assignment to global",name:sym.name,file:sym.start.file,line:sym.start.line,col:sym.start.col})}}if(options.eval&&node instanceof AST_SymbolRef&&node.undeclared()&&node.name=="eval"){AST_Node.warn("Eval is used [{file}:{line},{col}]",node.start)}if(options.unreferenced&&(node instanceof AST_SymbolDeclaration||node instanceof AST_Label)&&!(node instanceof AST_SymbolCatch)&&node.unreferenced()){AST_Node.warn("{type} {name} is declared but not referenced [{file}:{line},{col}]",{type:node instanceof AST_Label?"Label":"Symbol",name:node.name,file:node.start.file,line:node.start.line,col:node.start.col})}if(options.func_arguments&&node instanceof AST_Lambda&&node.uses_arguments){AST_Node.warn("arguments used in function {name} [{file}:{line},{col}]",{name:node.name?node.name.name:"anonymous",file:node.start.file,line:node.start.line,col:node.start.col})}if(options.nested_defuns&&node instanceof AST_Defun&&!(tw.parent() instanceof AST_Scope)){AST_Node.warn('Function {name} declared in nested statement "{type}" [{file}:{line},{col}]',{name:node.name.name,type:tw.parent().TYPE,file:node.start.file,line:node.start.line,col:node.start.col})}});this.walk(tw)});