"use strict";var punycode=require("punycode");var util=require("./util");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null}var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,delims=["<",">",'"',"`"," ","\r","\n","\t"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[+a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(b,d,c){if(b&&util.isObject(b)&&b instanceof Url){return b}var a=new Url;a.parse(b,d,c);return a}Url.prototype.parse=function(o,G,K){if(!util.isString(o)){throw new TypeError("Parameter 'url' must be a string, not "+typeof o)}var a=o.indexOf("?"),c=(a!==-1&&a<o.indexOf("#"))?"?":"#",q=o.split(c),g=/\\/g;q[0]=q[0].replace(g,"/");o=q.join(c);var w=o;w=w.trim();if(!K&&o.split("#").length===1){var f=simplePathPattern.exec(w);if(f){this.path=w;this.href=w;this.pathname=f[1];if(f[2]){this.search=f[2];if(G){this.query=querystring.parse(this.search.substr(1))}else{this.query=this.search.substr(1)}}else{if(G){this.search="";this.query={}}}return this}}var A=protocolPattern.exec(w);if(A){A=A[0];var L=A.toLowerCase();this.protocol=L;w=w.substr(A.length)}if(K||A||w.match(/^\/\/[^@\/]+@[^@\/]+/)){var n=w.substr(0,2)==="//";if(n&&!(A&&hostlessProtocol[A])){w=w.substr(2);this.slashes=true}}if(!hostlessProtocol[A]&&(n||(A&&!slashedProtocol[A]))){var d=-1;for(var H=0;H<hostEndingChars.length;H++){var J=w.indexOf(hostEndingChars[H]);if(J!==-1&&(d===-1||J<d)){d=J}}var u,y;if(d===-1){y=w.lastIndexOf("@")}else{y=w.lastIndexOf("@",d)}if(y!==-1){u=w.slice(0,y);w=w.slice(y+1);this.auth=decodeURIComponent(u)}d=-1;for(var H=0;H<nonHostChars.length;H++){var J=w.indexOf(nonHostChars[H]);if(J!==-1&&(d===-1||J<d)){d=J}}if(d===-1){d=w.length}this.host=w.slice(0,d);w=w.slice(d);this.parseHost();this.hostname=this.hostname||"";var m=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!m){var t=this.hostname.split(/\./);for(var H=0,C=t.length;H<C;H++){var B=t[H];if(!B){continue}if(!B.match(hostnamePartPattern)){var N="";for(var F=0,D=B.length;F<D;F++){if(B.charCodeAt(F)>127){N+="x"}else{N+=B[F]}}if(!N.match(hostnamePartPattern)){var E=t.slice(0,H);var r=t.slice(H+1);var v=B.match(hostnamePartStart);if(v){E.push(v[1]);r.unshift(v[2])}if(r.length){w="/"+r.join(".")+w}this.hostname=E.join(".");break}}}}if(this.hostname.length>hostnameMaxLen){this.hostname=""}else{this.hostname=this.hostname.toLowerCase()}if(!m){this.hostname=punycode.toASCII(this.hostname)}var z=this.port?":"+this.port:"";var I=this.hostname||"";this.host=I+z;this.href+=this.host;if(m){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(w[0]!=="/"){w="/"+w}}}if(!unsafeProtocol[L]){for(var H=0,C=autoEscape.length;H<C;H++){var M=autoEscape[H];if(w.indexOf(M)===-1){continue}var O=encodeURIComponent(M);if(O===M){O=escape(M)}w=w.split(M).join(O)}}var b=w.indexOf("#");if(b!==-1){this.hash=w.substr(b);w=w.slice(0,b)}var e=w.indexOf("?");if(e!==-1){this.search=w.substr(e);this.query=w.substr(e+1);if(G){this.query=querystring.parse(this.query)}w=w.slice(0,e)}else{if(G){this.search="";this.query={}}}if(w){this.pathname=w}if(slashedProtocol[L]&&this.hostname&&!this.pathname){this.pathname="/"}if(this.pathname||this.search){var z=this.pathname||"";var x=this.search||"";this.path=z+x}this.href=this.format();return this};function urlFormat(a){if(util.isString(a)){a=urlParse(a)}if(!(a instanceof Url)){return Url.prototype.format.call(a)}return a.format()}Url.prototype.format=function(){var c=this.auth||"";if(c){c=encodeURIComponent(c);c=c.replace(/%3A/i,":");c+="@"}var g=this.protocol||"",f=this.pathname||"",e=this.hash||"",b=false,d="";if(this.host){b=c+this.host}else{if(this.hostname){b=c+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]");if(this.port){b+=":"+this.port}}}if(this.query&&util.isObject(this.query)&&Object.keys(this.query).length){d=querystring.stringify(this.query)}var a=this.search||(d&&("?"+d))||"";if(g&&g.substr(-1)!==":"){g+=":"}if(this.slashes||(!g||slashedProtocol[g])&&b!==false){b="//"+(b||"");if(f&&f.charAt(0)!=="/"){f="/"+f}}else{if(!b){b=""}}if(e&&e.charAt(0)!=="#"){e="#"+e}if(a&&a.charAt(0)!=="?"){a="?"+a}f=f.replace(/[?#]/g,function(h){return encodeURIComponent(h)});a=a.replace("#","%23");return g+b+f+a+e};function urlResolve(b,a){return urlParse(b,false,true).resolve(a)}Url.prototype.resolve=function(a){return this.resolveObject(urlParse(a,false,true)).format()};function urlResolveObject(b,a){if(!b){return a}return urlParse(b,false,true).resolveObject(a)}Url.prototype.resolveObject=function(C){if(util.isString(C)){var d=new Url();d.parse(C,false,true);C=d}var l=new Url();var c=Object.keys(this);for(var e=0;e<c.length;e++){var f=c[e];l[f]=this[f]}l.hash=C.hash;if(C.href===""){l.href=l.format();return l}if(C.slashes&&!C.protocol){var D=Object.keys(C);for(var o=0;o<D.length;o++){var F=D[o];if(F!=="protocol"){l[F]=C[F]}}if(slashedProtocol[l.protocol]&&l.hostname&&!l.pathname){l.path=l.pathname="/"}l.href=l.format();return l}if(C.protocol&&C.protocol!==l.protocol){if(!slashedProtocol[C.protocol]){var r=Object.keys(C);for(var n=0;n<r.length;n++){var y=r[n];l[y]=C[y]}l.href=l.format();return l}l.protocol=C.protocol;if(!C.host&&!hostlessProtocol[C.protocol]){var E=(C.pathname||"").split("/");while(E.length&&!(C.host=E.shift())){}if(!C.host){C.host=""}if(!C.hostname){C.hostname=""}if(E[0]!==""){E.unshift("")}if(E.length<2){E.unshift("")}l.pathname=E.join("/")}else{l.pathname=C.pathname}l.search=C.search;l.query=C.query;l.host=C.host||"";l.auth=C.auth;l.hostname=C.hostname||C.host;l.port=C.port;if(l.pathname||l.search){var u=l.pathname||"";var q=l.search||"";l.path=u+q}l.slashes=l.slashes||C.slashes;l.href=l.format();return l}var t=(l.pathname&&l.pathname.charAt(0)==="/"),A=(C.host||C.pathname&&C.pathname.charAt(0)==="/"),z=(A||t||(l.host&&C.pathname)),g=z,m=l.pathname&&l.pathname.split("/")||[],E=C.pathname&&C.pathname.split("/")||[],b=l.protocol&&!slashedProtocol[l.protocol];if(b){l.hostname="";l.port=null;if(l.host){if(m[0]===""){m[0]=l.host}else{m.unshift(l.host)}}l.host="";if(C.protocol){C.hostname=null;C.port=null;if(C.host){if(E[0]===""){E[0]=C.host}else{E.unshift(C.host)}}C.host=null}z=z&&(E[0]===""||m[0]==="")}if(A){l.host=(C.host||C.host==="")?C.host:l.host;l.hostname=(C.hostname||C.hostname==="")?C.hostname:l.hostname;l.search=C.search;l.query=C.query;m=E}else{if(E.length){if(!m){m=[]}m.pop();m=m.concat(E);l.search=C.search;l.query=C.query}else{if(!util.isNullOrUndefined(C.search)){if(b){l.hostname=l.host=m.shift();var x=l.host&&l.host.indexOf("@")>0?l.host.split("@"):false;if(x){l.auth=x.shift();l.host=l.hostname=x.shift()}}l.search=C.search;l.query=C.query;if(!util.isNull(l.pathname)||!util.isNull(l.search)){l.path=(l.pathname?l.pathname:"")+(l.search?l.search:"")}l.href=l.format();return l}}}if(!m.length){l.pathname=null;if(l.search){l.path="/"+l.search}else{l.path=null}l.href=l.format();return l}var h=m.slice(-1)[0];var a=((l.host||C.host||m.length>1)&&(h==="."||h==="..")||h==="");var j=0;for(var B=m.length;B>=0;B--){h=m[B];if(h==="."){m.splice(B,1)}else{if(h===".."){m.splice(B,1);j++}else{if(j){m.splice(B,1);j--}}}}if(!z&&!g){for(;j--;j){m.unshift("..")}}if(z&&m[0]!==""&&(!m[0]||m[0].charAt(0)!=="/")){m.unshift("")}if(a&&(m.join("/").substr(-1)!=="/")){m.push("")}var w=m[0]===""||(m[0]&&m[0].charAt(0)==="/");if(b){l.hostname=l.host=w?"":m.length?m.shift():"";var x=l.host&&l.host.indexOf("@")>0?l.host.split("@"):false;if(x){l.auth=x.shift();l.host=l.hostname=x.shift()}}z=z||(l.host&&m.length);if(z&&!w){m.unshift("")}if(!m.length){l.pathname=null;l.path=null}else{l.pathname=m.join("/")}if(!util.isNull(l.pathname)||!util.isNull(l.search)){l.path=(l.pathname?l.pathname:"")+(l.search?l.search:"")}l.auth=C.auth||l.auth;l.slashes=l.slashes||C.slashes;l.href=l.format();return l};Url.prototype.parseHost=function(){var b=this.host;var a=portPattern.exec(b);if(a){a=a[0];if(a!==":"){this.port=a.substr(1)}b=b.substr(0,b.length-a.length)}if(b){this.hostname=b}};