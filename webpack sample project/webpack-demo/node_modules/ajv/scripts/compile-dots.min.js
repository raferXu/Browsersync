"use strict";var glob=require("glob"),fs=require("fs"),path=require("path"),doT=require("dot"),beautify=require("js-beautify").js_beautify;var defsRootPath=process.argv[2]||path.join(__dirname,"../lib");var defs={};var defFiles=glob.sync("./dot/**/*.def",{cwd:defsRootPath});defFiles.forEach(function(b){var a=path.basename(b,".def");defs[a]=fs.readFileSync(path.join(defsRootPath,b))});var filesRootPath=process.argv[3]||path.join(__dirname,"../lib");var files=glob.sync("./dot/**/*.jst",{cwd:filesRootPath});var dotjsPath=path.join(filesRootPath,"./dotjs");try{fs.mkdirSync(dotjsPath)}catch(e){}console.log("\n\nCompiling:");var FUNCTION_NAME=/function\s+anonymous\s*\(it[^)]*\)\s*{/;var OUT_EMPTY_STRING=/out\s*\+=\s*'\s*';/g;var ISTANBUL=/'(istanbul[^']+)';/g;var ERROR_KEYWORD=/\$errorKeyword/g;var ERROR_KEYWORD_OR=/\$errorKeyword\s+\|\|/g;var VARS=["$errs","$valid","$lvl","$data","$dataLvl","$errorKeyword","$closingBraces","$schemaPath","$validate"];files.forEach(function(h){var b=path.basename(h,".jst");var j=path.join(dotjsPath,b+".js");var d=fs.readFileSync(path.join(filesRootPath,h));var g=doT.compile(d,defs);g=g.toString().replace(OUT_EMPTY_STRING,"").replace(FUNCTION_NAME,"function generate_"+b+"(it, $keyword, $ruleType) {").replace(ISTANBUL,"/* $1 */");a();VARS.forEach(c);g="'use strict';\nmodule.exports = "+g;g=beautify(g,{indent_size:2})+"\n";fs.writeFileSync(j,g);console.log("compiled",b);function c(f){f=f.replace(/\$/g,"\\$$");var l=new RegExp(f+"[^A-Za-z0-9_$]","g");var k=i(l);if(k==1){l=new RegExp("var\\s+"+f+"\\s*=[^;]+;|var\\s+"+f+";");g=g.replace(l,"")}}function a(){var k=i(ERROR_KEYWORD);var f=i(ERROR_KEYWORD_OR);if(k==f+1){g=g.replace(ERROR_KEYWORD_OR,"")}}function i(f){return(g.match(f)||[]).length}});