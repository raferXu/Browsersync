"use strict";var url=require("url"),equal=require("fast-deep-equal"),util=require("./util"),SchemaObject=require("./schema_obj"),traverse=require("json-schema-traverse");module.exports=resolve;resolve.normalizeId=normalizeId;resolve.fullPath=getFullPath;resolve.url=resolveUrl;resolve.ids=resolveIds;resolve.inlineRef=inlineRef;resolve.schema=resolveSchema;function resolve(h,a,g){var f=this._refs[g];if(typeof f=="string"){if(this._refs[f]){f=this._refs[f]}else{return resolve.call(this,h,a,f)}}f=f||this._schemas[g];if(f instanceof SchemaObject){return inlineRef(f.schema,this._opts.inlineRefs)?f.schema:f.validate||this._compile(f)}var d=resolveSchema.call(this,a,g);var e,c,b;if(d){e=d.schema;a=d.root;b=d.baseId}if(e instanceof SchemaObject){c=e.validate||h.call(this,e.schema,a,undefined,b)}else{if(e!==undefined){c=inlineRef(e,this._opts.inlineRefs)?e:h.call(this,e,a,undefined,b)}}return c}function resolveSchema(a,e){var f=url.parse(e,false,true),c=_getFullPath(f),b=getFullPath(this._getId(a.schema));if(c!==b){var g=normalizeId(c);var d=this._refs[g];if(typeof d=="string"){return resolveRecursive.call(this,a,d,f)}else{if(d instanceof SchemaObject){if(!d.validate){this._compile(d)}a=d}else{d=this._schemas[g];if(d instanceof SchemaObject){if(!d.validate){this._compile(d)}if(g==normalizeId(e)){return{schema:d,root:a,baseId:b}}a=d}else{return}}}if(!a.schema){return}b=getFullPath(this._getId(a.schema))}return getJsonPointer.call(this,f,b,a.schema,a)}function resolveRecursive(a,e,f){var c=resolveSchema.call(this,a,e);if(c){var d=c.schema;var b=c.baseId;a=c.root;var g=this._getId(d);if(g){b=resolveUrl(b,g)}return getJsonPointer.call(this,f,b,d,a)}}var PREVENT_SCOPE_CHANGE=util.toHash(["properties","patternProperties","enum","dependencies","definitions"]);function getJsonPointer(g,k,c,h){g.hash=g.hash||"";if(g.hash.slice(0,2)!="#/"){return}var d=g.hash.split("/");for(var e=1;e<d.length;e++){var b=d[e];if(b){b=util.unescapeFragment(b);c=c[b];if(c===undefined){break}var a;if(!PREVENT_SCOPE_CHANGE[b]){a=this._getId(c);if(a){k=resolveUrl(k,a)}if(c.$ref){var j=resolveUrl(k,c.$ref);var f=resolveSchema.call(this,h,j);if(f){c=f.schema;h=f.root;k=f.baseId}}}}}if(c!==undefined&&c!==h.schema){return{schema:c,root:h,baseId:k}}}var SIMPLE_INLINED=util.toHash(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum"]);function inlineRef(b,a){if(a===false){return false}if(a===undefined||a===true){return checkNoRef(b)}else{if(a){return countKeys(b)<=a}}}function checkNoRef(d){var c;if(Array.isArray(d)){for(var b=0;b<d.length;b++){c=d[b];if(typeof c=="object"&&!checkNoRef(c)){return false}}}else{for(var a in d){if(a=="$ref"){return false}c=d[a];if(typeof c=="object"&&!checkNoRef(c)){return false}}}return true}function countKeys(e){var d=0,c;if(Array.isArray(e)){for(var b=0;b<e.length;b++){c=e[b];if(typeof c=="object"){d+=countKeys(c)}if(d==Infinity){return Infinity}}}else{for(var a in e){if(a=="$ref"){return Infinity}if(SIMPLE_INLINED[a]){d++}else{c=e[a];if(typeof c=="object"){d+=countKeys(c)+1}if(d==Infinity){return Infinity}}}}return d}function getFullPath(c,a){if(a!==false){c=normalizeId(c)}var b=url.parse(c,false,true);return _getFullPath(b)}function _getFullPath(b){var a=b.protocol||b.href.slice(0,2)=="//"?"//":"";return(b.protocol||"")+a+(b.host||"")+(b.path||"")+"#"}var TRAILING_SLASH_HASH=/#\/?$/;function normalizeId(a){return a?a.replace(TRAILING_SLASH_HASH,""):""}function resolveUrl(a,b){b=normalizeId(b);return url.resolve(a,b)}function resolveIds(e){var d=normalizeId(this._getId(e));var f={"":d};var c={"":getFullPath(d,false)};var a={};var b=this;traverse(e,{allKeys:true},function(g,l,k,q,o,p,i){if(l===""){return}var h=b._getId(g);var n=f[q];var j=c[q]+"/"+o;if(i!==undefined){j+="/"+(typeof i=="number"?i:util.escapeFragment(i))}if(typeof h=="string"){h=n=normalizeId(n?url.resolve(n,h):h);var m=b._refs[h];if(typeof m=="string"){m=b._refs[m]}if(m&&m.schema){if(!equal(g,m.schema)){throw new Error('id "'+h+'" resolves to more than one schema')}}else{if(h!=normalizeId(j)){if(h[0]=="#"){if(a[h]&&!equal(g,a[h])){throw new Error('id "'+h+'" resolves to more than one schema')}a[h]=g}else{b._refs[h]=j}}}}f[l]=n;c[l]=j});return a};