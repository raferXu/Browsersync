"use strict";var resolve=require("./resolve"),util=require("./util"),errorClasses=require("./error_classes"),stableStringify=require("json-stable-stringify");var validateGenerator=require("../dotjs/validate");var co=require("co");var ucs2length=util.ucs2length;var equal=require("fast-deep-equal");var ValidationError=errorClasses.Validation;module.exports=compile;function compile(x,y,j,s){var w=this,t=this._opts,A=[undefined],h={},e=[],u={},o=[],b={},d=[];y=y||{schema:x,refVal:A,refs:h};var B=checkCompiling.call(this,x,y,s);var C=this._compilations[B.index];if(B.compiling){return(C.callValidate=q)}var k=this._formats;var a=this.RULES;try{var r=m(x,y,j,s);C.validate=r;var i=C.callValidate;if(i){i.schema=r.schema;i.errors=null;i.refs=r.refs;i.refVal=r.refVal;i.root=r.root;i.$async=r.$async;if(t.sourceCode){i.source=r.source}}return r}finally{endCompiling.call(this,x,y,s)}function q(){var v=C.validate;var c=v.apply(null,arguments);q.errors=v.errors;return c}function m(K,H,M,L){var G=!H||(H&&H.schema==K);if(H.schema!=y.schema){return compile.call(w,K,H,M,L)}var F=K.$async===true;var v=validateGenerator({isTop:true,schema:K,isRoot:G,baseId:L,root:H,schemaPath:"",errSchemaPath:"#",errorPath:'""',MissingRefError:errorClasses.MissingRef,RULES:a,validate:validateGenerator,util:util,resolve:resolve,resolveRef:g,usePattern:E,useDefault:D,useCustomRule:p,opts:t,formats:k,self:w});v=vars(A,refValCode)+vars(e,patternCode)+vars(o,defaultCode)+vars(d,customRuleCode)+v;if(t.processCode){v=t.processCode(v)}var J;try{var c=new Function("self","RULES","formats","root","refVal","defaults","customRules","co","equal","ucs2length","ValidationError",v);J=c(w,a,k,y,A,o,d,co,equal,ucs2length,ValidationError);A[0]=J}catch(I){console.error("Error compiling schema, function code:",v);throw I}J.schema=K;J.errors=null;J.refs=h;J.refVal=A;J.root=G?J:H;if(F){J.$async=true}if(t.sourceCode===true){J.source={code:v,patterns:e,defaults:o}}return J}function g(K,F,H){F=resolve.url(K,F);var M=h[F];var G,I;if(M!==undefined){G=A[M];I="refVal["+M+"]";return z(G,I)}if(!H&&y.refs){var c=y.refs[F];if(c!==undefined){G=y.refVal[c];I=f(F,G);return z(G,I)}}I=f(F);var L=resolve.call(w,m,y,F);if(L===undefined){var J=j&&j[F];if(J){L=resolve.inlineRef(J,t.inlineRefs)?J:compile.call(w,J,y,j,K)}}if(L===undefined){l(F)}else{n(F,L);return z(L,I)}}function f(F,c){var G=A.length;A[G]=c;h[F]=G;return"refVal"+G}function l(c){delete h[c]}function n(F,c){var G=h[F];A[G]=c}function z(v,c){return typeof v=="object"||typeof v=="boolean"?{code:c,schema:v,inline:true}:{code:c,$async:v&&v.$async}}function E(v){var c=u[v];if(c===undefined){c=u[v]=e.length;e[c]=v}return"pattern"+c}function D(F){switch(typeof F){case"boolean":case"number":return""+F;case"string":return util.toQuotedString(F);case"object":if(F===null){return"null"}var c=stableStringify(F);var v=b[c];if(v===undefined){v=b[c]=o.length;o[v]=F}return"default"+v}}function p(L,F,N,G){var I=L.definition.validateSchema;if(I&&w._opts.validateSchema!==false){var c=I(F);if(!c){var O="keyword schema is invalid: "+w.errorsText(I.errors);if(w._opts.validateSchema=="log"){console.error(O)}else{throw new Error(O)}}}var M=L.definition.compile,J=L.definition.inline,v=L.definition.macro;var K;if(M){K=M.call(w,F,N,G)}else{if(v){K=v.call(w,F,N,G);if(t.validateSchema!==false){w.validateSchema(K,true)}}else{if(J){K=J.call(w,G,L.keyword,F,N)}else{K=L.definition.validate;if(!K){return}}}}if(K===undefined){throw new Error('custom keyword "'+L.keyword+'"failed to compile')}var H=d.length;d[H]=K;return{code:"customRule"+H,validate:K}}}function checkCompiling(d,a,b){var c=compIndex.call(this,d,a,b);if(c>=0){return{index:c,compiling:true}}c=this._compilations.length;this._compilations[c]={schema:d,root:a,baseId:b};return{index:c,compiling:false}}function endCompiling(d,a,b){var c=compIndex.call(this,d,a,b);if(c>=0){this._compilations.splice(c,1)}}function compIndex(e,a,b){for(var d=0;d<this._compilations.length;d++){var f=this._compilations[d];if(f.schema==e&&f.root==a&&f.baseId==b){return d}}return -1}function patternCode(a,b){return"var pattern"+a+" = new RegExp("+util.toQuotedString(b[a])+");"}function defaultCode(a){return"var default"+a+" = defaults["+a+"];"}function refValCode(a,b){return b[a]===undefined?"":"var refVal"+a+" = refVal["+a+"];"}function customRuleCode(a){return"var customRule"+a+" = customRules["+a+"];"}function vars(a,d){if(!a.length){return""}var c="";for(var b=0;b<a.length;b++){c+=d(b,a)}return c};