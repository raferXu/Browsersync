"use strict";var compileSchema=require("./compile"),resolve=require("./compile/resolve"),Cache=require("./cache"),SchemaObject=require("./compile/schema_obj"),stableStringify=require("json-stable-stringify"),formats=require("./compile/formats"),rules=require("./compile/rules"),$dataMetaSchema=require("./$data"),patternGroups=require("./patternGroups"),util=require("./compile/util"),co=require("co");module.exports=Ajv;Ajv.prototype.validate=validate;Ajv.prototype.compile=compile;Ajv.prototype.addSchema=addSchema;Ajv.prototype.addMetaSchema=addMetaSchema;Ajv.prototype.validateSchema=validateSchema;Ajv.prototype.getSchema=getSchema;Ajv.prototype.removeSchema=removeSchema;Ajv.prototype.addFormat=addFormat;Ajv.prototype.errorsText=errorsText;Ajv.prototype._addSchema=_addSchema;Ajv.prototype._compile=_compile;Ajv.prototype.compileAsync=require("./compile/async");var customKeyword=require("./keyword");Ajv.prototype.addKeyword=customKeyword.add;Ajv.prototype.getKeyword=customKeyword.get;Ajv.prototype.removeKeyword=customKeyword.remove;var errorClasses=require("./compile/error_classes");Ajv.ValidationError=errorClasses.Validation;Ajv.MissingRefError=errorClasses.MissingRef;Ajv.$dataMetaSchema=$dataMetaSchema;var META_SCHEMA_ID="http://json-schema.org/draft-06/schema";var META_IGNORE_OPTIONS=["removeAdditional","useDefaults","coerceTypes"];var META_SUPPORT_DATA=["/properties"];function Ajv(b){if(!(this instanceof Ajv)){return new Ajv(b)}b=this._opts=util.copy(b)||{};this._schemas={};this._refs={};this._fragments={};this._formats=formats(b.format);var a=this._schemaUriFormat=this._formats["uri-reference"];this._schemaUriFormatFunc=function(c){return a.test(c)};this._cache=b.cache||new Cache;this._loadingSchemas={};this._compilations=[];this.RULES=rules();this._getId=chooseGetId(b);b.loopRequired=b.loopRequired||Infinity;if(b.errorDataPath=="property"){b._errorDataPathProperty=true}if(b.serialize===undefined){b.serialize=stableStringify}this._metaOpts=getMetaSchemaOptions(this);if(b.formats){addInitialFormats(this)}addDraft6MetaSchema(this);if(typeof b.meta=="object"){this.addMetaSchema(b.meta)}addInitialSchemas(this);if(b.patternGroups){patternGroups(this)}}function validate(b,e){var a;if(typeof b=="string"){a=this.getSchema(b);if(!a){throw new Error('no schema with key or ref "'+b+'"')}}else{var c=this._addSchema(b);a=c.validate||this._compile(c)}var d=a(e);if(a.$async===true){return this._opts.async=="*"?co(d):d}this.errors=a.errors;return d}function compile(c,b){var a=this._addSchema(c,undefined,b);return a.validate||this._compile(a)}function addSchema(e,b,d,c){if(Array.isArray(e)){for(var a=0;a<e.length;a++){this.addSchema(e[a],undefined,d,c)}return}var f=this._getId(e);if(f!==undefined&&typeof f!="string"){throw new Error("schema id must be string")}b=resolve.normalizeId(b||f);checkUnique(this,b);this._schemas[b]=this._addSchema(e,d,c,true)}function addMetaSchema(c,a,b){this.addSchema(c,a,b,true)}function validateSchema(e,b){var f=e.$schema;if(f!==undefined&&typeof f!="string"){throw new Error("$schema must be a string")}f=f||this._opts.defaultMeta||defaultMeta(this);if(!f){console.warn("meta-schema not available");this.errors=null;return true}var a=this._formats.uri;this._formats.uri=typeof a=="function"?this._schemaUriFormatFunc:this._schemaUriFormat;var d;try{d=this.validate(f,e)}finally{this._formats.uri=a}if(!d&&b){var c="schema is invalid: "+this.errorsText();if(this._opts.validateSchema=="log"){console.error(c)}else{throw new Error(c)}}return d}function defaultMeta(a){var b=a._opts.meta;a._opts.defaultMeta=typeof b=="object"?a._getId(b)||b:a.getSchema(META_SCHEMA_ID)?META_SCHEMA_ID:undefined;return a._opts.defaultMeta}function getSchema(b){var a=_getSchemaObj(this,b);switch(typeof a){case"object":return a.validate||this._compile(a);case"string":return this.getSchema(a);case"undefined":return _getSchemaFragment(this,b)}}function _getSchemaFragment(d,g){var e=resolve.schema.call(d,{schema:{}},g);if(e){var f=e.schema,a=e.root,c=e.baseId;var b=compileSchema.call(d,f,a,undefined,c);d._fragments[g]=new SchemaObject({ref:g,fragment:true,schema:f,root:a,baseId:c,validate:b});return b}}function _getSchemaObj(a,b){b=resolve.normalizeId(b);return a._schemas[b]||a._refs[b]||a._fragments[b]}function removeSchema(a){if(a instanceof RegExp){_removeAllSchemas(this,this._schemas,a);_removeAllSchemas(this,this._refs,a);return}switch(typeof a){case"undefined":_removeAllSchemas(this,this._schemas);_removeAllSchemas(this,this._refs);this._cache.clear();return;case"string":var c=_getSchemaObj(this,a);if(c){this._cache.del(c.cacheKey)}delete this._schemas[a];delete this._refs[a];return;case"object":var b=this._opts.serialize;var d=b?b(a):a;this._cache.del(d);var e=this._getId(a);if(e){e=resolve.normalizeId(e);delete this._schemas[e];delete this._refs[e]}}}function _removeAllSchemas(a,b,d){for(var e in b){var c=b[e];if(!c.meta&&(!d||d.test(e))){a._cache.del(c.cacheKey);delete b[e]}}}function _addSchema(e,b,k,g){if(typeof e!="object"&&typeof e!="boolean"){throw new Error("schema should be object or boolean")}var l=this._opts.serialize;var h=l?l(e):e;var c=this._cache.get(h);if(c){return c}g=g||this._opts.addUsedSchema!==false;var a=resolve.normalizeId(this._getId(e));if(a&&g){checkUnique(this,a)}var d=this._opts.validateSchema!==false&&!b;var f;if(d&&!(f=a&&a==resolve.normalizeId(e.$schema))){this.validateSchema(e,true)}var j=resolve.ids.call(this,e);var i=new SchemaObject({id:a,schema:e,localRefs:j,cacheKey:h,meta:k});if(a[0]!="#"&&g){this._refs[a]=i}this._cache.put(h,i);if(d&&f){this.validateSchema(e,true)}return i}function _compile(d,a){if(d.compiling){d.validate=e;e.schema=d.schema;e.errors=null;e.root=a?a:e;if(d.schema.$async===true){e.$async=true}return e}d.compiling=true;var c;if(d.meta){c=this._opts;this._opts=this._metaOpts}var b;try{b=compileSchema.call(this,d.schema,a,d.localRefs)}finally{d.compiling=false;if(d.meta){this._opts=c}}d.validate=b;d.refs=b.refs;d.refVal=b.refVal;d.root=b.root;return b;function e(){var g=d.validate;var f=g.apply(null,arguments);e.errors=g.errors;return f}}function chooseGetId(a){switch(a.schemaId){case"$id":return _get$Id;case"id":return _getId;default:return _get$IdOrId}}function _getId(a){if(a.$id){console.warn("schema $id ignored",a.$id)}return a.id}function _get$Id(a){if(a.id){console.warn("schema id ignored",a.id)}return a.$id}function _get$IdOrId(a){if(a.$id&&a.id&&a.$id!=a.id){throw new Error("schema $id is different from id")}return a.$id||a.id}function errorsText(h,a){h=h||this.errors;if(!h){return"No errors"}a=a||{};var f=a.separator===undefined?", ":a.separator;var d=a.dataVar===undefined?"data":a.dataVar;var g="";for(var b=0;b<h.length;b++){var c=h[b];if(c){g+=d+c.dataPath+" "+c.message+f}}return g.slice(0,-f.length)}function addFormat(a,b){if(typeof b=="string"){b=new RegExp(b)}this._formats[a]=b}function addDraft6MetaSchema(b){var c;if(b._opts.$data){c=require("./refs/$data.json");b.addMetaSchema(c,c.$id,true)}if(b._opts.meta===false){return}var a=require("./refs/json-schema-draft-06.json");if(b._opts.$data){a=$dataMetaSchema(a,META_SUPPORT_DATA)}b.addMetaSchema(a,META_SCHEMA_ID,true);b._refs["http://json-schema.org/schema"]=META_SCHEMA_ID}function addInitialSchemas(a){var c=a._opts.schemas;if(!c){return}if(Array.isArray(c)){a.addSchema(c)}else{for(var b in c){a.addSchema(c[b],b)}}}function addInitialFormats(a){for(var b in a._opts.formats){var c=a._opts.formats[b];a.addFormat(b,c)}}function checkUnique(a,b){if(a._schemas[b]||a._refs[b]){throw new Error('schema with key or id "'+b+'" already exists')}}function getMetaSchemaOptions(b){var a=util.copy(b._opts);for(var c=0;c<META_IGNORE_OPTIONS.length;c++){delete a[META_IGNORE_OPTIONS[c]]}return a};