var fs=require("fs");var polyfills=require("./polyfills.js");var legacy=require("./legacy-streams.js");var queue=[];var util=require("util");function noop(){}var debug=noop;if(util.debuglog){debug=util.debuglog("gfs4")}else{if(/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")){debug=function(){var a=util.format.apply(util,arguments);a="GFS4: "+a.split(/\n/).join("\nGFS4: ");console.error(a)}}}if(/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")){process.on("exit",function(){debug(queue);require("assert").equal(queue.length,0)})}module.exports=patch(require("./fs.js"));if(process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH){module.exports=patch(fs)}module.exports.close=fs.close=(function(a){return function(c,b){return a.call(fs,c,function(d){if(!d){retry()}if(typeof b==="function"){b.apply(this,arguments)}})}})(fs.close);module.exports.closeSync=fs.closeSync=(function(a){return function(b){var c=a.apply(fs,arguments);retry();return c}})(fs.closeSync);function patch(h){polyfills(h);h.gracefulify=patch;h.FileReadStream=q;h.FileWriteStream=p;h.createReadStream=k;h.createWriteStream=m;var c=h.readFile;h.readFile=b;function b(y,x,v){if(typeof x==="function"){v=x,x=null}return w(y,x,v);function w(B,A,z){return c(B,A,function(C){if(C&&(C.code==="EMFILE"||C.code==="ENFILE")){enqueue([w,[B,A,z]])}else{if(typeof z==="function"){z.apply(this,arguments)}retry()}})}}var u=h.writeFile;h.writeFile=n;function n(z,y,w,v){if(typeof w==="function"){v=w,w=null}return x(z,y,w,v);function x(D,C,B,A){return u(D,C,B,function(E){if(E&&(E.code==="EMFILE"||E.code==="ENFILE")){enqueue([x,[D,C,B,A]])}else{if(typeof A==="function"){A.apply(this,arguments)}retry()}})}}var e=h.appendFile;if(e){h.appendFile=f}function f(z,y,w,v){if(typeof w==="function"){v=w,w=null}return x(z,y,w,v);function x(D,C,B,A){return e(D,C,B,function(E){if(E&&(E.code==="EMFILE"||E.code==="ENFILE")){enqueue([x,[D,C,B,A]])}else{if(typeof A==="function"){A.apply(this,arguments)}retry()}})}}var s=h.readdir;h.readdir=r;function r(z,y,v){var x=[z];if(typeof y!=="function"){x.push(y)}else{v=y}x.push(w);return t(x);function w(B,A){if(A&&A.sort){A.sort()}if(B&&(B.code==="EMFILE"||B.code==="ENFILE")){enqueue([t,[x]])}else{if(typeof v==="function"){v.apply(this,arguments)}retry()}}}function t(v){return s.apply(h,v)}if(process.version.substr(0,4)==="v0.8"){var j=legacy(h);q=j.ReadStream;p=j.WriteStream}var d=h.ReadStream;q.prototype=Object.create(d.prototype);q.prototype.open=o;var g=h.WriteStream;p.prototype=Object.create(g.prototype);p.prototype.open=a;h.ReadStream=q;h.WriteStream=p;function q(w,v){if(this instanceof q){return d.apply(this,arguments),this}else{return q.apply(Object.create(q.prototype),arguments)}}function o(){var v=this;l(v.path,v.flags,v.mode,function(x,w){if(x){if(v.autoClose){v.destroy()}v.emit("error",x)}else{v.fd=w;v.emit("open",w);v.read()}})}function p(w,v){if(this instanceof p){return g.apply(this,arguments),this}else{return p.apply(Object.create(p.prototype),arguments)}}function a(){var v=this;l(v.path,v.flags,v.mode,function(x,w){if(x){v.destroy();v.emit("error",x)}else{v.fd=w;v.emit("open",w)}})}function k(w,v){return new q(w,v)}function m(w,v){return new p(w,v)}var i=h.open;h.open=l;function l(y,w,z,v){if(typeof z==="function"){v=z,z=null}return x(y,w,z,v);function x(C,B,D,A){return i(C,B,D,function(F,E){if(F&&(F.code==="EMFILE"||F.code==="ENFILE")){enqueue([x,[C,B,D,A]])}else{if(typeof A==="function"){A.apply(this,arguments)}retry()}})}}return h}function enqueue(a){debug("ENQUEUE",a[0].name,a[1]);queue.push(a)}function retry(){var a=queue.shift();if(a){debug("RETRY",a[0].name,a[1]);a[0].apply(null,a[1])}};