const path=require("path");const inspect=require("util").inspect;const camelCase=require("camelcase");const DEFAULT_MARKER="*";module.exports=function(c,j,f){const n={};var d={};var o={};var k;n.addHandler=function(q,w,v,x){var p=[];x=x||function(){};if(Array.isArray(q)){p=q.slice(1);q=q[0]}else{if(typeof q==="object"){var s=(Array.isArray(q.command)||typeof q.command==="string")?q.command:b(q);if(q.aliases){s=[].concat(s).concat(q.aliases)}n.addHandler(s,e(q),q.builder,q.handler);return}}if(typeof v==="object"&&v.builder&&typeof v.handler==="function"){n.addHandler([q].concat(p),w,v.builder,v.handler);return}var t=n.parseCommand(q);p=p.map(function(y){return n.parseCommand(y).cmd});var r=false;var u=[t.cmd].concat(p).filter(function(y){if(y===DEFAULT_MARKER){r=true;return false}return true});if(r&&u.length===0){k={original:q.replace(DEFAULT_MARKER,"").trim(),handler:x,builder:v||{},demanded:t.demanded,optional:t.optional};return}if(r){t.cmd=u[0];p=u.slice(1);q=q.replace(DEFAULT_MARKER,t.cmd)}p.forEach(function(y){o[y]=t.cmd});if(w!==false){j.command(q,w,r,p)}d[t.cmd]={original:q,handler:x,builder:v||{},demanded:t.demanded,optional:t.optional};if(r){k=d[t.cmd]}};n.addDirectory=function(p,r,u,t,s){s=s||{};if(typeof s.recurse!=="boolean"){s.recurse=false}if(!Array.isArray(s.extensions)){s.extensions=["js"]}const q=typeof s.visit==="function"?s.visit:function(v){return v};s.visit=function(y,x,w){const v=q(y,x,w);if(v){if(~r.files.indexOf(x)){return v}r.files.push(x);n.addHandler(v)}return v};require("require-directory")({require:u,filename:t},p,s)};function b(q){const p=require("which-module")(q);if(!p){throw new Error("No command name given for module: "+inspect(q))}return i(p.filename)}function i(p){return path.basename(p,path.extname(p))}function e(s){for(var r=["describe","description","desc"],q=0,p=r.length,t;q<p;q++){t=s[r[q]];if(typeof t==="string"||typeof t==="boolean"){return t}}return false}n.parseCommand=function(s){var q=s.replace(/\s{2,}/g," ");var p=q.split(/\s+(?![^[]*]|[^<]*>)/);var t=/\.*[\][<>]/g;var r={cmd:(p.shift()).replace(t,""),demanded:[],optional:[]};p.forEach(function(w,v){var u=false;w=w.replace(/\s/g,"");if(/\.+[\]>]/.test(w)&&v===p.length-1){u=true}if(/^\[/.test(w)){r.optional.push({cmd:w.replace(t,"").split("|"),variadic:u})}else{r.demanded.push({cmd:w.replace(t,"").split("|"),variadic:u})}});return r};n.getCommands=function(){return Object.keys(d).concat(Object.keys(o))};n.getCommandHandlers=function(){return d};n.hasDefaultCommand=function(){return !!k};n.runCommand=function(u,q,A,z){var r=A.aliases;var w=d[u]||d[o[u]]||k;var t=q.getContext();var p=t.files.length;var v=t.commands.slice();var s=A.argv;var y=null;var x={};if(u){t.commands.push(u)}if(typeof w.builder==="function"){y=w.builder(q.reset(A.aliases));if(q.parsed===false){if(typeof q.getUsageInstance().getUsage()==="undefined"){q.usage("$0 "+(v.length?v.join(" ")+" ":"")+w.original)}s=y?y._parseArgs(null,null,true,z):q._parseArgs(null,null,true,z)}else{s=q.parsed.argv}if(y&&q.parsed===false){r=y.parsed.aliases}else{r=q.parsed.aliases}}else{if(typeof w.builder==="object"){y=q.reset(A.aliases);y.usage("$0 "+(v.length?v.join(" ")+" ":"")+w.original);Object.keys(w.builder).forEach(function(B){y.option(B,w.builder[B])});s=y._parseArgs(null,null,true,z);r=y.parsed.aliases}}if(!q._hasOutput()){x=h(w,s,t,q)}if(!q._hasOutput()){q._runValidation(s,r,x,q.parsed.error)}if(w.handler&&!q._hasOutput()){q._setHasOutput();w.handler(s)}if(u){t.commands.pop()}p=t.files.length-p;if(p>0){t.files.splice(p*-1,p)}return s};function h(t,u,q,r){u._=u._.slice(q.commands.length);var s=t.demanded.slice(0);var w=t.optional.slice(0);var v={};f.positionalCount(s.length,u._.length);while(s.length){var x=s.shift();m(x,u,r,v)}while(w.length){var p=w.shift();m(p,u,r,v)}u._=q.commands.concat(u._);return v}function m(w,p,r,t){var q=null;var v=null;for(var s=0,u;(u=w.cmd[s])!==undefined;s++){if(w.variadic){if(q){p[u]=q.slice(0)}else{p[u]=q=p._.splice(0)}}else{if(!v&&!p._.length){continue}if(v){p[u]=v}else{p[u]=v=p._.shift()}}t[u]=true;l(r,p,u);g(p,u)}}function l(q,p,r){var s=q.getOptions().coerce[r];if(typeof s==="function"){try{p[r]=s(p[r])}catch(t){q.getUsageInstance().fail(t.message,t)}}}function g(p,q){if(/-/.test(q)){const r=camelCase(q);if(typeof p[q]==="object"){p[r]=p[q].slice(0)}else{p[r]=p[q]}}}n.reset=function(){d={};o={};k=undefined;return n};var a;n.freeze=function(){a={};a.handlers=d;a.aliasMap=o;a.defaultCommand=k};n.unfreeze=function(){d=a.handlers;o=a.aliasMap;k=a.defaultCommand;a=undefined};return n};