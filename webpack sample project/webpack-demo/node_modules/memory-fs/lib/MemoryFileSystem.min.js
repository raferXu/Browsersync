var normalize=require("./normalize");var errors=require("errno");var stream=require("readable-stream");var ReadableStream=stream.Readable;var WritableStream=stream.Writable;function MemoryFileSystemError(a,b){Error.call(this);if(Error.captureStackTrace){Error.captureStackTrace(this,arguments.callee)}this.code=a.code;this.errno=a.errno;this.message=a.description;this.path=b}MemoryFileSystemError.prototype=new Error();function MemoryFileSystem(a){this.data=a||{}}module.exports=MemoryFileSystem;function isDir(a){if(typeof a!=="object"){return false}return a[""]===true}function isFile(a){if(typeof a!=="object"){return false}return !a[""]}function pathToArray(b){b=normalize(b);var a=/^\//.test(b);if(!a){if(!/^[A-Za-z]:/.test(b)){throw new MemoryFileSystemError(errors.code.EINVAL,b)}b=b.replace(/[\\\/]+/g,"\\");b=b.split(/[\\\/]/);b[0]=b[0].toUpperCase()}else{b=b.replace(/\/+/g,"/");b=b.substr(1).split("/")}if(!b[b.length-1]){b.pop()}return b}function trueFn(){return true}function falseFn(){return false}MemoryFileSystem.prototype.meta=function(b){var d=pathToArray(b);var c=this.data;for(var a=0;a<d.length-1;a++){if(!isDir(c[d[a]])){return}c=c[d[a]]}return c[d[a]]};MemoryFileSystem.prototype.existsSync=function(a){return !!this.meta(a)};MemoryFileSystem.prototype.statSync=function(a){var b=this.meta(a);if(a==="/"||isDir(b)){return{isFile:falseFn,isDirectory:trueFn,isBlockDevice:falseFn,isCharacterDevice:falseFn,isSymbolicLink:falseFn,isFIFO:falseFn,isSocket:falseFn}}else{if(isFile(b)){return{isFile:trueFn,isDirectory:falseFn,isBlockDevice:falseFn,isCharacterDevice:falseFn,isSymbolicLink:falseFn,isFIFO:falseFn,isSocket:falseFn}}else{throw new MemoryFileSystemError(errors.code.ENOENT,a)}}};MemoryFileSystem.prototype.readFileSync=function(c,b){var e=pathToArray(c);var d=this.data;for(var a=0;a<e.length-1;a++){if(!isDir(d[e[a]])){throw new MemoryFileSystemError(errors.code.ENOENT,c)}d=d[e[a]]}if(!isFile(d[e[a]])){if(isDir(d[e[a]])){throw new MemoryFileSystemError(errors.code.EISDIR,c)}else{throw new MemoryFileSystemError(errors.code.ENOENT,c)}}d=d[e[a]];return b?d.toString(b):d};MemoryFileSystem.prototype.readdirSync=function(b){if(b==="/"){return Object.keys(this.data).filter(Boolean)}var d=pathToArray(b);var c=this.data;for(var a=0;a<d.length-1;a++){if(!isDir(c[d[a]])){throw new MemoryFileSystemError(errors.code.ENOENT,b)}c=c[d[a]]}if(!isDir(c[d[a]])){if(isFile(c[d[a]])){throw new MemoryFileSystemError(errors.code.ENOTDIR,b)}else{throw new MemoryFileSystemError(errors.code.ENOENT,b)}}return Object.keys(c[d[a]]).filter(Boolean)};MemoryFileSystem.prototype.mkdirpSync=function(b){var d=pathToArray(b);if(d.length===0){return}var c=this.data;for(var a=0;a<d.length;a++){if(isFile(c[d[a]])){throw new MemoryFileSystemError(errors.code.ENOTDIR,b)}else{if(!isDir(c[d[a]])){c[d[a]]={"":true}}}c=c[d[a]]}return};MemoryFileSystem.prototype.mkdirSync=function(b){var d=pathToArray(b);if(d.length===0){return}var c=this.data;for(var a=0;a<d.length-1;a++){if(!isDir(c[d[a]])){throw new MemoryFileSystemError(errors.code.ENOENT,b)}c=c[d[a]]}if(isDir(c[d[a]])){throw new MemoryFileSystemError(errors.code.EEXIST,b)}else{if(isFile(c[d[a]])){throw new MemoryFileSystemError(errors.code.ENOTDIR,b)}}c[d[a]]={"":true};return};MemoryFileSystem.prototype._remove=function(c,a,f){var e=pathToArray(c);if(e.length===0){throw new MemoryFileSystemError(errors.code.EPERM,c)}var d=this.data;for(var b=0;b<e.length-1;b++){if(!isDir(d[e[b]])){throw new MemoryFileSystemError(errors.code.ENOENT,c)}d=d[e[b]]}if(!f(d[e[b]])){throw new MemoryFileSystemError(errors.code.ENOENT,c)}delete d[e[b]];return};MemoryFileSystem.prototype.rmdirSync=function(a){return this._remove(a,"Directory",isDir)};MemoryFileSystem.prototype.unlinkSync=function(a){return this._remove(a,"File",isFile)};MemoryFileSystem.prototype.readlinkSync=function(a){throw new MemoryFileSystemError(errors.code.ENOSYS,a)};MemoryFileSystem.prototype.writeFileSync=function(d,c,b){if(!c&&!b){throw new Error("No content")}var f=pathToArray(d);if(f.length===0){throw new MemoryFileSystemError(errors.code.EISDIR,d)}var e=this.data;for(var a=0;a<f.length-1;a++){if(!isDir(e[f[a]])){throw new MemoryFileSystemError(errors.code.ENOENT,d)}e=e[f[a]]}if(isDir(e[f[a]])){throw new MemoryFileSystemError(errors.code.EISDIR,d)}e[f[a]]=b||typeof c==="string"?new Buffer(c,b):c;return};MemoryFileSystem.prototype.join=require("./join");MemoryFileSystem.prototype.pathToArray=pathToArray;MemoryFileSystem.prototype.normalize=normalize;MemoryFileSystem.prototype.createReadStream=function(f,b){var g=new ReadableStream();var a=false;var c;try{c=this.readFileSync(f)}catch(d){g._read=function(){if(a){return}a=true;this.emit("error",d);this.push(null)};return g}b=b||{};b.start=b.start||0;b.end=b.end||c.length;g._read=function(){if(a){return}a=true;this.push(c.slice(b.start,b.end));this.push(null)};return g};MemoryFileSystem.prototype.createWriteStream=function(f,c){var g=new WritableStream(),b=this;try{this.writeFileSync(f,new Buffer(0))}catch(d){g.once("prefinish",function(){g.emit("error",d)});return g}var h=[],a=0;g._write=function(e,i,j){h.push(e);a+=e.length;b.writeFile(f,Buffer.concat(h,a),j)};return g};["stat","readdir","mkdirp","rmdir","unlink","readlink"].forEach(function(a){MemoryFileSystem.prototype[a]=function(d,f){try{var b=this[a+"Sync"](d)}catch(c){setImmediate(function(){f(c)});return}setImmediate(function(){f(null,b)})}});["mkdir","readFile"].forEach(function(a){MemoryFileSystem.prototype[a]=function(f,c,g){if(!g){g=c;c=undefined}try{var b=this[a+"Sync"](f,c)}catch(d){setImmediate(function(){g(d)});return}setImmediate(function(){g(null,b)})}});MemoryFileSystem.prototype.exists=function(a,b){return b(this.existsSync(a))};MemoryFileSystem.prototype.writeFile=function(d,b,a,f){if(!f){f=a;a=undefined}try{this.writeFileSync(d,b,a)}catch(c){return f(c)}return f()};