"use strict";var zlib_deflate=require("./zlib/deflate");var utils=require("./utils/common");var strings=require("./utils/strings");var msg=require("./zlib/messages");var ZStream=require("./zlib/zstream");var toString=Object.prototype.toString;var Z_NO_FLUSH=0;var Z_FINISH=4;var Z_OK=0;var Z_STREAM_END=1;var Z_SYNC_FLUSH=2;var Z_DEFAULT_COMPRESSION=-1;var Z_DEFAULT_STRATEGY=0;var Z_DEFLATED=8;function Deflate(b){if(!(this instanceof Deflate)){return new Deflate(b)}this.options=utils.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY,to:""},b||{});var c=this.options;if(c.raw&&(c.windowBits>0)){c.windowBits=-c.windowBits}else{if(c.gzip&&(c.windowBits>0)&&(c.windowBits<16)){c.windowBits+=16}}this.err=0;this.msg="";this.ended=false;this.chunks=[];this.strm=new ZStream();this.strm.avail_out=0;var a=zlib_deflate.deflateInit2(this.strm,c.level,c.method,c.windowBits,c.memLevel,c.strategy);if(a!==Z_OK){throw new Error(msg[a])}if(c.header){zlib_deflate.deflateSetHeader(this.strm,c.header)}if(c.dictionary){var d;if(typeof c.dictionary==="string"){d=strings.string2buf(c.dictionary)}else{if(toString.call(c.dictionary)==="[object ArrayBuffer]"){d=new Uint8Array(c.dictionary)}else{d=c.dictionary}}a=zlib_deflate.deflateSetDictionary(this.strm,d);if(a!==Z_OK){throw new Error(msg[a])}this._dict_set=true}}Deflate.prototype.push=function(d,e){var b=this.strm;var f=this.options.chunkSize;var a,c;if(this.ended){return false}c=(e===~~e)?e:((e===true)?Z_FINISH:Z_NO_FLUSH);if(typeof d==="string"){b.input=strings.string2buf(d)}else{if(toString.call(d)==="[object ArrayBuffer]"){b.input=new Uint8Array(d)}else{b.input=d}}b.next_in=0;b.avail_in=b.input.length;do{if(b.avail_out===0){b.output=new utils.Buf8(f);b.next_out=0;b.avail_out=f}a=zlib_deflate.deflate(b,c);if(a!==Z_STREAM_END&&a!==Z_OK){this.onEnd(a);this.ended=true;return false}if(b.avail_out===0||(b.avail_in===0&&(c===Z_FINISH||c===Z_SYNC_FLUSH))){if(this.options.to==="string"){this.onData(strings.buf2binstring(utils.shrinkBuf(b.output,b.next_out)))}else{this.onData(utils.shrinkBuf(b.output,b.next_out))}}}while((b.avail_in>0||b.avail_out===0)&&a!==Z_STREAM_END);if(c===Z_FINISH){a=zlib_deflate.deflateEnd(this.strm);this.onEnd(a);this.ended=true;return a===Z_OK}if(c===Z_SYNC_FLUSH){this.onEnd(Z_OK);b.avail_out=0;return true}return true};Deflate.prototype.onData=function(a){this.chunks.push(a)};Deflate.prototype.onEnd=function(a){if(a===Z_OK){if(this.options.to==="string"){this.result=this.chunks.join("")}else{this.result=utils.flattenChunks(this.chunks)}}this.chunks=[];this.err=a;this.msg=this.strm.msg};function deflate(a,b){var c=new Deflate(b);c.push(a,true);if(c.err){throw c.msg}return c.result}function deflateRaw(a,b){b=b||{};b.raw=true;return deflate(a,b)}function gzip(a,b){b=b||{};b.gzip=true;return deflate(a,b)}exports.Deflate=Deflate;exports.deflate=deflate;exports.deflateRaw=deflateRaw;exports.gzip=gzip;