"use strict";var utils=require("./common");var STR_APPLY_OK=true;var STR_APPLY_UIA_OK=true;try{String.fromCharCode.apply(null,[0])}catch(__){STR_APPLY_OK=false}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(__){STR_APPLY_UIA_OK=false}var _utf8len=new utils.Buf8(256);for(var q=0;q<256;q++){_utf8len[q]=(q>=252?6:q>=248?5:q>=240?4:q>=224?3:q>=192?2:1)}_utf8len[254]=_utf8len[254]=1;exports.string2buf=function(h){var a,j,d,e,b,g=h.length,f=0;for(e=0;e<g;e++){j=h.charCodeAt(e);if((j&64512)===55296&&(e+1<g)){d=h.charCodeAt(e+1);if((d&64512)===56320){j=65536+((j-55296)<<10)+(d-56320);e++}}f+=j<128?1:j<2048?2:j<65536?3:4}a=new utils.Buf8(f);for(b=0,e=0;b<f;e++){j=h.charCodeAt(e);if((j&64512)===55296&&(e+1<g)){d=h.charCodeAt(e+1);if((d&64512)===56320){j=65536+((j-55296)<<10)+(d-56320);e++}}if(j<128){a[b++]=j}else{if(j<2048){a[b++]=192|(j>>>6);a[b++]=128|(j&63)}else{if(j<65536){a[b++]=224|(j>>>12);a[b++]=128|(j>>>6&63);a[b++]=128|(j&63)}else{a[b++]=240|(j>>>18);a[b++]=128|(j>>>12&63);a[b++]=128|(j>>>6&63);a[b++]=128|(j&63)}}}}return a};function buf2binstring(c,b){if(b<65537){if((c.subarray&&STR_APPLY_UIA_OK)||(!c.subarray&&STR_APPLY_OK)){return String.fromCharCode.apply(null,utils.shrinkBuf(c,b))}}var a="";for(var d=0;d<b;d++){a+=String.fromCharCode(c[d])}return a}exports.buf2binstring=function(a){return buf2binstring(a,a.length)};exports.binstring2buf=function(d){var b=new utils.Buf8(d.length);for(var c=0,a=b.length;c<a;c++){b[c]=d.charCodeAt(c)}return b};exports.buf2string=function(g,d){var h,f,j,e;var b=d||g.length;var a=new Array(b*2);for(f=0,h=0;h<b;){j=g[h++];if(j<128){a[f++]=j;continue}e=_utf8len[j];if(e>4){a[f++]=65533;h+=e-1;continue}j&=e===2?31:e===3?15:7;while(e>1&&h<b){j=(j<<6)|(g[h++]&63);e--}if(e>1){a[f++]=65533;continue}if(j<65536){a[f++]=j}else{j-=65536;a[f++]=55296|((j>>10)&1023);a[f++]=56320|(j&1023)}}return buf2binstring(a,f)};exports.utf8border=function(b,a){var c;a=a||b.length;if(a>b.length){a=b.length}c=a-1;while(c>=0&&(b[c]&192)===128){c--}if(c<0){return a}if(c===0){return a}return(c+_utf8len[b[c]]>a)?c:a};