var assert=require("assert");var zlib=require("../");var path=require("path");var zlibPairs=[[zlib.Deflate,zlib.Inflate],[zlib.Gzip,zlib.Gunzip],[zlib.Deflate,zlib.Unzip],[zlib.Gzip,zlib.Unzip],[zlib.DeflateRaw,zlib.InflateRaw]];var trickle=[128,1024,1024*1024];var chunkSize=[128,1024,1024*16,1024*1024];var level=[-1,0,1,2,3,4,5,6,7,8,9];var windowBits=[8,9,10,11,12,13,14,15];var memLevel=[1,2,3,4,5,6,7,8,9];var strategy=[0,1,2,3,4];if(!process.env.PUMMEL){trickle=[1024];chunkSize=[1024*16];level=[6];memLevel=[8];windowBits=[15];strategy=[0]}var fs=require("fs");if(process.env.FAST){zlibPairs=[[zlib.Gzip,zlib.Unzip]]}var tests={"person.jpg":fs.readFileSync(__dirname+"/fixtures/person.jpg"),"elipses.txt":fs.readFileSync(__dirname+"/fixtures/elipses.txt"),"empty.txt":fs.readFileSync(__dirname+"/fixtures/empty.txt")};var util=require("util");var stream=require("stream");function BufferStream(){this.chunks=[];this.length=0;this.writable=true;this.readable=true}util.inherits(BufferStream,stream.Stream);BufferStream.prototype.write=function(a){this.chunks.push(a);this.length+=a.length;return true};BufferStream.prototype.end=function(d){if(d){this.write(d)}var a=new Buffer(this.length);var b=0;this.chunks.forEach(function(e){e.copy(a,b);b+=e.length});this.emit("data",a);this.emit("end");return true};function SlowStream(a){this.trickle=a;this.offset=0;this.readable=this.writable=true}util.inherits(SlowStream,stream.Stream);SlowStream.prototype.write=function(){throw new Error("not implemented, just call ss.end(chunk)")};SlowStream.prototype.pause=function(){this.paused=true;this.emit("pause")};SlowStream.prototype.resume=function(){var a=this;if(a.ended){return}a.emit("resume");if(!a.chunk){return}a.paused=false;b();function b(){if(a.paused){return}if(a.offset>=a.length){a.ended=true;return a.emit("end")}var d=Math.min(a.offset+a.trickle,a.length);var e=a.chunk.slice(a.offset,d);a.offset+=e.length;a.emit("data",e);process.nextTick(b)}};SlowStream.prototype.end=function(b){var a=this;a.chunk=b;a.length=b.length;a.resume();return a.ended};var tape=require("tape");Object.keys(tests).forEach(function(a){var b=tests[a];chunkSize.forEach(function(c){trickle.forEach(function(d){windowBits.forEach(function(e){level.forEach(function(f){memLevel.forEach(function(g){strategy.forEach(function(h){zlibPairs.forEach(function(m){var j=m[0];var i=m[1];var k={level:f,windowBits:e,memLevel:g,strategy:h};var l=a+" "+c+" "+JSON.stringify(k)+" "+j.name+" -> "+i.name;tape("zlib "+l,function(p){p.plan(1);var r=new j(k);var q=new i(k);var o=new SlowStream(d);var n=new BufferStream();n.on("data",function(s){p.deepEqual(s,b)});o.pipe(r).pipe(q).pipe(n);o.end(b)})})})})})})})})});