var crypto=require("crypto");var stream=require("stream");var Stream=stream.Stream;var util=require("util");var tape=require("tape");var zlib=require("../");function RandomReadStream(a){Stream.call(this);this.readable=true;this._paused=false;this._processing=false;this._hasher=crypto.createHash("sha1");a=a||{};a.block=a.block||256*1024;a.total=a.total||256*1024*1024;this._remaining=a.total;a.jitter=a.jitter||1024;this._opt=a;this._process=this._process.bind(this);process.nextTick(this._process)}util.inherits(RandomReadStream,Stream);RandomReadStream.prototype.pause=function(){this._paused=true;this.emit("pause")};RandomReadStream.prototype.resume=function(){this._paused=false;this.emit("resume");this._process()};RandomReadStream.prototype._process=function(){if(this._processing){return}if(this._paused){return}this._processing=true;if(!this._remaining){this._hash=this._hasher.digest("hex").toLowerCase().trim();this._processing=false;this.emit("end");return}var c=this._opt.block;var d=this._opt.jitter;if(d){c+=Math.ceil(Math.random()*d-(d/2))}c=Math.min(c,this._remaining);var a=new Buffer(c);for(var b=0;b<c;b++){a[b]=Math.random()*256}this._hasher.update(a);this._remaining-=c;this._processing=false;this.emit("data",a);process.nextTick(this._process)};function HashStream(){Stream.call(this);this.readable=this.writable=true;this._hasher=crypto.createHash("sha1")}util.inherits(HashStream,Stream);HashStream.prototype.write=function(a){this._hasher.update(a);process.nextTick(this.resume.bind(this));return false};HashStream.prototype.resume=function(){this.emit("resume");process.nextTick(this.emit.bind(this,"drain"))};HashStream.prototype.end=function(a){if(a){this.write(a)}this._hash=this._hasher.digest("hex").toLowerCase().trim();this.emit("data",this._hash);this.emit("end")};tape("random byte pipes",function(d){var e=new RandomReadStream({total:1024,block:256,jitter:16});var b=new HashStream();var c=zlib.createGzip();var a=zlib.createGunzip();e.pipe(c).pipe(a).pipe(b);e.on("data",function(f){d.ok(f.length)});c.on("data",function(f){d.ok(f.length)});a.on("data",function(f){d.ok(f.length)});b.on("data",function(f){d.ok(f.length)});b.on("data",function(f){d.ok(f.length);d.equal(f,e._hash,"hashes should match")});b.on("end",function(){d.end()})});