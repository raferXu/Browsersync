var Transform=require("_stream_transform");var binding=require("./binding");var util=require("util");var assert=require("assert").ok;binding.Z_MIN_WINDOWBITS=8;binding.Z_MAX_WINDOWBITS=15;binding.Z_DEFAULT_WINDOWBITS=15;binding.Z_MIN_CHUNK=64;binding.Z_MAX_CHUNK=Infinity;binding.Z_DEFAULT_CHUNK=(16*1024);binding.Z_MIN_MEMLEVEL=1;binding.Z_MAX_MEMLEVEL=9;binding.Z_DEFAULT_MEMLEVEL=8;binding.Z_MIN_LEVEL=-1;binding.Z_MAX_LEVEL=9;binding.Z_DEFAULT_LEVEL=binding.Z_DEFAULT_COMPRESSION;Object.keys(binding).forEach(function(a){if(a.match(/^Z/)){exports[a]=binding[a]}});exports.codes={Z_OK:binding.Z_OK,Z_STREAM_END:binding.Z_STREAM_END,Z_NEED_DICT:binding.Z_NEED_DICT,Z_ERRNO:binding.Z_ERRNO,Z_STREAM_ERROR:binding.Z_STREAM_ERROR,Z_DATA_ERROR:binding.Z_DATA_ERROR,Z_MEM_ERROR:binding.Z_MEM_ERROR,Z_BUF_ERROR:binding.Z_BUF_ERROR,Z_VERSION_ERROR:binding.Z_VERSION_ERROR};Object.keys(exports.codes).forEach(function(a){exports.codes[exports.codes[a]]=a});exports.Deflate=Deflate;exports.Inflate=Inflate;exports.Gzip=Gzip;exports.Gunzip=Gunzip;exports.DeflateRaw=DeflateRaw;exports.InflateRaw=InflateRaw;exports.Unzip=Unzip;exports.createDeflate=function(a){return new Deflate(a)};exports.createInflate=function(a){return new Inflate(a)};exports.createDeflateRaw=function(a){return new DeflateRaw(a)};exports.createInflateRaw=function(a){return new InflateRaw(a)};exports.createGzip=function(a){return new Gzip(a)};exports.createGunzip=function(a){return new Gunzip(a)};exports.createUnzip=function(a){return new Unzip(a)};exports.deflate=function(a,b,c){if(typeof b==="function"){c=b;b={}}return zlibBuffer(new Deflate(b),a,c)};exports.deflateSync=function(a,b){return zlibBufferSync(new Deflate(b),a)};exports.gzip=function(a,b,c){if(typeof b==="function"){c=b;b={}}return zlibBuffer(new Gzip(b),a,c)};exports.gzipSync=function(a,b){return zlibBufferSync(new Gzip(b),a)};exports.deflateRaw=function(a,b,c){if(typeof b==="function"){c=b;b={}}return zlibBuffer(new DeflateRaw(b),a,c)};exports.deflateRawSync=function(a,b){return zlibBufferSync(new DeflateRaw(b),a)};exports.unzip=function(a,b,c){if(typeof b==="function"){c=b;b={}}return zlibBuffer(new Unzip(b),a,c)};exports.unzipSync=function(a,b){return zlibBufferSync(new Unzip(b),a)};exports.inflate=function(a,b,c){if(typeof b==="function"){c=b;b={}}return zlibBuffer(new Inflate(b),a,c)};exports.inflateSync=function(a,b){return zlibBufferSync(new Inflate(b),a)};exports.gunzip=function(a,b,c){if(typeof b==="function"){c=b;b={}}return zlibBuffer(new Gunzip(b),a,c)};exports.gunzipSync=function(a,b){return zlibBufferSync(new Gunzip(b),a)};exports.inflateRaw=function(a,b,c){if(typeof b==="function"){c=b;b={}}return zlibBuffer(new InflateRaw(b),a,c)};exports.inflateRawSync=function(a,b){return zlibBufferSync(new InflateRaw(b),a)};function zlibBuffer(e,b,h){var a=[];var g=0;e.on("error",f);e.on("end",d);e.end(b);c();function c(){var i;while(null!==(i=e.read())){a.push(i);g+=i.length}e.once("readable",c)}function f(i){e.removeListener("end",d);e.removeListener("readable",c);h(i)}function d(){var i=Buffer.concat(a,g);a=[];h(null,i);e.close()}}function zlibBufferSync(c,a){if(typeof a==="string"){a=new Buffer(a)}if(!Buffer.isBuffer(a)){throw new TypeError("Not a string or buffer")}var b=binding.Z_FINISH;return c._processChunk(a,b)}function Deflate(a){if(!(this instanceof Deflate)){return new Deflate(a)}Zlib.call(this,a,binding.DEFLATE)}function Inflate(a){if(!(this instanceof Inflate)){return new Inflate(a)}Zlib.call(this,a,binding.INFLATE)}function Gzip(a){if(!(this instanceof Gzip)){return new Gzip(a)}Zlib.call(this,a,binding.GZIP)}function Gunzip(a){if(!(this instanceof Gunzip)){return new Gunzip(a)}Zlib.call(this,a,binding.GUNZIP)}function DeflateRaw(a){if(!(this instanceof DeflateRaw)){return new DeflateRaw(a)}Zlib.call(this,a,binding.DEFLATERAW)}function InflateRaw(a){if(!(this instanceof InflateRaw)){return new InflateRaw(a)}Zlib.call(this,a,binding.INFLATERAW)}function Unzip(a){if(!(this instanceof Unzip)){return new Unzip(a)}Zlib.call(this,a,binding.UNZIP)}function Zlib(b,d){this._opts=b=b||{};this._chunkSize=b.chunkSize||exports.Z_DEFAULT_CHUNK;Transform.call(this,b);if(b.flush){if(b.flush!==binding.Z_NO_FLUSH&&b.flush!==binding.Z_PARTIAL_FLUSH&&b.flush!==binding.Z_SYNC_FLUSH&&b.flush!==binding.Z_FULL_FLUSH&&b.flush!==binding.Z_FINISH&&b.flush!==binding.Z_BLOCK){throw new Error("Invalid flush flag: "+b.flush)}}this._flushFlag=b.flush||binding.Z_NO_FLUSH;if(b.chunkSize){if(b.chunkSize<exports.Z_MIN_CHUNK||b.chunkSize>exports.Z_MAX_CHUNK){throw new Error("Invalid chunk size: "+b.chunkSize)}}if(b.windowBits){if(b.windowBits<exports.Z_MIN_WINDOWBITS||b.windowBits>exports.Z_MAX_WINDOWBITS){throw new Error("Invalid windowBits: "+b.windowBits)}}if(b.level){if(b.level<exports.Z_MIN_LEVEL||b.level>exports.Z_MAX_LEVEL){throw new Error("Invalid compression level: "+b.level)}}if(b.memLevel){if(b.memLevel<exports.Z_MIN_MEMLEVEL||b.memLevel>exports.Z_MAX_MEMLEVEL){throw new Error("Invalid memLevel: "+b.memLevel)}}if(b.strategy){if(b.strategy!=exports.Z_FILTERED&&b.strategy!=exports.Z_HUFFMAN_ONLY&&b.strategy!=exports.Z_RLE&&b.strategy!=exports.Z_FIXED&&b.strategy!=exports.Z_DEFAULT_STRATEGY){throw new Error("Invalid strategy: "+b.strategy)}}if(b.dictionary){if(!Buffer.isBuffer(b.dictionary)){throw new Error("Invalid dictionary: it should be a Buffer instance")}}this._binding=new binding.Zlib(d);var a=this;this._hadError=false;this._binding.onerror=function(h,g){a._binding=null;a._hadError=true;var f=new Error(h);f.errno=g;f.code=exports.codes[g];a.emit("error",f)};var e=exports.Z_DEFAULT_COMPRESSION;if(typeof b.level==="number"){e=b.level}var c=exports.Z_DEFAULT_STRATEGY;if(typeof b.strategy==="number"){c=b.strategy}this._binding.init(b.windowBits||exports.Z_DEFAULT_WINDOWBITS,e,b.memLevel||exports.Z_DEFAULT_MEMLEVEL,c,b.dictionary);this._buffer=new Buffer(this._chunkSize);this._offset=0;this._closed=false;this._level=e;this._strategy=c;this.once("end",this.close)}util.inherits(Zlib,Transform);Zlib.prototype.params=function(d,b,c){if(d<exports.Z_MIN_LEVEL||d>exports.Z_MAX_LEVEL){throw new RangeError("Invalid compression level: "+d)}if(b!=exports.Z_FILTERED&&b!=exports.Z_HUFFMAN_ONLY&&b!=exports.Z_RLE&&b!=exports.Z_FIXED&&b!=exports.Z_DEFAULT_STRATEGY){throw new TypeError("Invalid strategy: "+b)}if(this._level!==d||this._strategy!==b){var a=this;this.flush(binding.Z_SYNC_FLUSH,function(){a._binding.params(d,b);if(!a._hadError){a._level=d;a._strategy=b;if(c){c()}}})}else{process.nextTick(c)}};Zlib.prototype.reset=function(){return this._binding.reset()};Zlib.prototype._flush=function(a){this._transform(new Buffer(0),"",a)};Zlib.prototype.flush=function(c,d){var a=this._writableState;if(typeof c==="function"||(c===void 0&&!d)){d=c;c=binding.Z_FULL_FLUSH}if(a.ended){if(d){process.nextTick(d)}}else{if(a.ending){if(d){this.once("end",d)}}else{if(a.needDrain){var b=this;this.once("drain",function(){b.flush(d)})}else{this._flushFlag=c;this.write(new Buffer(0),"",d)}}}};Zlib.prototype.close=function(b){if(b){process.nextTick(b)}if(this._closed){return}this._closed=true;this._binding.close();var a=this;process.nextTick(function(){a.emit("close")})};Zlib.prototype._transform=function(f,h,a){var e;var c=this._writableState;var b=c.ending||c.ended;var g=b&&(!f||c.length===f.length);if(!f===null&&!Buffer.isBuffer(f)){return a(new Error("invalid input"))}if(g){e=binding.Z_FINISH}else{e=this._flushFlag;if(f.length>=c.length){this._flushFlag=this._opts.flush||binding.Z_NO_FLUSH}}var d=this;this._processChunk(f,e,a)};Zlib.prototype._processChunk=function(k,e,d){var b=k&&k.length;var m=this._chunkSize-this._offset;var f=0;var n=this;var c=typeof d==="function";if(!c){var o=[];var g=0;var i;this.on("error",function(p){i=p});do{var h=this._binding.writeSync(e,k,f,b,this._buffer,this._offset,m)}while(!this._hadError&&l(h[0],h[1]));if(this._hadError){throw i}var a=Buffer.concat(o,g);this.close();return a}var j=this._binding.write(e,k,f,b,this._buffer,this._offset,m);j.buffer=k;j.callback=l;function l(s,r){if(n._hadError){return}var t=m-r;assert(t>=0,"have should not go down");if(t>0){var q=n._buffer.slice(n._offset,n._offset+t);n._offset+=t;if(c){n.push(q)}else{o.push(q);g+=q.length}}if(r===0||n._offset>=n._chunkSize){m=n._chunkSize;n._offset=0;n._buffer=new Buffer(n._chunkSize)}if(r===0){f+=(b-s);b=s;if(!c){return true}var p=n._binding.write(e,k,f,b,n._buffer,n._offset,n._chunkSize);p.callback=l;p.buffer=k;return}if(!c){return false}d()}};util.inherits(Deflate,Zlib);util.inherits(Inflate,Zlib);util.inherits(Gzip,Zlib);util.inherits(Gunzip,Zlib);util.inherits(DeflateRaw,Zlib);util.inherits(InflateRaw,Zlib);util.inherits(Unzip,Zlib);