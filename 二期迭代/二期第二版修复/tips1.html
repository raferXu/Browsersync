<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script>
    var jobTaskLoaded = false;
    function nativeLoadCompleted() {
      jobTaskLoaded = true;
    }
    function htmlFontSize(){
      var html = document.querySelector("html");
      var htmlWidth = html.getBoundingClientRect().width;
      html.style.fontSize = htmlWidth / 3.75 + "px";
    }
    htmlFontSize();
    window.addEventListener("resize",function(){
      htmlFontSize();
    },false);
  </script>
  <style>
    body,p{
      margin: 0;
    }

    html{
      width: 100%;
      height: 100%;
      font-size: 100px;
    }
    body{
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-size: .14rem;
    }
    img{
      vertical-align: top;
    }
    .tip{
      position: relative;
      width: 100%;
      height: 100%;
      overflow: auto;
    }
    .tip img:first-child{
      width: 100%;
    }
    .tip img:last-child{
      position: absolute;
      top: 5.38rem;
      left: 50%;
      width: .8rem;
      -webkit-transform: translateX(-50%);
      transform: translateX(-50%);
    }
    @keyframes change {
      0%{transform:rotate(0deg);}
      50%{transform:rotate(180deg);}
      100%{transform:rotate(360deg);}
    }
    @-webkit-keyframes change {
      0%{-webkit-transform:rotate(0deg);}
      50%{-webkit-transform:rotate(180deg);}
      100%{-webkit-transform:rotate(360deg);}
    }

  </style>
</head>
<body>
  <div class="tip" id="tip1">
    <img src="tips1.png" alt="tips1">
    <img src="OK.png" alt="ok" id="ok1">
  </div>
  <div class="tip" id="tip2" style="display:none">
    <img src="tips2.png" alt="tips2">
    <img src="OK.png" alt="ok" id="ok2">
  </div>
  <div id="showMes" style="display:none;position:absolute;left:0;right:0;top:0;bottom:0;background:transparent;color:white;text-align:center;font-size:36px;z-index:10000;">
    <div style="position:absolute;top:50%;left:50%;width:1.2rem;height:.65rem;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);background:rgba(0,0,0,.7);border-radius:.1rem">
      <img src="http://192.168.0.182:8000/loading.png" alt="loading" style="display:block;width:.36rem;height:.36rem;margin:.15rem auto;animation:change 2s linear infinite;-webkit-animation:change 2s linear infinite;">
    </div>
  </div>
  <script>
    var tip1 = document.getElementById('tip1');
    var tip2 = document.getElementById('tip2');
    var ok1 = document.getElementById('ok1');
    var ok2 = document.getElementById('ok2');
    var showMes = document.getElementById('showMes');
    ok1.onclick = function () {
      tip1.style.display = 'none';
      tip2.style.display = 'block';
    };

    ok2.onclick = function () {
      showMes.style.display = 'block';

//      location.href = 'http://192.168.0.182:5009/project/hospital/newtask-token';
      var shortName;
      var timer = setInterval(function () {
        if(jobTaskLoaded){
            clearInterval(timer);
            var tokenStr = jobTask.receiveNativeToken();

            function ajaxFunction(){
              var xmlHttp;
              try{ // Firefox, Opera 8.0+, Safari
                xmlHttp=new XMLHttpRequest();
              }
              catch (e){
                try{// Internet Explorer
                  xmlHttp=new ActiveXObject("Msxml2.XMLHTTP");
                }
                catch (e){
                  try{
                    xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");
                  }
                  catch (e){}
                }
              }

              return xmlHttp;
            }

            var xhr2 = ajaxFunction();
            xhr2.onreadystatechange = function(){
              if(xhr2.readyState==4){
                if(xhr2.status==200){
                  var data = eval("("+xhr2.responseText+")");
                  console.log(data);
                  shortName = data['body']['short_name'];

                  var xhr = ajaxFunction();
                  xhr.onreadystatechange = function(){
                    if(xhr.readyState==4){
                      location.href = 'http://192.168.0.182:5009/project/'+shortName+'/newtask-token';
                    }
                  };
                  xhr.open("POST","http://192.168.0.182:5009/project/"+shortName+"/newtask-token",true);
                  xhr.setRequestHeader('Content-Type','application/json;charset=utf-8');
                  xhr.setRequestHeader('Accept','application/json,text/plain');
                  xhr.setRequestHeader('Authorization',tokenStr);
                  xhr.send(null);
                }
              }
            };
            xhr2.open("GET","http://192.168.0.182:5009/token/getongoingproject",true);
            xhr2.setRequestHeader('Content-Type','application/json;charset=utf-8');
            xhr2.setRequestHeader('Accept','application/json,text/plain');
            xhr2.setRequestHeader('Authorization',tokenStr);
            xhr2.send(null);
        }
      },30);
    }
  </script>
</body>
</html>
